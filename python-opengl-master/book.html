<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="Docutils 0.14: http://docutils.sourceforge.net/" />
<title>Python &amp; OpenGL for Scientific Visualization</title>
<meta content="An open-source book about Python and OpenGL for Scientific Visualization based on experience, practice and descriptive examples" name="description" />
<link rel="stylesheet" href="book.css" type="text/css" />
</head>
<body>
<div class="document" id="python-opengl-for-scientific-visualization">
<h1 class="title">Python &amp; OpenGL for Scientific Visualization</h1>
<h2 class="subtitle" id="copyright-c-2018-nicolas-p-rougier-nicolas-rougier-inria-fr">Copyright (c) 2018 - Nicolas P. Rougier &lt;<a class="reference external" href="mailto:Nicolas&#46;Rougier&#37;&#52;&#48;inria&#46;fr">Nicolas<span>&#46;</span>Rougier<span>&#64;</span>inria<span>&#46;</span>fr</a>&gt;</h2>

<div class="title-logos docutils container">
<img alt="images/cc.large.png" src="images/cc.large.png" style="width: 32px;" />
<img alt="images/by.large.png" src="images/by.large.png" style="width: 32px;" />
<img alt="images/sa.large.png" src="images/sa.large.png" style="width: 32px;" />
<img alt="images/nc.large.png" src="images/nc.large.png" style="width: 32px;" />
<div class="line-block">
<div class="line">Latest version - October 2019</div>
<div class="line"><a class="reference external" href="http://www.labri.fr/perso/nrougier/python-opengl">www.labri.fr/perso/nrougier/python-opengl</a></div>
</div>
</div>
<img alt="images/teaser.png" class="teaser" src="images/teaser.png" />
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="book-abstract docutils container">
<strong>Python and OpenGL</strong> have a long but complicated story. It used to be
really easy to program something using the fixed-pipeline and libraries such
as Pyglet but things have became more difficult with the introduction of the
dynamic graphic pipeline in 2004. The goal of this book is to reconcile
Python programmers with OpenGL, providing both an introduction to modern
OpenGL and a set of basic and advanced techniques in order to achieve both
fast, scalable &amp; beautiful scientific visualizations. The book uses the GLES
2.0 API which is the most simple API for accessing the programmable graphic
pipeline. It does not cover up-to-date OpenGL techniques but it is
sufficient to achieve great visualisation. In fact, modern OpenGL allows to
control pretty much everything in the pipeline and the goal of this book is
to explain several techniques dedicated to scientific visualisation such as
isolines, markers, colormaps, arbitrary transformations but there are
actually many more techniques to be discovered and explained in this
open-access book. And of course, everything will be fast and beautiful.</div>
<div class="book-colophon docutils container">
<div class="line-block">
<div class="line">Copyright (c) 2018 by Nicolas P. Rougier</div>
<div class="line">This work is licensed under a Creative Commons</div>
<div class="line">Attribution-Non Commercial-Share Alike 4.0 International License</div>
<div class="line">First published online in 2018, Bordeaux, France</div>
<div class="line">ISBN: X-XXXXX-XXX-X</div>
</div>
</div>
<div class="line-block">
<div class="line"><br /></div>
<div class="line"><br /></div>
<div class="line"><br /></div>
</div>
<div class="sidebar">
<p class="first sidebar-title"><a class="reference external" href="#python-opengl-for-scientific-visualization">Python &amp; OpenGL</a>
          <span class="subtitle">for Scientific Visualization</span>
          <span class="small">by Nicolas P. Rougier, 2018</span></p>
<div class="contents local last topic" id="contents">
<ul class="simple">
<li><a class="reference internal" href="#preface" id="id55">Preface</a><ul>
<li><a class="reference internal" href="#about-the-author" id="id56">About the author</a></li>
<li><a class="reference internal" href="#about-this-book" id="id57">About this book</a></li>
<li><a class="reference internal" href="#license" id="id58">License</a></li>
</ul>
</li>
<li><a class="reference internal" href="#introduction" id="id59">Introduction</a><ul>
<li><a class="reference internal" href="#a-bit-of-history" id="id60">A bit of history</a></li>
<li><a class="reference internal" href="#modern-opengl" id="id61">Modern OpenGL</a></li>
<li><a class="reference internal" href="#state-of-the-union" id="id62">State of the union</a></li>
</ul>
</li>
<li><a class="reference internal" href="#quickstart" id="id63">Quickstart</a><ul>
<li><a class="reference internal" href="#preliminaries" id="id64">Preliminaries</a></li>
<li><a class="reference internal" href="#the-hard-way" id="id65">The hard way</a></li>
<li><a class="reference internal" href="#the-easy-way" id="id66">The easy way</a></li>
<li><a class="reference internal" href="#exercises" id="id67">Exercises</a></li>
</ul>
</li>
<li><a class="reference internal" href="#basic-mathematics" id="id68">Basic Mathematics</a><ul>
<li><a class="reference internal" href="#id12" id="id69">Projective Geometry</a></li>
<li><a class="reference internal" href="#transformations" id="id70">Transformations</a></li>
<li><a class="reference internal" href="#id14" id="id71">Projections</a></li>
</ul>
</li>
<li><a class="reference internal" href="#rendering-a-cube" id="id72">Rendering a cube</a><ul>
<li><a class="reference internal" href="#object-creation" id="id73">Object creation</a></li>
<li><a class="reference internal" href="#scene-setup" id="id74">Scene setup</a></li>
<li><a class="reference internal" href="#actual-rendering" id="id75">Actual rendering</a></li>
<li><a class="reference internal" href="#variations" id="id76">Variations</a></li>
<li><a class="reference internal" href="#id16" id="id77">Exercises</a></li>
</ul>
</li>
<li><a class="reference internal" href="#anti-grain-geometry" id="id78">Anti-grain geometry</a><ul>
<li><a class="reference internal" href="#antialiasing" id="id79">Antialiasing</a></li>
<li><a class="reference internal" href="#signed-distance-fields" id="id80">Signed distance fields</a></li>
<li><a class="reference internal" href="#distance-based-anti-aliasing" id="id81">Distance based anti-aliasing</a></li>
</ul>
</li>
<li><a class="reference internal" href="#rendering-points" id="id82">Rendering points</a><ul>
<li><a class="reference internal" href="#dots-discs-circles" id="id83">Dots, discs, circles</a></li>
<li><a class="reference internal" href="#ellipses" id="id84">Ellipses</a></li>
<li><a class="reference internal" href="#spheres" id="id85">Spheres</a></li>
<li><a class="reference internal" href="#id28" id="id86">Exercises</a></li>
</ul>
</li>
<li><a class="reference internal" href="#rendering-markers" id="id87">Rendering markers</a><ul>
<li><a class="reference internal" href="#constructive-solid-geometry" id="id88">Constructive Solid Geometry</a></li>
<li><a class="reference internal" href="#markers" id="id89">Markers</a></li>
<li><a class="reference internal" href="#arrows" id="id90">Arrows</a></li>
<li><a class="reference internal" href="#texture-based" id="id91">Texture based</a></li>
<li><a class="reference internal" href="#id37" id="id92">Exercises</a></li>
</ul>
</li>
<li><a class="reference internal" href="#rendering-lines" id="id93">Rendering lines</a><ul>
<li><a class="reference internal" href="#raw-lines" id="id94">Raw Lines</a></li>
<li><a class="reference internal" href="#segments" id="id95">Segments</a></li>
<li><a class="reference internal" href="#lines" id="id96">Lines</a></li>
<li><a class="reference internal" href="#patterns" id="id97">Patterns</a></li>
<li><a class="reference internal" href="#d-lines" id="id98">3D lines</a></li>
<li><a class="reference internal" href="#id44" id="id99">Exercises</a></li>
</ul>
</li>
<li><a class="reference internal" href="#rendering-polygons" id="id100">Rendering polygons</a><ul>
<li><a class="reference internal" href="#id46" id="id101">Triangulation</a></li>
<li><a class="reference internal" href="#fill-rule" id="id102">Fill rule</a></li>
<li><a class="reference internal" href="#id48" id="id103">Exercises</a></li>
</ul>
</li>
<li><a class="reference internal" href="#rendering-a-mesh" id="id104">Rendering a mesh</a></li>
<li><a class="reference internal" href="#rendering-text" id="id105">Rendering text</a></li>
<li><a class="reference internal" href="#framebuffer" id="id106">Framebuffer</a></li>
<li><a class="reference internal" href="#special-techniques" id="id107">Special techniques</a></li>
<li><a class="reference internal" href="#conclusion" id="id108">Conclusion</a></li>
<li><a class="reference internal" href="#glsl-references" id="id109">GLSL References</a><ul>
<li><a class="reference internal" href="#types" id="id110">Types</a></li>
<li><a class="reference internal" href="#qualifiers" id="id111">Qualifiers</a></li>
<li><a class="reference internal" href="#built-in-variables" id="id112">Built-in variables</a></li>
<li><a class="reference internal" href="#built-in-constants" id="id113">Built-in constants</a></li>
<li><a class="reference internal" href="#built-in-functions" id="id114">Built-in functions</a></li>
</ul>
</li>
<li><a class="reference internal" href="#bibliography" id="id115">Bibliography</a><ul>
<li><a class="reference internal" href="#people" id="id116">People</a></li>
<li><a class="reference internal" href="#tutorials" id="id117">Tutorials</a></li>
<li><a class="reference internal" href="#articles" id="id118">Articles</a></li>
<li><a class="reference internal" href="#books" id="id119">Books</a></li>
</ul>
</li>
</ul>
</div>
</div>
<!-- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -->
<div class="section" id="preface">
<h1><a class="toc-backref" href="#contents">Preface</a></h1>
<div class="contents toc chapter-01 local topic" id="id1">
<p class="topic-title first">.</p>
<ul class="simple">
<li><a class="reference internal" href="#about-the-author" id="id120">About the author</a></li>
<li><a class="reference internal" href="#about-this-book" id="id121">About this book</a><ul>
<li><a class="reference internal" href="#prerequisites" id="id122">Prerequisites</a></li>
<li><a class="reference internal" href="#conventions" id="id123">Conventions</a></li>
<li><a class="reference internal" href="#how-to-contribute" id="id124">How to contribute</a></li>
<li><a class="reference internal" href="#publishing" id="id125">Publishing</a></li>
</ul>
</li>
<li><a class="reference internal" href="#license" id="id126">License</a><ul>
<li><a class="reference internal" href="#book" id="id127">Book</a></li>
<li><a class="reference internal" href="#code" id="id128">Code</a></li>
</ul>
</li>
</ul>
</div>
<p>This book is open-access (i.e. it's free to read at <a class="reference external" href="http://www.labri.fr/perso/nrougier/python-opengl">this address</a>) because I believe
knowledge should be free. However, if you think the book is worth a few
dollars, you can give me a few euros (<a class="reference external" href="https://www.paypal.me/NicolasPRougier/5">5€</a> or <a class="reference external" href="https://www.paypal.me/NicolasPRougier/10">10€</a>). This money will help me to
travel to Python conferences and to write other books as well.  If you don't
have money, it's fine. Just enjoy the book and spread the word about it. The
teaser image above comes from the <a class="reference external" href="http://www.labri.fr/perso/nrougier/artwork/index.html">artwork section</a> of my website. It has
been made some years ago using the <a class="reference external" href="http://www.povray.org">Povray</a>
(Persistence of Vision) raytracer. I like it very much because it is a kind of
résumé of my <a class="reference external" href="http://www.labri.fr/perso/nrougier/research/index.html">research</a>.</p>
<div class="section" id="about-the-author">
<h2><a class="toc-backref" href="#id1">About the author</a></h2>
<p>I am a full-time research scientist at <a class="reference external" href="http://www.inria.fr/en">Inria</a> which is the French national
institute for research in computer science and control. This is a public
scientific and technological establishment (EPST) under the double supervision
of the Research &amp; Education Ministry, and the Ministry of Economy Finance and
Industry. I'm working within the <a class="reference external" href="http://www.inria.fr/en/teams/mnemosyne">Mnemosyne</a> project which lies at the frontier
between integrative and computational neuroscience in association with the
<a class="reference external" href="http://www.imn-bordeaux.org/en/">Institute of Neurodegenerative Diseases</a>, the Bordeaux laboratory for
research in computer science (<a class="reference external" href="https://www.labri.fr/">LaBRI</a>), the <a class="reference external" href="http://www.u-bordeaux.com/">University of Bordeaux</a> and the
national center for scientific research (<a class="reference external" href="http://www.cnrs.fr/index.php">CNRS</a>).</p>
<p>I've been using Python for more than 15 years and numpy for more than 10 years
for modeling in neuroscience, machine learning and for advanced visualization
(OpenGL). I'm the author of several online resources and tutorials (Matplotlib,
numpy, OpenGL) and I've been teaching Python, numpy and scientific
visualization at the University of Bordeaux and in various conferences and
schools worldwide (SciPy, EuroScipy, etc). I'm also the author of the popular
article <a class="reference external" href="http://dx.doi.org/10.1371/journal.pcbi.1003833">Ten Simple Rules for Better Figures</a> , a popular <a class="reference external" href="http://www.labri.fr/perso/nrougier/teaching/matplotlib/matplotlib.html">matplotlib
tutorial</a> and an open access book <a class="reference external" href="http://www.labri.fr/perso/nrougier/from-python-to-numpy/">From Python To Numpy</a>.</p>
</div>
<div class="section" id="about-this-book">
<h2><a class="toc-backref" href="#id1">About this book</a></h2>
<p>This book has been written in <a class="reference external" href="http://docutils.sourceforge.net/rst.html">restructured text</a> format and generated using a <a class="reference external" href="rst2html.py">customized
version</a> of the docutils rst2html.py command line (available from
the <a class="reference external" href="http://docutils.sourceforge.net/">docutils</a> python package) and a custom <a class="reference external" href="book-template.txt">template</a>.</p>
<p>If you want to rebuild the html output, from the top directory, type:</p>
<pre class="code literal-block">
$ ./rst2html.py --link-stylesheet            \
                --cloak-email-addresses      \
                --toc-top-backlinks          \
                --stylesheet book.css        \
                --stylesheet-dirs .          \
                book.rst book.html
</pre>
<p>Or you use the provided <a class="reference external" href="make.sh">make.sh</a> shell script.</p>
<p>The sources are available from <a class="reference external" href="https://github.com/rougier/python-opengl">https://github.com/rougier/python-opengl</a>.</p>
<p>Last point, I wrote the book in a kind of modern <a class="reference external" href="https://en.wikipedia.org/wiki/Jack_Kerouac">Kerouac</a>'s style such that you can
download it once and continue reading it offline. Initial loading may be
slow though.</p>
<div class="section" id="prerequisites">
<h3><a class="toc-backref" href="#id1">Prerequisites</a></h3>
<p>This is not a Python nor a NumpPy beginner guide and you should have an
intermediate level in both Python and NumPy. No prior knowledge of OpenGL is
necessary because I'll explain everything.</p>
</div>
<div class="section" id="conventions">
<h3><a class="toc-backref" href="#id1">Conventions</a></h3>
<p>I will use usual naming conventions. If not stated explicitly, each script
should import numpy, scipy and glumpy as:</p>
<pre class="code python literal-block">
<span class="keyword namespace">import</span> <span class="name namespace">numpy</span> <span class="keyword namespace">as</span> <span class="name namespace">np</span>
</pre>
<p>We'll use up-to-date versions (at the date of writing, i.e. August, 2017) of the
different packages:</p>
<table border="1" class="docutils">
<colgroup>
<col width="55%" />
<col width="45%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Packages</th>
<th class="head">Version</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>Python</td>
<td>3.6.0</td>
</tr>
<tr><td>Numpy</td>
<td>1.12.0</td>
</tr>
<tr><td>Scipy</td>
<td>0.18.1</td>
</tr>
<tr><td>Cython</td>
<td>0.25.2</td>
</tr>
<tr><td>Triangle</td>
<td>20170106</td>
</tr>
<tr><td>Glumpy</td>
<td>1.0.6</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="how-to-contribute">
<h3><a class="toc-backref" href="#id1">How to contribute</a></h3>
<p>If you want to contribute to this book, you can:</p>
<ul class="simple">
<li>Report issues (<a class="reference external" href="https://github.com/rougier/python-opengl/issues">https://github.com/rougier/python-opengl/issues</a>)</li>
<li>Suggest improvements (<a class="reference external" href="https://github.com/rougier/python-opengl/pulls">https://github.com/rougier/python-opengl/pulls</a>)</li>
<li>Correct English (<a class="reference external" href="https://github.com/rougier/python-opengl/issues">https://github.com/rougier/python-opengl/issues</a>)</li>
<li>Star the project (<a class="reference external" href="https://github.com/rougier/python-opengl">https://github.com/rougier/python-opengl</a>)</li>
<li>Suggest a more responsive design for the HTML Book</li>
<li>Spread the word about this book (Reddit, Hacker News, etc.)</li>
</ul>
</div>
<div class="section" id="publishing">
<h3><a class="toc-backref" href="#id1">Publishing</a></h3>
<p>If you're an editor interested in publishing this book, you can <a class="reference external" href="mailto:Nicolas&#46;Rougier&#37;&#52;&#48;inria&#46;fr">contact me</a> if you agree to have this version and all
subsequent versions open access (i.e. online at <a class="reference external" href="http://www.labri.fr/perso/nrougier/python-opengl">this address</a>), you know how to deal
with <a class="reference external" href="http://docutils.sourceforge.net/rst.html">restructured text</a> (Word is
not an option), you provide a real added-value as well as supporting services,
and more importantly, you have a truly amazing latex book template (and be
warned that I'm a bit picky about typography &amp; design: <a class="reference external" href="https://www.edwardtufte.com/tufte/">Edward Tufte</a> is my hero). Still here?</p>
</div>
</div>
<div class="section" id="license">
<h2><a class="toc-backref" href="#id1">License</a></h2>
<div class="section" id="book">
<h3><a class="toc-backref" href="#id1">Book</a></h3>
<p>This work is licensed under a <a class="reference external" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">Creative Commons Attribution-Non Commercial-Share
Alike 4.0 International License</a>. You are free to:</p>
<ul class="simple">
<li><strong>Share</strong> — copy and redistribute the material in any medium or format</li>
<li><strong>Adapt</strong> — remix, transform, and build upon the material</li>
</ul>
<p>The licensor cannot revoke these freedoms as long as you follow the license terms.</p>
<p>Under the following terms:</p>
<ul class="simple">
<li><strong>Attribution</strong> — You must give appropriate credit, provide a link to the
license, and indicate if changes were made. You may do so in any reasonable
manner, but not in any way that suggests the licensor endorses you or your
use.</li>
<li><strong>NonCommercial</strong> — You may not use the material for commercial purposes.</li>
<li><strong>ShareAlike</strong> — If you remix, transform, or build upon the material, you
must distribute your contributions under the same license as the original.</li>
</ul>
</div>
<div class="section" id="code">
<h3><a class="toc-backref" href="#id1">Code</a></h3>
<p>The code is licensed under the <a class="reference external" href="LICENSE-code.txt">OSI-approved BSD 2-Clause License</a>.</p>
<!-- - - - Links - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -->
<!-- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -->
</div>
</div>
</div>
<div class="section" id="introduction">
<h1><a class="toc-backref" href="#contents">Introduction</a></h1>
<div class="contents toc chapter-02 local topic" id="id5">
<p class="topic-title first">.</p>
<ul class="simple">
<li><a class="reference internal" href="#a-bit-of-history" id="id129">A bit of history</a></li>
<li><a class="reference internal" href="#modern-opengl" id="id130">Modern OpenGL</a><ul>
<li><a class="reference internal" href="#the-graphic-pipeline" id="id131">The graphic pipeline</a></li>
<li><a class="reference internal" href="#buffers" id="id132">Buffers</a></li>
<li><a class="reference internal" href="#variables" id="id133">Variables</a></li>
</ul>
</li>
<li><a class="reference internal" href="#state-of-the-union" id="id134">State of the union</a><ul>
<li><a class="reference internal" href="#bindings" id="id135">Bindings</a></li>
<li><a class="reference internal" href="#engines" id="id136">Engines</a></li>
<li><a class="reference internal" href="#libraries" id="id137">Libraries</a></li>
</ul>
</li>
</ul>
</div>
<p>Before diving into OpenGL programming, it is important to have a look at the
whole GL landscape because it is actually quite complex and you can easily lose
yourself between the different actors, terms and definitions. The teaser image
above shows the face of a character from the Wolfenstein game, one from 1992
and the other from 2015. You can see that computer graphics has evolved a lot
in 25 years.</p>
<div class="section" id="a-bit-of-history">
<h2><a class="toc-backref" href="#id5">A bit of history</a></h2>
<p>OpenGL is 25 years old! Since the first release in 1992, a lot has happened
(and is still happening actually, with the newly released <a class="reference external" href="https://en.wikipedia.org/wiki/Vulkan_(API)">Vulkan</a> API and the
4.6 GL release) and consequently, before diving into the book, it is important
to understand OpenGL API evolution over the years. If the first API (1.xx) has
not changed too much in the first twelve years, a big change occurred in 2004
with the introduction of the dynamic pipeline (OpenGL 2.x), i.e. the use of
shaders that allow to have direct access to the GPU. Before this version,
OpenGL was using a fixed pipeline that made it easy to rapidly prototype some
ideas. It was simple but not very powerful because the user had not much
control over the graphic pipeline. This is the reason why it has been
<a class="reference external" href="https://khronos.org/registry/OpenGL/specs/gl/glspec30.pdf#page=421">deprecated</a> more than ten years ago and you don't want to use it today. Problem
is that there are a lot of tutorials online that still use this fixed pipeline
and because most of them were written before modern GL, they're not even aware
(and cannot) that they use a deprecated API.</p>
<p>How to know if a tutorial address the fixed pipeline ? It's relatively
easy. It'll contain GL commands such as:</p>
<pre class="code neutral literal-block">
glVertex, glColor, glLight, glMaterial, glBegin, glEnd, glMatrix,
glMatrixMode, glLoadIdentity, glPushMatrix, glPopMatrix, glRect,
glPolygonMode, glBitmap, glAphaFunc, glNewList, glDisplayList,
glPushAttrib, glPopAttrib, glVertexPointer, glColorPointer,
glTexCoordPointer, glNormalPointer, glRotate, glTranslate, glScale,
glMatrixMode, glCall,
</pre>
<p>If you see any of them in a tutorial, run away because it it's most certainly a
tutorial that address the fixed pipeline and you don't want to read it because
what you will learn is already useless. If you look at the GL history below,
you'll realize that the &quot;modern&quot; GL API is already 13 years old while the fixed
pipeline has been deprecated more than 10 years ago.</p>
<pre class="code neutral literal-block">
 1                       2         Modern              2
 9                       0         OpenGL              0               Vulkan
 9                       0           ↓                 1                 ↓
 2  3  4  5  6  7  8  9  0  1  2  3  4  5  6  7  8  9  0  1  2  3  4  5  6  7
─────────────────────────────────────┬───────────────────────────────────┬────
OpenGL                                                3.3
                                                      4.0
                                                   3.1
                  1.2         1.4   2.0            3.2   4.2   4.4
1.0            1.1         1.3   1.5      2.1   3.0   4.1   4.3   4.5      4.6
╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌┬╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌
           Fixed pipeline            ╎           Programmable pipeline
╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌┴╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌
GLES                                    ╭─────╮                      3.2
                              1.0       │ 2.0 │             3.0   3.1
                                        ╰─────╯
╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌
GLSL                                                  4.0   4.3   4.5      4.6
                                                1.3   4.1      4.4
                                                   1.4   4.2
                                    1.1   1.2      1.5
╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌
WebGL                                             1.0                      2.0
╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌
Vulkan                                                                  1.0
──────────────────────────────────────────────────────────────────────────────
</pre>
<p>From <a class="reference external" href="https://www.khronos.org/opengl/wiki/History_of_OpenGL">OpenGL wiki</a>: <em>In 1992, Mark Segal and Kurt Akeley authored the OpenGL
1.0 specification which formalized a graphics API and made cross platform 3rd
party implementation and support viable. In 2004, OpenGL 2.0 incorporated the
significant addition of the OpenGL Shading Language (also called GLSL), a C
like language with which the transformation and fragment shading stages of the
pipeline can be programmed. In 2008, OpenGL 3.0 added the concept of
deprecation: marking certain features as subject to removal in later versions.</em></p>
<dl class="docutils">
<dt><a class="reference external" href="https://en.wikipedia.org/wiki/OpenGL">Open Graphics Library</a> (OpenGL)</dt>
<dd>OpenGL is a cross-language, cross-platform application programming interface
(API) for rendering 2D and 3D vector graphics. The API is typically used to
interact with a graphics processing unit (GPU), to achieve
hardware-accelerated rendering.</dd>
<dt><a class="reference external" href="https://en.wikipedia.org/wiki/OpenGL_ES`">OpenGL for Embedded Systems</a> (OpenGL ES or GLES)</dt>
<dd>GLES is a subset of the OpenGL computer graphics rendering application
programming interface (API) for rendering 2D and 3D computer graphics such as
those used by video games, typically hardware-accelerated using a graphics
processing unit (GPU).</dd>
<dt><a class="reference external" href="https://en.wikipedia.org/wiki/OpenGL_Shading_Language">OpenGL Shading Language</a> (GLSL)</dt>
<dd>GLSL is a high-level shading language with a syntax based on the C
programming language. It was created by the OpenGL ARB (OpenGL Architecture
Review Board) to give developers more direct control of the graphics pipeline</dd>
<dt><a class="reference external" href="https://en.wikipedia.org/wiki/WebGL">Web Graphics Library</a> (WebGL)</dt>
<dd>WebGL is a JavaScript API for rendering 3D graphics within any compatible web
browser without the use of plug-ins. WebGL is integrated completely into all
the web standards of the browser allowing GPU accelerated usage of physics
and image processing and effects as part of the web page canvas.</dd>
<dt><a class="reference external" href="https://en.wikipedia.org/wiki/Vulkan_(API)">Vulkan</a> (VK)</dt>
<dd>Vulkan is a low-overhead, cross-platform 3D graphics and compute API first
announced at GDC 2015 by the Khronos Group. Like OpenGL, Vulkan targets
high-performance realtime 3D graphics applications such as video games and
interactive media across all platforms, and can offer higher performance and
more balanced CPU/GPU usage, much like Direct3D 12 and Mantle.</dd>
</dl>
<p>For this book, we'll use the GLES 2.0 API that allows to use the modern GL API
while staying relatively simple.  For comparison, have a look at the table
below that gives the number of functions and constants for each version of the
GL API.  Note that once you'll master the GLES 2.0, it's only a matter of
reading the documentation to take advantage of more advanced version because
the core concepts remain the same (which is not the case for the new Vulkan
API).</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The number of functions and constants have been computed using the
<a class="reference external" href="code/chapter-02/registry.py">code/chapter-02/registry.py</a> program that parses the <a class="reference external" href="https://github.com/KhronosGroup/OpenGL-Registry/blob/master/xml/gl.xml">gl.xml</a> file that
defines the OpenGL and OpenGL API Registry</p>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="14%" />
<col width="15%" />
<col width="15%" />
<col width="5%" />
<col width="20%" />
<col width="15%" />
<col width="15%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Version</th>
<th class="head">Constants</th>
<th class="head">Functions</th>
<th class="head">&nbsp;</th>
<th class="head">Version</th>
<th class="head">Constants</th>
<th class="head">Functions</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>GL 1.0</td>
<td>0</td>
<td>306</td>
<td>&nbsp;</td>
<td>GL 3.2</td>
<td>800</td>
<td>316</td>
</tr>
<tr><td>GL 1.1</td>
<td>528</td>
<td>336</td>
<td>&nbsp;</td>
<td>GL 3.3</td>
<td>816</td>
<td>344</td>
</tr>
<tr><td>GL 1.2</td>
<td>569</td>
<td>340</td>
<td>&nbsp;</td>
<td>GL 4.0</td>
<td>894</td>
<td>390</td>
</tr>
<tr><td>GL 1.3</td>
<td>665</td>
<td>386</td>
<td>&nbsp;</td>
<td>GL 4.1</td>
<td>929</td>
<td>478</td>
</tr>
<tr><td>GL 1.4</td>
<td>713</td>
<td>433</td>
<td>&nbsp;</td>
<td>GL 4.2</td>
<td>1041</td>
<td>490</td>
</tr>
<tr><td>GL 1.5</td>
<td>763</td>
<td>452</td>
<td>&nbsp;</td>
<td>GL 4.3</td>
<td>1302</td>
<td>534</td>
</tr>
<tr><td>GL 2.0</td>
<td>847</td>
<td>545</td>
<td>&nbsp;</td>
<td>GL 4.4</td>
<td>1321</td>
<td>543</td>
</tr>
<tr><td>GL 2.1</td>
<td>870</td>
<td>551</td>
<td>&nbsp;</td>
<td>GL 4.5</td>
<td>1343</td>
<td>653</td>
</tr>
<tr><td>GL 3.0</td>
<td>1104</td>
<td>635</td>
<td>&nbsp;</td>
<td>GLES 1.0</td>
<td>333</td>
<td>106</td>
</tr>
<tr><td>GL 3.1</td>
<td>1165</td>
<td>647</td>
<td>&nbsp;</td>
<td><strong>GLES 2.0</strong></td>
<td><strong>301</strong></td>
<td><strong>142</strong></td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="modern-opengl">
<h2><a class="toc-backref" href="#id5">Modern OpenGL</a></h2>
<div class="section" id="the-graphic-pipeline">
<h3><a class="toc-backref" href="#id5">The graphic pipeline</a></h3>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The shader language is called glsl.  There are many versions that goes from 1.0
to 1.5 and subsequent version get the number of OpenGL version. Last version
is 4.6 (June 2017).</p>
</div>
<p>If you want to understand modern OpenGL, you have to understand the graphic
pipeline and shaders. Shaders are pieces of program (using a C-like language)
that are built onto the GPU and executed during the rendering
pipeline. Depending on the nature of the shaders (there are many types
depending on the version of OpenGL you're using), they will act at different
stage of the rendering pipeline. To simplify this tutorial, we'll use only
<strong>vertex</strong> and <strong>fragment</strong> shaders as shown below:</p>
<img alt="images/chapter-02/gl-pipeline.png" src="images/chapter-02/gl-pipeline.png" style="width: 100%;" />
<p>A vertex shader acts on vertices and is supposed to output the vertex
<strong>position</strong> (<code>gl_Position</code>) on the viewport (i.e. screen). A fragment shader
acts at the fragment level and is supposed to output the <strong>color</strong>
(<code>gl_FragColor</code>) of the fragment. Hence, a minimal vertex shader is:</p>
<pre class="code glsl literal-block">
<span class="keyword type">void</span> <span class="name">main</span><span class="punctuation">()</span>
<span class="punctuation">{</span>
    <span class="name builtin">gl_Position</span> <span class="operator">=</span> <span class="keyword type">vec4</span><span class="punctuation">(</span><span class="literal number float">0.0</span><span class="punctuation">,</span><span class="literal number float">0.0</span><span class="punctuation">,</span><span class="literal number float">0.0</span><span class="punctuation">,</span><span class="literal number float">1.0</span><span class="punctuation">);</span>
<span class="punctuation">}</span>
</pre>
<p>while a minimal fragment shader would be:</p>
<pre class="code glsl literal-block">
<span class="keyword type">void</span> <span class="name">main</span><span class="punctuation">()</span>
<span class="punctuation">{</span>
    <span class="name builtin">gl_FragColor</span> <span class="operator">=</span> <span class="keyword type">vec4</span><span class="punctuation">(</span><span class="literal number float">0.0</span><span class="punctuation">,</span><span class="literal number float">0.0</span><span class="punctuation">,</span><span class="literal number float">0.0</span><span class="punctuation">,</span><span class="literal number float">1.0</span><span class="punctuation">);</span>
<span class="punctuation">}</span>
</pre>
<p>These two shaders are not very useful because the first shader will always
output the null vertex (<code>gl_Position</code> is a special variable) while the second
will only output the black color for any fragment (<code>gl_FragColor</code> is also a
special variable). We'll see later how to make them to do more useful things.</p>
<p>One question remains: when are those shaders executed exactly ? The vertex
shader is executed for each vertex that is given to the rendering pipeline
(we'll see excatly what that means later) and the fragment shader is
executed on each fragment (= pixel) that is generated after the vertex
stage. For example, in the simple figure above, the vertex would be called 3
times, once for each vertex (1,2 and 3) while the fragment shader would be
executed 21 times, once for each fragment.</p>
</div>
<div class="section" id="buffers">
<h3><a class="toc-backref" href="#id5">Buffers</a></h3>
<p>The next question is thus where do those vertices comes from ? The idea of
modern GL is that vertices are stored on the CPU and need to be uploaded to
the GPU before rendering. The way to do that is to build buffers on the CPU
and to send these buffers onto the GPU. If your data does not change, no need
to upload them again. That is the big difference with the previous fixed
pipeline where data were uploaded at each rendering call (only display lists
were built into GPU memory).</p>
<p>But what is the structure of a vertex ? OpenGL does not assume anything about
your vertex structure and you're free to use as much information you may need
for each vertex. The only condition is that all vertices from a buffer have the
same structure (possibly with different content). This, again, is a big
difference with the fixed pipeline where OpenGL was doing a lot of complex
rendering stuff for you (projections, lighting, normals, etc.) with an implicit
fixed vertex structure. The good news is that you're now free to do anything
you want, but the bad news is that you have to program just about everything.</p>
<p>Let's take a simple example of a vertex structure where we want each vertex to
hold a position and a color. The easiest way to do that in python is to use a
structured array using <a class="reference external" href="http://www.numpy.org">numpy</a>:</p>
<pre class="code python literal-block">
<span class="name">data</span> <span class="operator">=</span> <span class="name">np</span><span class="operator">.</span><span class="name">zeros</span><span class="punctuation">(</span><span class="literal number integer">4</span><span class="punctuation">,</span> <span class="name">dtype</span> <span class="operator">=</span> <span class="punctuation">[</span> <span class="punctuation">(</span><span class="literal string double">&quot;position&quot;</span><span class="punctuation">,</span> <span class="name">np</span><span class="operator">.</span><span class="name">float32</span><span class="punctuation">,</span> <span class="literal number integer">3</span><span class="punctuation">),</span>
                             <span class="punctuation">(</span><span class="literal string double">&quot;color&quot;</span><span class="punctuation">,</span>    <span class="name">np</span><span class="operator">.</span><span class="name">float32</span><span class="punctuation">,</span> <span class="literal number integer">4</span><span class="punctuation">)]</span> <span class="punctuation">)</span>
</pre>
<p>We just created a CPU buffer with 4 vertices, each of them having a
<code>position</code> (3 floats for x,y,z coordinates) and a <code>color</code> (4 floats for
red, blue, green and alpha channels). Note that we explicitly chose to have 3
coordinates for <code>position</code> but we may have chosen to have only 2 if were to
work in two-dimensions. Same holds true for <code>color</code>. We could have used
only 3 channels (r,g,b) if we did not want to use transparency. This would save
some bytes for each vertex. Of course, for 4 vertices, this does not really
matter but you have to realize it <strong>will matter</strong> if your data size grows up to
one or ten million vertices.</p>
</div>
<div class="section" id="variables">
<h3><a class="toc-backref" href="#id5">Variables</a></h3>
<p>Now, we need to explain to our shaders what to do with these buffers and how to
connect them together. So, let's consider again a CPU buffer of 4 vertices
using 2 floats for position and 4 floats for color:</p>
<pre class="code python literal-block">
<span class="name">data</span> <span class="operator">=</span> <span class="name">np</span><span class="operator">.</span><span class="name">zeros</span><span class="punctuation">(</span><span class="literal number integer">4</span><span class="punctuation">,</span> <span class="name">dtype</span> <span class="operator">=</span> <span class="punctuation">[</span> <span class="punctuation">(</span><span class="literal string double">&quot;position&quot;</span><span class="punctuation">,</span> <span class="name">np</span><span class="operator">.</span><span class="name">float32</span><span class="punctuation">,</span> <span class="literal number integer">2</span><span class="punctuation">),</span>
                             <span class="punctuation">(</span><span class="literal string double">&quot;color&quot;</span><span class="punctuation">,</span>    <span class="name">np</span><span class="operator">.</span><span class="name">float32</span><span class="punctuation">,</span> <span class="literal number integer">4</span><span class="punctuation">)]</span> <span class="punctuation">)</span>
</pre>
<p>We need to tell the vertex shader that it will have to handle vertices where a
position is a tuple of 2 floats and color is a tuple of 4 floats. This is
precisely what <strong>attributes</strong> are meant for. Let us change slightly our previous
vertex shader:</p>
<pre class="code glsl literal-block">
<span class="keyword">attribute</span> <span class="keyword type">vec2</span> <span class="name">position</span><span class="punctuation">;</span>
<span class="keyword">attribute</span> <span class="keyword type">vec4</span> <span class="name">color</span><span class="punctuation">;</span>
<span class="keyword type">void</span> <span class="name">main</span><span class="punctuation">()</span>
<span class="punctuation">{</span>
    <span class="name builtin">gl_Position</span> <span class="operator">=</span> <span class="keyword type">vec4</span><span class="punctuation">(</span><span class="name">position</span><span class="punctuation">,</span> <span class="literal number float">0.0</span><span class="punctuation">,</span> <span class="literal number float">1.0</span><span class="punctuation">);</span>
<span class="punctuation">}</span>
</pre>
<p>This vertex shader now expects a vertex to possess 2 attributes, one named
<code>position</code> and one named <code>color</code> with specified types (vec2 means tuple of
2 floats and vec4 means tuple of 4 floats). It is important to note that even
if we labeled the first attribute <code>position</code>, this attribute is not yet bound
to the actual <code>position</code> in the numpy array. We'll need to do it explicitly
at some point in our program and there is no magic that will bind the numpy
array field to the right attribute, you'll have to do it yourself, but we'll
see that later.</p>
<p>The second type of information we can feed the vertex shader is the <strong>uniform</strong>
that may be considered as constant value (across all the vertices). Let's say
for example we want to scale all the vertices by a constant factor <code>scale</code>,
we would thus write:</p>
<pre class="code glsl literal-block">
<span class="keyword">uniform</span> <span class="keyword type">float</span> <span class="name">scale</span><span class="punctuation">;</span>
<span class="keyword">attribute</span> <span class="keyword type">vec2</span> <span class="name">position</span><span class="punctuation">;</span>
<span class="keyword">attribute</span> <span class="keyword type">vec4</span> <span class="name">color</span><span class="punctuation">;</span>
<span class="keyword type">void</span> <span class="name">main</span><span class="punctuation">()</span>
<span class="punctuation">{</span>
    <span class="name builtin">gl_Position</span> <span class="operator">=</span> <span class="keyword type">vec4</span><span class="punctuation">(</span><span class="name">position</span><span class="operator">*</span><span class="name">scale</span><span class="punctuation">,</span> <span class="literal number float">0.0</span><span class="punctuation">,</span> <span class="literal number float">1.0</span><span class="punctuation">);</span>
<span class="punctuation">}</span>
</pre>
<p>Last type is the varying type that is used to pass information between the
vertex stage and the fragment stage. So let us suppose (again) we want to pass
the vertex color to the fragment shader, we now write:</p>
<pre class="code glsl literal-block">
<span class="keyword">uniform</span> <span class="keyword type">float</span> <span class="name">scale</span><span class="punctuation">;</span>
<span class="keyword">attribute</span> <span class="keyword type">vec2</span> <span class="name">position</span><span class="punctuation">;</span>
<span class="keyword">attribute</span> <span class="keyword type">vec4</span> <span class="name">color</span><span class="punctuation">;</span>
<span class="keyword">varying</span> <span class="keyword type">vec4</span> <span class="name">v_color</span><span class="punctuation">;</span>

<span class="keyword type">void</span> <span class="name">main</span><span class="punctuation">()</span>
<span class="punctuation">{</span>
    <span class="name builtin">gl_Position</span> <span class="operator">=</span> <span class="keyword type">vec4</span><span class="punctuation">(</span><span class="name">position</span><span class="operator">*</span><span class="name">scale</span><span class="punctuation">,</span> <span class="literal number float">0.0</span><span class="punctuation">,</span> <span class="literal number float">1.0</span><span class="punctuation">);</span>
    <span class="name">v_color</span> <span class="operator">=</span> <span class="name">color</span><span class="punctuation">;</span>
<span class="punctuation">}</span>
</pre>
<p>and then in the fragment shader, we write:</p>
<pre class="code glsl literal-block">
<span class="keyword">varying</span> <span class="keyword type">vec4</span> <span class="name">v_color</span><span class="punctuation">;</span>

<span class="keyword type">void</span> <span class="name">main</span><span class="punctuation">()</span>
<span class="punctuation">{</span>
    <span class="name builtin">gl_FragColor</span> <span class="operator">=</span> <span class="name">v_color</span><span class="punctuation">;</span>
<span class="punctuation">}</span>
</pre>
<p>The question is what is the value of <code>v_color</code> inside the fragment shader ?
If you look at the figure that introduced the gl pipeline, we have 3 vertices
and 21 fragments. What is the color of each individual fragment ?</p>
<p>The answer is <em>the interpolation of all 3 vertices color</em>. This interpolation
is made using the distance of the fragment to each individual vertex. This is a
very important concept to understand. Any varying value is interpolated between
the vertices that compose the elementary item (mostly, line or triangle).</p>
<p>Ok, enough for now, we'll see an explicit example in the next chapter.</p>
</div>
</div>
<div class="section" id="state-of-the-union">
<h2><a class="toc-backref" href="#id5">State of the union</a></h2>
<p>Last, but not least, we need to access the OpenGL library from within Python
and we have mostly two solutions at our disposal. Either we use pure bindings
and we have to program everything (see next chapter) or we use an engine that
provides a lot of convenient functions that ease the development. We'll first
use the PyOpenGL bindings before using the <a class="reference external" href="http://glumpy.github.io">glumpy</a> library that offers a tight
integration with numpy.</p>
<div class="section" id="bindings">
<h3><a class="toc-backref" href="#id5">Bindings</a></h3>
<ul class="simple">
<li><a class="reference external" href="https://bitbucket.org/pyglet/pyglet/wiki/Home">Pyglet</a> is a pure python cross-platform application framework intended for
game development. It supports windowing, user interface event handling,
OpenGL graphics, loading images and videos and playing sounds and music. It
works on Windows, OS X and Linux.</li>
<li><a class="reference external" href="http://pyopengl.sourceforge.net">PyOpenGL</a> is the most common cross platform Python binding to OpenGL and
related APIs. The binding is created using the standard ctypes library, and
is provided under an extremely liberal BSD-style Open-Source license.</li>
<li><a class="reference external" href="https://moderngl.readthedocs.io/en/stable/">ModernGL</a> is a wrapper over OpenGL that simplifies the creation of simple
graphics applications like scientific simulations, small games or user
interfaces. Usually, acquiring in-depth knowledge of OpenGL requires a steep
learning curve. In contrast, ModernGL is easy to learn and use, moreover it
is capable of rendering with the same performance and quality, with less code
written.</li>
<li><a class="reference external" href="https://docs.python.org/3/library/ctypes.html">Ctypes</a> bindings can also be generated quite easily thanks to the <a class="reference external" href="https://github.com/KhronosGroup/OpenGL-Registry/blob/master/xml/gl.xml">gl.xml</a>
file provided by the Khronos group that defines the OpenGL and OpenGL API
Registry. The number of functions and constants given in the table above have
been computed using the <a class="reference external" href="code/chapter-02/registry.py">code/chapter-02/registry.py</a> program that parses
the gl.xml file for each API and version and count the relevant features.</li>
</ul>
</div>
<div class="section" id="engines">
<h3><a class="toc-backref" href="#id5">Engines</a></h3>
<ul class="simple">
<li>The Visualization Toolkit (<a class="reference external" href="http://www.vtk.org">VTK</a>) is an open-source, freely available
software system for 3D computer graphics, image processing, and
visualization. It consists of a C++ class library and several interpreted
interface layers including Tcl/Tk, Java, and Python.</li>
<li><a class="reference external" href="http://py.processing.org">Processing</a> is a programming language, development environment, and online
community. Since 2001, Processing has promoted software literacy within the
visual arts and visual literacy within technology. Today, there are tens of
thousands of students, artists, designers, researchers, and hobbyists who use
Processing for learning, prototyping, and production.</li>
<li><a class="reference external" href="http://www.cityinabottle.org/nodebox/">NodeBox</a> for OpenGL is a free, cross-platform library for generating 2D
animations with Python programming code. It is built on Pyglet and adopts the
drawing API from NodeBox for Mac OS X. It has built-in support for paths,
layers, motion tweening, hardware-accelerated image effects, simple physics
and interactivity.</li>
<li><a class="reference external" href="http://www.panda3d.org/">Panda3D</a> is a 3D engine: a library of subroutines for 3D rendering and game
development. The library is C++ with a set of Python bindings. Game
development with Panda3D usually consists of writing a Python or C++ program
that controls the Panda3D library.</li>
<li><a class="reference external" href="http://vpython.org">VPython</a> makes it easy to create navigable 3D displays and animations, even
for those with limited programming experience. Because it is based on Python,
it also has much to offer for experienced programmers and researchers.</li>
</ul>
</div>
<div class="section" id="libraries">
<h3><a class="toc-backref" href="#id5">Libraries</a></h3>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Even though glumpy and vispy share a number of concepts, they are different.
vispy offers a high-level interface that may be convenient in some
situations but this tends to hide the internal machinery. This is one of the
reasons we'll be using glumpy instead (the other reason being that I'm the
author of glumpy (and one of the authors of vispy as well in fact)).</p>
</div>
<ul class="simple">
<li><a class="reference external" href="http://glumpy.github.io">Glumpy</a> is a python library for scientific visualization that is both fast,
scalable and beautiful. Glumpy leverages the computational power of modern
Graphics Processing Units (GPUs) through the OpenGL library to display very
large datasets and offers an intuitive interface between numpy and modern
OpenGL. We'll use it extensively in this book.</li>
<li><a class="reference external" href="http://vispy.org">Vispy</a> is the sister project of glumpy. It is a high-performance
interactive 2D/3D data visualization library and offer a high-level interface
for scientific visualization. The difference between glumpy and vispy is
approximately the same as the difference between numpy and scipy even though
vispy is independent of glumpy and vice-versa.</li>
</ul>
<!-- - - - Links - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -->
<!-- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -->
</div>
</div>
</div>
<div class="section" id="quickstart">
<h1><a class="toc-backref" href="#contents">Quickstart</a></h1>
<div class="contents toc chapter-03 local topic" id="id7">
<p class="topic-title first">.</p>
<ul class="simple">
<li><a class="reference internal" href="#preliminaries" id="id138">Preliminaries</a><ul>
<li><a class="reference internal" href="#normalize-device-coordinates" id="id139">Normalize Device Coordinates</a></li>
<li><a class="reference internal" href="#triangulation" id="id140">Triangulation</a></li>
<li><a class="reference internal" href="#gl-primitives" id="id141">GL Primitives</a></li>
<li><a class="reference internal" href="#interpolation" id="id142">Interpolation</a></li>
</ul>
</li>
<li><a class="reference internal" href="#the-hard-way" id="id143">The hard way</a><ul>
<li><a class="reference internal" href="#writing-shaders" id="id144">Writing shaders</a></li>
<li><a class="reference internal" href="#compiling-the-program" id="id145">Compiling the program</a></li>
<li><a class="reference internal" href="#uploading-data-to-the-gpu" id="id146">Uploading data to the GPU</a></li>
<li><a class="reference internal" href="#rendering" id="id147">Rendering</a></li>
<li><a class="reference internal" href="#uniform-color" id="id148">Uniform color</a></li>
<li><a class="reference internal" href="#varying-color" id="id149">Varying color</a></li>
</ul>
</li>
<li><a class="reference internal" href="#the-easy-way" id="id150">The easy way</a><ul>
<li><a class="reference internal" href="#id9" id="id151">Uniform color</a></li>
<li><a class="reference internal" href="#id10" id="id152">Varying color</a></li>
</ul>
</li>
<li><a class="reference internal" href="#exercises" id="id153">Exercises</a></li>
</ul>
</div>
<p>For the <strong>really</strong> impatient, you can try to run the code in the <a class="reference external" href="code/chapter-03/glumpy-quad-solid.py">teaser image</a> above. If this works, a window should
open on your desktop with a red color in the background. If you now want to
understand how this works, you'll have to read the text below.</p>
<div class="section" id="preliminaries">
<h2><a class="toc-backref" href="#id7">Preliminaries</a></h2>
<p>The main difficulty for newcomers in programming modern OpenGL is that it
requires to understand a lot of different concepts at once and then, to perform
a lot of operations before rendering anything on screen. This complexity
implies that there are many places where your code can be wrong, both at the
conceptual and code level. To illustrate this difficulty, we'll program our
first OpenGL program using the raw interface and our goal is to display a
simple colored quad (i.e. a red square).</p>
<div class="section" id="normalize-device-coordinates">
<h3><a class="toc-backref" href="#id7">Normalize Device Coordinates</a></h3>
<div class="right figure" id="figure-images/chapter-03/NDC.png" style="width: 40%">
<img alt="images/chapter-03/NDC.png" src="images/chapter-03/NDC.png" />
<p class="caption">Figure</p>
<div class="legend">
Normalized Device Coordinates (NDC) where bottom-left corner coordinate is
(-1,-1) and top-right corner is (+1,+1).</div>
</div>
<p>Before even diving into actual code, it is important to understand first how
OpenGL handles coordinates. More precisely, OpenGL considers only coordinates
<code>(x,y,z)</code> that fall into the space where <code>-1 ≤ x,y,z ≤ +1</code>. Any coordinates
that are outside this range will be discarded or clipped (i.e. won't be visible
on screen). This is called Normalized Device Coordinates, or NDC for short.
This is something you cannot change because it is part of the OpenGL API and
implemented in your hardware (GPU). Consequently, even if you intend to render
the whole universe, you'll have utlimately to fit it into this small volume.</p>
<p>The second important fact to know is that <strong>x</strong> coordinates increase from left
to right and <strong>y</strong> coordinates increase from bottom to top. For this latter
one, it is noticeably different from the usual convention and this might induce
some problems, especially when you're dealing with the mouse pointer whose
<strong>y</strong> coordinate goes the other way around.</p>
</div>
<div class="section" id="triangulation">
<h3><a class="toc-backref" href="#id7">Triangulation</a></h3>
<div class="right figure" id="figure-images/chapter-03/triangulation.png" style="width: 35%">
<img alt="images/chapter-03/triangulation.png" src="images/chapter-03/triangulation.png" />
<p class="caption">Figure</p>
<div class="legend">
Different triangulation of the same quad using from 2 to 5 triangles.</div>
</div>
<p><a class="reference external" href="https://en.wikipedia.org/wiki/Surface_triangulation">Triangulation</a> of a
surface means to find a set of triangles, which covers a given surface. This
can be a tedious process but fortunately, there exist many different methods
and algorithms to perform such triangulation automatically for any 2D or 3D
surface. The quality of the triangulation is measured in terms of the closeness
to the approximated surface, the number of triangles necessary (the smaller,
the better) and the homogeneity of the triangles (we prefer to have triangles
that have more or less the same size and to not have any degenerated triangle).</p>
<p>In our case, we want to render a square and we need to find the proper
triangulation (which is not unique as illustrated on the figure). Since we want
to minimize the number of triangles, we'll use the 2 triangles solution that
requires only 4 (shared) vertices corresponding to the four corners of the
quad. However, you can see from the figure that we could have used different
triangulations using more vertices, and later in this book we will just do that
(but for a reason).</p>
<p>Considering the NDC, our quad will thus be composed of two triangles:</p>
<ul class="simple">
<li>One triangle described by vertices <code>(-1,+1), (+1,+1), (-1,-1)</code></li>
<li>One triangle described by vertices <code>(+1,+1), (-1,-1), (+1,-1)</code></li>
</ul>
<p>Here we can see that vertices <code>(-1,-1)</code> and <code>(+1,+1)</code> are common to both triangles. So instead of using 6 vertices to describe the two triangles, we can
re-use the common vertices to describe the whole quad. Let's name them:</p>
<ul class="simple">
<li><code>V₀</code>: <code>(-1,+1)</code></li>
<li><code>V₁</code>: <code>(+1,+1)</code></li>
<li><code>V₂</code>: <code>(-1,-1)</code></li>
<li><code>V₃</code>: <code>(+1,-1)</code></li>
</ul>
<p>Our quad can now be using triangle <code>(V₀,V₁,V₂)</code> and triangle <code>(V₁,V₂,V₃)</code>. This
is exactly what we need to tell OpenGL.</p>
</div>
<div class="section" id="gl-primitives">
<h3><a class="toc-backref" href="#id7">GL Primitives</a></h3>
<div class="right figure" id="figure-images/chapter-03/gl-primitives.png" style="width: 40%">
<img alt="images/chapter-03/gl-primitives.png" src="images/chapter-03/gl-primitives.png" />
<p class="caption">Figure</p>
<div class="legend">
Common OpenGL rendering primitives.</div>
</div>
<p>Ok, now things are getting serious because we need to actually tell OpenGL what
to do with the vertices, i.e. how to render them? What do they describe in terms
of geometrical primitives? This is quite an important topic since this will
determine how fragments will actually be generated as illustrated on the image
below:</p>
<p>Mostly, OpenGL knows how to draw (ugly) points, (ugly) lines and (ugly)
triangles. For lines and triangles, there exist some variations depending if
you want to specify very precisely what to draw or if you can take advantage of
some implicit assumptions. Let's consider lines first for example. Given a set
of four vertices <code>(V₀,V₁,V₂,V₃)</code>, you migh want to draw segments
<code>(V₀,V₁)``(V₂,V₃)</code> using <code>GL_LINES</code> or a broken line <code>(V₀,V₁,V₂,V₃)</code> using
using <code>GL_LINE_STRIP</code> or a closed broken line <code>(V₀,V₁,V₂,V₃,V₀,)</code> using
<code>GL_LINE_LOOP</code>. For triangles, you have the choices of specifying each triangle
individually using <code>GL_TRIANGLES</code> or you can tell OpenGL that triangles follow
an implicit structure using <code>GL_TRIANGLE_STRIP</code>. For example, considering a set
of vertices (Vᵢ), <code>GL_TRIANGLE_STRIP</code> will produce triangles <code>(Vᵢ,Vᵢ₊₁,Vᵢ₊₂)</code>.
There exist other primitives but we won't used them in this book because
they're mainly related to <em>geometry shaders</em> that are not introduced.</p>
<p>If you remember the previous section where we explained that our quad can be
described using using triangle <code>(V₀,V₁,V₂)</code> and triangle <code>(V₁,V₂,V₃)</code>, you can
now realize that we can take advantage or the <code>GL_TRIANGLE_STRIP</code> primitive
because we took care of describing the two triangles following this implicit
structure.</p>
</div>
<div class="section" id="interpolation">
<h3><a class="toc-backref" href="#id7">Interpolation</a></h3>
<div class="right figure" id="figure-images/chapter-03/interpolation.png" style="width: 40%">
<img alt="images/chapter-03/interpolation.png" src="images/chapter-03/interpolation.png" />
<p class="caption">Figure</p>
<div class="legend">
The Barycentric interpolation <code>f</code> of a fragment <code>p</code> is given by <code>f = 𝛌₁f₁ +
𝛌₂f₂ + 𝛌₃f₃</code></div>
</div>
<p>The choice of the triangle as the only surface primitive is not an arbitrary
choice, because a triangle offers the possibility of having a nice and intuitive
interpolation of any point that is inside the triangle. If you look back at
the graphic pipeline as it has been introduced in the <a class="reference internal" href="#modern-opengl">Modern OpenGL</a> section,
you can see that the rasterisation requires for OpenGL to generate fragments
inside the triangle but also to interpolate values (colors on the figure). One
of the legitimate questions to be solved is then: if I have a triangle
(V₁,V₂,V₃), each summit vertex having (for example) a different color, what is
the color of a fragment <code>p</code> inside the triangle? The answer is <a class="reference external" href="https://en.wikibooks.org/wiki/GLSL_Programming/Rasterization">barycentric
interpolation</a>
as illustrated on the figure on the right.</p>
<p>More precisely, for any point p inside a triangle <code>A = (V₁,V₂,V₃)</code>, we consider
triangles:</p>
<ul class="simple">
<li><code>A₁ = (P,V₂,V₃)</code></li>
<li><code>A₂ = (P,V₁,V₃)</code></li>
<li><code>A₃ = (P,V₁,V₂)</code></li>
</ul>
<p>And we can define (using area of triangles):</p>
<ul class="simple">
<li><code>𝛌₁ = A₁/A</code></li>
<li><code>𝛌₂ = A₂/A</code></li>
<li><code>𝛌₃ = A₃/A</code></li>
</ul>
<p>Now, if we attach a value <code>f₁</code> to vertex <code>V₁</code>, <code>f₂</code> to vertex <code>V₂</code> and <code>f₃</code> to
vertex <code>V₃</code>, the interpolated value <code>f</code> of <code>p</code> is given by: <code>f = 𝛌₁f₁ + 𝛌₂f₂ +
𝛌₃f₃</code> You can check by yourself that if the point <code>p</code> is on a border of the
triangle, the resulting interpolated value <code>f</code> is the linear interpolation of
the two vertices defining the segment the point <code>p</code> belongs to.</p>
<p>This <strong>barycentric interpolation is important to understand</strong> even if it is done
automatically by OpenGL (with some variation to take projection into
account). We took the example of colors, but the same interpolation scheme
holds true for any value you pass from the vertex shader to the fragment
shader. And this property will be used and abused in this book.</p>
</div>
</div>
<div class="section" id="the-hard-way">
<h2><a class="toc-backref" href="#id7">The hard way</a></h2>
<p>Having reviewed some important OpenGL concepts, it's time to code our quad
example. But, before even using OpenGL, we need to open a window with a valid GL
context. This can be done using a toolkit such as <a class="reference external" href="https://www.gtk.org">Gtk</a>, <a class="reference external" href="https://www.qt.io">Qt</a> or <a class="reference external" href="https://www.wxwidgets.org">Wx</a> or any native
toolkit (Windows, Linux, OSX). Unfortunately, the <a class="reference external" href="https://docs.python.org/3/library/tk.html">Tk</a> Python interface does not
allow to create a GL context and we cannot use it. Note there also exists
dedicated toolkits such as <a class="reference external" href="http://www.glfw.org">GLFW</a> or <a class="reference external" href="http://freeglut.sourceforge.net">GLUT</a> and the advantage of GLUT is that
it's already installed alongside OpenGL. Even if it is now deprecated, we'll
use GLUT since it's a very lightweight toolkit and does not require any extra
package. Here is a minimal setup that should open a window with a black background.</p>
<pre class="code python literal-block">
<span class="keyword namespace">import</span> <span class="name namespace">sys</span>
<span class="keyword namespace">import</span> <span class="name namespace">OpenGL.GL</span> <span class="keyword namespace">as</span> <span class="name namespace">gl</span>
<span class="keyword namespace">import</span> <span class="name namespace">OpenGL.GLUT</span> <span class="keyword namespace">as</span> <span class="name namespace">glut</span>

<span class="keyword">def</span> <span class="name function">display</span><span class="punctuation">():</span>
    <span class="name">gl</span><span class="operator">.</span><span class="name">glClear</span><span class="punctuation">(</span><span class="name">gl</span><span class="operator">.</span><span class="name">GL_COLOR_BUFFER_BIT</span><span class="punctuation">)</span>
    <span class="name">glut</span><span class="operator">.</span><span class="name">glutSwapBuffers</span><span class="punctuation">()</span>

<span class="keyword">def</span> <span class="name function">reshape</span><span class="punctuation">(</span><span class="name">width</span><span class="punctuation">,</span><span class="name">height</span><span class="punctuation">):</span>
    <span class="name">gl</span><span class="operator">.</span><span class="name">glViewport</span><span class="punctuation">(</span><span class="literal number integer">0</span><span class="punctuation">,</span> <span class="literal number integer">0</span><span class="punctuation">,</span> <span class="name">width</span><span class="punctuation">,</span> <span class="name">height</span><span class="punctuation">)</span>

<span class="keyword">def</span> <span class="name function">keyboard</span><span class="punctuation">(</span> <span class="name">key</span><span class="punctuation">,</span> <span class="name">x</span><span class="punctuation">,</span> <span class="name">y</span> <span class="punctuation">):</span>
    <span class="keyword">if</span> <span class="name">key</span> <span class="operator">==</span> <span class="literal string affix">b</span><span class="literal string single">'</span><span class="literal string escape">\x1b</span><span class="literal string single">'</span><span class="punctuation">:</span>
        <span class="name">sys</span><span class="operator">.</span><span class="name">exit</span><span class="punctuation">(</span> <span class="punctuation">)</span>

<span class="name">glut</span><span class="operator">.</span><span class="name">glutInit</span><span class="punctuation">()</span>
<span class="name">glut</span><span class="operator">.</span><span class="name">glutInitDisplayMode</span><span class="punctuation">(</span><span class="name">glut</span><span class="operator">.</span><span class="name">GLUT_DOUBLE</span> <span class="operator">|</span> <span class="name">glut</span><span class="operator">.</span><span class="name">GLUT_RGBA</span><span class="punctuation">)</span>
<span class="name">glut</span><span class="operator">.</span><span class="name">glutCreateWindow</span><span class="punctuation">(</span><span class="literal string single">'Hello world!'</span><span class="punctuation">)</span>
<span class="name">glut</span><span class="operator">.</span><span class="name">glutReshapeWindow</span><span class="punctuation">(</span><span class="literal number integer">512</span><span class="punctuation">,</span><span class="literal number integer">512</span><span class="punctuation">)</span>
<span class="name">glut</span><span class="operator">.</span><span class="name">glutReshapeFunc</span><span class="punctuation">(</span><span class="name">reshape</span><span class="punctuation">)</span>
<span class="name">glut</span><span class="operator">.</span><span class="name">glutDisplayFunc</span><span class="punctuation">(</span><span class="name">display</span><span class="punctuation">)</span>
<span class="name">glut</span><span class="operator">.</span><span class="name">glutKeyboardFunc</span><span class="punctuation">(</span><span class="name">keyboard</span><span class="punctuation">)</span>
<span class="name">glut</span><span class="operator">.</span><span class="name">glutMainLoop</span><span class="punctuation">()</span>
</pre>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">You won't have access to any GL command before the <code>glutInit()</code> has been
executed because no OpenGL context will be available before this command is
executed.</p>
</div>
<p>The <code>glutInitDisplayMode</code> tells OpenGL what are the GL context properties. At
this stage, we only need a swap buffer (we draw on one buffer while the other
is displayed) and we use a full RGBA 32 bits color buffer (8 bits per channel).
The <code>reshape</code> callback informs OpenGL of the new window size while the
<code>display</code> method tells OpenGL what to do when a redraw is needed. In this
simple case, we just ask OpenGL to swap buffers (this avoids flickering).
Finally, the keyboard callback allows us to exit by pressing the <code>Escape</code> key.</p>
<div class="section" id="writing-shaders">
<h3><a class="toc-backref" href="#id7">Writing shaders</a></h3>
<p>Now that your window has been created, we can start writing our program, that
is, we need to write a vertex and a fragment shader. For the vertex shader, the
code is very simple because we took care of using the normalized device
coordinates to describe our quad in the previous section. This means vertices
do not need to be transformed.  Nonetheless, we have to take care of sending 4D
coordinates even though we'll transmit only 2D coordinates (<code>x,y</code>) or the final
result will be undefined. For coordinate <code>z</code> we'll just set it to <code>0.0</code> (but
any value would do) and for coordinate <code>w</code>, we set it to <code>1.0</code> (see section
<a class="reference internal" href="#basic-mathematics">Basic Mathematics</a> for the explanation). Note also the (commented)
alternative ways of writing the shader.</p>
<pre class="code glsl literal-block">
<span class="keyword">attribute</span> <span class="keyword type">vec2</span> <span class="name">position</span><span class="punctuation">;</span>
<span class="keyword type">void</span> <span class="name">main</span><span class="punctuation">()</span>
<span class="punctuation">{</span>
  <span class="name builtin">gl_Position</span> <span class="operator">=</span> <span class="keyword type">vec4</span><span class="punctuation">(</span><span class="name">position</span><span class="punctuation">,</span> <span class="literal number float">0.0</span><span class="punctuation">,</span> <span class="literal number float">1.0</span><span class="punctuation">);</span>

  <span class="comment single">// or gl_Position.xyzw = vec4(position, 0.0, 1.0);</span>

  <span class="comment single">// or gl_Position.xy = position;</span>
  <span class="comment single">//    gl_Position.zw = vec2(0.0, 1.0);</span>

  <span class="comment single">// or gl_Position.x = position.x;</span>
  <span class="comment single">//    gl_Position.y = position.y;</span>
  <span class="comment single">//    gl_Position.z = 0.0;</span>
  <span class="comment single">//    gl_Position.w = 1.0;</span>
<span class="punctuation">}</span>
</pre>
<p>For the fragment shader, it is even simpler. We set the color to red which is
described by the tuple <code>(1.0, 0.0, 0.0, 1.0)</code> in normalized RGBA
notation. <code>1.0</code> for alpha channel means fully opaque.</p>
<pre class="code glsl literal-block">
<span class="keyword type">void</span> <span class="name">main</span><span class="punctuation">()</span>
<span class="punctuation">{</span>
  <span class="name builtin">gl_FragColor</span> <span class="operator">=</span> <span class="keyword type">vec4</span><span class="punctuation">(</span><span class="literal number float">1.0</span><span class="punctuation">,</span> <span class="literal number float">0.0</span><span class="punctuation">,</span> <span class="literal number float">0.0</span><span class="punctuation">,</span> <span class="literal number float">1.0</span><span class="punctuation">);</span>

  <span class="comment single">// or gl_FragColor.rgba = vec4(1.0, 0.0, 0.0, 1.0);</span>

  <span class="comment single">// or gl_FragColor.rgb = vec3(1.0, 0.0, 0.0);</span>
  <span class="comment single">//    gl_FragColor.a = 1.0;</span>
<span class="punctuation">}</span>
</pre>
</div>
<div class="section" id="compiling-the-program">
<h3><a class="toc-backref" href="#id7">Compiling the program</a></h3>
<p>We wrote our shader and we need now to build a program that will link the
vertex and the fragment shader together. Building such program is relatively
straightforward (provided we do not check for errors). First we need to request
program and shader slots from the GPU:</p>
<pre class="code python literal-block">
<span class="name">program</span>  <span class="operator">=</span> <span class="name">gl</span><span class="operator">.</span><span class="name">glCreateProgram</span><span class="punctuation">()</span>
<span class="name">vertex</span>   <span class="operator">=</span> <span class="name">gl</span><span class="operator">.</span><span class="name">glCreateShader</span><span class="punctuation">(</span><span class="name">gl</span><span class="operator">.</span><span class="name">GL_VERTEX_SHADER</span><span class="punctuation">)</span>
<span class="name">fragment</span> <span class="operator">=</span> <span class="name">gl</span><span class="operator">.</span><span class="name">glCreateShader</span><span class="punctuation">(</span><span class="name">gl</span><span class="operator">.</span><span class="name">GL_FRAGMENT_SHADER</span><span class="punctuation">)</span>
</pre>
<p>We can now ask for the compilation of our shaders into GPU objects and we log
for any error from the compiler (e.g. syntax error, undefined variables, etc):</p>
<pre class="code python literal-block">
<span class="name">vertex_code</span> <span class="operator">=</span> <span class="literal string double">&quot;&quot;&quot;
  attribute vec2 position;
  void main() { gl_Position = vec4(position, 0.0, 1.0); } &quot;&quot;&quot;</span>

<span class="name">fragment_code</span> <span class="operator">=</span> <span class="literal string double">&quot;&quot;&quot;
  void main() { gl_FragColor = vec4(1.0, 0.0, 0.0, 1.0); } &quot;&quot;&quot;</span>

<span class="comment single"># Set shaders source</span>
<span class="name">gl</span><span class="operator">.</span><span class="name">glShaderSource</span><span class="punctuation">(</span><span class="name">vertex</span><span class="punctuation">,</span> <span class="name">vertex_code</span><span class="punctuation">)</span>
<span class="name">gl</span><span class="operator">.</span><span class="name">glShaderSource</span><span class="punctuation">(</span><span class="name">fragment</span><span class="punctuation">,</span> <span class="name">fragment_code</span><span class="punctuation">)</span>

<span class="comment single"># Compile shaders</span>
<span class="name">gl</span><span class="operator">.</span><span class="name">glCompileShader</span><span class="punctuation">(</span><span class="name">vertex</span><span class="punctuation">)</span>
<span class="keyword">if</span> <span class="operator word">not</span> <span class="name">gl</span><span class="operator">.</span><span class="name">glGetShaderiv</span><span class="punctuation">(</span><span class="name">vertex</span><span class="punctuation">,</span> <span class="name">gl</span><span class="operator">.</span><span class="name">GL_COMPILE_STATUS</span><span class="punctuation">):</span>
    <span class="name">error</span> <span class="operator">=</span> <span class="name">gl</span><span class="operator">.</span><span class="name">glGetShaderInfoLog</span><span class="punctuation">(</span><span class="name">vertex</span><span class="punctuation">)</span><span class="operator">.</span><span class="name">decode</span><span class="punctuation">()</span>
    <span class="keyword">print</span><span class="punctuation">(</span><span class="name">error</span><span class="punctuation">)</span>
    <span class="keyword">raise</span> <span class="name exception">RuntimeError</span><span class="punctuation">(</span><span class="literal string double">&quot;Vertex shader compilation error&quot;</span><span class="punctuation">)</span>

<span class="name">gl</span><span class="operator">.</span><span class="name">glCompileShader</span><span class="punctuation">(</span><span class="name">fragment</span><span class="punctuation">)</span>
<span class="keyword">if</span> <span class="operator word">not</span> <span class="name">gl</span><span class="operator">.</span><span class="name">glGetShaderiv</span><span class="punctuation">(</span><span class="name">fragment</span><span class="punctuation">,</span> <span class="name">gl</span><span class="operator">.</span><span class="name">GL_COMPILE_STATUS</span><span class="punctuation">):</span>
    <span class="name">error</span> <span class="operator">=</span> <span class="name">gl</span><span class="operator">.</span><span class="name">glGetShaderInfoLog</span><span class="punctuation">(</span><span class="name">fragment</span><span class="punctuation">)</span><span class="operator">.</span><span class="name">decode</span><span class="punctuation">()</span>
    <span class="keyword">print</span><span class="punctuation">(</span><span class="name">error</span><span class="punctuation">)</span>
    <span class="keyword">raise</span> <span class="name exception">RuntimeError</span><span class="punctuation">(</span><span class="literal string double">&quot;Fragment shader compilation error&quot;</span><span class="punctuation">)</span>
</pre>
<p>Then we link our two objects in into a program and again, we check for errors
during the process.</p>
<pre class="code python literal-block">
<span class="name">gl</span><span class="operator">.</span><span class="name">glAttachShader</span><span class="punctuation">(</span><span class="name">program</span><span class="punctuation">,</span> <span class="name">vertex</span><span class="punctuation">)</span>
<span class="name">gl</span><span class="operator">.</span><span class="name">glAttachShader</span><span class="punctuation">(</span><span class="name">program</span><span class="punctuation">,</span> <span class="name">fragment</span><span class="punctuation">)</span>
<span class="name">gl</span><span class="operator">.</span><span class="name">glLinkProgram</span><span class="punctuation">(</span><span class="name">program</span><span class="punctuation">)</span>

<span class="keyword">if</span> <span class="operator word">not</span> <span class="name">gl</span><span class="operator">.</span><span class="name">glGetProgramiv</span><span class="punctuation">(</span><span class="name">program</span><span class="punctuation">,</span> <span class="name">gl</span><span class="operator">.</span><span class="name">GL_LINK_STATUS</span><span class="punctuation">):</span>
    <span class="keyword">print</span><span class="punctuation">(</span><span class="name">gl</span><span class="operator">.</span><span class="name">glGetProgramInfoLog</span><span class="punctuation">(</span><span class="name">program</span><span class="punctuation">))</span>
    <span class="keyword">raise</span> <span class="name exception">RuntimeError</span><span class="punctuation">(</span><span class="literal string single">'Linking error'</span><span class="punctuation">)</span>
</pre>
<p>and we can get rid of the shaders, they won't be used again (you can think of
them as <code>.o</code> files in C).</p>
<pre class="code python literal-block">
<span class="name">gl</span><span class="operator">.</span><span class="name">glDetachShader</span><span class="punctuation">(</span><span class="name">program</span><span class="punctuation">,</span> <span class="name">vertex</span><span class="punctuation">)</span>
<span class="name">gl</span><span class="operator">.</span><span class="name">glDetachShader</span><span class="punctuation">(</span><span class="name">program</span><span class="punctuation">,</span> <span class="name">fragment</span><span class="punctuation">)</span>
</pre>
<p>Finally, we make program the default program to be ran. We can do it now
because we'll use a single program in this example:</p>
<pre class="code python literal-block">
<span class="name">gl</span><span class="operator">.</span><span class="name">glUseProgram</span><span class="punctuation">(</span><span class="name">program</span><span class="punctuation">)</span>
</pre>
</div>
<div class="section" id="uploading-data-to-the-gpu">
<h3><a class="toc-backref" href="#id7">Uploading data to the GPU</a></h3>
<p>Next, we need to build CPU data and the corresponding GPU buffer that will hold
a copy of the CPU data (GPU cannot access CPU memory). In Python, things are
grealty facilitated by NumPy that allows to have a precise control over number
representations. This is important because GLES 2.0 floats have to be exactly
32 bits long and a regular Python float would not work (they are actually
equivalent to a C <code>double</code>). So let us specify a NumPy array holding 4×2
32-bits float that will correspond to our 4×(x,y) vertices:</p>
<pre class="code python literal-block">
<span class="comment single"># Build data</span>
<span class="name">data</span> <span class="operator">=</span> <span class="name">np</span><span class="operator">.</span><span class="name">zeros</span><span class="punctuation">((</span><span class="literal number integer">4</span><span class="punctuation">,</span><span class="literal number integer">2</span><span class="punctuation">),</span> <span class="name">dtype</span><span class="operator">=</span><span class="name">np</span><span class="operator">.</span><span class="name">float32</span><span class="punctuation">)</span>
</pre>
<p>We then create a placeholder on the GPU without yet specifying the size:</p>
<pre class="code python literal-block">
<span class="comment single"># Request a buffer slot from GPU</span>
<span class="name builtin">buffer</span> <span class="operator">=</span> <span class="name">gl</span><span class="operator">.</span><span class="name">glGenBuffers</span><span class="punctuation">(</span><span class="literal number integer">1</span><span class="punctuation">)</span>

<span class="comment single"># Make this buffer the default one</span>
<span class="name">gl</span><span class="operator">.</span><span class="name">glBindBuffer</span><span class="punctuation">(</span><span class="name">gl</span><span class="operator">.</span><span class="name">GL_ARRAY_BUFFER</span><span class="punctuation">,</span> <span class="name builtin">buffer</span><span class="punctuation">)</span>
</pre>
<p>We now need to bind the buffer to the program, that is, for each attribute
present in the vertex shader program, we need to tell OpenGL where to find the
corresponding data (i.e. GPU buffer) and this requires some computations. More
precisely, we need to tell the GPU how to read the buffer in order to bind each
value to the relevant attribute. To do this, GPU needs to know what is the
stride between 2 consecutive elements and what is the offset to read one
attribute:</p>
<pre class="code neutral literal-block">
                 1ˢᵗ vertex  2ⁿᵈ vertex  3ʳᵈ vertex   …
                ┌───────────┬───────────┬───────────┬┄┄
                ┌─────┬─────┬─────┬─────┬─────┬─────┬─┄
                │  X  │  Y  │  X  │  Y  │  X  │  Y  │ …
                └─────┴─────┴─────┴─────┴─────┴─────┴─┄
     offset 0 → │ (x,y)     └───────────┘
                                stride
</pre>
<p>In our simple quad scenario, this is relatively easy to write because we have a
single attribute (&quot;<code>position</code>&quot;). We first require the attribute location
inside the program and then we bind the buffer with the relevant offset.</p>
<pre class="code python literal-block">
<span class="name">stride</span> <span class="operator">=</span> <span class="name">data</span><span class="operator">.</span><span class="name">strides</span><span class="punctuation">[</span><span class="literal number integer">0</span><span class="punctuation">]</span>

<span class="name">offset</span> <span class="operator">=</span> <span class="name">ctypes</span><span class="operator">.</span><span class="name">c_void_p</span><span class="punctuation">(</span><span class="literal number integer">0</span><span class="punctuation">)</span>
<span class="name">loc</span> <span class="operator">=</span> <span class="name">gl</span><span class="operator">.</span><span class="name">glGetAttribLocation</span><span class="punctuation">(</span><span class="name">program</span><span class="punctuation">,</span> <span class="literal string double">&quot;position&quot;</span><span class="punctuation">)</span>
<span class="name">gl</span><span class="operator">.</span><span class="name">glEnableVertexAttribArray</span><span class="punctuation">(</span><span class="name">loc</span><span class="punctuation">)</span>
<span class="name">gl</span><span class="operator">.</span><span class="name">glBindBuffer</span><span class="punctuation">(</span><span class="name">gl</span><span class="operator">.</span><span class="name">GL_ARRAY_BUFFER</span><span class="punctuation">,</span> <span class="name builtin">buffer</span><span class="punctuation">)</span>
<span class="name">gl</span><span class="operator">.</span><span class="name">glVertexAttribPointer</span><span class="punctuation">(</span><span class="name">loc</span><span class="punctuation">,</span> <span class="literal number integer">2</span><span class="punctuation">,</span> <span class="name">gl</span><span class="operator">.</span><span class="name">GL_FLOAT</span><span class="punctuation">,</span> <span class="name builtin pseudo">False</span><span class="punctuation">,</span> <span class="name">stride</span><span class="punctuation">,</span> <span class="name">offset</span><span class="punctuation">)</span>
</pre>
<p>We're basically telling the program how to bind data to the relevant
attribute. This is made by providing the stride of the array (how many bytes
between each record) and the offset of a given attribute.</p>
<p>Let's now fill our CPU data and upload it to the newly created GPU buffer:</p>
<pre class="code python literal-block">
<span class="comment single"># Assign CPU data</span>
<span class="name">data</span><span class="punctuation">[</span><span class="operator">...</span><span class="punctuation">]</span> <span class="operator">=</span> <span class="punctuation">(</span><span class="operator">-</span><span class="literal number integer">1</span><span class="punctuation">,</span><span class="operator">+</span><span class="literal number integer">1</span><span class="punctuation">),</span> <span class="punctuation">(</span><span class="operator">+</span><span class="literal number integer">1</span><span class="punctuation">,</span><span class="operator">+</span><span class="literal number integer">1</span><span class="punctuation">),</span> <span class="punctuation">(</span><span class="operator">-</span><span class="literal number integer">1</span><span class="punctuation">,</span><span class="operator">-</span><span class="literal number integer">1</span><span class="punctuation">),</span> <span class="punctuation">(</span><span class="operator">+</span><span class="literal number integer">1</span><span class="punctuation">,</span><span class="operator">-</span><span class="literal number integer">1</span><span class="punctuation">)</span>

<span class="comment single"># Upload CPU data to GPU buffer</span>
<span class="name">gl</span><span class="operator">.</span><span class="name">glBufferData</span><span class="punctuation">(</span><span class="name">gl</span><span class="operator">.</span><span class="name">GL_ARRAY_BUFFER</span><span class="punctuation">,</span> <span class="name">data</span><span class="operator">.</span><span class="name">nbytes</span><span class="punctuation">,</span> <span class="name">data</span><span class="punctuation">,</span> <span class="name">gl</span><span class="operator">.</span><span class="name">GL_DYNAMIC_DRAW</span><span class="punctuation">)</span>
</pre>
</div>
<div class="section" id="rendering">
<h3><a class="toc-backref" href="#id7">Rendering</a></h3>
<p>We're done, we can now rewrite the display function:</p>
<pre class="code python literal-block">
<span class="keyword">def</span> <span class="name function">display</span><span class="punctuation">():</span>
    <span class="name">gl</span><span class="operator">.</span><span class="name">glClear</span><span class="punctuation">(</span><span class="name">gl</span><span class="operator">.</span><span class="name">GL_COLOR_BUFFER_BIT</span><span class="punctuation">)</span>
    <span class="name">gl</span><span class="operator">.</span><span class="name">glDrawArrays</span><span class="punctuation">(</span><span class="name">gl</span><span class="operator">.</span><span class="name">GL_TRIANGLE_STRIP</span><span class="punctuation">,</span> <span class="literal number integer">0</span><span class="punctuation">,</span> <span class="literal number integer">4</span><span class="punctuation">)</span>
    <span class="name">glut</span><span class="operator">.</span><span class="name">glutSwapBuffers</span><span class="punctuation">()</span>
</pre>
<div class="right figure" id="figure-images/chapter-03/glumpy-quad-solid.png" style="width: 30%">
<img alt="images/chapter-03/glumpy-quad-solid.png" src="images/chapter-03/glumpy-quad-solid.png" />
<p class="caption">Figure</p>
<div class="legend">
A red quad rendered using Python, raw OpenGL bindings and the venerable
GLUT.</div>
</div>
<p>The <code>0,4</code> arguments in the <code>glDrawArrays</code> tells OpenGL we want to display 4
vertices from our current active buffer and we start at vertex 0. You should
obtain the figure on the right with the same red (boring) color. The whole
source ia available from <a class="reference external" href="code/chapter-03/glut-quad-solid.py">code/chapter-03/glut-quad-solid.py</a>.</p>
<p>All these operations are necessary for displaying a single colored quad on
screen and complexity can escalate pretty badly if you add more objects,
projections, lighting, texture, etc. This is the reason why we'll stop using
the raw OpenGL interface in favor of a library. We'll use the <a class="reference external" href="http://glumpy.github.io">glumpy</a> library,
mostly because I wrote it, but also because it offers a tight integration with
numpy. Of course, you can design your own library to ease the writing of GL
Python applications.</p>
</div>
<div class="section" id="uniform-color">
<h3><a class="toc-backref" href="#id7">Uniform color</a></h3>
<div class="right figure" id="figure-images/chapter-03/glumpy-quad-uniform-color.png" style="width: 30%">
<img alt="images/chapter-03/glumpy-quad-uniform-color.png" src="images/chapter-03/glumpy-quad-uniform-color.png" />
<p class="caption">Figure</p>
<div class="legend">
A blue quad rendered using a <code>uniform</code> variable specifying the color of the
quad.</div>
</div>
<p>In the previous example, we hard-coded the red color inside the fragment shader
source code. But what if we want to change the color from within the Python
program? We could rebuild the program with the new color but that would not be
very efficient. Fortunately there is a simple solution provided by OpenGL:
<code>uniform</code>. Uniforms, unlike attributes, do not change from one vertex to the
other and this is precisely what we need in our case. We thus need to slightly
modify our fragment shader to use this uniform color:</p>
<pre class="code glsl literal-block">
<span class="keyword">uniform</span> <span class="keyword type">vec4</span> <span class="name">color</span><span class="punctuation">;</span>
<span class="keyword type">void</span> <span class="name">main</span><span class="punctuation">()</span>
<span class="punctuation">{</span>
  <span class="name builtin">gl_FragColor</span> <span class="operator">=</span> <span class="name">color</span><span class="punctuation">;</span>
<span class="punctuation">}</span>
</pre>
<p>Of course, we also need to upload a color to this new uniform location and this
is easier than for attribute because the memory has already been allocated on
the GPU (since the size is know and does not depend on the number of vertices).</p>
<pre class="code python literal-block">
<span class="name">loc</span> <span class="operator">=</span> <span class="name">gl</span><span class="operator">.</span><span class="name">glGetUniformLocation</span><span class="punctuation">(</span><span class="name">program</span><span class="punctuation">,</span> <span class="literal string double">&quot;color&quot;</span><span class="punctuation">)</span>
<span class="name">gl</span><span class="operator">.</span><span class="name">glUniform4f</span><span class="punctuation">(</span><span class="name">loc</span><span class="punctuation">,</span> <span class="literal number float">0.0</span><span class="punctuation">,</span> <span class="literal number float">0.0</span><span class="punctuation">,</span> <span class="literal number float">1.0</span><span class="punctuation">,</span> <span class="literal number float">1.0</span><span class="punctuation">)</span>
</pre>
<p>If you run the new <a class="reference external" href="code/glut-quad-uniform-color.py">code/glut-quad-uniform-color.py</a> example, you should
obtain the blue quad as shown on the right.</p>
</div>
<div class="section" id="varying-color">
<h3><a class="toc-backref" href="#id7">Varying color</a></h3>
<div class="right figure" id="figure-images/chapter-03/glumpy-quad-varying-color.png" style="width: 30%">
<img alt="images/chapter-03/glumpy-quad-varying-color.png" src="images/chapter-03/glumpy-quad-varying-color.png" />
<p class="caption">Figure</p>
<div class="legend">
A colored quad using a per-vertex color.</div>
</div>
<p>Until now, we have been using a constant color for the four vertices of our
quad and the result is (unsurprisingly) a boring uniform red or blue quad. We
can make it a bit more interesting though by assigning different colors to each
vertex and see how OpenGL will interpolate colors. Our new vertex shader would
need to be rewritten as:</p>
<pre class="code glsl literal-block">
<span class="keyword">attribute</span> <span class="keyword type">vec2</span> <span class="name">position</span><span class="punctuation">;</span>
<span class="keyword">attribute</span> <span class="keyword type">vec4</span> <span class="name">color</span><span class="punctuation">;</span>
<span class="keyword">varying</span> <span class="keyword type">vec4</span> <span class="name">v_color</span><span class="punctuation">;</span>
<span class="keyword type">void</span> <span class="name">main</span><span class="punctuation">()</span>
<span class="punctuation">{</span>
  <span class="name builtin">gl_Position</span> <span class="operator">=</span> <span class="keyword type">vec4</span><span class="punctuation">(</span><span class="name">position</span><span class="punctuation">,</span> <span class="literal number float">0.0</span><span class="punctuation">,</span> <span class="literal number float">1.0</span><span class="punctuation">);</span>
  <span class="name">v_color</span><span class="operator">=</span> <span class="name">color</span><span class="punctuation">;</span>
<span class="punctuation">}</span>
</pre>
<p>We just added our new attribute <code>color</code> but we also added a new variable type:
<code>varying</code>. This type is actually used to transmit a value from the vertex
shader to the fragment shader. As you might have guessed, the <code>varying</code> type
means this value won't be constant over the different fragments but will be
interpolated depending on the relative position of the fragment in the
triangle, as I explained in the <a class="reference internal" href="#interpolation">Interpolation</a> section. Note that we also
have to rewrite our fragment shader accordingly, but now the <code>v_color</code> will be
an input:</p>
<pre class="code glsl literal-block">
<span class="keyword">varying</span> <span class="keyword type">vec4</span> <span class="name">v_color</span><span class="punctuation">;</span>
<span class="keyword type">void</span> <span class="name">main</span><span class="punctuation">()</span>
<span class="punctuation">{</span>
  <span class="name builtin">gl_FragColor</span> <span class="operator">=</span> <span class="name">v_color</span><span class="punctuation">;</span>
<span class="punctuation">}</span>
</pre>
<p>We now need to upload vertex color to the GPU. We could create a new vertex
dedicated buffer and bind it to the new <code>color</code> attribute, but there is a more
interesting solution. We'll use instead a single numpy array and a single buffer,
taking advantage of the NumPy structured array:</p>
<pre class="code python literal-block">
<span class="name">data</span> <span class="operator">=</span> <span class="name">np</span><span class="operator">.</span><span class="name">zeros</span><span class="punctuation">(</span><span class="literal number integer">4</span><span class="punctuation">,</span> <span class="punctuation">[(</span><span class="literal string double">&quot;position&quot;</span><span class="punctuation">,</span> <span class="name">np</span><span class="operator">.</span><span class="name">float32</span><span class="punctuation">,</span> <span class="literal number integer">2</span><span class="punctuation">),</span>
                    <span class="punctuation">(</span><span class="literal string double">&quot;color&quot;</span><span class="punctuation">,</span>    <span class="name">np</span><span class="operator">.</span><span class="name">float32</span><span class="punctuation">,</span> <span class="literal number integer">4</span><span class="punctuation">)])</span>
<span class="name">data</span><span class="punctuation">[</span><span class="literal string single">'position'</span><span class="punctuation">]</span> <span class="operator">=</span> <span class="punctuation">(</span><span class="operator">-</span><span class="literal number integer">1</span><span class="punctuation">,</span><span class="operator">+</span><span class="literal number integer">1</span><span class="punctuation">),</span> <span class="punctuation">(</span><span class="operator">+</span><span class="literal number integer">1</span><span class="punctuation">,</span><span class="operator">+</span><span class="literal number integer">1</span><span class="punctuation">),</span> <span class="punctuation">(</span><span class="operator">-</span><span class="literal number integer">1</span><span class="punctuation">,</span><span class="operator">-</span><span class="literal number integer">1</span><span class="punctuation">),</span> <span class="punctuation">(</span><span class="operator">+</span><span class="literal number integer">1</span><span class="punctuation">,</span><span class="operator">-</span><span class="literal number integer">1</span><span class="punctuation">)</span>
<span class="name">data</span><span class="punctuation">[</span><span class="literal string single">'color'</span><span class="punctuation">]</span>    <span class="operator">=</span> <span class="punctuation">(</span><span class="literal number integer">0</span><span class="punctuation">,</span><span class="literal number integer">1</span><span class="punctuation">,</span><span class="literal number integer">0</span><span class="punctuation">,</span><span class="literal number integer">1</span><span class="punctuation">),</span> <span class="punctuation">(</span><span class="literal number integer">1</span><span class="punctuation">,</span><span class="literal number integer">1</span><span class="punctuation">,</span><span class="literal number integer">0</span><span class="punctuation">,</span><span class="literal number integer">1</span><span class="punctuation">),</span> <span class="punctuation">(</span><span class="literal number integer">1</span><span class="punctuation">,</span><span class="literal number integer">0</span><span class="punctuation">,</span><span class="literal number integer">0</span><span class="punctuation">,</span><span class="literal number integer">1</span><span class="punctuation">),</span> <span class="punctuation">(</span><span class="literal number integer">0</span><span class="punctuation">,</span><span class="literal number integer">0</span><span class="punctuation">,</span><span class="literal number integer">1</span><span class="punctuation">,</span><span class="literal number integer">1</span><span class="punctuation">)</span>
</pre>
<p>Our CPU data structure is thus:</p>
<pre class="code neutral literal-block">
           1ˢᵗ vertex              2ⁿᵈ vertex
   ┌───────────────────────┬───────────────────────┬┄
   ┌───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬─┄
   │ X │ Y │ R │ G │ B │ A │ X │ Y │ R │ G │ B │ A │ …
   └───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴─┄
   ↑       ↑               └───────────────────────┘
 position  color                     stride
 offset    offset
</pre>
<p>Binding the buffer is now a bit more complicated but it is made relatively easy
thanks to NumPy:</p>
<pre class="code python literal-block">
<span class="name">stride</span> <span class="operator">=</span> <span class="name">data</span><span class="operator">.</span><span class="name">strides</span><span class="punctuation">[</span><span class="literal number integer">0</span><span class="punctuation">]</span>
<span class="name">offset</span> <span class="operator">=</span> <span class="name">ctypes</span><span class="operator">.</span><span class="name">c_void_p</span><span class="punctuation">(</span><span class="literal number integer">0</span><span class="punctuation">)</span>
<span class="name">loc</span> <span class="operator">=</span> <span class="name">gl</span><span class="operator">.</span><span class="name">glGetAttribLocation</span><span class="punctuation">(</span><span class="name">program</span><span class="punctuation">,</span> <span class="literal string double">&quot;position&quot;</span><span class="punctuation">)</span>
<span class="name">gl</span><span class="operator">.</span><span class="name">glEnableVertexAttribArray</span><span class="punctuation">(</span><span class="name">loc</span><span class="punctuation">)</span>
<span class="name">gl</span><span class="operator">.</span><span class="name">glBindBuffer</span><span class="punctuation">(</span><span class="name">gl</span><span class="operator">.</span><span class="name">GL_ARRAY_BUFFER</span><span class="punctuation">,</span> <span class="name builtin">buffer</span><span class="punctuation">)</span>
<span class="name">gl</span><span class="operator">.</span><span class="name">glVertexAttribPointer</span><span class="punctuation">(</span><span class="name">loc</span><span class="punctuation">,</span> <span class="literal number integer">2</span><span class="punctuation">,</span> <span class="name">gl</span><span class="operator">.</span><span class="name">GL_FLOAT</span><span class="punctuation">,</span> <span class="name builtin pseudo">False</span><span class="punctuation">,</span> <span class="name">stride</span><span class="punctuation">,</span> <span class="name">offset</span><span class="punctuation">)</span>

<span class="name">offset</span> <span class="operator">=</span> <span class="name">ctypes</span><span class="operator">.</span><span class="name">c_void_p</span><span class="punctuation">(</span><span class="name">data</span><span class="operator">.</span><span class="name">dtype</span><span class="punctuation">[</span><span class="literal string double">&quot;position&quot;</span><span class="punctuation">]</span><span class="operator">.</span><span class="name">itemsize</span><span class="punctuation">)</span>
<span class="name">loc</span> <span class="operator">=</span> <span class="name">gl</span><span class="operator">.</span><span class="name">glGetAttribLocation</span><span class="punctuation">(</span><span class="name">program</span><span class="punctuation">,</span> <span class="literal string double">&quot;color&quot;</span><span class="punctuation">)</span>
<span class="name">gl</span><span class="operator">.</span><span class="name">glEnableVertexAttribArray</span><span class="punctuation">(</span><span class="name">loc</span><span class="punctuation">)</span>
<span class="name">gl</span><span class="operator">.</span><span class="name">glBindBuffer</span><span class="punctuation">(</span><span class="name">gl</span><span class="operator">.</span><span class="name">GL_ARRAY_BUFFER</span><span class="punctuation">,</span> <span class="name builtin">buffer</span><span class="punctuation">)</span>
<span class="name">gl</span><span class="operator">.</span><span class="name">glVertexAttribPointer</span><span class="punctuation">(</span><span class="name">loc</span><span class="punctuation">,</span> <span class="literal number integer">4</span><span class="punctuation">,</span> <span class="name">gl</span><span class="operator">.</span><span class="name">GL_FLOAT</span><span class="punctuation">,</span> <span class="name builtin pseudo">False</span><span class="punctuation">,</span> <span class="name">stride</span><span class="punctuation">,</span> <span class="name">offset</span><span class="punctuation">)</span>
</pre>
</div>
</div>
<div class="section" id="the-easy-way">
<h2><a class="toc-backref" href="#id7">The easy way</a></h2>
<p>As we've seen in the previous section, displaying a simple quad using modern GL
is quite tedious and requires a fair number of operations and this is why, from now
on, we'll use <a class="reference external" href="http://glumpy.github.io">glumpy</a> whose goal is to make this process both easy and
intuitive.</p>
<p>Glumpy is organized around three main modules:</p>
<ul class="simple">
<li>The Application layer (<code>app</code>) package is responsible for opening a window and
handling user events such as mouse and keyboard interactions.</li>
<li>The OpenGL object oriented layer (<code>gloo</code>) package is responsible for
handling shader programs and syncing CPU/GPU data through the numpy
interface.</li>
<li>The Graphic layer (<code>graphics</code>) package provides higher-level common objects
such as text, collections and widgets.</li>
</ul>
<p>Those modules will help us writing any OpenGL program quite easily. Let's
consider again our quad example:</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Glumpy will look for any available backend in a given order, starting by
<a class="reference external" href="http://www.glfw.org">GLFW</a>. I strongly advise to install the GLFW package on your system since
this backend is activately maintainted and &quot;just works&quot;.</p>
</div>
<p>We still need to open a window, but now this is straightforward:</p>
<pre class="code python literal-block">
<span class="keyword namespace">from</span> <span class="name namespace">glumpy</span> <span class="keyword namespace">import</span> <span class="name">app</span><span class="punctuation">,</span> <span class="name">gloo</span><span class="punctuation">,</span> <span class="name">gl</span>

<span class="comment single"># Create a window with a valid GL context</span>
<span class="name">window</span> <span class="operator">=</span> <span class="name">app</span><span class="operator">.</span><span class="name">Window</span><span class="punctuation">()</span>
</pre>
<p>If necessary, you can also indicate which backend to use by writing
<code>app.use(&quot;glfw&quot;)</code> before creating the window. The creation of the program is
also straightforward:</p>
<pre class="code python literal-block">
<span class="comment single"># Build the program and corresponding buffers (with 4 vertices)</span>
<span class="name">quad</span> <span class="operator">=</span> <span class="name">gloo</span><span class="operator">.</span><span class="name">Program</span><span class="punctuation">(</span><span class="name">vertex</span><span class="punctuation">,</span> <span class="name">fragment</span><span class="punctuation">,</span> <span class="name">count</span><span class="operator">=</span><span class="literal number integer">4</span><span class="punctuation">)</span>
</pre>
<p>With the above line, both the CPU data and GPU data (buffer) have been created
and no extra command is necessary at this stage and uploading the data is only
a matter of setting the different fields of the <code>quad</code> program:</p>
<pre class="code python literal-block">
<span class="comment single"># Upload data into GPU</span>
<span class="name">quad</span><span class="punctuation">[</span><span class="literal string single">'position'</span><span class="punctuation">]</span> <span class="operator">=</span> <span class="punctuation">(</span><span class="operator">-</span><span class="literal number integer">1</span><span class="punctuation">,</span><span class="operator">+</span><span class="literal number integer">1</span><span class="punctuation">),</span> <span class="punctuation">(</span><span class="operator">+</span><span class="literal number integer">1</span><span class="punctuation">,</span><span class="operator">+</span><span class="literal number integer">1</span><span class="punctuation">),</span> <span class="punctuation">(</span><span class="operator">-</span><span class="literal number integer">1</span><span class="punctuation">,</span><span class="operator">-</span><span class="literal number integer">1</span><span class="punctuation">),</span> <span class="punctuation">(</span><span class="operator">+</span><span class="literal number integer">1</span><span class="punctuation">,</span><span class="operator">-</span><span class="literal number integer">1</span><span class="punctuation">)</span>
</pre>
<p>Under the hood, glumpy has parsed your shader programs and has identified
attributes. Rendering is just a matter of calling the <code>draw</code> method from our
shader program, using the proper mode.</p>
<pre class="code python literal-block">
<span class="comment single"># Tell glumpy what needs to be done at each redraw</span>
<span class="name decorator">&#64;window.event</span>
<span class="keyword">def</span> <span class="name function">on_draw</span><span class="punctuation">(</span><span class="name">dt</span><span class="punctuation">):</span>
    <span class="name">window</span><span class="operator">.</span><span class="name">clear</span><span class="punctuation">()</span>
    <span class="name">quad</span><span class="operator">.</span><span class="name">draw</span><span class="punctuation">(</span><span class="name">gl</span><span class="operator">.</span><span class="name">GL_TRIANGLE_STRIP</span><span class="punctuation">)</span>

<span class="comment single"># Run the app</span>
<span class="name">app</span><span class="operator">.</span><span class="name">run</span><span class="punctuation">()</span>
</pre>
<p>The whole source is available in <a class="reference external" href="code/chapter-03/glumpy-quad-solid.py">code/chapter-03/glumpy-quad-solid.py</a>.</p>
<p>If you run this program using the <code>--debug</code> switch, you should obtain the
following output that shows what is being done in the background. More
specifically, you can check that the program is actually compiled and linked
using the specified shaders and that the buffer is created and bound to the
program.</p>
<pre class="code output literal-block">
[i] HiDPI detected, fixing window size
[i] Using GLFW (GL 2.1)
[i] Running at 60 frames/second
GPU: Creating program
GPU: Attaching shaders to program
GPU: Creating shader
GPU: Compiling shader
GPU: Creating shader
GPU: Compiling shader
GPU: Linking program
GPU: Activating program (id=1)
GPU: Activating buffer (id=7)
GPU: Creating buffer (id=7)
GPU: Updating position
GPU: Deactivating buffer (id=7)
GPU: Deactivating program (id=1)
</pre>
<!-- Glumpy takes care of building the buffer because we specified the vertex count
value and will also bind the relevant attributes and uniforms to the program.
You should obtain the same output as in previous section.
`<code/chapter-03/quad-glumpy.py>`_ -->
<div class="section" id="id9">
<h3><a class="toc-backref" href="#id7">Uniform color</a></h3>
<p>Adding a <code>uniform</code> specified color is only a matter of modifying the
fragment shader as in the previous section and directly assigning the color to
the quad program (see <a class="reference external" href="code/chapter-03/glumpy-quad-uniform-color.py">code/chapter-03/glumpy-quad-uniform-color.py</a>):</p>
<pre class="code python literal-block">
<span class="name">quad</span><span class="punctuation">[</span><span class="literal string double">&quot;color&quot;</span><span class="punctuation">]</span> <span class="operator">=</span> <span class="literal number integer">0</span><span class="punctuation">,</span><span class="literal number integer">0</span><span class="punctuation">,</span><span class="literal number integer">1</span><span class="punctuation">,</span><span class="literal number integer">1</span>
</pre>
</div>
<div class="section" id="id10">
<h3><a class="toc-backref" href="#id7">Varying color</a></h3>
<p>Adding a per-vertex color is also only a matter of modifying the
fragment shader as in the previous section and directly assigning the color to
the quad program (see <a class="reference external" href="code/chapter-03/glumpy-quad-varying-color.py">code/chapter-03/glumpy-quad-varying-color.py</a>):</p>
<pre class="code python literal-block">
<span class="name">quad</span><span class="punctuation">[</span><span class="literal string double">&quot;color&quot;</span><span class="punctuation">]</span> <span class="operator">=</span> <span class="punctuation">(</span><span class="literal number integer">1</span><span class="punctuation">,</span><span class="literal number integer">1</span><span class="punctuation">,</span><span class="literal number integer">0</span><span class="punctuation">,</span><span class="literal number integer">1</span><span class="punctuation">),</span> <span class="punctuation">(</span><span class="literal number integer">1</span><span class="punctuation">,</span><span class="literal number integer">0</span><span class="punctuation">,</span><span class="literal number integer">0</span><span class="punctuation">,</span><span class="literal number integer">1</span><span class="punctuation">),</span> <span class="punctuation">(</span><span class="literal number integer">0</span><span class="punctuation">,</span><span class="literal number integer">0</span><span class="punctuation">,</span><span class="literal number integer">1</span><span class="punctuation">,</span><span class="literal number integer">1</span><span class="punctuation">),</span> <span class="punctuation">(</span><span class="literal number integer">0</span><span class="punctuation">,</span><span class="literal number integer">1</span><span class="punctuation">,</span><span class="literal number integer">0</span><span class="punctuation">,</span><span class="literal number integer">1</span><span class="punctuation">)</span>
</pre>
<!-- Animating
+++++++++

.. figure:: movies/chapter-03/quad-scale.mp4
   :loop:
   :controls:
   :figwidth: 35%

   Figure

   An `animated quad <code/chapter-03/quad-scale.py>`_.

The nice thing with glumpy_ is that it takes care of any change in uniform or
attribute values. If you change them through the program interface, these
values will be updated on the GPU just-in-time. So, let's have some animation
by making the scale value to oscillate betwen -1 and 1. To do this, we need to keep
track of time and to update the scale value accordingly:

.. code:: python

   time = 0.0

   # Tell glumpy what needs to be done
   # at each redraw
   @window.event
   def on_draw(dt):
       global time
       time += 1.0 * math.pi/180.0
       window.clear()
       quad["scale"] = math.cos(time)
       quad.draw(gl.GL_TRIANGLE_STRIP)

   app.run(framerate=60, framecount=360)

.. note::

   You'll need to have the ffmpeg_ library installed if you want to record a movie.

When running the program, we set the `framecount` to 360, meaning the program
will exit after 360 elapsed frames (a whole `cos` cycle actually).  This will
allow us to record a movie that can loop indefinetly. If you want to record
your own movie, run `the program <code/chapter-03/quad-scale.py>`_ with:


.. code:: shell

   $ python quad-scale.py - -record quad-scale.mp4 -->
</div>
</div>
<div class="section" id="exercises">
<h2><a class="toc-backref" href="#id7">Exercises</a></h2>
<p>Now we can play a bit with the shader and hopefully you'll understand why
learning to program the dynamic graphic pipeline is worth the effort. Modifying
the rendering is now a matter of writing the proper shader. We'll get a first
taste in the three exercises below but we'll see much more powerful shader
tricks in the next chapters.</p>
<div class="right figure" id="figure-movies/chapter-03/quad-scale.mp4" style="width: 35%">
<video controls="True" loop="True">
<source src="movies/chapter-03/quad-scale.mp4"></source>
</video>
<p class="caption">Figure</p>
<div class="legend">
Basic animation with the quad.</div>
</div>
<p><strong>Scaling the quad</strong> We've been using previously a <code>uniform</code> to pass a color to
the fragment shader, but we could have used also in the vertex shader to pass
any kind of information. In this exercise, try to modify the vertex shader in
the <a class="reference external" href="code/chapter-03/glumpy-quad-varying-color.py">varying color example</a> in
order for the quad to be animated and to scale with time as shown in the figure
on the right. You will need to update the scale factor within the Python
program, for example in the <code>draw</code> function.</p>
<p>Solution: <a class="reference external" href="code/chapter-03/quad-scale.py">code/chapter-03/quad-scale.py</a></p>
<hr class="docutils" />
<div class="right figure" id="figure-movies/chapter-03/quad-rotate.mp4" style="width: 35%">
<video controls="True" loop="True">
<source src="movies/chapter-03/quad-rotate.mp4"></source>
</video>
<p class="caption">Figure</p>
<div class="legend">
Basic animation with the quad.</div>
</div>
<p><strong>Rotating the quad</strong> Let's now rotate the quad as in the figure on the right.
Note that you have access to the <code>cos</code> and <code>sin</code> functions from within the
shader. If you forgot your geometry, here is a quick reminder for a rotation of
angle theta around the origin (0,0) for a point (x,y):</p>
<pre class="code glsl literal-block">
<span class="keyword type">float</span> <span class="name">x2</span> <span class="operator">=</span> <span class="name">cos</span><span class="punctuation">(</span><span class="name">theta</span><span class="punctuation">)</span><span class="operator">*</span><span class="name">x</span> <span class="operator">-</span> <span class="name">sin</span><span class="punctuation">(</span><span class="name">theta</span><span class="punctuation">)</span><span class="operator">*</span><span class="name">y</span><span class="punctuation">;</span>
<span class="keyword type">float</span> <span class="name">y2</span> <span class="operator">=</span> <span class="name">sin</span><span class="punctuation">(</span><span class="name">theta</span><span class="punctuation">)</span><span class="operator">*</span><span class="name">x</span> <span class="operator">+</span> <span class="name">cos</span><span class="punctuation">(</span><span class="name">theta</span><span class="punctuation">)</span><span class="operator">*</span><span class="name">y</span><span class="punctuation">;</span>
</pre>
<p>Solution: <a class="reference external" href="code/chapter-03/quad-rotation.py">code/chapter-03/quad-rotation.py</a></p>
</div>
</div>
<div class="section" id="basic-mathematics">
<h1><a class="toc-backref" href="#contents">Basic Mathematics</a></h1>
<div class="contents toc chapter-04 local topic" id="id11">
<p class="topic-title first">.</p>
<ul class="simple">
<li><a class="reference internal" href="#id12" id="id154">Projective Geometry</a><ul>
<li><a class="reference internal" href="#id13" id="id155">Homogeneous coordinates</a></li>
<li><a class="reference internal" href="#projections" id="id156">Projections</a></li>
</ul>
</li>
<li><a class="reference internal" href="#transformations" id="id157">Transformations</a><ul>
<li><a class="reference internal" href="#translation" id="id158">Translation</a></li>
<li><a class="reference internal" href="#scaling" id="id159">Scaling</a></li>
<li><a class="reference internal" href="#rotation" id="id160">Rotation</a></li>
<li><a class="reference internal" href="#a-word-of-caution" id="id161">A word of caution</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id14" id="id162">Projections</a><ul>
<li><a class="reference internal" href="#orthographic" id="id163">Orthographic</a></li>
<li><a class="reference internal" href="#perspective" id="id164">Perspective</a></li>
<li><a class="reference internal" href="#model-and-view-matrices" id="id165">Model and view matrices</a></li>
</ul>
</li>
</ul>
</div>
<!-- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -->
<p>There is no way around mathematics. If you want to understand computer
geometry, you need to master a few mathematical concepts. But not that many
actually. I won't introduce everything since there is already a lot of
tutorials online explaining the core concepts of <a class="reference external" href="http://math.hws.edu/graphicsbook/c3/s5.html">linear algrebra</a>, <a class="reference external" href="https://en.wikipedia.org/wiki/Three-dimensional_space">Euclidean geometry</a>, <a class="reference external" href="http://www.tomdalling.com/blog/modern-opengl/explaining-homogenous-coordinates-and-projective-geometry/">homogeneous
coordinates</a>,
<a class="reference external" href="http://www.songho.ca/opengl/gl_projectionmatrix.html">projective geometry</a>
and quaternions (yes, those are the keywords to enter in your preferred search
engine). The teaser image above comes from the Cyclopaedia, an Universal
Dictionary of Arts and Sciences published by Ephraim Chambers in London in 1728
(sources <a class="reference external" href="https://en.wikipedia.org/wiki/History_of_geometry">History of Geometry</a>).</p>
<div class="section" id="id12">
<h2><a class="toc-backref" href="#id11">Projective Geometry</a></h2>
<div class="section" id="id13">
<h3><a class="toc-backref" href="#id11">Homogeneous coordinates</a></h3>
<p>Even though we're dealing with the three-dimensional Euclidean space, three
dimensional coordinates are actually not the best representation we can use and
this is the reason why we will use homogeneous coordinates that describe
coordinates in a four-dimensional projective space (that includes the Euclidean
space). We'll see in the next section that this allows us to express linear
transformations (rotation, scaling), affine transformations (translations) and
projection using 4×4 matrices. Homogeneous coordinatess are tightly linked with
regular 3D coordinates with the noticeable difference that they require a
fourth <code>w</code> coordinate that corresponds to the fourth dimension, let's call it
the projective dimension. In order to explain it, we'll use a 1-dimensional
space where point coordinates are single scalars indicating the position of the
points onto the X-axis. This will make everything clearer hopefully.</p>
<p>Let us consider for example a simple set of points <code>[-1.0, -0.5, 0.0, +0.5,
+1.0]</code> in this unidimensional space. We want to project onto another segment
<code>[-2,+2]</code> that represents the screen (any point projected outside this segment
is discared and won't be visible into the final projection). The question now is
how do we project the points onto the screen?</p>
<div class="right figure" id="figure-images/chapter-04/1D-H-Coordinates.png" style="width: 50%">
<img alt="images/chapter-04/1D-H-Coordinates.png" src="images/chapter-04/1D-H-Coordinates.png" />
<p class="caption">Figure</p>
<div class="legend">
5 sets of homogeneous coordinates, each of them corresponding to the set of
unidimensional Cartesian coordinates <code>[-1.0, -0.5, 0.0, +0.5, +1.0]</code>.</div>
</div>
<p>To answer this question, we need to know where is the camera (from where do we
look at the scene) and where are the points positioned relatively to the
screen. This is the reason why we introduce a supplementary <code>w</code> coordinate in
order to indicate the distance to the screen. To go from our Euclidean
representation to our new homogeneous representation, we'll use a conventional
and default value of 1 for all the <code>w</code> such that our new point set is now
<code>[(-1.0,1.0), -(0.5,1.0), (0.0,1.0), (+0.5,1.0), (+1.0,1.0)]</code>. Reciprocally, a
point <code>(x,w)</code> in projective space corresponds to the point <code>x/w</code> (if <code>w</code> ≠ 0)
in our unidimensional Euclidean space. From this conversion, we can see
immediately that there exists actually an infinite set of homogenous coordinates
that correspond to a single Cartesian coordinate as illustrated on the figure.</p>
<div class="right figure" id="figure-images/chapter-04/1D-Projection.png" style="width: 100%">
<img alt="images/chapter-04/1D-Projection.png" src="images/chapter-04/1D-Projection.png" />
<p class="caption">Figure</p>
<div class="legend">
Different one dimensional projections using homogeneous coordinates.</div>
</div>
<!-- .. note::

What if `w` is null then? The answer is that this point cannot be
projected and you can consider it like an infinite point. -->
</div>
<div class="section" id="projections">
<h3><a class="toc-backref" href="#id11">Projections</a></h3>
<p>We are now ready to project our point set onto the screen. As shown on the
figure above, we can use an orthographic (all rays are parallel) or a linear
projection (rays originate from the camera point and hit the screen, passing
through points to be projected). For these two projections, results are similar
but different. In the first case, distances have been exactly conserved while
in the second case, the distance between projected points has increased, but
projected points are still equidistant. The third projection is where
homogenous coordinates make sense. For this (arbitrary) projection, we decided
that the further the point is from the origin, the further away from the
origin its projection will be. To do that, we measure the distance of the point
to the origin and we add this distance to its <code>w</code> value before projecting it
(this corresponds to the black circles on the figure) using the linear
projection. It is to be noted that this new projection does not conserve the
distance relationship and if we consider the set of projected points <code>[P(-1.0),
P(-0.5), P(0.0), P(+0.5), P(+1.0)]</code>, we have <code>║P(-1.0)-P(-0.5)]║ &gt;
║P(-0.5)- P(0.0)║</code>.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last"><strong>Quaternions are not homogenous coordinates</strong> even though they are usually
represented in the form of a 4-tuple (a,b,c,d) that is a shortcut for the
actual representation: a + bi⃗ + cj⃗ + dk⃗, where a, b, c, and d are real
numbers, and i⃗, j⃗, k⃗ are the fundamental quaternion units.</p>
</div>
<p>Back to our regular 3D-Euclidean space, the principle remains the same and we have the following relationship between Cartesian and homogeneous coordinates:</p>
<pre class="code math literal-block">
 (x,y,z,w) → (x/w, y/w, z/w) (for w ≠ 0)
Homogeneous    Cartesian

 (x,y,z)   → (x, y, z, 1)
Cartesian     Homogeneous
</pre>
<p>If you didn't understand everything, you can stick to the description provided
by Sam Hocevar:</p>
<ul class="simple">
<li>If w = 1, then the vector (x,y,z,1) is a position in space</li>
<li>If w = 0, then the vector (x,y,z,0) is a direction</li>
</ul>
</div>
</div>
<div class="section" id="transformations">
<h2><a class="toc-backref" href="#id11">Transformations</a></h2>
<div class="right figure" id="figure-images/chapter-04/composition.png" style="width: 50%">
<img alt="images/chapter-04/composition.png" src="images/chapter-04/composition.png" />
<p class="caption">Figure</p>
<div class="legend">
Transformation are not commutative, hence R*T*V (up) is different from T*R*V
(bottom). Remember that last transformation is on the left.</div>
</div>
<p>We'll now use homogeneous coordinates and express all our transformations using
only 4×4 matrices. This will allow us to chain several transformations by
multiplying transformation matrices. However, before diving into the actual
definition of these matrices, we need to decide if we consider a four
coordinates vector to be 4 rows and 1 column or 1 row and 4 columns. Depending
on the answer, the multiplication with a matrix will happen on the left or on
the right side of the vector. To be consistent with OpenGL convention, we'll
consider a vector to be 4 rows and 1 columns, meaning transformations happen on
the left side of vectors. To transform a vertex V by a transformation matrix M,
we write: V' = M*V. To chain two transformations M1 and M2 (first M1, then M2),
we write: V' = M2*M1*V which is different from V' = M1*M2*V because matrix
multiplication is not commutative. As clearly illustrated by the figure on the right,
this means for example that a rotation followed by a translation is not the
same as a translation followed by a rotation.</p>
<!-- **Main transformations**

   For the impatient, here are all the main transformations:

   .. code::
      :class: math

            ┌         ┐            ┌          ┐         ┌            ┐
            │ 1 0 0 0 │            │ 1 0 0 tx │         │ sx 0  0  0 │
            │ 0 1 0 0 │            │ 0 1 0 ty │         │ 0  sy 0  0 │
            │ 0 0 1 0 │            │ 0 0 1 tz │         │ 0  0  sz 0 │
            │ 0 0 0 1 │            │ 0 0 0 1  │         │ 0  0  0  1 │
            └         ┘            └          ┘         └            ┘
             Identity               Translate               Scale

      ┌                    ┐ ┌                    ┐ ┌                    ┐
      │   1       0    0 0 │ │  cos(d) 0 sin(d) 0 │ │ cos(d) -sin(d) 0 0 │
      │ cos(d) -sin(d) 0 0 │ │    0    1   0    0 │ │ sin(d)  cos(d) 0 0 │
      │ sin(d)  cos(d) 0 0 │ │ -sin(d) 0 cos(d) 0 │ │   0       0    1 0 │
      │   0       0    0 1 │ │    0    0    0   1 │ │   0       0    0 1 │
      └                    ┘ └                    ┘ └                    ┘
          Rotate X-axis          Rotate Y-axis           Rotate Z-axis

   Let us check they work as expected. -->
<!-- Identity transformation
+++++++++++++++++++++++

.. code::
   :class: math

   ┌         ┐   ┌   ┐   ┌                       ┐   ┌   ┐
   │ 1 0 0 0 │ * │ x │ = │ 1*x + 0*0 + 0*0 + 0*0 │ = │ x │
   │ 0 1 0 0 │   │ y │   │ 0*0 + 1*y + 0*0 + 0*0 │   │ y │
   │ 0 0 1 0 │   │ z │   │ 0*0 + 0*0 + 1*z + 0*0 │   │ z │
   │ 0 0 0 1 │   │ 1 │   │ 0*0 + 0*0 + 0*0 + 1*1 │   │ 1 │
   └         ┘   └   ┘   └                       ┘   └   ┘ -->
<div class="section" id="translation">
<h3><a class="toc-backref" href="#id11">Translation</a></h3>
<p>Considering a vertex <code>V = (x, y, z, 1)</code> and a translation vector <code>T = (tx, ty,
tz, 0)</code>, the translation of <code>V</code> by <code>T</code> is <code>(x+tx, y+ty, z+tz, 1)</code>.  The
corresponding matrix is given below:</p>
<pre class="code math literal-block">
┌          ┐   ┌   ┐   ┌                        ┐   ┌      ┐
│ 1 0 0 tx │ * │ x │ = │ 1*x + 0*y + 0*z + tx*1 │ = │ x+tx │
│ 0 1 0 ty │   │ y │   │ 0*x + 1*y + 0*z + ty*1 │   │ y+ty │
│ 0 0 1 tz │   │ z │   │ 0*x + 0*y + 1*z + tz*1 │   │ z+tz │
│ 0 0 0 1  │   │ 1 │   │ 0*x + 0*y + 0*z +  1*1 │   │ 1    │
└          ┘   └   ┘   └                        ┘   └      ┘
</pre>
</div>
<div class="section" id="scaling">
<h3><a class="toc-backref" href="#id11">Scaling</a></h3>
<p>Considering a vertex <code>V = (x, y, z, 1)</code> and a scaling vector <code>S = (sx, sy, sz,
0)</code>, the scaling of <code>V</code> by <code>S</code> is <code>(sx*x, sy*y, sz*z, 1)</code>. The corresponding
matrix is given below:</p>
<pre class="code math literal-block">
┌            ┐   ┌   ┐   ┌                          ┐   ┌      ┐
│ sx 0  0  0 │ * │ x │ = │ sx*x +  0*y +  0*z + 0*1 │ = │ sx*x │
│ 0  sy 0  0 │   │ y │   │  0*x + sy*y +  0*z + 0*1 │   │ sy*y │
│ 0  0  sz 0 │   │ z │   │  0*x +  0*y + sz*z + 0*1 │   │ sz*z │
│ 0  0  0  1 │   │ 1 │   │  0*x +  0*y +  0*z + 1*1 │   │ 1    │
└            ┘   └   ┘   └                          ┘   └      ┘
</pre>
</div>
<div class="section" id="rotation">
<h3><a class="toc-backref" href="#id11">Rotation</a></h3>
<p>A rotation is defined by an axis of rotation A and an angle of rotation d. We
defined below only the most common rotations, that is, around the X-axis,
Y-axis and Z-axis.</p>
<div class="section" id="x-axis-rotation">
<h4>X-axis rotation</h4>
<pre class="code math literal-block">
┌                    ┐   ┌   ┐   ┌                                 ┐
│ 1   0       0    0 │ * │ x │ = │ 1*x      + 0*y      + 0*z + 0*1 │
│ 0 cos(d) -sin(d) 0 │   │ y │   │ 0*x + cos(d)*y - sin(d)*z + 0*1 │
│ 0 sin(d)  cos(d) 0 │   │ z │   │ 0*x + sin(d)*y + cos(d)*z + 0*1 │
│ 0   0       0    1 │   │ 1 │   │ 0*x      + 0*y +      0*z + 1*1 │
└                    ┘   └   ┘   └                                 ┘
                                 ┌                      ┐
                               = │ x                    │
                                 │ cos(d)*y - sin(d)*z  │
                                 │ sin(d)*y + cos(d)*z  │
                                 │ 1                    │
                                 └                      ┘
</pre>
</div>
<div class="section" id="y-axis-rotation">
<h4>Y-axis rotation</h4>
<pre class="code math literal-block">
┌                    ┐   ┌   ┐   ┌                                  ┐
│  cos(d) 0 sin(d) 0 │ * │ x │ = │  cos(d)*x + 0*y + sin(d)*z + 0*1 │
│    0    1   0    0 │   │ y │   │       0*x + 1*y +      0*z + 0*1 │
│ -sin(d) 0 cos(d) 0 │   │ z │   │ -sin(d)*x + 0*y + cos(d)*z + 0*1 │
│    0    0    0   1 │   │ 1 │   │       0*x + 0*y      + 0*z + 1*1 │
└                    ┘   └   ┘   └                                  ┘
                                 ┌                      ┐
                               = │ cos(d)*x + sin(d)*z  │
                                 │ y                    │
                                 │ -sin(d)*x + cos(d)*z │
                                 │ 1                    │
                                 └                      ┘
</pre>
</div>
<div class="section" id="z-axis-rotation">
<h4>Z-axis rotation</h4>
<pre class="code math literal-block">
┌                    ┐   ┌   ┐   ┌                                  ┐
│ cos(d) -sin(d) 0 0 │ * │ x │ = │  cos(d)*x - sin(d)*y + 0*z + 0*1 │
│ sin(d)  cos(d) 0 0 │   │ y │   │  sin(d)*x + cos(d)*y + 0*z + 0*1 │
│   0       0    1 0 │   │ z │   │       0*x +      0*y + 1*z + 0*1 │
│   0       0    0 1 │   │ 1 │   │       0*x +      0*y + 0*z + 1*1 │
└                    ┘   └   ┘   └                                  ┘
                                 ┌                      ┐
                               = │ cos(d)*x - sin(d)*y  │
                                 │ sin(d)*x + cos(d)*y  │
                                 │ z                    │
                                 │ 1                    │
                                 └                      ┘
</pre>
</div>
</div>
<div class="section" id="a-word-of-caution">
<h3><a class="toc-backref" href="#id11">A word of caution</a></h3>
<p>OpenGL uses a <a class="reference external" href="https://www.opengl.org/archives/resources/faq/technical/transformations.htm">column-major representation</a>
of matrices. This mean that when reading a set of 16 contiguous
values in memory, relative to a 4×4 matrix, the first 4 values correspond to the first column while in
Numpy (using C default layout), this would correspond to the first row. In
order to stay consistent with most OpenGL tutorials, we'll use a column-major
order in the rest of this book. This means that any glumpy transformations will
appear to be transposed when displayed, but the underlying memory
representation will still be consistent with OpenGL and GLSL. This is all you
need to know at this stage.</p>
<p>Considering a set of 16 contiguous values in memory:</p>
<pre class="code math literal-block">
┌                                  ┐
│ a b c d e f g h i j k l  m n o p │
└                                  ┘
</pre>
<p>We get different representations depending on the order convention (column major or row major):</p>
<pre class="code math literal-block">
column-major                          row-major
  (OpenGL)                             (NumPy)
 ┌         ┐   ┌   ┐   ┌         ┐   ┌         ┐   ┌                   ┐
 │ a e i m │ × │ x │ = │ x y z w │ × │ a b c d │ = │ ax + ey + iz + mw │
 │ b f j n │   │ y │   └         ┘   │ e f g h │   │ bx + fy + jz + nw │
 │ c g k o │   │ z │                 │ i j k l │   │ cx + gy + kz + ow │
 │ d h l p │   │ w │                 │ m n o p │   │ dx + hy + lz + pw │
 └         ┘   └   ┘                 └         ┘   └                   ┘
</pre>
<p>For example, here is a translation matrix as returned by the
<code>glumpy.glm.translation</code> function:</p>
<pre class="code python literal-block">
<span class="keyword namespace">import</span> <span class="name namespace">glumpy</span>
<span class="name">T</span> <span class="operator">=</span> <span class="name">glumpy</span><span class="operator">.</span><span class="name">glm</span><span class="operator">.</span><span class="name">translation</span><span class="punctuation">(</span><span class="literal number integer">1</span><span class="punctuation">,</span><span class="literal number integer">2</span><span class="punctuation">,</span><span class="literal number integer">3</span><span class="punctuation">)</span>
<span class="keyword">print</span><span class="punctuation">(</span><span class="name">T</span><span class="punctuation">)</span>
<span class="punctuation">[[</span> <span class="literal number float">1.</span>  <span class="literal number float">0.</span>  <span class="literal number float">0.</span>  <span class="literal number float">0.</span><span class="punctuation">]</span>
 <span class="punctuation">[</span> <span class="literal number float">0.</span>  <span class="literal number float">1.</span>  <span class="literal number float">0.</span>  <span class="literal number float">0.</span><span class="punctuation">]</span>
 <span class="punctuation">[</span> <span class="literal number float">0.</span>  <span class="literal number float">0.</span>  <span class="literal number float">1.</span>  <span class="literal number float">0.</span><span class="punctuation">]</span>
 <span class="punctuation">[</span> <span class="literal number float">1.</span>  <span class="literal number float">2.</span>  <span class="literal number float">3.</span>  <span class="literal number float">1.</span><span class="punctuation">]]</span>
<span class="keyword">print</span><span class="punctuation">(</span><span class="name">T</span><span class="operator">.</span><span class="name">ravel</span><span class="punctuation">())</span>
<span class="punctuation">[</span> <span class="literal number float">1.</span>  <span class="literal number float">0.</span>  <span class="literal number float">0.</span>  <span class="literal number float">0.</span>  <span class="literal number float">0.</span>  <span class="literal number float">1.</span>  <span class="literal number float">0.</span>  <span class="literal number float">0.</span>  <span class="literal number float">0.</span>  <span class="literal number float">0.</span>  <span class="literal number float">1.</span>  <span class="literal number float">0.</span>  <span class="literal number float">1.</span>  <span class="literal number float">2.</span>  <span class="literal number float">3.</span>  <span class="literal number float">1.</span><span class="punctuation">]</span>
                                                  <span class="error">↑</span>   <span class="error">↑</span>   <span class="error">↑</span>
                                                  <span class="literal number integer">13</span>  <span class="literal number integer">14</span>  <span class="literal number integer">15</span>
</pre>
<p>So this means you would use this translation on the left when uploaded to the
GPU, but you would use on the right with Python/NumPy:</p>
<pre class="code python literal-block">
<span class="name">T</span> <span class="operator">=</span> <span class="name">glumpy</span><span class="operator">.</span><span class="name">glm</span><span class="operator">.</span><span class="name">translation</span><span class="punctuation">(</span><span class="literal number integer">1</span><span class="punctuation">,</span><span class="literal number integer">2</span><span class="punctuation">,</span><span class="literal number integer">3</span><span class="punctuation">)</span>
<span class="name">V</span> <span class="operator">=</span> <span class="punctuation">[</span><span class="literal number integer">3</span><span class="punctuation">,</span><span class="literal number integer">2</span><span class="punctuation">,</span><span class="literal number integer">1</span><span class="punctuation">,</span><span class="literal number integer">1</span><span class="punctuation">]</span>
<span class="keyword">print</span><span class="punctuation">(</span><span class="name">np</span><span class="operator">.</span><span class="name">dot</span><span class="punctuation">(</span><span class="name">V</span><span class="punctuation">,</span> <span class="name">T</span><span class="punctuation">))</span>
<span class="punctuation">[</span> <span class="literal number float">4.</span>  <span class="literal number float">4.</span>  <span class="literal number float">4.</span>  <span class="literal number float">1.</span><span class="punctuation">]</span>
</pre>
</div>
</div>
<div class="section" id="id14">
<h2><a class="toc-backref" href="#id11">Projections</a></h2>
<p>In order to define a projection, we need to specify first what do we want
to view, that is, we need to define a viewing volume such that any object
within the volume (even partially) will be rendered while objects outside
won't. On the image below, the yellow and red spheres are within the volume
while the green one is not and does not appear on the projection.</p>
<img alt="images/chapter-04/projection.png" src="images/chapter-04/projection.png" style="width: 100%;" />
<p>There exist many different ways to project a 3D volume onto a 2D screen but
we'll only use the <a class="reference external" href="https://en.wikipedia.org/wiki/Perspective_(graphical)">perspective projection</a> (distant objects appear smaller)
and the <a class="reference external" href="https://en.wikipedia.org/wiki/Orthographic_projection_(geometry)">orthographic projection</a> which is a parallel projection (distant
objects have the same size as closer ones) as illustrated on the image
above. Until now (previous section), we have been using implicitly an
orthographic projection in the z=0 plane.</p>
<p>Depending on the projection we want, we will use one of the two projection
matrices below:</p>
<div class="section" id="orthographic">
<h3><a class="toc-backref" href="#id11">Orthographic</a></h3>
<pre class="code math literal-block">
┌                                         ┐ n: near
│ 2/(r-l)    0       0     -((r+l)/(r-l)) │ f: far
│   0     2/(t-b)    0     -((t+b)/(t-b)) │ t: top
│   0        0    -2/(f-n) -((f+n)/(f-n)) │ b: bottom
│   0        0      -1            0       │ l: left
└                                         ┘ r: right
          Orthographic projection
</pre>
</div>
<div class="section" id="perspective">
<h3><a class="toc-backref" href="#id11">Perspective</a></h3>
<pre class="code math literal-block">
┌                                               ┐ n: near
│ 2n/(r-l)    0       (r+l)/(r-l)       0       │ f: far
│    0     2n/(t-b)   (t+b)/(t-b)       0       │ t: top
│    0        0     -((f+n)/(f-n)) -(2nf/(f-n)) │ b: bottom
│    0        0           -1            0       │ l: left
└                                               ┘ r: right
            Perspective projection
</pre>
<p>At this point, it is not necessary to understand how these matrices were
built. Suffice it to say they are standard matrices in the 3D world. Both
assume the viewer (=camera) is located at position (0,0,0) and is looking in
the direction (0,0,1).</p>
<p>There exists a second form of the perpective matrix that might be easier to
manipulate. Instead of specifying the right/left/top/bottom planes, we'll use
field of view in the horizontal and vertical direction:</p>
<pre class="code math literal-block">
┌                                     ┐ n: near
│ c/aspect  0       0          0      │ f: far
│    0      c       0          0      │ c: cotangent(fovy)
│    0      0  (f+n)/(n-f)  2nf/(n-f) │
│    0      0      -1          0      │
└                                     ┘
            Perspective projection
</pre>
<p>where <code>fovy</code> specifies the field of view angle in the y direction
and <code>aspect</code> specifies the aspect ratio that determines the field of view in
the x direction.</p>
</div>
<div class="section" id="model-and-view-matrices">
<h3><a class="toc-backref" href="#id11">Model and view matrices</a></h3>
<p>We are almost done with matrices. You may have guessed that the above matrices
require the viewing volume to be in the z direction. We could design our 3D
scene such that all objects are within this direction but it would not be very
convenient. So instead, we use a view matrix that maps the world space to
camera space. This is pretty much as if we were orienting the camera at a given
position and look toward a given direction. In the meantime, we can further
refine the whole pipeline by providing a model matrix that maps the object's
local coordinate space into world space. For example, this is useful for
rotating an object around its center. To sum up, we need:</p>
<ul class="simple">
<li><strong>Model matrix</strong> maps from an object's local coordinate space into world space</li>
<li><strong>View matrix</strong> maps from world space to camera space</li>
<li><strong>Projection matrix</strong> maps from camera to screen space</li>
</ul>
<p>This corresponds to the model-view-projection model. If you have read the whole
chapter carefully, you may have guessed the corresponding GLSL shader:</p>
<pre class="code glsl literal-block">
<span class="keyword">uniform</span> <span class="keyword type">mat4</span> <span class="name">view</span><span class="punctuation">;</span>
<span class="keyword">uniform</span> <span class="keyword type">mat4</span> <span class="name">model</span><span class="punctuation">;</span>
<span class="keyword">uniform</span> <span class="keyword type">mat4</span> <span class="name">projection</span><span class="punctuation">;</span>
<span class="keyword">attribute</span> <span class="keyword type">vec3</span> <span class="name">P</span><span class="punctuation">;</span>
<span class="keyword type">void</span> <span class="name">main</span><span class="punctuation">(</span><span class="keyword type">void</span><span class="punctuation">)</span>
<span class="punctuation">{</span>
    <span class="name builtin">gl_Position</span> <span class="operator">=</span> <span class="name">projection</span><span class="operator">*</span><span class="name">view</span><span class="operator">*</span><span class="name">model</span><span class="operator">*</span><span class="keyword type">vec4</span><span class="punctuation">(</span><span class="name">P</span><span class="punctuation">,</span> <span class="literal number float">1.0</span><span class="punctuation">);</span>
<span class="punctuation">}</span>
</pre>
</div>
</div>
</div>
<div class="section" id="rendering-a-cube">
<h1><a class="toc-backref" href="#contents">Rendering a cube</a></h1>
<div class="contents toc chapter-05 local topic" id="id15">
<p class="topic-title first">.</p>
<ul class="simple">
<li><a class="reference internal" href="#object-creation" id="id166">Object creation</a></li>
<li><a class="reference internal" href="#scene-setup" id="id167">Scene setup</a></li>
<li><a class="reference internal" href="#actual-rendering" id="id168">Actual rendering</a></li>
<li><a class="reference internal" href="#variations" id="id169">Variations</a><ul>
<li><a class="reference internal" href="#colored-cube" id="id170">Colored cube</a></li>
<li><a class="reference internal" href="#outlined-cube" id="id171">Outlined cube</a></li>
<li><a class="reference internal" href="#textured-cube" id="id172">Textured cube</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id16" id="id173">Exercises</a></li>
</ul>
</div>
<p>We now have all the pieces needed to render a simple 3D scene, that is, a
rotating cube as shown in the teaser image above. But we first need to create
the cube and to tell OpenGL how we want to actually project it on the screen.</p>
<div class="section" id="object-creation">
<h2><a class="toc-backref" href="#id15">Object creation</a></h2>
<p>We need to define what we mean by a <em>cube</em> since there is not such thing as as
cube in OpenGL. A cube, when seen from the outside has 6 faces, each being a
square. We just saw that to render a square, we need two triangles. So, 6
faces, each of them being made of 2 triangles, we need 12 triangles.</p>
<p>How many vertices? 12 triangles × 3 vertices per triangles = 36 vertices might
be a reasonable answer. However, we can also notice that each vertex is part of
3 different faces actually. We'll thus use no more than 8 vertices and tell
explicitly OpenGL how to draw 6 faces with them:</p>
<pre class="code python literal-block">
<span class="name">V</span> <span class="operator">=</span> <span class="name">np</span><span class="operator">.</span><span class="name">zeros</span><span class="punctuation">(</span><span class="literal number integer">8</span><span class="punctuation">,</span> <span class="punctuation">[(</span><span class="literal string double">&quot;position&quot;</span><span class="punctuation">,</span> <span class="name">np</span><span class="operator">.</span><span class="name">float32</span><span class="punctuation">,</span> <span class="literal number integer">3</span><span class="punctuation">)])</span>
<span class="name">V</span><span class="punctuation">[</span><span class="literal string double">&quot;position&quot;</span><span class="punctuation">]</span> <span class="operator">=</span> <span class="punctuation">[[</span> <span class="literal number integer">1</span><span class="punctuation">,</span> <span class="literal number integer">1</span><span class="punctuation">,</span> <span class="literal number integer">1</span><span class="punctuation">],</span> <span class="punctuation">[</span><span class="operator">-</span><span class="literal number integer">1</span><span class="punctuation">,</span> <span class="literal number integer">1</span><span class="punctuation">,</span> <span class="literal number integer">1</span><span class="punctuation">],</span> <span class="punctuation">[</span><span class="operator">-</span><span class="literal number integer">1</span><span class="punctuation">,</span><span class="operator">-</span><span class="literal number integer">1</span><span class="punctuation">,</span> <span class="literal number integer">1</span><span class="punctuation">],</span> <span class="punctuation">[</span> <span class="literal number integer">1</span><span class="punctuation">,</span><span class="operator">-</span><span class="literal number integer">1</span><span class="punctuation">,</span> <span class="literal number integer">1</span><span class="punctuation">],</span>
                 <span class="punctuation">[</span> <span class="literal number integer">1</span><span class="punctuation">,</span><span class="operator">-</span><span class="literal number integer">1</span><span class="punctuation">,</span><span class="operator">-</span><span class="literal number integer">1</span><span class="punctuation">],</span> <span class="punctuation">[</span> <span class="literal number integer">1</span><span class="punctuation">,</span> <span class="literal number integer">1</span><span class="punctuation">,</span><span class="operator">-</span><span class="literal number integer">1</span><span class="punctuation">],</span> <span class="punctuation">[</span><span class="operator">-</span><span class="literal number integer">1</span><span class="punctuation">,</span> <span class="literal number integer">1</span><span class="punctuation">,</span><span class="operator">-</span><span class="literal number integer">1</span><span class="punctuation">],</span> <span class="punctuation">[</span><span class="operator">-</span><span class="literal number integer">1</span><span class="punctuation">,</span><span class="operator">-</span><span class="literal number integer">1</span><span class="punctuation">,</span><span class="operator">-</span><span class="literal number integer">1</span><span class="punctuation">]]</span>
</pre>
<p>These vertices describe a cube centered on (0,0,0) that goes from (-1,-1,-1) to
(+1,+1,+1). Unfortunately, we cannot use <code>gl.GL_TRIANGLE_STRIP</code> as we did for
the quad. If you remember how this rendering primitive considers vertices as a
succession of triangles, you should also realize there is no way to organize
our vertices into a triangle strip that would describe our cube. This means we
have to tell OpenGL explicitly what are our triangles, i.e. we need to
describe triangles in terms of vertex indices (relatively to the <code>V</code> array we
just defined):</p>
<pre class="code python literal-block">
<span class="name">I</span> <span class="operator">=</span> <span class="name">np</span><span class="operator">.</span><span class="name">array</span><span class="punctuation">([</span><span class="literal number integer">0</span><span class="punctuation">,</span><span class="literal number integer">1</span><span class="punctuation">,</span><span class="literal number integer">2</span><span class="punctuation">,</span> <span class="literal number integer">0</span><span class="punctuation">,</span><span class="literal number integer">2</span><span class="punctuation">,</span><span class="literal number integer">3</span><span class="punctuation">,</span>  <span class="literal number integer">0</span><span class="punctuation">,</span><span class="literal number integer">3</span><span class="punctuation">,</span><span class="literal number integer">4</span><span class="punctuation">,</span> <span class="literal number integer">0</span><span class="punctuation">,</span><span class="literal number integer">4</span><span class="punctuation">,</span><span class="literal number integer">5</span><span class="punctuation">,</span>  <span class="literal number integer">0</span><span class="punctuation">,</span><span class="literal number integer">5</span><span class="punctuation">,</span><span class="literal number integer">6</span><span class="punctuation">,</span> <span class="literal number integer">0</span><span class="punctuation">,</span><span class="literal number integer">6</span><span class="punctuation">,</span><span class="literal number integer">1</span><span class="punctuation">,</span>
              <span class="literal number integer">1</span><span class="punctuation">,</span><span class="literal number integer">6</span><span class="punctuation">,</span><span class="literal number integer">7</span><span class="punctuation">,</span> <span class="literal number integer">1</span><span class="punctuation">,</span><span class="literal number integer">7</span><span class="punctuation">,</span><span class="literal number integer">2</span><span class="punctuation">,</span>  <span class="literal number integer">7</span><span class="punctuation">,</span><span class="literal number integer">4</span><span class="punctuation">,</span><span class="literal number integer">3</span><span class="punctuation">,</span> <span class="literal number integer">7</span><span class="punctuation">,</span><span class="literal number integer">3</span><span class="punctuation">,</span><span class="literal number integer">2</span><span class="punctuation">,</span>  <span class="literal number integer">4</span><span class="punctuation">,</span><span class="literal number integer">7</span><span class="punctuation">,</span><span class="literal number integer">6</span><span class="punctuation">,</span> <span class="literal number integer">4</span><span class="punctuation">,</span><span class="literal number integer">6</span><span class="punctuation">,</span><span class="literal number integer">5</span><span class="punctuation">],</span> <span class="name">dtype</span><span class="operator">=</span><span class="name">np</span><span class="operator">.</span><span class="name">uint32</span><span class="punctuation">)</span>
</pre>
<p>This <code>I</code> is an <code>IndexBuffer</code> that needs to be uploaded to the GPU as well.
Using glumpy, the easiest way is to use a <code>VertexBuffer</code> for vertex data and
an <code>IndexBuffer</code> for index data:</p>
<pre class="code python literal-block">
<span class="name">V</span> <span class="operator">=</span> <span class="name">V</span><span class="operator">.</span><span class="name">view</span><span class="punctuation">(</span><span class="name">gloo</span><span class="operator">.</span><span class="name">VertexBuffer</span><span class="punctuation">)</span>
<span class="name">I</span> <span class="operator">=</span> <span class="name">I</span><span class="operator">.</span><span class="name">view</span><span class="punctuation">(</span><span class="name">gloo</span><span class="operator">.</span><span class="name">IndexBuffer</span><span class="punctuation">)</span>
</pre>
<p>We can now proceed with the actual creation of the cube and upload the
vertices. Note that we do not specify the <code>count</code> argument because we'll bind
explicitely our own vertex buffer. The <code>vertex</code> and <code>fragment</code> shader sources
are given below.</p>
<pre class="code python literal-block">
<span class="name">cube</span> <span class="operator">=</span> <span class="name">gloo</span><span class="operator">.</span><span class="name">Program</span><span class="punctuation">(</span><span class="name">vertex</span><span class="punctuation">,</span> <span class="name">fragment</span><span class="punctuation">)</span>
<span class="name">cube</span><span class="punctuation">[</span><span class="literal string double">&quot;position&quot;</span><span class="punctuation">]</span> <span class="operator">=</span> <span class="name">V</span>
</pre>
<p>And we'll use the indices buffer when actually rendering the cube.</p>
</div>
<div class="section" id="scene-setup">
<h2><a class="toc-backref" href="#id15">Scene setup</a></h2>
<p>The next step is to define the scene. This means we need to say where are our
objects located and oriented in space, where is our camera located, what kind
of camera we want to use and ultimately, where do we look at. In this simple
example, we'll use the model-view-projection model that requires 3 matrices:</p>
<ul class="simple">
<li><code>model:</code> maps from an object's local coordinate space into world space</li>
<li><code>view:</code> maps from world space to camera space</li>
<li><code>projection:</code> maps from camera to screen space</li>
</ul>
<p>The corresponding vertex shader code is then:</p>
<pre class="code glsl literal-block">
<span class="name">vertex</span> <span class="operator">=</span> <span class="error">&quot;&quot;&quot;</span>
<span class="keyword">uniform</span> <span class="keyword type">mat4</span>   <span class="name">model</span><span class="punctuation">;</span>
<span class="keyword">uniform</span> <span class="keyword type">mat4</span>   <span class="name">view</span><span class="punctuation">;</span>
<span class="keyword">uniform</span> <span class="keyword type">mat4</span>   <span class="name">projection</span><span class="punctuation">;</span>
<span class="keyword">attribute</span> <span class="keyword type">vec3</span> <span class="name">position</span><span class="punctuation">;</span>
<span class="keyword type">void</span> <span class="name">main</span><span class="punctuation">()</span>
<span class="punctuation">{</span>
    <span class="name builtin">gl_Position</span> <span class="operator">=</span> <span class="name">projection</span> <span class="operator">*</span> <span class="name">view</span> <span class="operator">*</span> <span class="name">model</span> <span class="operator">*</span> <span class="keyword type">vec4</span><span class="punctuation">(</span><span class="name">position</span><span class="punctuation">,</span><span class="literal number float">1.0</span><span class="punctuation">);</span>
<span class="punctuation">}</span> <span class="error">&quot;&quot;&quot;</span>
</pre>
<p>and we'll keep the fragment shader to a minimum for now (red color):</p>
<pre class="code glsl literal-block">
<span class="name">fragment</span> <span class="operator">=</span> <span class="error">&quot;&quot;&quot;</span>
<span class="keyword type">void</span> <span class="name">main</span><span class="punctuation">()</span>
<span class="punctuation">{</span>
    <span class="name builtin">gl_FragColor</span> <span class="operator">=</span> <span class="keyword type">vec4</span><span class="punctuation">(</span><span class="literal number float">1.0</span><span class="punctuation">,</span> <span class="literal number float">0.0</span><span class="punctuation">,</span> <span class="literal number float">0.0</span><span class="punctuation">,</span> <span class="literal number float">1.0</span><span class="punctuation">);</span>
<span class="punctuation">}</span> <span class="error">&quot;&quot;&quot;</span>
</pre>
<p>For the projection, we'll use the default perspective camera that is available
from the <code>glumpy.glm</code> module (that also defines ortho, frustum and perspective
matrices as well as rotation, translation and scaling operations). This default
perspective matrix is located at the origin and looks in the negative z
direction with the up direction pointing toward the positive y-axis. If we
leave our cube at the origin, the camera would be inside the cube and we would
not see much. So let's first create a view matrix that is a translation along the
z-axis:</p>
<pre class="code python literal-block">
<span class="name">view</span> <span class="operator">=</span> <span class="name">np</span><span class="operator">.</span><span class="name">eye</span><span class="punctuation">(</span><span class="literal number integer">4</span><span class="punctuation">,</span><span class="name">dtype</span><span class="operator">=</span><span class="name">np</span><span class="operator">.</span><span class="name">float32</span><span class="punctuation">)</span>
<span class="name">glm</span><span class="operator">.</span><span class="name">translate</span><span class="punctuation">(</span><span class="name">view</span><span class="punctuation">,</span> <span class="literal number integer">0</span><span class="punctuation">,</span><span class="literal number integer">0</span><span class="punctuation">,</span><span class="operator">-</span><span class="literal number integer">5</span><span class="punctuation">)</span>
</pre>
<p>Next, we need to define the model matrix and the projection matrix. However,
we'll not setup them right away because the model matrix will be updated in the
<code>on_draw</code> function in order to rotate the cube, while the projection matrix
will be updated as soon as the viewport changes (which is the case when the
window is first created) in the <code>on_resize</code> function.</p>
<pre class="code python literal-block">
<span class="name">projection</span> <span class="operator">=</span> <span class="name">np</span><span class="operator">.</span><span class="name">eye</span><span class="punctuation">(</span><span class="literal number integer">4</span><span class="punctuation">,</span><span class="name">dtype</span><span class="operator">=</span><span class="name">np</span><span class="operator">.</span><span class="name">float32</span><span class="punctuation">)</span>
<span class="name">model</span> <span class="operator">=</span> <span class="name">np</span><span class="operator">.</span><span class="name">eye</span><span class="punctuation">(</span><span class="literal number integer">4</span><span class="punctuation">,</span><span class="name">dtype</span><span class="operator">=</span><span class="name">np</span><span class="operator">.</span><span class="name">float32</span><span class="punctuation">)</span>

<span class="name">cube</span><span class="punctuation">[</span><span class="literal string single">'model'</span><span class="punctuation">]</span> <span class="operator">=</span> <span class="name">model</span>
<span class="name">cube</span><span class="punctuation">[</span><span class="literal string single">'view'</span><span class="punctuation">]</span> <span class="operator">=</span> <span class="name">view</span>
<span class="name">cube</span><span class="punctuation">[</span><span class="literal string single">'projection'</span><span class="punctuation">]</span> <span class="operator">=</span> <span class="name">projection</span>
</pre>
<p>In the resize function, we update the projection with a perspective matrix,
taking the window aspect ratio into account. We define the viewing volume
with <code>near=2.0</code>, <code>far=100.0</code> and field of view of 45°:</p>
<pre class="code python literal-block">
<span class="name decorator">&#64;window.event</span>
<span class="keyword">def</span> <span class="name function">on_resize</span><span class="punctuation">(</span><span class="name">width</span><span class="punctuation">,</span> <span class="name">height</span><span class="punctuation">):</span>
   <span class="name">ratio</span> <span class="operator">=</span> <span class="name">width</span> <span class="operator">/</span> <span class="name builtin">float</span><span class="punctuation">(</span><span class="name">height</span><span class="punctuation">)</span>
   <span class="name">cube</span><span class="punctuation">[</span><span class="literal string single">'projection'</span><span class="punctuation">]</span> <span class="operator">=</span> <span class="name">glm</span><span class="operator">.</span><span class="name">perspective</span><span class="punctuation">(</span><span class="literal number float">45.0</span><span class="punctuation">,</span> <span class="name">ratio</span><span class="punctuation">,</span> <span class="literal number float">2.0</span><span class="punctuation">,</span> <span class="literal number float">100.0</span><span class="punctuation">)</span>
</pre>
<p>For the model matrix, we want the cube to rotate around its center. We do that
by compositing a rotation about the z axis (<code>theta</code>), then about the y axis (<code>phi</code>):</p>
<pre class="code python literal-block">
<span class="name">phi</span><span class="punctuation">,</span> <span class="name">theta</span> <span class="operator">=</span> <span class="literal number integer">0</span><span class="punctuation">,</span><span class="literal number integer">0</span>

<span class="name decorator">&#64;window.event</span>
<span class="keyword">def</span> <span class="name function">on_draw</span><span class="punctuation">(</span><span class="name">dt</span><span class="punctuation">):</span>
    <span class="keyword">global</span> <span class="name">phi</span><span class="punctuation">,</span> <span class="name">theta</span>
    <span class="name">window</span><span class="operator">.</span><span class="name">clear</span><span class="punctuation">()</span>
    <span class="name">cube</span><span class="operator">.</span><span class="name">draw</span><span class="punctuation">(</span><span class="name">gl</span><span class="operator">.</span><span class="name">GL_TRIANGLES</span><span class="punctuation">,</span> <span class="name">I</span><span class="punctuation">)</span>

    <span class="comment single"># Make cube rotate</span>
    <span class="name">theta</span> <span class="operator">+=</span> <span class="literal number float">1.0</span> <span class="comment single"># degrees</span>
    <span class="name">phi</span> <span class="operator">+=</span> <span class="literal number float">1.0</span> <span class="comment single"># degrees</span>
    <span class="name">model</span> <span class="operator">=</span> <span class="name">np</span><span class="operator">.</span><span class="name">eye</span><span class="punctuation">(</span><span class="literal number integer">4</span><span class="punctuation">,</span> <span class="name">dtype</span><span class="operator">=</span><span class="name">np</span><span class="operator">.</span><span class="name">float32</span><span class="punctuation">)</span>
    <span class="name">glm</span><span class="operator">.</span><span class="name">rotate</span><span class="punctuation">(</span><span class="name">model</span><span class="punctuation">,</span> <span class="name">theta</span><span class="punctuation">,</span> <span class="literal number integer">0</span><span class="punctuation">,</span> <span class="literal number integer">0</span><span class="punctuation">,</span> <span class="literal number integer">1</span><span class="punctuation">)</span>
    <span class="name">glm</span><span class="operator">.</span><span class="name">rotate</span><span class="punctuation">(</span><span class="name">model</span><span class="punctuation">,</span> <span class="name">phi</span><span class="punctuation">,</span> <span class="literal number integer">0</span><span class="punctuation">,</span> <span class="literal number integer">1</span><span class="punctuation">,</span> <span class="literal number integer">0</span><span class="punctuation">)</span>
    <span class="name">cube</span><span class="punctuation">[</span><span class="literal string single">'model'</span><span class="punctuation">]</span> <span class="operator">=</span> <span class="name">model</span>
</pre>
</div>
<div class="section" id="actual-rendering">
<h2><a class="toc-backref" href="#id15">Actual rendering</a></h2>
<div class="right figure" id="figure-movies/chapter-05/solid-cube.mp4" style="width: 35%">
<video controls="True" loop="True">
<source src="movies/chapter-05/solid-cube.mp4"></source>
</video>
<p class="caption">Figure</p>
<div class="legend">
A flat shaded rotating cube using Python, OpenGL and glumpy. The 3D aspect
may be difficult to see because of the flat shading of the cube.</div>
</div>
<p>We're now alsmost ready to render the whole scene but we need to modify the
initialization a little bit to enable depth testing:</p>
<pre class="code python literal-block">
<span class="name decorator">&#64;window.event</span>
<span class="keyword">def</span> <span class="name function">on_init</span><span class="punctuation">():</span>
    <span class="name">gl</span><span class="operator">.</span><span class="name">glEnable</span><span class="punctuation">(</span><span class="name">gl</span><span class="operator">.</span><span class="name">GL_DEPTH_TEST</span><span class="punctuation">)</span>
</pre>
<p>This is needed because we're now dealing with 3D, meaning some rendered
triangles may be behind some others. OpenGL will take care of that provided we
declared our context with a depth buffer which is the default in glumpy.</p>
<p>As previously, we'll run the program for exactly 360 frames in order to make an
endless animation:</p>
<pre class="code python literal-block">
<span class="name">app</span><span class="operator">.</span><span class="name">run</span><span class="punctuation">(</span><span class="name">framerate</span><span class="operator">=</span><span class="literal number integer">60</span><span class="punctuation">,</span> <span class="name">framecount</span><span class="operator">=</span><span class="literal number integer">360</span><span class="punctuation">)</span>
</pre>
<p>Complete source code: <a class="reference external" href="code/chapter-05/solid-cube.py">code/chapter-05/solid-cube.py</a></p>
</div>
<div class="section" id="variations">
<h2><a class="toc-backref" href="#id15">Variations</a></h2>
<div class="section" id="colored-cube">
<h3><a class="toc-backref" href="#id15">Colored cube</a></h3>
<p>The previous cube is not very interesting because we used a single color for
all the faces and this tends to hide the 3D structure. We can fix this by adding
some colors and in the process, we'll discover why <a class="reference external" href="http://glumpy.github.io">glumpy</a> is so useful. To add
color per vertex to the cube, we simply define the vertex structure as:</p>
<pre class="code python literal-block">
<span class="name">V</span> <span class="operator">=</span> <span class="name">np</span><span class="operator">.</span><span class="name">zeros</span><span class="punctuation">(</span><span class="literal number integer">8</span><span class="punctuation">,</span> <span class="punctuation">[(</span><span class="literal string double">&quot;position&quot;</span><span class="punctuation">,</span> <span class="name">np</span><span class="operator">.</span><span class="name">float32</span><span class="punctuation">,</span> <span class="literal number integer">3</span><span class="punctuation">),</span>
                 <span class="punctuation">(</span><span class="literal string double">&quot;color&quot;</span><span class="punctuation">,</span>    <span class="name">np</span><span class="operator">.</span><span class="name">float32</span><span class="punctuation">,</span> <span class="literal number integer">4</span><span class="punctuation">)])</span>
<span class="name">V</span><span class="punctuation">[</span><span class="literal string double">&quot;position&quot;</span><span class="punctuation">]</span> <span class="operator">=</span> <span class="punctuation">[[</span> <span class="literal number integer">1</span><span class="punctuation">,</span> <span class="literal number integer">1</span><span class="punctuation">,</span> <span class="literal number integer">1</span><span class="punctuation">],</span> <span class="punctuation">[</span><span class="operator">-</span><span class="literal number integer">1</span><span class="punctuation">,</span> <span class="literal number integer">1</span><span class="punctuation">,</span> <span class="literal number integer">1</span><span class="punctuation">],</span> <span class="punctuation">[</span><span class="operator">-</span><span class="literal number integer">1</span><span class="punctuation">,</span><span class="operator">-</span><span class="literal number integer">1</span><span class="punctuation">,</span> <span class="literal number integer">1</span><span class="punctuation">],</span> <span class="punctuation">[</span> <span class="literal number integer">1</span><span class="punctuation">,</span><span class="operator">-</span><span class="literal number integer">1</span><span class="punctuation">,</span> <span class="literal number integer">1</span><span class="punctuation">],</span>
                 <span class="punctuation">[</span> <span class="literal number integer">1</span><span class="punctuation">,</span><span class="operator">-</span><span class="literal number integer">1</span><span class="punctuation">,</span><span class="operator">-</span><span class="literal number integer">1</span><span class="punctuation">],</span> <span class="punctuation">[</span> <span class="literal number integer">1</span><span class="punctuation">,</span> <span class="literal number integer">1</span><span class="punctuation">,</span><span class="operator">-</span><span class="literal number integer">1</span><span class="punctuation">],</span> <span class="punctuation">[</span><span class="operator">-</span><span class="literal number integer">1</span><span class="punctuation">,</span> <span class="literal number integer">1</span><span class="punctuation">,</span><span class="operator">-</span><span class="literal number integer">1</span><span class="punctuation">],</span> <span class="punctuation">[</span><span class="operator">-</span><span class="literal number integer">1</span><span class="punctuation">,</span><span class="operator">-</span><span class="literal number integer">1</span><span class="punctuation">,</span><span class="operator">-</span><span class="literal number integer">1</span><span class="punctuation">]]</span>
<span class="name">V</span><span class="punctuation">[</span><span class="literal string double">&quot;color&quot;</span><span class="punctuation">]</span>    <span class="operator">=</span> <span class="punctuation">[[</span><span class="literal number integer">0</span><span class="punctuation">,</span> <span class="literal number integer">1</span><span class="punctuation">,</span> <span class="literal number integer">1</span><span class="punctuation">,</span> <span class="literal number integer">1</span><span class="punctuation">],</span> <span class="punctuation">[</span><span class="literal number integer">0</span><span class="punctuation">,</span> <span class="literal number integer">0</span><span class="punctuation">,</span> <span class="literal number integer">1</span><span class="punctuation">,</span> <span class="literal number integer">1</span><span class="punctuation">],</span> <span class="punctuation">[</span><span class="literal number integer">0</span><span class="punctuation">,</span> <span class="literal number integer">0</span><span class="punctuation">,</span> <span class="literal number integer">0</span><span class="punctuation">,</span> <span class="literal number integer">1</span><span class="punctuation">],</span> <span class="punctuation">[</span><span class="literal number integer">0</span><span class="punctuation">,</span> <span class="literal number integer">1</span><span class="punctuation">,</span> <span class="literal number integer">0</span><span class="punctuation">,</span> <span class="literal number integer">1</span><span class="punctuation">],</span>
                 <span class="punctuation">[</span><span class="literal number integer">1</span><span class="punctuation">,</span> <span class="literal number integer">1</span><span class="punctuation">,</span> <span class="literal number integer">0</span><span class="punctuation">,</span> <span class="literal number integer">1</span><span class="punctuation">],</span> <span class="punctuation">[</span><span class="literal number integer">1</span><span class="punctuation">,</span> <span class="literal number integer">1</span><span class="punctuation">,</span> <span class="literal number integer">1</span><span class="punctuation">,</span> <span class="literal number integer">1</span><span class="punctuation">],</span> <span class="punctuation">[</span><span class="literal number integer">1</span><span class="punctuation">,</span> <span class="literal number integer">0</span><span class="punctuation">,</span> <span class="literal number integer">1</span><span class="punctuation">,</span> <span class="literal number integer">1</span><span class="punctuation">],</span> <span class="punctuation">[</span><span class="literal number integer">1</span><span class="punctuation">,</span> <span class="literal number integer">0</span><span class="punctuation">,</span> <span class="literal number integer">0</span><span class="punctuation">,</span> <span class="literal number integer">1</span><span class="punctuation">]]</span>
</pre>
<p>And we're done ! Well, actually, we also need to slightly modify the vertex
shader since color is now an attribute that needs to be passed to the fragment
shader.</p>
<pre class="code glsl literal-block">
<span class="name">vertex</span> <span class="operator">=</span> <span class="error">&quot;&quot;&quot;</span>
<span class="keyword">uniform</span> <span class="keyword type">mat4</span>   <span class="name">model</span><span class="punctuation">;</span>         <span class="comment single">// Model matrix</span>
<span class="keyword">uniform</span> <span class="keyword type">mat4</span>   <span class="name">view</span><span class="punctuation">;</span>          <span class="comment single">// View matrix</span>
<span class="keyword">uniform</span> <span class="keyword type">mat4</span>   <span class="name">projection</span><span class="punctuation">;</span>    <span class="comment single">// Projection matrix</span>
<span class="keyword">attribute</span> <span class="keyword type">vec4</span> <span class="name">color</span><span class="punctuation">;</span>         <span class="comment single">// Vertex color</span>
<span class="keyword">attribute</span> <span class="keyword type">vec3</span> <span class="name">position</span><span class="punctuation">;</span>      <span class="comment single">// Vertex position</span>
<span class="keyword">varying</span> <span class="keyword type">vec4</span>   <span class="name">v_color</span><span class="punctuation">;</span>       <span class="comment single">// Interpolated fragment color (out)</span>
<span class="keyword type">void</span> <span class="name">main</span><span class="punctuation">()</span>
<span class="punctuation">{</span>
    <span class="name">v_color</span> <span class="operator">=</span> <span class="name">color</span><span class="punctuation">;</span>
    <span class="name builtin">gl_Position</span> <span class="operator">=</span> <span class="name">projection</span> <span class="operator">*</span> <span class="name">view</span> <span class="operator">*</span> <span class="name">model</span> <span class="operator">*</span> <span class="keyword type">vec4</span><span class="punctuation">(</span><span class="name">position</span><span class="punctuation">,</span><span class="literal number float">1.0</span><span class="punctuation">);</span>
<span class="punctuation">}</span> <span class="error">&quot;&quot;&quot;</span>

<span class="name">fragment</span> <span class="operator">=</span> <span class="error">&quot;&quot;&quot;</span>
<span class="keyword">varying</span> <span class="keyword type">vec4</span> <span class="name">v_color</span><span class="punctuation">;</span>         <span class="comment single">// Interpolated fragment color (in)</span>
<span class="keyword type">void</span> <span class="name">main</span><span class="punctuation">()</span>
<span class="punctuation">{</span>
    <span class="name builtin">gl_FragColor</span> <span class="operator">=</span> <span class="name">v_color</span><span class="punctuation">;</span>
<span class="punctuation">}</span> <span class="error">&quot;&quot;&quot;</span>
</pre>
<div class="right figure" id="figure-movies/chapter-05/color-cube.mp4" style="width: 35%">
<video controls="True" loop="True">
<source src="movies/chapter-05/color-cube.mp4"></source>
</video>
<p class="caption">Figure</p>
<div class="legend">
The RGB rotating cube</div>
</div>
<p>Furthermore, since our vertex buffer fields corresponds exactly to program
attributes, we can directly bind it:</p>
<pre class="code python literal-block">
<span class="name">cube</span> <span class="operator">=</span> <span class="name">gloo</span><span class="operator">.</span><span class="name">Program</span><span class="punctuation">(</span><span class="name">vertex</span><span class="punctuation">,</span> <span class="name">fragment</span><span class="punctuation">)</span>
<span class="name">cube</span><span class="operator">.</span><span class="name">bind</span><span class="punctuation">(</span><span class="name">V</span><span class="punctuation">)</span>
</pre>
<p>But we could also have written</p>
<pre class="code python literal-block">
<span class="name">cube</span> <span class="operator">=</span> <span class="name">gloo</span><span class="operator">.</span><span class="name">Program</span><span class="punctuation">(</span><span class="name">vertex</span><span class="punctuation">,</span> <span class="name">fragment</span><span class="punctuation">)</span>
<span class="name">cube</span><span class="punctuation">[</span><span class="literal string double">&quot;position&quot;</span><span class="punctuation">]</span> <span class="operator">=</span> <span class="name">V</span><span class="punctuation">[</span><span class="literal string double">&quot;position&quot;</span><span class="punctuation">]</span>
<span class="name">cube</span><span class="punctuation">[</span><span class="literal string double">&quot;color&quot;</span><span class="punctuation">]</span> <span class="operator">=</span> <span class="name">V</span><span class="punctuation">[</span><span class="literal string double">&quot;color&quot;</span><span class="punctuation">]</span>
</pre>
<p>Complete source code: <a class="reference external" href="code/chapter-05/color-cube.py">code/chapter-05/color-cube.py</a></p>
</div>
<div class="section" id="outlined-cube">
<h3><a class="toc-backref" href="#id15">Outlined cube</a></h3>
<div class="right figure" id="figure-movies/chapter-05/outline-cube.mp4" style="width: 35%">
<video controls="True" loop="True">
<source src="movies/chapter-05/outline-cube.mp4"></source>
</video>
<p class="caption">Figure</p>
<div class="legend">
An outlined colored cube using <code>GL_POLYGON_OFFSET_FILL</code> that allows to draw
coincident surfaces properly.</div>
</div>
<p>We can make the cube a bit nicer by outlining it using black lines. To outline
the cube, we need to draw lines between pairs of vertices on each face. 4
lines for the back and front face and 2 lines for the top and bottom faces. Why
only 2 lines for top and bottom? Because lines are shared between the
faces. So overall we need 12 lines and we need to compute the corresponding
indices (I did it for you):</p>
<pre class="code python literal-block">
<span class="name">O</span> <span class="operator">=</span> <span class="name">np</span><span class="operator">.</span><span class="name">array</span><span class="punctuation">([</span><span class="literal number integer">0</span><span class="punctuation">,</span><span class="literal number integer">1</span><span class="punctuation">,</span> <span class="literal number integer">1</span><span class="punctuation">,</span><span class="literal number integer">2</span><span class="punctuation">,</span> <span class="literal number integer">2</span><span class="punctuation">,</span><span class="literal number integer">3</span><span class="punctuation">,</span> <span class="literal number integer">3</span><span class="punctuation">,</span><span class="literal number integer">0</span><span class="punctuation">,</span>
     <span class="literal number integer">4</span><span class="punctuation">,</span><span class="literal number integer">7</span><span class="punctuation">,</span> <span class="literal number integer">7</span><span class="punctuation">,</span><span class="literal number integer">6</span><span class="punctuation">,</span> <span class="literal number integer">6</span><span class="punctuation">,</span><span class="literal number integer">5</span><span class="punctuation">,</span> <span class="literal number integer">5</span><span class="punctuation">,</span><span class="literal number integer">4</span><span class="punctuation">,</span>
     <span class="literal number integer">0</span><span class="punctuation">,</span><span class="literal number integer">5</span><span class="punctuation">,</span> <span class="literal number integer">1</span><span class="punctuation">,</span><span class="literal number integer">6</span><span class="punctuation">,</span> <span class="literal number integer">2</span><span class="punctuation">,</span><span class="literal number integer">7</span><span class="punctuation">,</span> <span class="literal number integer">3</span><span class="punctuation">,</span><span class="literal number integer">4</span> <span class="punctuation">],</span> <span class="name">dtype</span><span class="operator">=</span><span class="name">np</span><span class="operator">.</span><span class="name">uint32</span><span class="punctuation">)</span>
<span class="name">O</span> <span class="operator">=</span> <span class="name">O</span><span class="operator">.</span><span class="name">view</span><span class="punctuation">(</span><span class="name">gloo</span><span class="operator">.</span><span class="name">IndexBuffer</span><span class="punctuation">)</span>
</pre>
<p>We then need to draw the cube twice. One time using triangles and the indices
index buffer and one time using lines with the outline index buffer.  We need
also to add some OpenGL black magic to make things nice. It's not very
important to understand it at this point but roughly the idea to make sure lines
are drawn &quot;above&quot; the cube because we paint a line on a surface:</p>
<hr class="docutils" />
<pre class="code python literal-block">
<span class="name decorator">&#64;window.event</span>
<span class="keyword">def</span> <span class="name function">on_draw</span><span class="punctuation">(</span><span class="name">dt</span><span class="punctuation">):</span>
    <span class="keyword">global</span> <span class="name">phi</span><span class="punctuation">,</span> <span class="name">theta</span><span class="punctuation">,</span> <span class="name">duration</span>

    <span class="name">window</span><span class="operator">.</span><span class="name">clear</span><span class="punctuation">()</span>

    <span class="comment single"># Filled cube</span>
    <span class="name">gl</span><span class="operator">.</span><span class="name">glDisable</span><span class="punctuation">(</span><span class="name">gl</span><span class="operator">.</span><span class="name">GL_BLEND</span><span class="punctuation">)</span>
    <span class="name">gl</span><span class="operator">.</span><span class="name">glEnable</span><span class="punctuation">(</span><span class="name">gl</span><span class="operator">.</span><span class="name">GL_DEPTH_TEST</span><span class="punctuation">)</span>
    <span class="name">gl</span><span class="operator">.</span><span class="name">glEnable</span><span class="punctuation">(</span><span class="name">gl</span><span class="operator">.</span><span class="name">GL_POLYGON_OFFSET_FILL</span><span class="punctuation">)</span>
    <span class="name">cube</span><span class="punctuation">[</span><span class="literal string single">'ucolor'</span><span class="punctuation">]</span> <span class="operator">=</span> <span class="operator">.</span><span class="literal number integer">75</span><span class="punctuation">,</span> <span class="operator">.</span><span class="literal number integer">75</span><span class="punctuation">,</span> <span class="operator">.</span><span class="literal number integer">75</span><span class="punctuation">,</span> <span class="literal number integer">1</span>
    <span class="name">cube</span><span class="operator">.</span><span class="name">draw</span><span class="punctuation">(</span><span class="name">gl</span><span class="operator">.</span><span class="name">GL_TRIANGLES</span><span class="punctuation">,</span> <span class="name">I</span><span class="punctuation">)</span>

    <span class="comment single"># Outlined cube</span>
    <span class="name">gl</span><span class="operator">.</span><span class="name">glDisable</span><span class="punctuation">(</span><span class="name">gl</span><span class="operator">.</span><span class="name">GL_POLYGON_OFFSET_FILL</span><span class="punctuation">)</span>
    <span class="name">gl</span><span class="operator">.</span><span class="name">glEnable</span><span class="punctuation">(</span><span class="name">gl</span><span class="operator">.</span><span class="name">GL_BLEND</span><span class="punctuation">)</span>
    <span class="name">gl</span><span class="operator">.</span><span class="name">glDepthMask</span><span class="punctuation">(</span><span class="name">gl</span><span class="operator">.</span><span class="name">GL_FALSE</span><span class="punctuation">)</span>
    <span class="name">cube</span><span class="punctuation">[</span><span class="literal string single">'ucolor'</span><span class="punctuation">]</span> <span class="operator">=</span> <span class="literal number integer">0</span><span class="punctuation">,</span> <span class="literal number integer">0</span><span class="punctuation">,</span> <span class="literal number integer">0</span><span class="punctuation">,</span> <span class="literal number integer">1</span>
    <span class="name">cube</span><span class="operator">.</span><span class="name">draw</span><span class="punctuation">(</span><span class="name">gl</span><span class="operator">.</span><span class="name">GL_LINES</span><span class="punctuation">,</span> <span class="name">O</span><span class="punctuation">)</span>
    <span class="name">gl</span><span class="operator">.</span><span class="name">glDepthMask</span><span class="punctuation">(</span><span class="name">gl</span><span class="operator">.</span><span class="name">GL_TRUE</span><span class="punctuation">)</span>

    <span class="comment single"># Rotate cube</span>
    <span class="name">theta</span> <span class="operator">+=</span> <span class="literal number float">1.0</span> <span class="comment single"># degrees</span>
    <span class="name">phi</span> <span class="operator">+=</span> <span class="literal number float">1.0</span> <span class="comment single"># degrees</span>
    <span class="name">model</span> <span class="operator">=</span> <span class="name">np</span><span class="operator">.</span><span class="name">eye</span><span class="punctuation">(</span><span class="literal number integer">4</span><span class="punctuation">,</span> <span class="name">dtype</span><span class="operator">=</span><span class="name">np</span><span class="operator">.</span><span class="name">float32</span><span class="punctuation">)</span>
    <span class="name">glm</span><span class="operator">.</span><span class="name">rotate</span><span class="punctuation">(</span><span class="name">model</span><span class="punctuation">,</span> <span class="name">theta</span><span class="punctuation">,</span> <span class="literal number integer">0</span><span class="punctuation">,</span> <span class="literal number integer">0</span><span class="punctuation">,</span> <span class="literal number integer">1</span><span class="punctuation">)</span>
    <span class="name">glm</span><span class="operator">.</span><span class="name">rotate</span><span class="punctuation">(</span><span class="name">model</span><span class="punctuation">,</span> <span class="name">phi</span><span class="punctuation">,</span> <span class="literal number integer">0</span><span class="punctuation">,</span> <span class="literal number integer">1</span><span class="punctuation">,</span> <span class="literal number integer">0</span><span class="punctuation">)</span>
    <span class="name">cube</span><span class="punctuation">[</span><span class="literal string single">'model'</span><span class="punctuation">]</span> <span class="operator">=</span> <span class="name">model</span>
</pre>
<p>Complete source code: <a class="reference external" href="code/chapter-05/outlined-cube.py">code/chapter-05/outlined-cube.py</a></p>
</div>
<div class="section" id="textured-cube">
<h3><a class="toc-backref" href="#id15">Textured cube</a></h3>
<div class="right figure" id="figure-movies/chapter-05/texture-cube.mp4" style="width: 35%">
<video controls="True" loop="True">
<source src="movies/chapter-05/texture-cube.mp4"></source>
</video>
<p class="caption">Figure</p>
<div class="legend">
A textured cube.</div>
</div>
<p>For making a textured cube, we need a texture (a.k.a. an image) and some
coordinates to tell OpenGL how to map it to the cube faces. Texture coordinates
are normalized and should be inside the [0,1] range (actually, texture
coordinates can be pretty much anything but for the sake of simplicity, we'll
stick to the [0,1] range). Since we are displaying a cube, we'll use one
texture per side and the texture coordinates are quite easy to define: [0,0],
[0,1], [1,0] and [1,1]. Of course, we have to take care of assigning the right
texture coordinates to the right vertex or you texture will be messed up.</p>
<p>Furthemore, we'll need some extra work because we cannot share anymore our
vertices between faces since they won't share their texture coordinates. We
thus need to have a set of 24 vertices (6 faces × 4 vertices). We'll use the
dedicated function below that will take care of generating the right texture
coordinates.</p>
<hr class="docutils" />
<pre class="code python literal-block">
<span class="keyword">def</span> <span class="name function">cube</span><span class="punctuation">():</span>
    <span class="name">vtype</span> <span class="operator">=</span> <span class="punctuation">[(</span><span class="literal string single">'position'</span><span class="punctuation">,</span> <span class="name">np</span><span class="operator">.</span><span class="name">float32</span><span class="punctuation">,</span> <span class="literal number integer">3</span><span class="punctuation">),</span>
             <span class="punctuation">(</span><span class="literal string single">'texcoord'</span><span class="punctuation">,</span> <span class="name">np</span><span class="operator">.</span><span class="name">float32</span><span class="punctuation">,</span> <span class="literal number integer">2</span><span class="punctuation">)]</span>
    <span class="name">itype</span> <span class="operator">=</span> <span class="name">np</span><span class="operator">.</span><span class="name">uint32</span>

    <span class="comment single"># Vertices positions</span>
    <span class="name">p</span> <span class="operator">=</span> <span class="name">np</span><span class="operator">.</span><span class="name">array</span><span class="punctuation">([[</span><span class="literal number integer">1</span><span class="punctuation">,</span> <span class="literal number integer">1</span><span class="punctuation">,</span> <span class="literal number integer">1</span><span class="punctuation">],</span> <span class="punctuation">[</span><span class="operator">-</span><span class="literal number integer">1</span><span class="punctuation">,</span> <span class="literal number integer">1</span><span class="punctuation">,</span> <span class="literal number integer">1</span><span class="punctuation">],</span> <span class="punctuation">[</span><span class="operator">-</span><span class="literal number integer">1</span><span class="punctuation">,</span> <span class="operator">-</span><span class="literal number integer">1</span><span class="punctuation">,</span> <span class="literal number integer">1</span><span class="punctuation">],</span> <span class="punctuation">[</span><span class="literal number integer">1</span><span class="punctuation">,</span> <span class="operator">-</span><span class="literal number integer">1</span><span class="punctuation">,</span> <span class="literal number integer">1</span><span class="punctuation">],</span>
                  <span class="punctuation">[</span><span class="literal number integer">1</span><span class="punctuation">,</span> <span class="operator">-</span><span class="literal number integer">1</span><span class="punctuation">,</span> <span class="operator">-</span><span class="literal number integer">1</span><span class="punctuation">],</span> <span class="punctuation">[</span><span class="literal number integer">1</span><span class="punctuation">,</span> <span class="literal number integer">1</span><span class="punctuation">,</span> <span class="operator">-</span><span class="literal number integer">1</span><span class="punctuation">],</span> <span class="punctuation">[</span><span class="operator">-</span><span class="literal number integer">1</span><span class="punctuation">,</span> <span class="literal number integer">1</span><span class="punctuation">,</span> <span class="operator">-</span><span class="literal number integer">1</span><span class="punctuation">],</span> <span class="punctuation">[</span><span class="operator">-</span><span class="literal number integer">1</span><span class="punctuation">,</span> <span class="operator">-</span><span class="literal number integer">1</span><span class="punctuation">,</span> <span class="operator">-</span><span class="literal number integer">1</span><span class="punctuation">]],</span>
                  <span class="name">dtype</span><span class="operator">=</span><span class="name builtin">float</span><span class="punctuation">)</span>

    <span class="comment single"># Texture coords</span>
    <span class="name">t</span> <span class="operator">=</span> <span class="name">np</span><span class="operator">.</span><span class="name">array</span><span class="punctuation">([[</span><span class="literal number integer">0</span><span class="punctuation">,</span> <span class="literal number integer">0</span><span class="punctuation">],</span> <span class="punctuation">[</span><span class="literal number integer">0</span><span class="punctuation">,</span> <span class="literal number integer">1</span><span class="punctuation">],</span> <span class="punctuation">[</span><span class="literal number integer">1</span><span class="punctuation">,</span> <span class="literal number integer">1</span><span class="punctuation">],</span> <span class="punctuation">[</span><span class="literal number integer">1</span><span class="punctuation">,</span> <span class="literal number integer">0</span><span class="punctuation">]])</span>

    <span class="name">faces_p</span> <span class="operator">=</span> <span class="punctuation">[</span><span class="literal number integer">0</span><span class="punctuation">,</span> <span class="literal number integer">1</span><span class="punctuation">,</span> <span class="literal number integer">2</span><span class="punctuation">,</span> <span class="literal number integer">3</span><span class="punctuation">,</span>  <span class="literal number integer">0</span><span class="punctuation">,</span> <span class="literal number integer">3</span><span class="punctuation">,</span> <span class="literal number integer">4</span><span class="punctuation">,</span> <span class="literal number integer">5</span><span class="punctuation">,</span>   <span class="literal number integer">0</span><span class="punctuation">,</span> <span class="literal number integer">5</span><span class="punctuation">,</span> <span class="literal number integer">6</span><span class="punctuation">,</span> <span class="literal number integer">1</span><span class="punctuation">,</span>
               <span class="literal number integer">1</span><span class="punctuation">,</span> <span class="literal number integer">6</span><span class="punctuation">,</span> <span class="literal number integer">7</span><span class="punctuation">,</span> <span class="literal number integer">2</span><span class="punctuation">,</span>  <span class="literal number integer">7</span><span class="punctuation">,</span> <span class="literal number integer">4</span><span class="punctuation">,</span> <span class="literal number integer">3</span><span class="punctuation">,</span> <span class="literal number integer">2</span><span class="punctuation">,</span>   <span class="literal number integer">4</span><span class="punctuation">,</span> <span class="literal number integer">7</span><span class="punctuation">,</span> <span class="literal number integer">6</span><span class="punctuation">,</span> <span class="literal number integer">5</span><span class="punctuation">]</span>
    <span class="name">faces_t</span> <span class="operator">=</span> <span class="punctuation">[</span><span class="literal number integer">0</span><span class="punctuation">,</span> <span class="literal number integer">1</span><span class="punctuation">,</span> <span class="literal number integer">2</span><span class="punctuation">,</span> <span class="literal number integer">3</span><span class="punctuation">,</span>  <span class="literal number integer">0</span><span class="punctuation">,</span> <span class="literal number integer">1</span><span class="punctuation">,</span> <span class="literal number integer">2</span><span class="punctuation">,</span> <span class="literal number integer">3</span><span class="punctuation">,</span>   <span class="literal number integer">0</span><span class="punctuation">,</span> <span class="literal number integer">1</span><span class="punctuation">,</span> <span class="literal number integer">2</span><span class="punctuation">,</span> <span class="literal number integer">3</span><span class="punctuation">,</span>
               <span class="literal number integer">3</span><span class="punctuation">,</span> <span class="literal number integer">2</span><span class="punctuation">,</span> <span class="literal number integer">1</span><span class="punctuation">,</span> <span class="literal number integer">0</span><span class="punctuation">,</span>  <span class="literal number integer">0</span><span class="punctuation">,</span> <span class="literal number integer">1</span><span class="punctuation">,</span> <span class="literal number integer">2</span><span class="punctuation">,</span> <span class="literal number integer">3</span><span class="punctuation">,</span>   <span class="literal number integer">0</span><span class="punctuation">,</span> <span class="literal number integer">1</span><span class="punctuation">,</span> <span class="literal number integer">2</span><span class="punctuation">,</span> <span class="literal number integer">3</span><span class="punctuation">]</span>

    <span class="name">vertices</span> <span class="operator">=</span> <span class="name">np</span><span class="operator">.</span><span class="name">zeros</span><span class="punctuation">(</span><span class="literal number integer">24</span><span class="punctuation">,</span> <span class="name">vtype</span><span class="punctuation">)</span>
    <span class="name">vertices</span><span class="punctuation">[</span><span class="literal string single">'position'</span><span class="punctuation">]</span> <span class="operator">=</span> <span class="name">p</span><span class="punctuation">[</span><span class="name">faces_p</span><span class="punctuation">]</span>
    <span class="name">vertices</span><span class="punctuation">[</span><span class="literal string single">'texcoord'</span><span class="punctuation">]</span> <span class="operator">=</span> <span class="name">t</span><span class="punctuation">[</span><span class="name">faces_t</span><span class="punctuation">]</span>

    <span class="name">filled</span> <span class="operator">=</span> <span class="name">np</span><span class="operator">.</span><span class="name">resize</span><span class="punctuation">(</span>
       <span class="name">np</span><span class="operator">.</span><span class="name">array</span><span class="punctuation">([</span><span class="literal number integer">0</span><span class="punctuation">,</span> <span class="literal number integer">1</span><span class="punctuation">,</span> <span class="literal number integer">2</span><span class="punctuation">,</span> <span class="literal number integer">0</span><span class="punctuation">,</span> <span class="literal number integer">2</span><span class="punctuation">,</span> <span class="literal number integer">3</span><span class="punctuation">],</span> <span class="name">dtype</span><span class="operator">=</span><span class="name">itype</span><span class="punctuation">),</span> <span class="literal number integer">6</span> <span class="operator">*</span> <span class="punctuation">(</span><span class="literal number integer">2</span> <span class="operator">*</span> <span class="literal number integer">3</span><span class="punctuation">))</span>
    <span class="name">filled</span> <span class="operator">+=</span> <span class="name">np</span><span class="operator">.</span><span class="name">repeat</span><span class="punctuation">(</span><span class="literal number integer">4</span> <span class="operator">*</span> <span class="name">np</span><span class="operator">.</span><span class="name">arange</span><span class="punctuation">(</span><span class="literal number integer">6</span><span class="punctuation">,</span> <span class="name">dtype</span><span class="operator">=</span><span class="name">itype</span><span class="punctuation">),</span> <span class="literal number integer">6</span><span class="punctuation">)</span>

    <span class="name">vertices</span> <span class="operator">=</span> <span class="name">vertices</span><span class="operator">.</span><span class="name">view</span><span class="punctuation">(</span><span class="name">gloo</span><span class="operator">.</span><span class="name">VertexBuffer</span><span class="punctuation">)</span>
    <span class="name">filled</span>   <span class="operator">=</span> <span class="name">filled</span><span class="operator">.</span><span class="name">view</span><span class="punctuation">(</span><span class="name">gloo</span><span class="operator">.</span><span class="name">IndexBuffer</span><span class="punctuation">)</span>

    <span class="keyword">return</span> <span class="name">vertices</span><span class="punctuation">,</span> <span class="name">filled</span>
</pre>
<p>Now, inside the fragment shader, we have access to the texture:</p>
<pre class="code literal-block">
vertex = &quot;&quot;&quot;
uniform mat4   model;      // Model matrix
uniform mat4   view;       // View matrix
uniform mat4   projection; // Projection matrix
attribute vec3 position;   // Vertex position
attribute vec2 texcoord;   // Vertex texture coordinates
varying vec2   v_texcoord;   // Interpolated fragment texture coordinates (out)

void main()
{
    // Assign varying variables
    v_texcoord  = texcoord;

    // Final position
    gl_Position = projection * view * model * vec4(position,1.0);
} &quot;&quot;&quot;


fragment = &quot;&quot;&quot;
uniform sampler2D texture; // Texture
varying vec2 v_texcoord;   // Interpolated fragment texture coordinates (in)
void main()
{
    // Get texture color
    gl_FragColor = texture2D(texture, v_texcoord);
} &quot;&quot;&quot;
</pre>
<p>Complete source code: <a class="reference external" href="code/chapter-05/textured-cube.py">code/chapter-05/textured-cube.py</a></p>
</div>
</div>
<div class="section" id="id16">
<h2><a class="toc-backref" href="#id15">Exercises</a></h2>
<div class="right figure" id="figure-movies/chapter-05/color-border-cube-1.mp4" style="width: 35%">
<video controls="True" loop="True">
<source src="movies/chapter-05/color-border-cube-1.mp4"></source>
</video>
<p class="caption">Figure</p>
<div class="legend">
An outlined cube where outline is computed from within the shader.</div>
</div>
<p><strong>Shader outline</strong> We've seen in the section <a class="reference internal" href="#outlined-cube">outlined cube</a> how to draw a
thin line around the cube to enhance its shape. For this, we drew the cube
twice, one for the cube itself and a second time for the outline. However, it
is possible to get more or less the same results from within the shader in a
single pass. The trick is to pass the (untransformed) position from the vertex
shader to the fragment shader and to use this information to set the color of
the fragment to either the black color or the v_color. Starting from the <a class="reference external" href="code/chapter-05/color-cube.py">color
cube code</a>, try to modify only the shader code
(both vertex and fragment) to achieve the result on the right.</p>
<p><strong>Solution</strong>: <a class="reference external" href="code/chapter-05/border-cube.py">code/chapter-05/border-cube.py</a></p>
<hr class="docutils" />
<div class="right figure" id="figure-movies/chapter-05/color-border-cube-2.mp4" style="width: 35%">
<video controls="True" loop="True">
<source src="movies/chapter-05/color-border-cube-2.mp4"></source>
</video>
<p class="caption">Figure</p>
<div class="legend">
An outlined hollow cube computed from within the shader.</div>
</div>
<p><strong>Hollow cube</strong> We can play a bit more with the shader and try to draw only a
thick border surrounded by black outline. For the &quot;transparent&quot; part, you'll
need to use the <code>discard</code> instruction from within the fragment shader that
instructs OpenGL to not display the fragment at all and to terminate the
program from this shader. Since nothing will be rendered, there is no need to
process the rest of program.</p>
<p><strong>Solution</strong>: <a class="reference external" href="code/chapter-05/hollow-cube.py">code/chapter-05/hollow-cube.py</a></p>
<hr class="docutils" />
<!-- - - - Links - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -->
<!-- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -->
</div>
</div>
<div class="section" id="anti-grain-geometry">
<h1><a class="toc-backref" href="#contents">Anti-grain geometry</a></h1>
<div class="contents toc chapter-06 local topic" id="id25">
<p class="topic-title first">.</p>
<ul class="simple">
<li><a class="reference internal" href="#antialiasing" id="id174">Antialiasing</a><ul>
<li><a class="reference internal" href="#sample-based-methods" id="id175">Sample based methods</a></li>
<li><a class="reference internal" href="#coverage-methods" id="id176">Coverage methods</a></li>
</ul>
</li>
<li><a class="reference internal" href="#signed-distance-fields" id="id177">Signed distance fields</a><ul>
<li><a class="reference internal" href="#signed-distance-function" id="id178">Signed distance function</a></li>
<li><a class="reference internal" href="#geometrical-primitives" id="id179">Geometrical primitives</a></li>
</ul>
</li>
<li><a class="reference internal" href="#distance-based-anti-aliasing" id="id180">Distance based anti-aliasing</a></li>
</ul>
</div>
<img alt="images/chapter-06/mcseem.jpg" class="right" src="images/chapter-06/mcseem.jpg" style="width: 20%;" />
<p>The late Maxim Shemanarev (1966-2013) designed the <a class="reference external" href="http://www.antigrain.com/">anti-grain</a> library, a
(very) high quality rendering engine written in C++. The library is both nicely
written (one of the best C++ library I've seen with the <a class="reference external" href="http://eigen.tuxfamily.org/">Eigen</a> library) and
heavily documented, but the strongest feature is the quality of the rendering
output that is probably one of the best, even 10 years after the library has
been released (have look at the <a class="reference external" href="http://www.antigrain.com/demo/">demos</a>). This is the level of quality we target
in this book. However, OpenGL anti-aliasing techniques (even latest ones) won't
do the job and we'll need to take care of pretty much everything.</p>
<div class="section" id="antialiasing">
<h2><a class="toc-backref" href="#id25">Antialiasing</a></h2>
<div class="right figure" id="figure-images/chapter-06/circle-aa-none.png" style="width: 50%">
<img alt="images/chapter-06/circle-aa-none.png" src="images/chapter-06/circle-aa-none.png" />
<p class="caption">Figure</p>
<div class="legend">
Rendering of a non-aliased disc. Even if the center of a pixel is very close
to the shape but oustide, the associated pixel is not painted as shown for
the thick black square.</div>
</div>
<p>Aliasing is a well known problem in signal processing where it can occur in
time (temporal aliasing) or in space (spatial aliasing). In computer graphics,
we're mostly interested in spatial aliasing (such a <a class="reference external" href="https://en.wikipedia.org/wiki/Moiré_pattern">Moiré pattern</a> or
<a class="reference external" href="https://en.wikipedia.org/wiki/Jaggies">jaggies</a>) and the way to attenuate it.  Let's first examine the origin of the
problem from a practical point of view (have a look at wikipedia for the
<a class="reference external" href="https://en.wikipedia.org/wiki/Aliasing">background theory</a>).</p>
<p>The figure on the right illustrates the problem when we want to render a disc
onto a small area. The very first thing to be noticed is that pixels are
<strong>not</strong> mathematical points and the center of the pixel is usually associated
with the center of the pixel. This means that if we consider a pair of integer
coordinates <code>(i,j)</code>, then <code>(i+Δx, j+Δy)</code> designates the same pixel (with <code>-0.5
&lt; Δx, Δy &lt; 0.5</code>).  In order to rasterize the mathematical description of our
circle (center and radius), the rasterizer examines the center of each pixel to
determine if it falls inside or outside the shape. The result is illustrated on
the right part of the figure. Even if the center of a pixel is very close but
outside of the circle, it is not painted as it is shown for the thicker square
on the figure. More generally, without anti-aliasing, a pixel will be only on
(inside) or off (outside), leading to very hard jagged edges and a very
approximate shape for small sizes as well.</p>
<div class="section" id="sample-based-methods">
<h3><a class="toc-backref" href="#id25">Sample based methods</a></h3>
<div class="right figure" id="figure-images/chapter-06/circle-aa-multisample.png" style="width: 45%">
<img alt="images/chapter-06/circle-aa-multisample.png" src="images/chapter-06/circle-aa-multisample.png" />
<p class="caption">Figure</p>
<div class="legend">
Rendering of a disc using multisample anti-aliasing. By mutisampling the
same pixel, the edge can be rendered smoother. The thick black square pixel
that was previously considered outside the shape can not be considered
half-outside (2 samples outside) and half-inside (2 samples inside).</div>
</div>
<p>One of the simplest method to remove antialising consists in using several
samples to estimate the final color of a fragment. Instead of only considering
the center of the pixel, one case use several samples over the whole surface of
a pixel in order to have a better estimate as shown on the figure on the
right. A fragment that was previously considered outside, based on its center
only, can now be considered half inside / half outside. This multi-sampling
helps to attenuate the jagged edges we've seen in the previous section. On the
figure, we used a very simple and straightforward multi-sample method,
assigning fixed and equidistant locations for the four subsamples. There exist
however better methods for multi-sampling as shown by the impressive list of
sample based antialiasing techniques:</p>
<ul class="simple">
<li><a class="reference external" href="https://en.wikipedia.org/wiki/Supersampling">SSAA</a>: Supersampling antialiasing</li>
<li><a class="reference external" href="https://en.wikipedia.org/wiki/Multisample_anti-aliasing">MSAA</a>: Multisample antialiasing</li>
<li><a class="reference external" href="https://en.wikipedia.org/wiki/Supersampling">FSAA</a>: Full screen anti-aliasing</li>
<li><a class="reference external" href="https://en.wikipedia.org/wiki/Fast_approximate_anti-aliasing">FXAA</a>: Fast approximate antialiasing</li>
<li><a class="reference external" href="http://www.iryoku.com/smaa/">SMAA</a>: Subpixel morphological antialiasing</li>
<li><a class="reference external" href="http://and.intercon.ru/releases/talks/dlaagdc2011/slides/">DLAA</a>: Directionally localized antialiasing</li>
<li><a class="reference external" href="https://www.gamedev.net/forums/topic/580517-nfaa---a-post-process-anti-aliasing-filter-results-implementation-details/">NFAA</a>: Normal filter antialiasing</li>
<li><a class="reference external" href="http://www.nvidia.com/object/feature_hraa.html">HRAA</a>: High-Resolution antialiasing</li>
<li><a class="reference external" href="https://www.geforce.com/hardware/technology/txaa">TXAA</a>: Temporal antialiasing</li>
<li><a class="reference external" href="http://www.anandtech.com/show/4061/amds-radeon-hd-6970-radeon-hd-6950/10">EQAA</a>: Enhanced quality at-prntialiasing</li>
<li><a class="reference external" href="http://www.anandtech.com/show/2116/9">CSAA</a>: Coverage Sample antialiasing</li>
</ul>
<p>Depending on the performance you need to achieve (in terms of rendering quality
and speed) one method might be better than the other. However, you cannot
expect to achieve top quality due to inherent limitations of all these
methods. If they are great for real-time rendering such as video games (and
some of them are really good), they are hardly sufficient for any scientific
visualization as illustrated on the figure below.</p>
<div class="right figure" id="figure-images/chapter-06/ssaa-sdf.png" style="width: 100%">
<img alt="images/chapter-06/ssaa-sdf.png" src="images/chapter-06/ssaa-sdf.png" />
<p class="caption">Figure</p>
<div class="legend">
Supersampling applied to a rasterized triangle, using various sub-pixel
patterns. The more samples , the better the output but even using 64
samples, the rendering quality does not match the SDF rendering, especially
if you consider triangle sharp vertices.  Supersampled triangles have been
rendered using a dedicated shader (see <a class="reference external" href="code/chapter-06/triangle-ssaa.py">code/chapter-06/triangle-ssaa.py</a>) and the
SDF triangle has been rendered using a fake signed-distance triangle
function (see below) and a stroke anti-alias function (see
<a class="reference external" href="code/chapter-06/triangle-sdf.py">code/chapter-06/triangle-sdf.py</a>)</div>
</div>
<p>This is the reason why we won't use them in the rest of this book. If you want
more details on these techniques, you can have a look at this reddit discussion
explaining <a class="reference external" href="https://www.reddit.com/r/Games/comments/1rb964/antialiasing_modes_explained/">antialiasing modes</a> or this nice <a class="reference external" href="https://mynameismjp.wordpress.com/2012/10/24/msaa-overview/">overview of MSAA</a></p>
</div>
<div class="section" id="coverage-methods">
<h3><a class="toc-backref" href="#id25">Coverage methods</a></h3>
<div class="right figure" id="figure-images/chapter-06/circle-aa-exact.png" style="width: 50%">
<img alt="images/chapter-06/circle-aa-exact.png" src="images/chapter-06/circle-aa-exact.png" />
<p class="caption">Figure</p>
<div class="legend">
Rendering of a disc using exact coverage anti-aliasing.</div>
</div>
<p>Another approach for anti-aliasing is to compute the exact coverage of a shape
over each pixel surface as shown on the figure on the right. To do so, we need
of course to know precisely the shape we want to display and where it is
located in order to compute the coverage of the shape onto the pixel grid. On
the image, this corresponds to the grey areas that give us direct access to the
final color of the pixel (more precisely, the percentage of the color we have
to mix with the background color or any other object in the vicinity).
Unfortunately, such method is not possible to enforce in a full 3D scene
because all the transformations and different occlusions would make the
computation of the final shape too complex. In two dimensions however, this is
probably the best method we can use and this is also the method that is used in
the <a class="reference external" href="http://www.antigrain.com/doc/introduction/introduction.agdoc.html">Anti-grain geometry</a> library
that constitutes the quality standard we aim at.</p>
<div class="right figure" id="figure-images/chapter-06/coverage.png" style="width: 40%">
<img alt="images/chapter-06/coverage.png" src="images/chapter-06/coverage.png" />
<p class="caption">Figure</p>
<div class="legend">
Actual versus approximated coverage.</div>
</div>
<p>But even in 2D, computing the exact coverage of the shape over the different
pixels can become rapidly a complex and slow task. One way to greatly simplify
the problem is to consider pixel to be round (instead of square or
rectangle). With such asumption, we only need to compute the distance from the
center of the pixel to the border of the shape (that is locally considered to
be a line) to get a very accurate estimate of the coverage and this is exactly
what we'll do in the next section.</p>
<p>If you wonder if our round pixel shape approximation makes any. sense at all,
have a look at the <a class="reference external" href="https://geometrian.com/programming/reference/subpixelzoo/index.php">subpixel zoo</a>
maintained by Ian Mallett and you'll understand our assumption is not so bad
overall.</p>
</div>
</div>
<div class="section" id="signed-distance-fields">
<h2><a class="toc-backref" href="#id25">Signed distance fields</a></h2>
<p>Here comes the fun. After having reviewed different method for anti-aliasing,
we (mostly me actually) retained the coverage method that necessitates to
evaluate the distance from the center of a pixel to the border of the shape. To
do that, we'll use signed distance functions.</p>
<div class="section" id="signed-distance-function">
<h3><a class="toc-backref" href="#id25">Signed distance function</a></h3>
<p>From wikipedia (again):</p>
<blockquote>
<em>A signed distance function (or oriented distance function) of a set Ω in a
metric space determines the distance of a given point x from the boundary of
Ω, with the sign determined by whether x is in Ω. The function has positive
values at points x inside Ω, it decreases in value as x approaches the
boundary of Ω where the signed distance function is zero, and it takes
negative values outside of Ω.</em></blockquote>
<p>Said differently: in order to render a shape, we need to find a function of
<code>x</code> and <code>y</code> that returns a value that is the signed distance to the shape, that
is, a signed distance to the border of the shape. Inside the shape, the value
is positive, outside the shape the value is negative and on the border, the
value is zero. Easy enough.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The sign of inside/outside can be reversed as long as they are opposite.</p>
</div>
<p>Of course, the question is now how do we find such function? Let's start with
the most simple geometrical primitive: a circle centered on <code>(xc,yc)</code> with a
radius <code>r</code>. For any point <code>(x,y)</code>, we know the (non-negative) distance to
the center is given by: <code>d = sqrt((x-xc)*(x-xc)+(y-yc)*(y-yc))</code>. To simplify
computations, we'll consider the circle to centered on the origin, the distance
now writes <code>d = sqrt(x*x+y*y)</code>. This distance is not what we want since we
target a signed distance to the border of the circle. However, this can be
obtained very easily by subtracting the radius <code>r</code> from <code>d(x,y)</code>. In the end,
signed distance from a point <code>(x,y)</code> to a circle of radius <code>r</code> centered on the
origin is given by:</p>
<pre class="code math literal-block">
d(x,y) = sqrt(x*x+y*y) - r
</pre>
<div class="right figure" id="figure-images/chapter-06/circle-sdf-distances.png" style="width: 30%">
<img alt="images/chapter-06/circle-sdf-distances.png" src="images/chapter-06/circle-sdf-distances.png" />
<p class="caption">Figure</p>
<div class="legend">
<p>Signed distance to a circle. Inside is red, outside is blue, border is white.</p>
<p>See <a class="reference external" href="code/chapter-06/circle-sdf-distances.py">code/chapter-06/circle-sdf-distances.py</a></p>
</div>
</div>
<p>As an exercise, you can check that <code>d(x,y)</code> is zero if <code>(x,y)</code> is on the
border, strictly negative if <code>(x,y)</code> is inside the circle and strictly positive
outside the circle.</p>
<p>Now, let's check if OpenGL is consistent with our maths. We'll write a fragment
shader that compute the color according to the distance to the shape. We'll use
the blue color outside the circle, red color inside and white color on the
border (with some tolerance or we won't see anything).</p>
<pre class="code glsl literal-block">
<span class="keyword type">float</span> <span class="name">distance</span><span class="punctuation">(</span><span class="keyword type">vec2</span> <span class="name">P</span><span class="punctuation">,</span> <span class="keyword type">vec2</span> <span class="name">center</span><span class="punctuation">,</span> <span class="keyword type">float</span> <span class="name">radius</span><span class="punctuation">)</span>
<span class="punctuation">{</span>
    <span class="keyword">return</span> <span class="name">length</span><span class="punctuation">(</span><span class="name">P</span><span class="operator">-</span><span class="name">center</span><span class="punctuation">)</span> <span class="operator">-</span> <span class="name">radius</span><span class="punctuation">;</span>
<span class="punctuation">}</span>

<span class="keyword">varying</span> <span class="keyword type">vec2</span> <span class="name">v_position</span><span class="punctuation">;</span>
<span class="keyword type">void</span> <span class="name">main</span><span class="punctuation">()</span>
<span class="punctuation">{</span>
    <span class="keyword">const</span> <span class="keyword type">float</span> <span class="name">epsilon</span> <span class="operator">=</span> <span class="literal number float">0.005</span><span class="punctuation">;</span>
    <span class="keyword type">float</span> <span class="name">d</span> <span class="operator">=</span> <span class="name">distance</span><span class="punctuation">(</span><span class="name">v_position</span><span class="punctuation">,</span> <span class="keyword type">vec2</span><span class="punctuation">(</span><span class="literal number float">0.0</span><span class="punctuation">),</span> <span class="literal number float">0.5</span><span class="punctuation">);</span>
    <span class="keyword">if</span> <span class="punctuation">(</span><span class="name">d</span> <span class="operator">&gt;</span> <span class="operator">+</span><span class="name">epsilon</span><span class="punctuation">)</span>
        <span class="name builtin">gl_FragColor</span> <span class="operator">=</span> <span class="keyword type">vec4</span><span class="punctuation">(</span><span class="literal number float">1.0</span><span class="operator">-</span><span class="name">abs</span><span class="punctuation">(</span><span class="name">d</span><span class="punctuation">),</span> <span class="literal number float">0.0</span><span class="punctuation">,</span> <span class="literal number float">0.0</span><span class="punctuation">,</span> <span class="literal number float">1.0</span><span class="punctuation">);</span>
    <span class="keyword">else</span> <span class="keyword">if</span> <span class="punctuation">(</span><span class="name">d</span> <span class="operator">&lt;</span> <span class="operator">-</span><span class="name">epsilon</span><span class="punctuation">)</span>
        <span class="name builtin">gl_FragColor</span> <span class="operator">=</span> <span class="keyword type">vec4</span><span class="punctuation">(</span><span class="literal number float">0.0</span><span class="punctuation">,</span> <span class="literal number float">0.0</span><span class="punctuation">,</span> <span class="literal number float">1.0</span><span class="operator">-</span><span class="name">abs</span><span class="punctuation">(</span><span class="name">d</span><span class="punctuation">),</span> <span class="literal number float">1.0</span><span class="punctuation">);</span>
    <span class="keyword">else</span>
        <span class="name builtin">gl_FragColor</span> <span class="operator">=</span> <span class="keyword type">vec4</span><span class="punctuation">(</span><span class="literal number float">1.0</span><span class="punctuation">,</span> <span class="literal number float">1.0</span><span class="punctuation">,</span> <span class="literal number float">1.0</span><span class="punctuation">,</span> <span class="literal number float">1.0</span><span class="punctuation">);</span>
<span class="punctuation">}</span>
</pre>
</div>
<div class="section" id="geometrical-primitives">
<h3><a class="toc-backref" href="#id25">Geometrical primitives</a></h3>
<p>We need now to define a few primitives usigned signed distance function. You'll
understand in the next section why we only need a few primitives. In the
meantime, we'll use a less boring palette than the one in the previous
section. We'll use instead the palette that has become the standard for
displaying SDF on <a class="reference external" href="https://www.shadertoy.com">Shadertoy</a> (it has been
designed by <a class="reference external" href="http://iquilezles.org/www/index.htm">Íñigo Quílez</a> to the best
of my knowledge):</p>
<pre class="code glsl literal-block">
<span class="keyword type">vec4</span> <span class="name">color</span><span class="punctuation">(</span><span class="keyword type">float</span> <span class="name">d</span><span class="punctuation">)</span>
<span class="punctuation">{</span>
    <span class="keyword type">vec3</span> <span class="name">white</span> <span class="operator">=</span> <span class="keyword type">vec3</span><span class="punctuation">(</span><span class="literal number float">1.0</span><span class="punctuation">,</span> <span class="literal number float">1.0</span><span class="punctuation">,</span> <span class="literal number float">1.0</span><span class="punctuation">);</span>
    <span class="keyword type">vec3</span> <span class="name">blue</span>  <span class="operator">=</span> <span class="keyword type">vec3</span><span class="punctuation">(</span><span class="literal number float">0.1</span><span class="punctuation">,</span> <span class="literal number float">0.4</span><span class="punctuation">,</span> <span class="literal number float">0.7</span><span class="punctuation">);</span>
    <span class="keyword type">vec3</span> <span class="name">color</span> <span class="operator">=</span> <span class="name">white</span> <span class="operator">-</span> <span class="name">sign</span><span class="punctuation">(</span><span class="name">d</span><span class="punctuation">)</span><span class="operator">*</span><span class="name">blue</span><span class="punctuation">;</span>
    <span class="name">color</span> <span class="operator">*=</span> <span class="punctuation">(</span><span class="literal number float">1.0</span> <span class="operator">-</span> <span class="name">exp</span><span class="punctuation">(</span><span class="operator">-</span><span class="literal number float">4.0</span><span class="operator">*</span><span class="name">abs</span><span class="punctuation">(</span><span class="name">d</span><span class="punctuation">)))</span> <span class="operator">*</span> <span class="punctuation">(</span><span class="literal number float">0.8</span> <span class="operator">+</span> <span class="literal number float">0.2</span><span class="operator">*</span><span class="name">cos</span><span class="punctuation">(</span><span class="literal number float">140.0</span><span class="operator">*</span><span class="name">d</span><span class="punctuation">));</span>
    <span class="name">color</span> <span class="operator">=</span> <span class="name">mix</span><span class="punctuation">(</span><span class="name">color</span><span class="punctuation">,</span> <span class="name">white</span><span class="punctuation">,</span> <span class="literal number float">1.0</span><span class="operator">-</span><span class="name">smoothstep</span><span class="punctuation">(</span><span class="literal number float">0.0</span><span class="punctuation">,</span><span class="literal number float">0.02</span><span class="punctuation">,</span><span class="name">abs</span><span class="punctuation">(</span><span class="name">d</span><span class="punctuation">))</span> <span class="punctuation">);</span>
    <span class="keyword">return</span> <span class="keyword type">vec4</span><span class="punctuation">(</span><span class="name">color</span><span class="punctuation">,</span> <span class="literal number float">1.0</span><span class="punctuation">);</span>
<span class="punctuation">}</span>
</pre>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The <code>#include</code> directive is not part ot the glsl specification and is only
available from within glumpy.</p>
</div>
<p>However, we don't want to copy this code in all the example. We can instead
write a <a class="reference external" href="code/chapter-06/palette.glsl">palette.glsl</a> shader and include it in
each of the example.</p>
<div class="section" id="circle">
<h4>Circle</h4>
<p>Distance to a circle is the easiest to compute.</p>
<div class="right figure" id="figure-movies/chapter-06/SDF-circle.mp4" style="width: 25%">
<video controls="True" loop="True">
<source src="movies/chapter-06/SDF-circle.mp4"></source>
</video>
<p class="caption">Figure</p>
<div class="legend">
<a class="reference external" href="code/chapter-06/SDF-circle.py">SDF-circle.py</a></div>
</div>
<pre class="code glsl literal-block">
<span class="keyword type">float</span> <span class="name">SDF_circle</span><span class="punctuation">(</span><span class="keyword type">vec2</span> <span class="name">p</span><span class="punctuation">,</span> <span class="keyword type">float</span> <span class="name">radius</span><span class="punctuation">)</span>
<span class="punctuation">{</span>
    <span class="keyword">return</span> <span class="name">length</span><span class="punctuation">(</span><span class="name">p</span><span class="punctuation">)</span> <span class="operator">-</span> <span class="name">radius</span><span class="punctuation">;</span>
<span class="punctuation">}</span>
</pre>
</div>
<div class="section" id="plane">
<h4>Plane</h4>
<p>The distance from a point P to a plane (line in 2d) is the distance from P to
the projection of P onto the place.</p>
<div class="right figure" id="figure-movies/chapter-06/SDF-plane.mp4" style="width: 25%">
<video controls="True" loop="True">
<source src="movies/chapter-06/SDF-plane.mp4"></source>
</video>
<p class="caption">Figure</p>
<div class="legend">
<a class="reference external" href="code/chapter-06/SDF-plane.py">SDF-plane.py</a></div>
</div>
<pre class="code glsl literal-block">
<span class="keyword type">float</span> <span class="name">SDF_plane</span><span class="punctuation">(</span><span class="keyword type">vec2</span> <span class="name">p</span><span class="punctuation">,</span> <span class="keyword type">vec2</span> <span class="name">p0</span><span class="punctuation">,</span> <span class="keyword type">vec2</span> <span class="name">p1</span><span class="punctuation">)</span>
<span class="punctuation">{</span>
  <span class="keyword type">vec2</span> <span class="name">T</span> <span class="operator">=</span> <span class="name">p1</span> <span class="operator">-</span> <span class="name">p0</span><span class="punctuation">;</span>
  <span class="keyword type">vec2</span> <span class="name">O</span> <span class="operator">=</span> <span class="name">normalize</span><span class="punctuation">(</span><span class="keyword type">vec2</span><span class="punctuation">(</span><span class="name">T</span><span class="punctuation">.</span><span class="name">y</span><span class="punctuation">,</span> <span class="operator">-</span><span class="name">T</span><span class="punctuation">.</span><span class="name">x</span><span class="punctuation">));</span>
  <span class="keyword">return</span> <span class="name">dot</span><span class="punctuation">(</span><span class="name">O</span><span class="punctuation">,</span> <span class="name">p0</span> <span class="operator">-</span> <span class="name">p</span><span class="punctuation">);</span>
<span class="punctuation">}</span>
</pre>
</div>
<div class="section" id="true-box">
<h4>True Box</h4>
<p>When computing distance to a box, one has to take care of the distance to the
vertices defining the box.</p>
<div class="right figure" id="figure-movies/chapter-06/SDF-box.mp4" style="width: 25%">
<video controls="True" loop="True">
<source src="movies/chapter-06/SDF-box.mp4"></source>
</video>
<p class="caption">Figure</p>
<div class="legend">
<a class="reference external" href="code/chapter-06/SDF-box.py">SDF-box.py</a></div>
</div>
<pre class="code glsl literal-block">
<span class="comment single">// Code by Inigo Quilez</span>
<span class="comment single">// See https://www.shadertoy.com/view/4llXD7</span>
<span class="keyword type">float</span> <span class="name">SDF_box</span><span class="punctuation">(</span><span class="keyword type">vec2</span> <span class="name">p</span><span class="punctuation">,</span> <span class="keyword type">vec2</span> <span class="name">size</span><span class="punctuation">)</span>
<span class="punctuation">{</span>
     <span class="keyword type">vec2</span> <span class="name">d</span> <span class="operator">=</span> <span class="name">abs</span><span class="punctuation">(</span><span class="name">p</span><span class="punctuation">)</span> <span class="operator">-</span> <span class="name">size</span><span class="punctuation">;</span>
     <span class="keyword">return</span> <span class="name">min</span><span class="punctuation">(</span><span class="name">max</span><span class="punctuation">(</span><span class="name">d</span><span class="punctuation">.</span><span class="name">x</span><span class="punctuation">,</span><span class="name">d</span><span class="punctuation">.</span><span class="name">y</span><span class="punctuation">),</span><span class="literal number float">0.0</span><span class="punctuation">)</span> <span class="operator">+</span> <span class="name">length</span><span class="punctuation">(</span><span class="name">max</span><span class="punctuation">(</span><span class="name">d</span><span class="punctuation">,</span><span class="literal number float">0.0</span><span class="punctuation">));</span>
<span class="punctuation">}</span>
</pre>
</div>
<div class="section" id="rounded-box">
<h4>Rounded Box</h4>
<div class="right figure" id="figure-movies/chapter-06/SDF-round-box.mp4" style="width: 25%">
<video controls="True" loop="True">
<source src="movies/chapter-06/SDF-round-box.mp4"></source>
</video>
<p class="caption">Figure</p>
<div class="legend">
<a class="reference external" href="code/chapter-06/SDF-round-box.py">SDF-round-box.py</a></div>
</div>
<p>Distance to a round can be immediately derived from the distance to a box by
subtracting the corner radius.</p>
<pre class="code glsl literal-block">
<span class="comment single">// Code derived from the true triangle code by Inigo Quilez</span>
<span class="comment single">// See https://www.shadertoy.com/view/4llXD7</span>
<span class="keyword type">float</span> <span class="name">SDF_round_box</span><span class="punctuation">(</span><span class="keyword type">vec2</span> <span class="name">p</span><span class="punctuation">,</span> <span class="keyword type">vec2</span> <span class="name">size</span><span class="punctuation">,</span> <span class="keyword type">float</span> <span class="name">radius</span><span class="punctuation">)</span>
<span class="punctuation">{</span>
    <span class="keyword">return</span> <span class="name">SDF_box</span><span class="punctuation">(</span><span class="name">p</span><span class="punctuation">,</span> <span class="name">size</span><span class="punctuation">)</span> <span class="operator">-</span> <span class="name">radius</span><span class="punctuation">;</span>
<span class="punctuation">}</span>
</pre>
</div>
<div class="section" id="fake-box">
<h4>Fake Box</h4>
<div class="right figure" id="figure-movies/chapter-06/SDF-fake-box.mp4" style="width: 25%">
<video controls="True" loop="True">
<source src="movies/chapter-06/SDF-fake-box.mp4"></source>
</video>
<p class="caption">Figure</p>
<div class="legend">
<a class="reference external" href="code/chapter-06/SDF-fake-box.py">SDF-fake-box.py</a></div>
</div>
<p>A faster way to compute a SDF box is to consider it to be delimited by lines
(instead of line segments). We save the time of computing the distance to the
box vertices.</p>
<pre class="code glsl literal-block">
<span class="keyword type">float</span> <span class="name">SDF_fake_box</span><span class="punctuation">(</span><span class="keyword type">vec2</span> <span class="name">p</span><span class="punctuation">,</span> <span class="keyword type">vec2</span> <span class="name">size</span><span class="punctuation">)</span>
<span class="punctuation">{</span>
    <span class="keyword">return</span> <span class="name">max</span><span class="punctuation">(</span><span class="name">abs</span><span class="punctuation">(</span><span class="name">p</span><span class="punctuation">.</span><span class="name">x</span><span class="punctuation">)</span><span class="operator">-</span><span class="name">size</span><span class="punctuation">.</span><span class="name">x</span><span class="punctuation">,</span> <span class="name">abs</span><span class="punctuation">(</span><span class="name">p</span><span class="punctuation">.</span><span class="name">y</span><span class="punctuation">)</span><span class="operator">-</span><span class="name">size</span><span class="punctuation">.</span><span class="name">y</span><span class="punctuation">);</span>
<span class="punctuation">}</span>
</pre>
</div>
<div class="section" id="true-triangle">
<h4>True triangle</h4>
<div class="right figure" id="figure-movies/chapter-06/SDF-triangle.mp4" style="width: 25%">
<video controls="True" loop="True">
<source src="movies/chapter-06/SDF-triangle.mp4"></source>
</video>
<p class="caption">Figure</p>
<div class="legend">
<a class="reference external" href="code/chapter-06/SDF-triangle.py">SDF-triangle.py</a></div>
</div>
<p>Computing the distance to a triangle is not totally straightfoward because a
triangle is made of three line segments, meaning we have to take into account
both the distance to the side of the triangle and the distance to the triangle
vertices.</p>
<pre class="code glsl literal-block">
<span class="comment single">// Code by Inigo Quilez</span>
<span class="comment single">// See https://www.shadertoy.com/view/XsXSz4</span>
<span class="keyword type">float</span> <span class="name">SDF_triangle</span><span class="punctuation">(</span><span class="keyword type">vec2</span> <span class="name">p</span><span class="punctuation">,</span> <span class="keyword type">vec2</span> <span class="name">p0</span><span class="punctuation">,</span> <span class="keyword type">vec2</span> <span class="name">p1</span><span class="punctuation">,</span> <span class="keyword type">vec2</span> <span class="name">p2</span><span class="punctuation">)</span>
<span class="punctuation">{</span>
    <span class="keyword type">vec2</span> <span class="name">e0</span> <span class="operator">=</span> <span class="name">p1</span> <span class="operator">-</span> <span class="name">p0</span><span class="punctuation">;</span>
    <span class="keyword type">vec2</span> <span class="name">e1</span> <span class="operator">=</span> <span class="name">p2</span> <span class="operator">-</span> <span class="name">p1</span><span class="punctuation">;</span>
    <span class="keyword type">vec2</span> <span class="name">e2</span> <span class="operator">=</span> <span class="name">p0</span> <span class="operator">-</span> <span class="name">p2</span><span class="punctuation">;</span>

    <span class="keyword type">vec2</span> <span class="name">v0</span> <span class="operator">=</span> <span class="name">p</span> <span class="operator">-</span> <span class="name">p0</span><span class="punctuation">;</span>
    <span class="keyword type">vec2</span> <span class="name">v1</span> <span class="operator">=</span> <span class="name">p</span> <span class="operator">-</span> <span class="name">p1</span><span class="punctuation">;</span>
    <span class="keyword type">vec2</span> <span class="name">v2</span> <span class="operator">=</span> <span class="name">p</span> <span class="operator">-</span> <span class="name">p2</span><span class="punctuation">;</span>

    <span class="keyword type">vec2</span> <span class="name">pq0</span> <span class="operator">=</span> <span class="name">v0</span> <span class="operator">-</span> <span class="name">e0</span><span class="operator">*</span><span class="name">clamp</span><span class="punctuation">(</span> <span class="name">dot</span><span class="punctuation">(</span><span class="name">v0</span><span class="punctuation">,</span><span class="name">e0</span><span class="punctuation">)</span><span class="operator">/</span><span class="name">dot</span><span class="punctuation">(</span><span class="name">e0</span><span class="punctuation">,</span><span class="name">e0</span><span class="punctuation">),</span> <span class="literal number float">0.0</span><span class="punctuation">,</span> <span class="literal number float">1.0</span> <span class="punctuation">);</span>
    <span class="keyword type">vec2</span> <span class="name">pq1</span> <span class="operator">=</span> <span class="name">v1</span> <span class="operator">-</span> <span class="name">e1</span><span class="operator">*</span><span class="name">clamp</span><span class="punctuation">(</span> <span class="name">dot</span><span class="punctuation">(</span><span class="name">v1</span><span class="punctuation">,</span><span class="name">e1</span><span class="punctuation">)</span><span class="operator">/</span><span class="name">dot</span><span class="punctuation">(</span><span class="name">e1</span><span class="punctuation">,</span><span class="name">e1</span><span class="punctuation">),</span> <span class="literal number float">0.0</span><span class="punctuation">,</span> <span class="literal number float">1.0</span> <span class="punctuation">);</span>
    <span class="keyword type">vec2</span> <span class="name">pq2</span> <span class="operator">=</span> <span class="name">v2</span> <span class="operator">-</span> <span class="name">e2</span><span class="operator">*</span><span class="name">clamp</span><span class="punctuation">(</span> <span class="name">dot</span><span class="punctuation">(</span><span class="name">v2</span><span class="punctuation">,</span><span class="name">e2</span><span class="punctuation">)</span><span class="operator">/</span><span class="name">dot</span><span class="punctuation">(</span><span class="name">e2</span><span class="punctuation">,</span><span class="name">e2</span><span class="punctuation">),</span> <span class="literal number float">0.0</span><span class="punctuation">,</span> <span class="literal number float">1.0</span> <span class="punctuation">);</span>

    <span class="keyword type">float</span> <span class="name">s</span> <span class="operator">=</span> <span class="name">sign</span><span class="punctuation">(</span> <span class="name">e0</span><span class="punctuation">.</span><span class="name">x</span><span class="operator">*</span><span class="name">e2</span><span class="punctuation">.</span><span class="name">y</span> <span class="operator">-</span> <span class="name">e0</span><span class="punctuation">.</span><span class="name">y</span><span class="operator">*</span><span class="name">e2</span><span class="punctuation">.</span><span class="name">x</span> <span class="punctuation">);</span>
    <span class="keyword type">vec2</span> <span class="name">d</span> <span class="operator">=</span> <span class="name">min</span><span class="punctuation">(</span> <span class="name">min</span><span class="punctuation">(</span>
          <span class="keyword type">vec2</span><span class="punctuation">(</span> <span class="name">dot</span><span class="punctuation">(</span> <span class="name">pq0</span><span class="punctuation">,</span> <span class="name">pq0</span> <span class="punctuation">),</span> <span class="name">s</span><span class="operator">*</span><span class="punctuation">(</span><span class="name">v0</span><span class="punctuation">.</span><span class="name">x</span><span class="operator">*</span><span class="name">e0</span><span class="punctuation">.</span><span class="name">y</span><span class="operator">-</span><span class="name">v0</span><span class="punctuation">.</span><span class="name">y</span><span class="operator">*</span><span class="name">e0</span><span class="punctuation">.</span><span class="name">x</span><span class="punctuation">)</span> <span class="punctuation">),</span>
          <span class="keyword type">vec2</span><span class="punctuation">(</span> <span class="name">dot</span><span class="punctuation">(</span> <span class="name">pq1</span><span class="punctuation">,</span> <span class="name">pq1</span> <span class="punctuation">),</span> <span class="name">s</span><span class="operator">*</span><span class="punctuation">(</span><span class="name">v1</span><span class="punctuation">.</span><span class="name">x</span><span class="operator">*</span><span class="name">e1</span><span class="punctuation">.</span><span class="name">y</span><span class="operator">-</span><span class="name">v1</span><span class="punctuation">.</span><span class="name">y</span><span class="operator">*</span><span class="name">e1</span><span class="punctuation">.</span><span class="name">x</span><span class="punctuation">)</span> <span class="punctuation">)),</span>
          <span class="keyword type">vec2</span><span class="punctuation">(</span> <span class="name">dot</span><span class="punctuation">(</span> <span class="name">pq2</span><span class="punctuation">,</span> <span class="name">pq2</span> <span class="punctuation">),</span> <span class="name">s</span><span class="operator">*</span><span class="punctuation">(</span><span class="name">v2</span><span class="punctuation">.</span><span class="name">x</span><span class="operator">*</span><span class="name">e2</span><span class="punctuation">.</span><span class="name">y</span><span class="operator">-</span><span class="name">v2</span><span class="punctuation">.</span><span class="name">y</span><span class="operator">*</span><span class="name">e2</span><span class="punctuation">.</span><span class="name">x</span><span class="punctuation">)</span> <span class="punctuation">));</span>
    <span class="keyword">return</span> <span class="operator">-</span><span class="name">sqrt</span><span class="punctuation">(</span><span class="name">d</span><span class="punctuation">.</span><span class="name">x</span><span class="punctuation">)</span><span class="operator">*</span><span class="name">sign</span><span class="punctuation">(</span><span class="name">d</span><span class="punctuation">.</span><span class="name">y</span><span class="punctuation">);</span>
<span class="punctuation">}</span>
</pre>
</div>
<div class="section" id="round-triangle">
<h4>Round triangle</h4>
<div class="right figure" id="figure-movies/chapter-06/SDF-round-triangle.mp4" style="width: 25%">
<video controls="True" loop="True">
<source src="movies/chapter-06/SDF-round-triangle.mp4"></source>
</video>
<p class="caption">Figure</p>
<div class="legend">
<a class="reference external" href="code/chapter-06/SDF-round-triangle.py">SDF-round-triangle.py</a></div>
</div>
<p>Round triangle is very easy to obtain from the triangle above. We just
substract the radius of the corner such that the border of the triangle is on
the oustide part of the SDF triangle.</p>
<pre class="code glsl literal-block">
<span class="comment single">// Code derived from the true triangle code by Inigo Quilez</span>
<span class="comment single">// See https://www.shadertoy.com/view/XsXSz4</span>
<span class="keyword type">float</span> <span class="name">SDF_round_triangle</span><span class="punctuation">(</span><span class="keyword type">vec2</span> <span class="name">p</span><span class="punctuation">,</span> <span class="keyword type">vec2</span> <span class="name">p0</span><span class="punctuation">,</span> <span class="keyword type">vec2</span> <span class="name">p1</span><span class="punctuation">,</span> <span class="keyword type">vec2</span> <span class="name">p2</span><span class="punctuation">,</span> <span class="keyword type">float</span> <span class="name">radius</span><span class="punctuation">)</span>
<span class="punctuation">{</span>
    <span class="keyword">return</span> <span class="name">SDF_triangle</span><span class="punctuation">(</span><span class="name">p</span><span class="punctuation">,</span> <span class="name">p0</span><span class="punctuation">,</span> <span class="name">p1</span><span class="punctuation">,</span> <span class="name">p2</span><span class="punctuation">)</span> <span class="operator">-</span> <span class="name">radius</span><span class="punctuation">;</span>
<span class="punctuation">}</span>
</pre>
</div>
<div class="section" id="fake-triangle">
<h4>Fake triangle</h4>
<div class="right figure" id="figure-movies/chapter-06/SDF-fake-triangle.mp4" style="width: 25%">
<video controls="True" loop="True">
<source src="movies/chapter-06/SDF-fake-triangle.mp4"></source>
</video>
<p class="caption">Figure</p>
<div class="legend">
<a class="reference external" href="code/chapter-06/SDF-fake-triangle.py">SDF-fake-triangle.py</a></div>
</div>
<p>What I call a fake SDF triangle is a triangle made of lines instead of line
segments. If you look at the corner (outside part), you will notice the
different compared to the real triangle. This fake triangle will used later for
markers because it is faster to compute than the regular SDF triangle.</p>
<pre class="code glsl literal-block">
<span class="keyword type">float</span> <span class="name">SDF_fake_triangle</span><span class="punctuation">(</span><span class="keyword type">vec2</span> <span class="name">p</span><span class="punctuation">,</span> <span class="keyword type">vec2</span> <span class="name">p0</span><span class="punctuation">,</span> <span class="keyword type">vec2</span> <span class="name">p1</span><span class="punctuation">,</span> <span class="keyword type">vec2</span> <span class="name">p2</span><span class="punctuation">)</span>
<span class="punctuation">{</span>
    <span class="keyword type">vec2</span> <span class="name">e0</span> <span class="operator">=</span> <span class="name">p1</span> <span class="operator">-</span> <span class="name">p0</span><span class="punctuation">;</span>
    <span class="keyword type">vec2</span> <span class="name">e1</span> <span class="operator">=</span> <span class="name">p2</span> <span class="operator">-</span> <span class="name">p1</span><span class="punctuation">;</span>
    <span class="keyword type">vec2</span> <span class="name">e2</span> <span class="operator">=</span> <span class="name">p0</span> <span class="operator">-</span> <span class="name">p2</span><span class="punctuation">;</span>

    <span class="keyword type">vec2</span> <span class="name">v0</span> <span class="operator">=</span> <span class="name">p</span> <span class="operator">-</span> <span class="name">p0</span><span class="punctuation">;</span>
    <span class="keyword type">vec2</span> <span class="name">v1</span> <span class="operator">=</span> <span class="name">p</span> <span class="operator">-</span> <span class="name">p1</span><span class="punctuation">;</span>
    <span class="keyword type">vec2</span> <span class="name">v2</span> <span class="operator">=</span> <span class="name">p</span> <span class="operator">-</span> <span class="name">p2</span><span class="punctuation">;</span>

    <span class="keyword type">vec2</span> <span class="name">o0</span> <span class="operator">=</span> <span class="name">normalize</span><span class="punctuation">(</span><span class="keyword type">vec2</span><span class="punctuation">(</span><span class="name">e0</span><span class="punctuation">.</span><span class="name">y</span><span class="punctuation">,</span> <span class="operator">-</span><span class="name">e0</span><span class="punctuation">.</span><span class="name">x</span><span class="punctuation">));</span>
    <span class="keyword type">vec2</span> <span class="name">o1</span> <span class="operator">=</span> <span class="name">normalize</span><span class="punctuation">(</span><span class="keyword type">vec2</span><span class="punctuation">(</span><span class="name">e1</span><span class="punctuation">.</span><span class="name">y</span><span class="punctuation">,</span> <span class="operator">-</span><span class="name">e1</span><span class="punctuation">.</span><span class="name">x</span><span class="punctuation">));</span>
    <span class="keyword type">vec2</span> <span class="name">o2</span> <span class="operator">=</span> <span class="name">normalize</span><span class="punctuation">(</span><span class="keyword type">vec2</span><span class="punctuation">(</span><span class="name">e2</span><span class="punctuation">.</span><span class="name">y</span><span class="punctuation">,</span> <span class="operator">-</span><span class="name">e2</span><span class="punctuation">.</span><span class="name">x</span><span class="punctuation">));</span>

    <span class="keyword">return</span> <span class="name">max</span><span class="punctuation">(</span><span class="name">max</span><span class="punctuation">(</span><span class="name">dot</span><span class="punctuation">(</span><span class="name">o0</span><span class="punctuation">,</span><span class="name">v0</span><span class="punctuation">),</span> <span class="name">dot</span><span class="punctuation">(</span><span class="name">o1</span><span class="punctuation">,</span><span class="name">v1</span><span class="punctuation">)),</span> <span class="name">dot</span><span class="punctuation">(</span><span class="name">o2</span><span class="punctuation">,</span><span class="name">v2</span><span class="punctuation">));</span>
<span class="punctuation">}</span>
</pre>
</div>
<div class="section" id="true-ellipse">
<h4>True ellipse</h4>
<div class="right figure" id="figure-movies/chapter-06/SDF-ellipse.mp4" style="width: 25%">
<video controls="True" loop="True">
<source src="movies/chapter-06/SDF-ellipse.mp4"></source>
</video>
<p class="caption">Figure</p>
<div class="legend">
<a class="reference external" href="code/chapter-06/SDF-ellipse.py">SDF-ellipse.py</a></div>
</div>
<p>Computing the distance from an arbitrary point to an ellipse is surprinsingly
difficult if you compare it to the distance to a circle. If you want to read
the details, I would advise to read the paper <a class="reference external" href="https://www.spaceroots.org/documents/distance/distance-to-ellipse.pdf">Quick computation of the
distance between a point and an ellipse</a> by
Luc Maisonobe. The good news for us is that Íñigo Quílez already solved the
problem for us. We will re-use his formula.</p>
<pre class="code glsl literal-block">
<span class="comment single">// Code by Inigo Quilez</span>
<span class="comment single">// See https://www.shadertoy.com/view/4sS3zz</span>
<span class="keyword type">float</span> <span class="name">SDF_ellipse</span><span class="punctuation">(</span><span class="keyword type">vec2</span> <span class="name">p</span><span class="punctuation">,</span> <span class="keyword type">vec2</span> <span class="name">ab</span><span class="punctuation">)</span>
<span class="punctuation">{</span>
    <span class="comment single">// The function does not like circles</span>
    <span class="keyword">if</span> <span class="punctuation">(</span><span class="name">ab</span><span class="punctuation">.</span><span class="name">x</span> <span class="operator">==</span> <span class="name">ab</span><span class="punctuation">.</span><span class="name">y</span><span class="punctuation">)</span> <span class="name">ab</span><span class="punctuation">.</span><span class="name">x</span> <span class="operator">=</span> <span class="name">ab</span><span class="punctuation">.</span><span class="name">x</span><span class="operator">*</span><span class="literal number float">0.9999</span><span class="punctuation">;</span>

    <span class="name">p</span> <span class="operator">=</span> <span class="name">abs</span><span class="punctuation">(</span> <span class="name">p</span> <span class="punctuation">);</span> <span class="keyword">if</span><span class="punctuation">(</span> <span class="name">p</span><span class="punctuation">.</span><span class="name">x</span> <span class="operator">&gt;</span> <span class="name">p</span><span class="punctuation">.</span><span class="name">y</span> <span class="punctuation">){</span> <span class="name">p</span><span class="operator">=</span><span class="name">p</span><span class="punctuation">.</span><span class="name">yx</span><span class="punctuation">;</span> <span class="name">ab</span><span class="operator">=</span><span class="name">ab</span><span class="punctuation">.</span><span class="name">yx</span><span class="punctuation">;</span> <span class="punctuation">}</span>
    <span class="keyword type">float</span> <span class="name">l</span> <span class="operator">=</span> <span class="name">ab</span><span class="punctuation">.</span><span class="name">y</span><span class="operator">*</span><span class="name">ab</span><span class="punctuation">.</span><span class="name">y</span> <span class="operator">-</span> <span class="name">ab</span><span class="punctuation">.</span><span class="name">x</span><span class="operator">*</span><span class="name">ab</span><span class="punctuation">.</span><span class="name">x</span><span class="punctuation">;</span>
    <span class="keyword type">float</span> <span class="name">m</span> <span class="operator">=</span> <span class="name">ab</span><span class="punctuation">.</span><span class="name">x</span><span class="operator">*</span><span class="name">p</span><span class="punctuation">.</span><span class="name">x</span><span class="operator">/</span><span class="name">l</span><span class="punctuation">;</span>
    <span class="keyword type">float</span> <span class="name">n</span> <span class="operator">=</span> <span class="name">ab</span><span class="punctuation">.</span><span class="name">y</span><span class="operator">*</span><span class="name">p</span><span class="punctuation">.</span><span class="name">y</span><span class="operator">/</span><span class="name">l</span><span class="punctuation">;</span>
    <span class="keyword type">float</span> <span class="name">m2</span> <span class="operator">=</span> <span class="name">m</span><span class="operator">*</span><span class="name">m</span><span class="punctuation">;</span>
    <span class="keyword type">float</span> <span class="name">n2</span> <span class="operator">=</span> <span class="name">n</span><span class="operator">*</span><span class="name">n</span><span class="punctuation">;</span>
    <span class="keyword type">float</span> <span class="name">c</span> <span class="operator">=</span> <span class="punctuation">(</span><span class="name">m2</span> <span class="operator">+</span> <span class="name">n2</span> <span class="operator">-</span> <span class="literal number float">1.0</span><span class="punctuation">)</span><span class="operator">/</span><span class="literal number float">3.0</span><span class="punctuation">;</span>
    <span class="keyword type">float</span> <span class="name">c3</span> <span class="operator">=</span> <span class="name">c</span><span class="operator">*</span><span class="name">c</span><span class="operator">*</span><span class="name">c</span><span class="punctuation">;</span>
    <span class="keyword type">float</span> <span class="name">q</span> <span class="operator">=</span> <span class="name">c3</span> <span class="operator">+</span> <span class="name">m2</span><span class="operator">*</span><span class="name">n2</span><span class="operator">*</span><span class="literal number float">2.0</span><span class="punctuation">;</span>
    <span class="keyword type">float</span> <span class="name">d</span> <span class="operator">=</span> <span class="name">c3</span> <span class="operator">+</span> <span class="name">m2</span><span class="operator">*</span><span class="name">n2</span><span class="punctuation">;</span>
    <span class="keyword type">float</span> <span class="name">g</span> <span class="operator">=</span> <span class="name">m</span> <span class="operator">+</span> <span class="name">m</span><span class="operator">*</span><span class="name">n2</span><span class="punctuation">;</span>
    <span class="keyword type">float</span> <span class="name">co</span><span class="punctuation">;</span>

    <span class="keyword">if</span><span class="punctuation">(</span> <span class="name">d</span><span class="operator">&lt;</span><span class="literal number float">0.0</span> <span class="punctuation">)</span> <span class="punctuation">{</span>
        <span class="keyword type">float</span> <span class="name">p</span> <span class="operator">=</span> <span class="name">acos</span><span class="punctuation">(</span><span class="name">q</span><span class="operator">/</span><span class="name">c3</span><span class="punctuation">)</span><span class="operator">/</span><span class="literal number float">3.0</span><span class="punctuation">;</span>
        <span class="keyword type">float</span> <span class="name">s</span> <span class="operator">=</span> <span class="name">cos</span><span class="punctuation">(</span><span class="name">p</span><span class="punctuation">);</span>
        <span class="keyword type">float</span> <span class="name">t</span> <span class="operator">=</span> <span class="name">sin</span><span class="punctuation">(</span><span class="name">p</span><span class="punctuation">)</span><span class="operator">*</span><span class="name">sqrt</span><span class="punctuation">(</span><span class="literal number float">3.0</span><span class="punctuation">);</span>
        <span class="keyword type">float</span> <span class="name">rx</span> <span class="operator">=</span> <span class="name">sqrt</span><span class="punctuation">(</span> <span class="operator">-</span><span class="name">c</span><span class="operator">*</span><span class="punctuation">(</span><span class="name">s</span> <span class="operator">+</span> <span class="name">t</span> <span class="operator">+</span> <span class="literal number float">2.0</span><span class="punctuation">)</span> <span class="operator">+</span> <span class="name">m2</span> <span class="punctuation">);</span>
        <span class="keyword type">float</span> <span class="name">ry</span> <span class="operator">=</span> <span class="name">sqrt</span><span class="punctuation">(</span> <span class="operator">-</span><span class="name">c</span><span class="operator">*</span><span class="punctuation">(</span><span class="name">s</span> <span class="operator">-</span> <span class="name">t</span> <span class="operator">+</span> <span class="literal number float">2.0</span><span class="punctuation">)</span> <span class="operator">+</span> <span class="name">m2</span> <span class="punctuation">);</span>
        <span class="name">co</span> <span class="operator">=</span> <span class="punctuation">(</span> <span class="name">ry</span> <span class="operator">+</span> <span class="name">sign</span><span class="punctuation">(</span><span class="name">l</span><span class="punctuation">)</span><span class="operator">*</span><span class="name">rx</span> <span class="operator">+</span> <span class="name">abs</span><span class="punctuation">(</span><span class="name">g</span><span class="punctuation">)</span><span class="operator">/</span><span class="punctuation">(</span><span class="name">rx</span><span class="operator">*</span><span class="name">ry</span><span class="punctuation">)</span> <span class="operator">-</span> <span class="name">m</span><span class="punctuation">)</span><span class="operator">/</span><span class="literal number float">2.0</span><span class="punctuation">;</span>
    <span class="punctuation">}</span> <span class="keyword">else</span> <span class="punctuation">{</span>
        <span class="keyword type">float</span> <span class="name">h</span> <span class="operator">=</span> <span class="literal number float">2.0</span><span class="operator">*</span><span class="name">m</span><span class="operator">*</span><span class="name">n</span><span class="operator">*</span><span class="name">sqrt</span><span class="punctuation">(</span> <span class="name">d</span> <span class="punctuation">);</span>
        <span class="keyword type">float</span> <span class="name">s</span> <span class="operator">=</span> <span class="name">sign</span><span class="punctuation">(</span><span class="name">q</span><span class="operator">+</span><span class="name">h</span><span class="punctuation">)</span><span class="operator">*</span><span class="name">pow</span><span class="punctuation">(</span> <span class="name">abs</span><span class="punctuation">(</span><span class="name">q</span><span class="operator">+</span><span class="name">h</span><span class="punctuation">),</span> <span class="literal number float">1.0</span><span class="operator">/</span><span class="literal number float">3.0</span> <span class="punctuation">);</span>
        <span class="keyword type">float</span> <span class="name">u</span> <span class="operator">=</span> <span class="name">sign</span><span class="punctuation">(</span><span class="name">q</span><span class="operator">-</span><span class="name">h</span><span class="punctuation">)</span><span class="operator">*</span><span class="name">pow</span><span class="punctuation">(</span> <span class="name">abs</span><span class="punctuation">(</span><span class="name">q</span><span class="operator">-</span><span class="name">h</span><span class="punctuation">),</span> <span class="literal number float">1.0</span><span class="operator">/</span><span class="literal number float">3.0</span> <span class="punctuation">);</span>
        <span class="keyword type">float</span> <span class="name">rx</span> <span class="operator">=</span> <span class="operator">-</span><span class="name">s</span> <span class="operator">-</span> <span class="name">u</span> <span class="operator">-</span> <span class="name">c</span><span class="operator">*</span><span class="literal number float">4.0</span> <span class="operator">+</span> <span class="literal number float">2.0</span><span class="operator">*</span><span class="name">m2</span><span class="punctuation">;</span>
        <span class="keyword type">float</span> <span class="name">ry</span> <span class="operator">=</span> <span class="punctuation">(</span><span class="name">s</span> <span class="operator">-</span> <span class="name">u</span><span class="punctuation">)</span><span class="operator">*</span><span class="name">sqrt</span><span class="punctuation">(</span><span class="literal number float">3.0</span><span class="punctuation">);</span>
        <span class="keyword type">float</span> <span class="name">rm</span> <span class="operator">=</span> <span class="name">sqrt</span><span class="punctuation">(</span> <span class="name">rx</span><span class="operator">*</span><span class="name">rx</span> <span class="operator">+</span> <span class="name">ry</span><span class="operator">*</span><span class="name">ry</span> <span class="punctuation">);</span>
        <span class="keyword type">float</span> <span class="name">p</span> <span class="operator">=</span> <span class="name">ry</span><span class="operator">/</span><span class="name">sqrt</span><span class="punctuation">(</span><span class="name">rm</span><span class="operator">-</span><span class="name">rx</span><span class="punctuation">);</span>
        <span class="name">co</span> <span class="operator">=</span> <span class="punctuation">(</span><span class="name">p</span> <span class="operator">+</span> <span class="literal number float">2.0</span><span class="operator">*</span><span class="name">g</span><span class="operator">/</span><span class="name">rm</span> <span class="operator">-</span> <span class="name">m</span><span class="punctuation">)</span><span class="operator">/</span><span class="literal number float">2.0</span><span class="punctuation">;</span>
    <span class="punctuation">}</span>
    <span class="keyword type">float</span> <span class="name">si</span> <span class="operator">=</span> <span class="name">sqrt</span><span class="punctuation">(</span> <span class="literal number float">1.0</span> <span class="operator">-</span> <span class="name">co</span><span class="operator">*</span><span class="name">co</span> <span class="punctuation">);</span>
    <span class="keyword type">vec2</span> <span class="name">r</span> <span class="operator">=</span> <span class="keyword type">vec2</span><span class="punctuation">(</span> <span class="name">ab</span><span class="punctuation">.</span><span class="name">x</span><span class="operator">*</span><span class="name">co</span><span class="punctuation">,</span> <span class="name">ab</span><span class="punctuation">.</span><span class="name">y</span><span class="operator">*</span><span class="name">si</span> <span class="punctuation">);</span>
    <span class="keyword">return</span> <span class="name">length</span><span class="punctuation">(</span><span class="name">r</span> <span class="operator">-</span> <span class="name">p</span> <span class="punctuation">)</span> <span class="operator">*</span> <span class="name">sign</span><span class="punctuation">(</span><span class="name">p</span><span class="punctuation">.</span><span class="name">y</span><span class="operator">-</span><span class="name">r</span><span class="punctuation">.</span><span class="name">y</span><span class="punctuation">);</span>
<span class="punctuation">}</span>
</pre>
</div>
<div class="section" id="fake-but-fast-ellipse">
<h4>Fake (but fast) ellipse</h4>
<div class="right figure" id="figure-movies/chapter-06/SDF-fake-ellipse.mp4" style="width: 25%">
<video controls="True" loop="True">
<source src="movies/chapter-06/SDF-fake-ellipse.mp4"></source>
</video>
<p class="caption">Figure</p>
<div class="legend">
<a class="reference external" href="code/chapter-06/SDF-fake-ellipse.py">SDF-fake-ellipse.py</a></div>
</div>
<p>Íñigo Quílez also provided a very fast approximation of the ellipse
distance. Some artifacts can be clearly seen but we'll see later that if our ellipse is not too thick, this approximation will do the job.</p>
<pre class="code glsl literal-block">
<span class="comment single">// Code by Inigo Quilez</span>
<span class="comment single">// See https://www.shadertoy.com/view/MdfGWn</span>
<span class="keyword type">float</span> <span class="name">SDF_fake_ellipse</span><span class="punctuation">(</span><span class="keyword type">vec2</span> <span class="name">p</span><span class="punctuation">,</span> <span class="keyword type">vec2</span> <span class="name">size</span><span class="punctuation">)</span>
<span class="punctuation">{</span>
    <span class="keyword type">float</span> <span class="name">r</span> <span class="operator">=</span> <span class="literal number float">0.2</span><span class="punctuation">;</span>
    <span class="keyword type">float</span> <span class="name">f</span> <span class="operator">=</span> <span class="name">length</span><span class="punctuation">(</span> <span class="name">p</span><span class="operator">*</span><span class="name">size</span> <span class="punctuation">);</span>
    <span class="name">f</span> <span class="operator">=</span> <span class="name">length</span><span class="punctuation">(</span><span class="name">p</span><span class="operator">*</span><span class="name">size</span><span class="punctuation">);</span>
    <span class="keyword">return</span> <span class="name">f</span><span class="operator">*</span><span class="punctuation">(</span><span class="name">f</span><span class="operator">-</span><span class="name">r</span><span class="punctuation">)</span><span class="operator">/</span><span class="name">length</span><span class="punctuation">(</span><span class="name">p</span><span class="operator">*</span><span class="name">size</span><span class="operator">*</span><span class="name">size</span><span class="punctuation">);</span>
<span class="punctuation">}</span>
</pre>
</div>
</div>
</div>
<div class="section" id="distance-based-anti-aliasing">
<h2><a class="toc-backref" href="#id25">Distance based anti-aliasing</a></h2>
<p>We have our signed distance functions but we need to exploit them in order to
do the proper antialiasing. If you remember that a SDF function gives the
distance to the border of the shape, we still need to compute the right color
according to this distance. When we are fully inside or outside the shape, it
is easy: let's say black for the inside and white for the outside (or nothing
using the transparency level). The interesting part is located in the vicinity
of the border, it is not fully black nor fully white but grey. What amount of
grey you might ask? Well, it is directly correlated with the distance to the
border. But first, let's have a look at the figure below that show the
different situations:</p>
<div class="right figure" id="figure-images/chapter-06/circle-aa.png">
<img alt="images/chapter-06/circle-aa.png" src="images/chapter-06/circle-aa.png" />
<p class="caption">Figure</p>
<div class="legend">
For a given shape, we might want to draw only the outline of the shape
(left), the interior only (left) or both of them (middle).</div>
</div>
<p>For all these cases, we need to define the thickness of the antialiased area,
(that is, the area where the estimated coverage will go from 0 (outside) to 1
(inside)) and the line thickness for the stroke and outline cases. This means
that wen we compute the actual size of the circle, we have to take this into
account (2*antialias + linewidth). The antialias area is usually 1.0 pixel.
If it is larger, the shape will appear blurry, and it it is too narrow, the
shape will have hard egdes. The degenerated case being zero area that results
in no antialias at all.</p>
<div class="right figure" id="figure-images/chapter-06/antialias-function.png">
<img alt="images/chapter-06/antialias-function.png" src="images/chapter-06/antialias-function.png" />
<p class="caption">Figure</p>
<div class="legend">
Antialiasing functions: <strong>Left</strong>: None, <strong>Middle</strong>: linear, <strong>Right</strong>:
exponential.</div>
</div>
<p>Finally, we need to define a function that gives the coverage according to the
distance. As illustrated above, we have the choice between several solutions
(you're also free to design your own) but we'll mostly use the last one for the
rest of this book because it appears to be the nicest (to me).</p>
</div>
</div>
<div class="section" id="rendering-points">
<h1><a class="toc-backref" href="#contents">Rendering points</a></h1>
<div class="contents toc chapter-07 local topic" id="id27">
<p class="topic-title first">.</p>
<ul class="simple">
<li><a class="reference internal" href="#dots-discs-circles" id="id181">Dots, discs, circles</a><ul>
<li><a class="reference internal" href="#raw-points" id="id182">Raw points</a></li>
<li><a class="reference internal" href="#antialiased-points" id="id183">Antialiased points</a></li>
</ul>
</li>
<li><a class="reference internal" href="#ellipses" id="id184">Ellipses</a></li>
<li><a class="reference internal" href="#spheres" id="id185">Spheres</a><ul>
<li><a class="reference internal" href="#flat-sphere" id="id186">Flat sphere</a></li>
<li><a class="reference internal" href="#true-sphere" id="id187">True sphere</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id28" id="id188">Exercises</a><ul>
<li><a class="reference internal" href="#tiny-discs" id="id189">Tiny discs</a></li>
<li><a class="reference internal" href="#antialiased-triangles" id="id190">Antialiased triangles</a></li>
<li><a class="reference internal" href="#gpu-voronoi" id="id191">GPU Voronoi</a></li>
</ul>
</li>
</ul>
</div>
<p>If you have read the previous chapters, you may have noticed that there exists
actually a <code>gl.GL_POINTS</code> drawing primitive and you might have concluded (quite
logically) that displaying points in OpenGL is straightforward. This is partly
true. This primitive can be actually used to display points, but the concept of
point for OpenGL is roughly a non-antialiased, non-rotated, boring and ugly
square. Consequently, if we want to display points like in the teaser image
above , we'll need to take care of pretty much everything.</p>
<div class="section" id="dots-discs-circles">
<h2><a class="toc-backref" href="#id27">Dots, discs, circles</a></h2>
<div class="section" id="raw-points">
<h3><a class="toc-backref" href="#id27">Raw points</a></h3>
<div class="right figure" id="figure-images/chapter-07/points.png" style="width: 30%">
<img alt="images/chapter-07/points.png" src="images/chapter-07/points.png" />
<p class="caption">Figure</p>
<div class="legend">
&quot;Point&quot; as drawn by OpenGL
(see <a class="reference external" href="code/chapter-07/points.py">points.py</a>).</div>
</div>
<p>The most straightforward way to display points is to use the <code>gl.GL_POINTS</code>
primitive that displays a quad that is always facing the camera
(i.e. billboard).  This is very convenient because a mathematical point has no
dimension, even though we'll use this primitive to draw discs and circles in
the next section. The size of the quad must be specified within the vertex
shader using the <code>gl_PointSize</code> variable (note that the size is expressed in
pixels). As shown on the figure, the result is quite ugly.</p>
<pre class="code python literal-block">
<span class="keyword namespace">import</span> <span class="name namespace">numpy</span> <span class="keyword namespace">as</span> <span class="name namespace">np</span>
<span class="keyword namespace">from</span> <span class="name namespace">glumpy</span> <span class="keyword namespace">import</span> <span class="name">app</span><span class="punctuation">,</span> <span class="name">gloo</span><span class="punctuation">,</span> <span class="name">gl</span>

<span class="name">vertex</span> <span class="operator">=</span> <span class="literal string double">&quot;&quot;&quot;
  attribute vec2 position;
  void main() {
      gl_PointSize = 5.0;
      gl_Position = vec4(position, 0.0, 1.0);
  } &quot;&quot;&quot;</span>

<span class="name">fragment</span> <span class="operator">=</span> <span class="literal string double">&quot;&quot;&quot;
  void main() {
       gl_FragColor = vec4(vec3(0.0), 1.0);
  } &quot;&quot;&quot;</span>

<span class="name">window</span> <span class="operator">=</span> <span class="name">app</span><span class="operator">.</span><span class="name">Window</span><span class="punctuation">(</span><span class="literal number integer">512</span><span class="punctuation">,</span> <span class="literal number integer">512</span><span class="punctuation">,</span> <span class="name">color</span><span class="operator">=</span><span class="punctuation">(</span><span class="literal number integer">1</span><span class="punctuation">,</span><span class="literal number integer">1</span><span class="punctuation">,</span><span class="literal number integer">1</span><span class="punctuation">,</span><span class="literal number integer">1</span><span class="punctuation">))</span>
<span class="name">points</span> <span class="operator">=</span> <span class="name">gloo</span><span class="operator">.</span><span class="name">Program</span><span class="punctuation">(</span><span class="name">vertex</span><span class="punctuation">,</span> <span class="name">fragment</span><span class="punctuation">,</span> <span class="name">count</span><span class="operator">=</span><span class="literal number integer">1000</span><span class="punctuation">)</span>
<span class="name">points</span><span class="punctuation">[</span><span class="literal string double">&quot;position&quot;</span><span class="punctuation">]</span> <span class="operator">=</span> <span class="name">np</span><span class="operator">.</span><span class="name">random</span><span class="operator">.</span><span class="name">uniform</span><span class="punctuation">(</span><span class="operator">-</span><span class="literal number integer">1</span><span class="punctuation">,</span><span class="literal number integer">1</span><span class="punctuation">,(</span><span class="name builtin">len</span><span class="punctuation">(</span><span class="name">points</span><span class="punctuation">),</span><span class="literal number integer">2</span><span class="punctuation">))</span>

<span class="name decorator">&#64;window.event</span>
<span class="keyword">def</span> <span class="name function">on_draw</span><span class="punctuation">(</span><span class="name">dt</span><span class="punctuation">):</span>
    <span class="name">window</span><span class="operator">.</span><span class="name">clear</span><span class="punctuation">()</span>
    <span class="name">points</span><span class="operator">.</span><span class="name">draw</span><span class="punctuation">(</span><span class="name">gl</span><span class="operator">.</span><span class="name">GL_POINTS</span><span class="punctuation">)</span>

<span class="name">app</span><span class="operator">.</span><span class="name">run</span><span class="punctuation">()</span>
</pre>
</div>
<div class="section" id="antialiased-points">
<h3><a class="toc-backref" href="#id27">Antialiased points</a></h3>
<p>For drawing antialiased point, the size of the quad must be slighlty larger
than the actual diameter of the point because we need some extra space for the
antialias area. Considering a point with a radius <code>r</code>, the size of the quad is
thus <code>2+ceil(2*r)</code> if we consider using 1 pixel for the antalias area. Finally,
considering a point centered at <code>center</code> with radius <code>radius</code>, our vertex
shader reads (see also previous chapter on signed distance field):</p>
<pre class="code glsl literal-block">
<span class="comment single">// Screen resolution as (width, height)</span>
<span class="keyword">uniform</span> <span class="keyword type">vec2</span> <span class="name">resolution</span><span class="punctuation">;</span>

<span class="comment single">// Point center (in pixel coordinates)</span>
<span class="keyword">attribute</span> <span class="keyword type">vec2</span> <span class="name">center</span><span class="punctuation">;</span>

<span class="comment single">// Point radius (in pixels)</span>
<span class="keyword">attribute</span> <span class="keyword type">float</span> <span class="name">radius</span><span class="punctuation">;</span>

<span class="keyword">varying</span> <span class="keyword type">vec2</span> <span class="name">v_center</span><span class="punctuation">;</span>
<span class="keyword">varying</span> <span class="keyword type">float</span> <span class="name">v_radius</span><span class="punctuation">;</span>
<span class="keyword type">void</span> <span class="name">main</span><span class="punctuation">()</span>
<span class="punctuation">{</span>
    <span class="name">v_radius</span> <span class="operator">=</span> <span class="name">radius</span><span class="punctuation">;</span>
    <span class="name">v_center</span> <span class="operator">=</span> <span class="name">center</span><span class="punctuation">;</span>
    <span class="name builtin">gl_PointSize</span> <span class="operator">=</span> <span class="literal number float">2.0</span> <span class="operator">+</span> <span class="name">ceil</span><span class="punctuation">(</span><span class="literal number float">2.0</span><span class="operator">*</span><span class="name">radius</span><span class="punctuation">);</span>
    <span class="name builtin">gl_Position</span> <span class="operator">=</span> <span class="keyword type">vec4</span><span class="punctuation">(</span><span class="literal number float">2.0</span><span class="operator">*</span><span class="name">center</span><span class="operator">/</span><span class="name">resolution</span><span class="operator">-</span><span class="literal number float">1.0</span><span class="punctuation">,</span> <span class="literal number float">0.0</span><span class="punctuation">,</span> <span class="literal number float">1.0</span><span class="punctuation">);</span>
<span class="punctuation">}</span>
</pre>
<p>You may have noticed that we gave the window resolution to the shader using a
uniform (that will be updated each time the window size has changed). The goal
is to be able to use window coordinates (i.e. pixels) from within Python
without taking care of the normalized device coordinate (this transformation
has been done in the vertex shader above). We now have one problem to solve. A
GL point is made from a single vertex and the apparent size of the resulting
quad is controlled by the <code>gl_PointSize</code> variable resulting in several
fragments. How things are interpolated between vertices knowing there is only
one vertex? The answer is that there is no interpolation. If we want to know
the position of a fragment relatively to the center, we have to find it
ourself. Luckily, there is one interesting variable <code>gl_FragCoord</code> that gives
us the absolute coordinate of the fragment in window coordinates (bottom-left
is (0,0)). Subtracting the center from this coordinate will give us the
relative position of the fragment from which we can compute the distance to the
outer border of the point. Finally, our fragment shader reads:</p>
<pre class="code glsl literal-block">
<span class="keyword">varying</span> <span class="keyword type">vec2</span> <span class="name">v_center</span><span class="punctuation">;</span>
<span class="keyword">varying</span> <span class="keyword type">float</span> <span class="name">v_radius</span><span class="punctuation">;</span>
<span class="keyword type">void</span> <span class="name">main</span><span class="punctuation">()</span>
<span class="punctuation">{</span>
    <span class="keyword type">vec2</span> <span class="name">p</span> <span class="operator">=</span> <span class="name builtin">gl_FragCoord</span><span class="punctuation">.</span><span class="name">xy</span> <span class="operator">-</span> <span class="name">v_center</span><span class="punctuation">;</span>
    <span class="keyword type">float</span> <span class="name">a</span> <span class="operator">=</span> <span class="literal number float">1.0</span><span class="punctuation">;</span>
    <span class="keyword type">float</span> <span class="name">d</span> <span class="operator">=</span> <span class="name">length</span><span class="punctuation">(</span><span class="name">p</span><span class="punctuation">)</span> <span class="operator">-</span> <span class="name">v_radius</span><span class="punctuation">;</span>
    <span class="keyword">if</span><span class="punctuation">(</span><span class="name">d</span> <span class="operator">&gt;</span> <span class="literal number float">0.0</span><span class="punctuation">)</span> <span class="name">a</span> <span class="operator">=</span> <span class="name">exp</span><span class="punctuation">(</span><span class="operator">-</span><span class="name">d</span><span class="operator">*</span><span class="name">d</span><span class="punctuation">);</span>
    <span class="name builtin">gl_FragColor</span> <span class="operator">=</span> <span class="keyword type">vec4</span><span class="punctuation">(</span><span class="keyword type">vec3</span><span class="punctuation">(</span><span class="literal number float">0.0</span><span class="punctuation">),</span> <span class="name">a</span><span class="punctuation">);</span>
<span class="punctuation">}</span>
</pre>
<p>Last, we setup our python program to display some discs:</p>
<pre class="code python literal-block">
<span class="name">V</span> <span class="operator">=</span> <span class="name">np</span><span class="operator">.</span><span class="name">zeros</span><span class="punctuation">(</span><span class="literal number integer">16</span><span class="punctuation">,</span> <span class="punctuation">[(</span><span class="literal string double">&quot;center&quot;</span><span class="punctuation">,</span> <span class="name">np</span><span class="operator">.</span><span class="name">float32</span><span class="punctuation">,</span> <span class="literal number integer">2</span><span class="punctuation">),</span>
                  <span class="punctuation">(</span><span class="literal string double">&quot;radius&quot;</span><span class="punctuation">,</span> <span class="name">np</span><span class="operator">.</span><span class="name">float32</span><span class="punctuation">,</span> <span class="literal number integer">1</span><span class="punctuation">)])</span>
<span class="name">V</span><span class="punctuation">[</span><span class="literal string double">&quot;center&quot;</span><span class="punctuation">]</span> <span class="operator">=</span> <span class="name">np</span><span class="operator">.</span><span class="name">dstack</span><span class="punctuation">([</span><span class="name">np</span><span class="operator">.</span><span class="name">linspace</span><span class="punctuation">(</span><span class="literal number integer">32</span><span class="punctuation">,</span> <span class="literal number integer">512</span><span class="operator">-</span><span class="literal number integer">32</span><span class="punctuation">,</span> <span class="name builtin">len</span><span class="punctuation">(</span><span class="name">V</span><span class="punctuation">)),</span>
                         <span class="name">np</span><span class="operator">.</span><span class="name">linspace</span><span class="punctuation">(</span><span class="literal number integer">25</span><span class="punctuation">,</span> <span class="literal number integer">28</span><span class="punctuation">,</span> <span class="name builtin">len</span><span class="punctuation">(</span><span class="name">V</span><span class="punctuation">))])</span>
<span class="name">V</span><span class="punctuation">[</span><span class="literal string double">&quot;radius&quot;</span><span class="punctuation">]</span> <span class="operator">=</span> <span class="literal number integer">15</span>

<span class="name">window</span> <span class="operator">=</span> <span class="name">app</span><span class="operator">.</span><span class="name">Window</span><span class="punctuation">(</span><span class="literal number integer">512</span><span class="punctuation">,</span> <span class="literal number integer">50</span><span class="punctuation">,</span> <span class="name">color</span><span class="operator">=</span><span class="punctuation">(</span><span class="literal number integer">1</span><span class="punctuation">,</span><span class="literal number integer">1</span><span class="punctuation">,</span><span class="literal number integer">1</span><span class="punctuation">,</span><span class="literal number integer">1</span><span class="punctuation">))</span>
<span class="name">points</span> <span class="operator">=</span> <span class="name">gloo</span><span class="operator">.</span><span class="name">Program</span><span class="punctuation">(</span><span class="name">vertex</span><span class="punctuation">,</span> <span class="name">fragment</span><span class="punctuation">)</span>
<span class="name">points</span><span class="operator">.</span><span class="name">bind</span><span class="punctuation">(</span><span class="name">V</span><span class="operator">.</span><span class="name">view</span><span class="punctuation">(</span><span class="name">gloo</span><span class="operator">.</span><span class="name">VertexBuffer</span><span class="punctuation">))</span>

<span class="name decorator">&#64;window.event</span>
<span class="keyword">def</span> <span class="name function">on_resize</span><span class="punctuation">(</span><span class="name">width</span><span class="punctuation">,</span> <span class="name">height</span><span class="punctuation">):</span>
    <span class="name">points</span><span class="punctuation">[</span><span class="literal string double">&quot;resolution&quot;</span><span class="punctuation">]</span> <span class="operator">=</span> <span class="name">width</span><span class="punctuation">,</span> <span class="name">height</span>

<span class="name decorator">&#64;window.event</span>
<span class="keyword">def</span> <span class="name function">on_draw</span><span class="punctuation">(</span><span class="name">dt</span><span class="punctuation">):</span>
    <span class="name">window</span><span class="operator">.</span><span class="name">clear</span><span class="punctuation">()</span>
    <span class="name">points</span><span class="operator">.</span><span class="name">draw</span><span class="punctuation">(</span><span class="name">gl</span><span class="operator">.</span><span class="name">GL_POINTS</span><span class="punctuation">)</span>

<span class="name">app</span><span class="operator">.</span><span class="name">run</span><span class="punctuation">()</span>
</pre>
<div class="right figure" id="figure-images/chapter-07/dots-1.png" style="width: 50%">
<img alt="images/chapter-07/dots-1.png" src="images/chapter-07/dots-1.png" />
<p class="caption">Figure</p>
<div class="legend">
Discs positionned vertically with a 0.2 pixel increase.
See <a class="reference external" href="code/chapter-07/discs-aligned.py">discs-aligned.py</a></div>
</div>
<div class="right figure" id="figure-images/chapter-07/dots-2.png" style="width: 50%">
<img alt="images/chapter-07/dots-2.png" src="images/chapter-07/dots-2.png" />
<p class="caption">Figure</p>
<div class="legend">
Circles positionned vertically with a 0.2 pixel increase.
See <a class="reference external" href="code/chapter-07/circles-aligned.py">circles-aligned.py</a></div>
</div>
<p>You can see the result on the image on the right. Not only the discs are
properly antialiased, but they are also positionned at the subpixel level. In
the image on the right, each disc is actually vertically shifted upward by 0.2
pixels compared to its left neightbour. However, you cannot see any artefacts
(can you?): the discs are similar and properly aligned. For the disc outlines,
we simply have to get the absolute distance instead of the signed distance.</p>
<pre class="code glsl literal-block">
<span class="keyword">varying</span> <span class="keyword type">vec2</span> <span class="name">v_center</span><span class="punctuation">;</span>
<span class="keyword">varying</span> <span class="keyword type">float</span> <span class="name">v_radius</span><span class="punctuation">;</span>
<span class="keyword type">void</span> <span class="name">main</span><span class="punctuation">()</span>
<span class="punctuation">{</span>
    <span class="keyword type">vec2</span> <span class="name">p</span> <span class="operator">=</span> <span class="name builtin">gl_FragCoord</span><span class="punctuation">.</span><span class="name">xy</span> <span class="operator">-</span> <span class="name">v_center</span><span class="punctuation">;</span>
    <span class="keyword type">float</span> <span class="name">a</span> <span class="operator">=</span> <span class="literal number float">1.0</span><span class="punctuation">;</span>
    <span class="keyword type">float</span> <span class="name">d</span> <span class="operator">=</span> <span class="name">length</span><span class="punctuation">(</span><span class="name">p</span><span class="punctuation">)</span> <span class="operator">-</span> <span class="name">v_radius</span><span class="punctuation">;</span>
    <span class="keyword">if</span><span class="punctuation">(</span><span class="name">abs</span><span class="punctuation">(</span><span class="name">d</span><span class="punctuation">)</span> <span class="operator">&gt;</span> <span class="literal number float">0.0</span><span class="punctuation">)</span> <span class="name">a</span> <span class="operator">=</span> <span class="name">exp</span><span class="punctuation">(</span><span class="operator">-</span><span class="name">d</span><span class="operator">*</span><span class="name">d</span><span class="punctuation">);</span>
    <span class="name builtin">gl_FragColor</span> <span class="operator">=</span> <span class="keyword type">vec4</span><span class="punctuation">(</span><span class="keyword type">vec3</span><span class="punctuation">(</span><span class="literal number float">0.0</span><span class="punctuation">),</span> <span class="name">a</span><span class="punctuation">);</span>
<span class="punctuation">}</span>
</pre>
</div>
</div>
<div class="section" id="ellipses">
<h2><a class="toc-backref" href="#id27">Ellipses</a></h2>
<div class="right figure" id="figure-movies/chapter-07/ellipses.mp4" style="width: 30%">
<video controls="True" loop="True">
<source src="movies/chapter-07/ellipses.mp4"></source>
</video>
<p class="caption">Figure</p>
<div class="legend">
Perfectly antialiases ellipse made of two triangles
(<a class="reference external" href="code/chapter-07/ellipses.py">ellipses.py</a>)</div>
</div>
<p>Rendering ellipses is harder than it seems because, as we've explained in a
previous chapter, computing the distance from an arbitrary point to an ellipse
is surprinsingly difficult if you compare it to the distance to a circle. The
second difficulty for us is the fact that an ellipse can be very &quot;flat&quot; and if
we use the gl.GL_POINTS primitive, a lot of useless fragment will be
generated. This is the reason why we need to compute the bounding box
(including thickness and antialias area) and use two triangles to actually
display the ellipse. Last difficulty is that we cannot take advantage of the
<code>gl_FragCoord</code> but we can now take advantage of the four vertices to have local
coordinate interpolation in the fragment shader.</p>
<pre class="code glsl literal-block">
<span class="keyword">uniform</span> <span class="keyword type">vec2</span> <span class="name">resolution</span><span class="punctuation">;</span>
<span class="keyword">uniform</span> <span class="keyword type">float</span> <span class="name">theta</span><span class="punctuation">;</span>
<span class="keyword">attribute</span> <span class="keyword type">vec2</span> <span class="name">position</span><span class="punctuation">;</span>
<span class="keyword">attribute</span> <span class="keyword type">float</span> <span class="name">angle</span><span class="punctuation">;</span>
<span class="keyword">varying</span> <span class="keyword type">vec2</span> <span class="name">v_position</span><span class="punctuation">;</span>
<span class="keyword type">void</span> <span class="name">main</span><span class="punctuation">()</span> <span class="punctuation">{</span>
    <span class="name">v_position</span> <span class="operator">=</span> <span class="name">position</span><span class="punctuation">;</span>
    <span class="keyword type">vec2</span> <span class="name">p</span> <span class="operator">=</span> <span class="name">position</span><span class="punctuation">;</span>
    <span class="name">p</span> <span class="operator">=</span> <span class="keyword type">vec2</span><span class="punctuation">(</span><span class="name">p</span><span class="punctuation">.</span><span class="name">x</span><span class="operator">*</span><span class="name">cos</span><span class="punctuation">(</span><span class="name">angle</span><span class="operator">+</span><span class="name">theta</span><span class="punctuation">)</span> <span class="operator">-</span> <span class="name">p</span><span class="punctuation">.</span><span class="name">y</span><span class="operator">*</span><span class="name">sin</span><span class="punctuation">(</span><span class="name">angle</span><span class="operator">+</span><span class="name">theta</span><span class="punctuation">),</span>
             <span class="name">p</span><span class="punctuation">.</span><span class="name">y</span><span class="operator">*</span><span class="name">cos</span><span class="punctuation">(</span><span class="name">angle</span><span class="operator">+</span><span class="name">theta</span><span class="punctuation">)</span> <span class="operator">+</span> <span class="name">p</span><span class="punctuation">.</span><span class="name">x</span><span class="operator">*</span><span class="name">sin</span><span class="punctuation">(</span><span class="name">angle</span><span class="operator">+</span><span class="name">theta</span><span class="punctuation">));</span>
    <span class="name">p</span> <span class="operator">=</span> <span class="name">p</span> <span class="operator">+</span> <span class="name">resolution</span><span class="operator">/</span><span class="literal number float">2.0</span><span class="punctuation">;</span>
    <span class="name builtin">gl_Position</span> <span class="operator">=</span> <span class="keyword type">vec4</span><span class="punctuation">(</span><span class="literal number float">2.0</span><span class="operator">*</span><span class="name">p</span><span class="operator">/</span><span class="name">resolution</span><span class="operator">-</span><span class="literal number float">1.0</span><span class="punctuation">,</span> <span class="literal number float">0.0</span><span class="punctuation">,</span> <span class="literal number float">1.0</span><span class="punctuation">);</span>
<span class="punctuation">}</span>
</pre>
<p>Note that in the vertex shader above, we pass the non-rotated coordinates to
the fragment shader. It makes things much simpler in the fragment shader that
reads:</p>
<pre class="code glsl literal-block">
<span class="keyword type">float</span> <span class="name">SDF_fake_ellipse</span><span class="punctuation">(</span><span class="keyword type">vec2</span> <span class="name">p</span><span class="punctuation">,</span> <span class="keyword type">vec2</span> <span class="name">size</span><span class="punctuation">)</span> <span class="punctuation">{</span>
  <span class="keyword type">float</span> <span class="name">a</span> <span class="operator">=</span> <span class="literal number float">1.0</span><span class="punctuation">;</span>
  <span class="keyword type">float</span> <span class="name">b</span> <span class="operator">=</span> <span class="name">size</span><span class="punctuation">.</span><span class="name">x</span><span class="operator">/</span><span class="name">size</span><span class="punctuation">.</span><span class="name">y</span><span class="punctuation">;</span>
  <span class="keyword type">float</span> <span class="name">r</span> <span class="operator">=</span> <span class="literal number float">0.5</span><span class="operator">*</span><span class="name">max</span><span class="punctuation">(</span><span class="name">size</span><span class="punctuation">.</span><span class="name">x</span><span class="punctuation">,</span><span class="name">size</span><span class="punctuation">.</span><span class="name">y</span><span class="punctuation">);</span>
  <span class="keyword type">float</span> <span class="name">f</span> <span class="operator">=</span> <span class="name">length</span><span class="punctuation">(</span><span class="name">p</span><span class="operator">*</span><span class="keyword type">vec2</span><span class="punctuation">(</span><span class="name">a</span><span class="punctuation">,</span><span class="name">b</span><span class="punctuation">));</span>
  <span class="keyword">return</span> <span class="name">f</span><span class="operator">*</span><span class="punctuation">(</span><span class="name">f</span><span class="operator">-</span><span class="name">r</span><span class="punctuation">)</span><span class="operator">/</span><span class="name">length</span><span class="punctuation">(</span><span class="name">p</span><span class="operator">*</span><span class="keyword type">vec2</span><span class="punctuation">(</span><span class="name">a</span><span class="operator">*</span><span class="name">a</span><span class="punctuation">,</span><span class="name">b</span><span class="operator">*</span><span class="name">b</span><span class="punctuation">));</span>
<span class="punctuation">}</span>

<span class="keyword">uniform</span> <span class="keyword type">vec2</span> <span class="name">size</span><span class="punctuation">;</span>
<span class="keyword">varying</span> <span class="keyword type">vec2</span> <span class="name">v_position</span><span class="punctuation">;</span>
<span class="keyword type">void</span> <span class="name">main</span><span class="punctuation">()</span> <span class="punctuation">{</span>
    <span class="keyword type">float</span> <span class="name">d</span> <span class="operator">=</span> <span class="name">SDF_fake_ellipse</span><span class="punctuation">(</span><span class="name">v_position</span><span class="punctuation">,</span> <span class="name">size</span><span class="punctuation">)</span> <span class="operator">+</span> <span class="literal number float">1.0</span><span class="punctuation">;</span>
    <span class="keyword type">float</span> <span class="name">alpha</span><span class="punctuation">;</span>
    <span class="keyword">if</span> <span class="punctuation">(</span><span class="name">abs</span><span class="punctuation">(</span><span class="name">d</span><span class="punctuation">)</span> <span class="operator">&lt;</span> <span class="literal number float">1.0</span><span class="punctuation">)</span> <span class="name">alpha</span> <span class="operator">=</span> <span class="name">exp</span><span class="punctuation">(</span><span class="operator">-</span><span class="name">d</span><span class="operator">*</span><span class="name">d</span><span class="punctuation">)</span><span class="operator">/</span> <span class="literal number float">4.0</span><span class="punctuation">;</span>
    <span class="keyword">else</span> <span class="keyword">if</span> <span class="punctuation">(</span><span class="name">d</span> <span class="operator">&lt;</span> <span class="literal number float">0.0</span><span class="punctuation">)</span> <span class="name">alpha</span> <span class="operator">=</span>       <span class="literal number float">1.0</span><span class="operator">/</span><span class="literal number float">16.0</span><span class="punctuation">;</span>
    <span class="keyword">else</span>              <span class="name">alpha</span> <span class="operator">=</span> <span class="name">exp</span><span class="punctuation">(</span><span class="operator">-</span><span class="name">d</span><span class="operator">*</span><span class="name">d</span><span class="punctuation">)</span><span class="operator">/</span><span class="literal number float">16.0</span><span class="punctuation">;</span>
    <span class="name builtin">gl_FragColor</span> <span class="operator">=</span> <span class="keyword type">vec4</span><span class="punctuation">(</span><span class="keyword type">vec3</span><span class="punctuation">(</span><span class="literal number float">0.0</span><span class="punctuation">),</span> <span class="name">alpha</span><span class="punctuation">);</span>
<span class="punctuation">}</span>
</pre>
</div>
<div class="section" id="spheres">
<h2><a class="toc-backref" href="#id27">Spheres</a></h2>
<div class="section" id="flat-sphere">
<h3><a class="toc-backref" href="#id27">Flat sphere</a></h3>
<div class="right figure" id="figure-images/chapter-07/sphere.png" style="width: 30%">
<img alt="images/chapter-07/sphere.png" src="images/chapter-07/sphere.png" />
<p class="caption">Figure</p>
<div class="legend">
A lit sphere</div>
</div>
<p>If you look closely at a sphere, you'll see that that the projected shape on
screen is actually a disc as shown on the figure on the right. This is actually
true independently of the viewpoint and we can take advantage of it. A long
time ago (with the fixed pipeline), rendering a sphere meant tesselating the
sphere with a large number of triangles. The larger the number of triangles,
the higher the quality of the sphere and the slower the rendering. However,
with the advent of shaders, things have changed dramatically and we can use
fake spheres, i.e. discs that are painted such as to appear as spheres. This is
known as &quot;impostors&quot;. If you look again at the image, you might realize that
the appeareance of the sphere is given by the shading that is not uniform and
suggests instead a specific lighting that seems to come from the upper right
corner. Let's see if we can reproduce this.</p>
<div class="right figure" id="figure-images/chapter-07/sphere-1.png" style="width: 20%">
<img alt="images/chapter-07/sphere-1.png" src="images/chapter-07/sphere-1.png" />
<p class="caption">Figure</p>
<div class="legend">
A black disc (<a class="reference external" href="code/chapter-07/sphere-1.py">sphere-1.py</a>)</div>
</div>
<p>First thing first, Let's setup a scene in order to display a single and large
disc. To do that, we simply test if a fragment is inside or outside the circle:</p>
<pre class="code glsl literal-block">
<span class="keyword">varying</span> <span class="keyword type">vec2</span> <span class="name">v_center</span><span class="punctuation">;</span>
<span class="keyword">varying</span> <span class="keyword type">float</span> <span class="name">v_radius</span><span class="punctuation">;</span>
<span class="keyword type">void</span> <span class="name">main</span><span class="punctuation">()</span>
<span class="punctuation">{</span>
    <span class="keyword type">vec2</span> <span class="name">p</span> <span class="operator">=</span> <span class="name builtin">gl_FragCoord</span><span class="punctuation">.</span><span class="name">xy</span> <span class="operator">-</span> <span class="name">v_center</span><span class="punctuation">;</span>
    <span class="keyword type">float</span> <span class="name">z</span> <span class="operator">=</span> <span class="literal number float">1.0</span> <span class="operator">-</span> <span class="name">length</span><span class="punctuation">(</span><span class="name">p</span><span class="punctuation">)</span><span class="operator">/</span><span class="name">v_radius</span><span class="punctuation">;</span>
    <span class="keyword">if</span> <span class="punctuation">(</span><span class="name">z</span> <span class="operator">&lt;</span> <span class="literal number float">0.0</span><span class="punctuation">)</span> <span class="keyword">discard</span><span class="punctuation">;</span>
    <span class="name builtin">gl_FragColor</span> <span class="operator">=</span> <span class="keyword type">vec4</span><span class="punctuation">(</span><span class="keyword type">vec3</span><span class="punctuation">(</span><span class="literal number float">0.0</span><span class="punctuation">),</span> <span class="literal number float">1.0</span><span class="punctuation">);</span>
<span class="punctuation">}</span>
</pre>
<hr class="docutils" />
<div class="right figure" id="figure-images/chapter-07/sphere-normals.png" style="width: 20%">
<img alt="images/chapter-07/sphere-normals.png" src="images/chapter-07/sphere-normals.png" />
<p class="caption">Figure</p>
<div class="legend">
Sphere normals view on the xz plane.</div>
</div>
<p>To simulate lighting on the disc, we need to compute normal vectors over the
surface of the sphere (i.e. disc). Luckily enough for us, computing the normal
for a sphere is very easy. We can simply use the <code>p=(x,y)</code> coordinates inside the
fragment shader and compute the <code>z</code> coordinate. How? you might ask
yourself. This is actually correlated to the distance <code>d</code> to the center such
that <code>z = 1-d</code>. If you want to convice yourself, just look at the figure on
the right that shows a side view of half a sphere on the xz plane. The z
coordinate is maximal in the center and null on the border.</p>
<p>We're ready to simulate lighting on our disc using the <a class="reference external" href="https://en.wikipedia.org/wiki/Phong_reflection_model">Phong model</a>. I won't give all the
detail now because we'll see that later. However, as you can see on the source
below, this is quite easy and the result is flawless.</p>
<div class="right figure" id="figure-images/chapter-07/sphere-3.png" style="width: 20%">
<img alt="images/chapter-07/sphere-3.png" src="images/chapter-07/sphere-3.png" />
<p class="caption">Figure</p>
<div class="legend">
A fake lit sphere (<a class="reference external" href="code/chapter-07/sphere-3.py">sphere-3.py</a>)</div>
</div>
<pre class="code glsl literal-block">
<span class="keyword">varying</span> <span class="keyword type">vec2</span> <span class="name">v_center</span><span class="punctuation">;</span>
<span class="keyword">varying</span> <span class="keyword type">float</span> <span class="name">v_radius</span><span class="punctuation">;</span>
<span class="keyword type">void</span> <span class="name">main</span><span class="punctuation">()</span>
<span class="punctuation">{</span>
    <span class="keyword type">vec2</span> <span class="name">p</span> <span class="operator">=</span> <span class="punctuation">(</span><span class="name builtin">gl_FragCoord</span><span class="punctuation">.</span><span class="name">xy</span> <span class="operator">-</span> <span class="name">v_center</span><span class="punctuation">)</span><span class="operator">/</span><span class="name">v_radius</span><span class="punctuation">;</span>
    <span class="keyword type">float</span> <span class="name">z</span> <span class="operator">=</span> <span class="literal number float">1.0</span> <span class="operator">-</span> <span class="name">length</span><span class="punctuation">(</span><span class="name">p</span><span class="punctuation">);</span>
    <span class="keyword">if</span> <span class="punctuation">(</span><span class="name">z</span> <span class="operator">&lt;</span> <span class="literal number float">0.0</span><span class="punctuation">)</span> <span class="keyword">discard</span><span class="punctuation">;</span>

    <span class="keyword type">vec3</span> <span class="name">color</span> <span class="operator">=</span> <span class="keyword type">vec3</span><span class="punctuation">(</span><span class="literal number float">1.0</span><span class="punctuation">,</span> <span class="literal number float">0.0</span><span class="punctuation">,</span> <span class="literal number float">0.0</span><span class="punctuation">);</span>
    <span class="keyword type">vec3</span> <span class="name">normal</span> <span class="operator">=</span> <span class="name">normalize</span><span class="punctuation">(</span><span class="keyword type">vec3</span><span class="punctuation">(</span><span class="name">p</span><span class="punctuation">.</span><span class="name">xy</span><span class="punctuation">,</span> <span class="name">z</span><span class="punctuation">));</span>
    <span class="keyword type">vec3</span> <span class="name">direction</span> <span class="operator">=</span> <span class="name">normalize</span><span class="punctuation">(</span><span class="keyword type">vec3</span><span class="punctuation">(</span><span class="literal number float">1.0</span><span class="punctuation">,</span> <span class="literal number float">1.0</span><span class="punctuation">,</span> <span class="literal number float">1.0</span><span class="punctuation">));</span>
    <span class="keyword type">float</span> <span class="name">diffuse</span> <span class="operator">=</span> <span class="name">max</span><span class="punctuation">(</span><span class="literal number float">0.0</span><span class="punctuation">,</span> <span class="name">dot</span><span class="punctuation">(</span><span class="name">direction</span><span class="punctuation">,</span> <span class="name">normal</span><span class="punctuation">));</span>
    <span class="keyword type">float</span> <span class="name">specular</span> <span class="operator">=</span> <span class="name">pow</span><span class="punctuation">(</span><span class="name">diffuse</span><span class="punctuation">,</span> <span class="literal number float">24.0</span><span class="punctuation">);</span>
    <span class="name builtin">gl_FragColor</span> <span class="operator">=</span> <span class="keyword type">vec4</span><span class="punctuation">(</span><span class="name">max</span><span class="punctuation">(</span><span class="name">diffuse</span><span class="operator">*</span><span class="name">color</span><span class="punctuation">,</span> <span class="name">specular</span><span class="operator">*</span><span class="keyword type">vec3</span><span class="punctuation">(</span><span class="literal number float">1.0</span><span class="punctuation">)),</span> <span class="literal number float">1.0</span><span class="punctuation">);</span>
<span class="punctuation">}</span>
</pre>
</div>
<hr class="docutils" />
<div class="section" id="true-sphere">
<h3><a class="toc-backref" href="#id27">True sphere</a></h3>
<div class="right figure" id="figure-images/chapter-07/spheres-no-depth.png" style="width: 30%">
<img alt="images/chapter-07/spheres-no-depth.png" src="images/chapter-07/spheres-no-depth.png" />
<p class="caption">Figure</p>
<div class="legend">
A bunch of fake spheres.</div>
</div>
<p>We can use this technique to display several &quot;spheres&quot; having different sizes
and positions as shown on the figure on the right. This can be used to
represent molecules for examples. Howewer, we have a problem with sphere
intersecting each other. If you look closely the figure, you might have notices
that no sphere intersect any sphere. This is due to the depth testing of the
unique vertex (remember gl.GL_POINTS) that is used to generate the quad
fragments. Each of these fragments share the same <code>z</code> coordinate resulting in
having sphre fully in front of another of fully behind another. For accurate
rendering, we thus have to tell OpenGL what is the depth of each fragment using
the <code>gl_FragDepth</code> variable (that must be between 0 and 1):</p>
<div class="right figure" id="figure-images/chapter-07/spheres.png" style="width: 30%">
<img alt="images/chapter-07/spheres.png" src="images/chapter-07/spheres.png" />
<p class="caption">Figure</p>
<div class="legend">
A bunch of fake spheres with correct intersections
(<a class="reference external" href="code/chapter-07/spheres.py">spheres.py</a>).</div>
</div>
<pre class="code glsl literal-block">
<span class="keyword">varying</span> <span class="keyword type">vec3</span> <span class="name">v_center</span><span class="punctuation">;</span>
<span class="keyword">varying</span> <span class="keyword type">float</span> <span class="name">v_radius</span><span class="punctuation">;</span>
<span class="keyword type">void</span> <span class="name">main</span><span class="punctuation">()</span>
<span class="punctuation">{</span>
    <span class="keyword type">vec2</span> <span class="name">p</span> <span class="operator">=</span> <span class="punctuation">(</span><span class="name builtin">gl_FragCoord</span><span class="punctuation">.</span><span class="name">xy</span> <span class="operator">-</span> <span class="name">v_center</span><span class="punctuation">.</span><span class="name">xy</span><span class="punctuation">)</span><span class="operator">/</span><span class="name">v_radius</span><span class="punctuation">;</span>
    <span class="keyword type">float</span> <span class="name">z</span> <span class="operator">=</span> <span class="literal number float">1.0</span> <span class="operator">-</span> <span class="name">length</span><span class="punctuation">(</span><span class="name">p</span><span class="punctuation">);</span>
    <span class="keyword">if</span> <span class="punctuation">(</span><span class="name">z</span> <span class="operator">&lt;</span> <span class="literal number float">0.0</span><span class="punctuation">)</span> <span class="keyword">discard</span><span class="punctuation">;</span>

    <span class="name builtin">gl_FragDepth</span> <span class="operator">=</span> <span class="literal number float">0.5</span><span class="operator">*</span><span class="name">v_center</span><span class="punctuation">.</span><span class="name">z</span> <span class="operator">+</span> <span class="literal number float">0.5</span><span class="operator">*</span><span class="punctuation">(</span><span class="literal number float">1.0</span> <span class="operator">-</span> <span class="name">z</span><span class="punctuation">);</span>

    <span class="keyword type">vec3</span> <span class="name">color</span> <span class="operator">=</span> <span class="keyword type">vec3</span><span class="punctuation">(</span><span class="literal number float">1.0</span><span class="punctuation">,</span> <span class="literal number float">0.0</span><span class="punctuation">,</span> <span class="literal number float">0.0</span><span class="punctuation">);</span>
    <span class="keyword type">vec3</span> <span class="name">normal</span> <span class="operator">=</span> <span class="name">normalize</span><span class="punctuation">(</span><span class="keyword type">vec3</span><span class="punctuation">(</span><span class="name">p</span><span class="punctuation">.</span><span class="name">xy</span><span class="punctuation">,</span> <span class="name">z</span><span class="punctuation">));</span>
    <span class="keyword type">vec3</span> <span class="name">direction</span> <span class="operator">=</span> <span class="name">normalize</span><span class="punctuation">(</span><span class="keyword type">vec3</span><span class="punctuation">(</span><span class="literal number float">1.0</span><span class="punctuation">,</span> <span class="literal number float">1.0</span><span class="punctuation">,</span> <span class="literal number float">1.0</span><span class="punctuation">));</span>
    <span class="keyword type">float</span> <span class="name">diffuse</span> <span class="operator">=</span> <span class="name">max</span><span class="punctuation">(</span><span class="literal number float">0.0</span><span class="punctuation">,</span> <span class="name">dot</span><span class="punctuation">(</span><span class="name">direction</span><span class="punctuation">,</span> <span class="name">normal</span><span class="punctuation">));</span>
    <span class="keyword type">float</span> <span class="name">specular</span> <span class="operator">=</span> <span class="name">pow</span><span class="punctuation">(</span><span class="name">diffuse</span><span class="punctuation">,</span> <span class="literal number float">24.0</span><span class="punctuation">);</span>
    <span class="name builtin">gl_FragColor</span> <span class="operator">=</span> <span class="keyword type">vec4</span><span class="punctuation">(</span><span class="name">max</span><span class="punctuation">(</span><span class="name">diffuse</span><span class="operator">*</span><span class="name">color</span><span class="punctuation">,</span> <span class="name">specular</span><span class="operator">*</span><span class="keyword type">vec3</span><span class="punctuation">(</span><span class="literal number float">1.0</span><span class="punctuation">)),</span> <span class="literal number float">1.0</span><span class="punctuation">);</span>
<span class="punctuation">}</span>
</pre>
<p>You can see on the figures that the spheres now intersect each other correctly.</p>
</div>
</div>
<div class="section" id="id28">
<h2><a class="toc-backref" href="#id27">Exercises</a></h2>
<div class="section" id="tiny-discs">
<h3><a class="toc-backref" href="#id27">Tiny discs</a></h3>
<div class="right figure" id="figure-images/chapter-07/spiral.png" style="width: 30%">
<img alt="images/chapter-07/spiral.png" src="images/chapter-07/spiral.png" />
<p class="caption">Figure</p>
<div class="legend">
Disc spiral</div>
</div>
<p>Adapting the shader from the &quot;Dots, discs, circles&quot; section, try to write a
script to draw discs on a spiral as displayed on the figure on the right. Be
careful with small discs, especially when the radius is less than one pixel. In
such case, you'll have to find a convincing way to suggest the size of the
disc...</p>
<p>Solution: <a class="reference external" href="code/chapter-07/spiral.py">spiral.py</a></p>
</div>
<div class="section" id="antialiased-triangles">
<h3><a class="toc-backref" href="#id27">Antialiased triangles</a></h3>
<div class="right figure" id="figure-movies/chapter-07/triangles.mp4" style="width: 30%">
<video controls="True" loop="True">
<source src="movies/chapter-07/triangles.mp4"></source>
</video>
<p class="caption">Figure</p>
<div class="legend">
Antialiased triangles</div>
</div>
<p>Try to adapt the code from the ellipses section to remake the animation on the
right. Be careful with the computation of the bouding box.</p>
<p>Solution: <a class="reference external" href="code/chapter-07/triangles.py">triangles.py</a></p>
</div>
<div class="section" id="gpu-voronoi">
<h3><a class="toc-backref" href="#id27">GPU Voronoi</a></h3>
<div class="right figure" id="figure-images/chapter-07/voronoi.png" style="width: 30%">
<img alt="images/chapter-07/voronoi.png" src="images/chapter-07/voronoi.png" />
<p class="caption">Figure</p>
<div class="legend">
A voronoi diagram computed on the GPU.</div>
</div>
<p>We've seen when rendering sphere that the individual depth of each fragment can
be controled withing the fragment shader and we computed this depth by taking
the distance to the center of each disc/sphere. The goal of this exercise is
thus to adapt this method to render a Voronoi diagram as shown on the right.</p>
<p>Solution: <a class="reference external" href="code/chapter-07/voronoi.py">voronoi.py</a></p>
</div>
</div>
</div>
<hr class="docutils" />
<div class="section" id="rendering-markers">
<h1><a class="toc-backref" href="#contents">Rendering markers</a></h1>
<div class="contents toc chapter-08 local topic" id="id29">
<p class="topic-title first">.</p>
<ul class="simple">
<li><a class="reference internal" href="#constructive-solid-geometry" id="id192">Constructive Solid Geometry</a></li>
<li><a class="reference internal" href="#markers" id="id193">Markers</a></li>
<li><a class="reference internal" href="#arrows" id="id194">Arrows</a></li>
<li><a class="reference internal" href="#texture-based" id="id195">Texture based</a></li>
<li><a class="reference internal" href="#id37" id="id196">Exercises</a><ul>
<li><a class="reference internal" href="#quiver-plot" id="id197">Quiver plot</a></li>
<li><a class="reference internal" href="#light-and-shadows" id="id198">Light and shadows</a></li>
</ul>
</li>
</ul>
</div>
<p>Markers and arrows are important components in scientific visualisation.
Markers help to visualize individual points and aggregated data while arrows
can be used to visualize a stream flow. Markers and arrows can be actually
rendered very fast by taking advantage of the shader. In fact, they can be
drawn entirely inside the shader provided we know the size, the type and the
orientation. The teaser figure comes from an <a class="reference external" href="http://jcgt.org/published/0003/04/01/">article</a> I wrote and published in the journal
of Computer Graphics and Techniques. The content of this chapter is largely
inspired by this article.</p>
<div class="section" id="constructive-solid-geometry">
<h2><a class="toc-backref" href="#id29">Constructive Solid Geometry</a></h2>
<div class="right figure" id="figure-images/chapter-08/CSG.png" style="width: 50%">
<img alt="images/chapter-08/CSG.png" src="images/chapter-08/CSG.png" />
<p class="caption">Figure</p>
<div class="legend">
Constructive solid geometry (CSG) allows a to create a complex object by using
Boolean operators to combine simpler objects.</div>
</div>
<p>Constructive solid geometry (CSG) is a technique used for modeling in order to
create a complex object by using Boolean operators to combine simpler objects
(primitives). Resulting objects appear visually complex but are actually a
cleverly combined or decombined objects. The teaser image in the <a class="reference internal" href="#glsl-references">GLSL
References</a> chapter is the result of <a class="reference external" href="http://iquilezles.org/www/articles/distfunctions/distfunctions.htm">complex constructive geometry in 3D</a>. See
also the Wikipedia entry on <a class="reference external" href="https://en.wikipedia.org/wiki/Truth_function">Truth function</a>.</p>
<p>This is the reason we did not bother to try to render complex shapes in the
previous section. Using constructive solid geometry, we are free to model
pretty much anything and we'll see that in the markers section below. In the
meantime, we need to define our CSG operations in glsl. The good news is that
it is incredibly simple, just read:</p>
<pre class="code glsl literal-block">
<span class="comment single">// Union (A or B)</span>
<span class="keyword type">float</span> <span class="name">csg_union</span><span class="punctuation">(</span><span class="keyword type">float</span> <span class="name">d1</span><span class="punctuation">,</span> <span class="keyword type">float</span> <span class="name">d2</span><span class="punctuation">)</span>
<span class="punctuation">{</span> <span class="keyword">return</span> <span class="name">min</span><span class="punctuation">(</span><span class="name">d1</span><span class="punctuation">,</span><span class="name">d2</span><span class="punctuation">);</span> <span class="punctuation">}</span>

<span class="comment single">// Difference (A not B)</span>
<span class="keyword type">float</span> <span class="name">csg_difference</span><span class="punctuation">(</span><span class="keyword type">float</span> <span class="name">d1</span><span class="punctuation">,</span> <span class="keyword type">float</span> <span class="name">d2</span><span class="punctuation">)</span>
<span class="punctuation">{</span> <span class="keyword">return</span> <span class="name">max</span><span class="punctuation">(</span><span class="name">d1</span><span class="punctuation">,</span><span class="operator">-</span><span class="name">d2</span><span class="punctuation">);</span> <span class="punctuation">}</span>

<span class="comment single">// Intersection (A and B)</span>
<span class="keyword type">float</span> <span class="name">csg_intersection</span><span class="punctuation">(</span><span class="keyword type">float</span> <span class="name">d1</span><span class="punctuation">,</span> <span class="keyword type">float</span> <span class="name">d2</span><span class="punctuation">)</span>
<span class="punctuation">{</span>  <span class="keyword">return</span> <span class="name">max</span><span class="punctuation">(</span><span class="name">d1</span><span class="punctuation">,</span><span class="name">d2</span><span class="punctuation">);</span> <span class="punctuation">}</span>

<span class="comment single">// Exclusion (A xor B)</span>
<span class="keyword type">float</span> <span class="name">csg_exclusion</span><span class="punctuation">(</span><span class="keyword type">float</span> <span class="name">d1</span><span class="punctuation">,</span> <span class="keyword type">float</span> <span class="name">d2</span><span class="punctuation">)</span>
<span class="punctuation">{</span> <span class="keyword">return</span> <span class="name">min</span><span class="punctuation">(</span><span class="name">max</span><span class="punctuation">(</span><span class="name">d1</span><span class="punctuation">,</span><span class="operator">-</span><span class="name">d2</span><span class="punctuation">),</span> <span class="name">max</span><span class="punctuation">(</span><span class="operator">-</span><span class="name">d1</span><span class="punctuation">,</span><span class="name">d2</span><span class="punctuation">));</span> <span class="punctuation">}</span>
</pre>
<p>And we can check for the result using two circles (the shadertoy link for each
example allows you to play online with them):</p>
<div class="right figure" id="figure-images/chapter-08/csg-intersection.png" style="width: 30%">
<img alt="images/chapter-08/csg-intersection.png" src="images/chapter-08/csg-intersection.png" />
<p class="caption">Figure</p>
<div class="legend">
<div class="line-block">
<div class="line">Intersection (A and B)</div>
<div class="line"><a class="reference external" href="code/chapter-08/csg-intersection.py">CSG-intersection.py</a> / <a class="reference external" href="https://www.shadertoy.com/view/XllyWn">Shadertoy</a></div>
</div>
</div>
</div>
<div class="right figure" id="figure-images/chapter-08/csg-union.png" style="width: 30%">
<img alt="images/chapter-08/csg-union.png" src="images/chapter-08/csg-union.png" />
<p class="caption">Figure</p>
<div class="legend">
<div class="line-block">
<div class="line">Union (A or B)</div>
<div class="line"><a class="reference external" href="code/chapter-08/csg-union.py">CSG-union.py</a> / <a class="reference external" href="https://www.shadertoy.com/view/4tlyWn">Shadertoy</a></div>
</div>
</div>
</div>
<div class="right figure" id="figure-images/chapter-08/csg-mix.png" style="width: 30%">
<img alt="images/chapter-08/csg-mix.png" src="images/chapter-08/csg-mix.png" />
<p class="caption">Figure</p>
<div class="legend">
<div class="line-block">
<div class="line">Two SDF circles (A, B)</div>
<div class="line"><a class="reference external" href="code/chapter-08/csg-mix.py">CSG-mix.py</a> / <a class="reference external" href="https://www.shadertoy.com/view/MtfcDr">Shadertoy</a></div>
</div>
</div>
</div>
<hr class="docutils" />
<div class="right figure" id="figure-images/chapter-08/csg-exclusion.png" style="width: 30%">
<img alt="images/chapter-08/csg-exclusion.png" src="images/chapter-08/csg-exclusion.png" />
<p class="caption">Figure</p>
<div class="legend">
<div class="line-block">
<div class="line">Exclusion (A xor B)</div>
<div class="line"><a class="reference external" href="code/chapter-08/csg-exclusion.py">CSG-exclusion.py</a> / <a class="reference external" href="https://www.shadertoy.com/view/4tsyWn">Shadertoy</a></div>
</div>
</div>
</div>
<div class="right figure" id="figure-images/chapter-08/csg-difference-2.png" style="width: 30%">
<img alt="images/chapter-08/csg-difference-2.png" src="images/chapter-08/csg-difference-2.png" />
<p class="caption">Figure</p>
<div class="legend">
<div class="line-block">
<div class="line">Difference (B not A)</div>
<div class="line"><a class="reference external" href="code/chapter-08/csg-difference-2.py">CSG-difference-2.py</a> / <a class="reference external" href="https://www.shadertoy.com/view/XtsyWn">Shadertoy</a></div>
</div>
</div>
</div>
<div class="right figure" id="figure-images/chapter-08/csg-difference-1.png" style="width: 30%">
<img alt="images/chapter-08/csg-difference-1.png" src="images/chapter-08/csg-difference-1.png" />
<p class="caption">Figure</p>
<div class="legend">
<div class="line-block">
<div class="line">Difference (A not B)</div>
<div class="line"><a class="reference external" href="code/chapter-08/csg-difference-1.py">CSG-difference-1.py</a> / <a class="reference external" href="https://www.shadertoy.com/view/4llyWn">Shadertoy</a></div>
</div>
</div>
</div>
</div>
<div class="section" id="markers">
<h2><a class="toc-backref" href="#id29">Markers</a></h2>
<div class="right figure" id="figure-csg-markers" style="width: 50%">
<img alt="images/chapter-08/CSG-markers.png" src="images/chapter-08/CSG-markers.png" />
<p class="caption">Figure</p>
<div class="legend">
Some example of markers constructed using CSG. See below for corresponding
GLSL code.</div>
</div>
<p>As illustrated on the right figure creating markers is merely a matter of
imagination. Try to think of a precise shape and see how you can decompose it
in terms of constructive solid geometry. I've put a collection of such markers
in the (open access) article <a class="reference external" href="http://jcgt.org/published/0003/04/01/">Antialiased 2D Grid, Marker, and Arrow Shaders</a>.</p>
<p>All these markers are also defined in the glumpy library. Have a look at the
<a class="reference external" href="code/chapter-08/marker.py">marker.py</a> example where you can experiment with
the different markers and the different rendering options. Feel free to design
your own and to open a pull request to have them added to glumpy. Note that all
the markers have a default orientation that can be changed very easily from
within the shader.</p>
<p>For example, the heart marker, which is made of two discs and one sphere, reads
as follows:</p>
<pre class="code glsl literal-block">
<span class="keyword type">float</span> <span class="name">marker_heart</span><span class="punctuation">(</span><span class="keyword type">vec2</span> <span class="name">P</span><span class="punctuation">,</span> <span class="keyword type">float</span> <span class="name">size</span><span class="punctuation">)</span>
<span class="punctuation">{</span>
   <span class="keyword type">float</span> <span class="name">x</span> <span class="operator">=</span> <span class="name">M_SQRT2</span><span class="operator">/</span><span class="literal number float">2.0</span> <span class="operator">*</span> <span class="punctuation">(</span><span class="name">P</span><span class="punctuation">.</span><span class="name">x</span> <span class="operator">-</span> <span class="name">P</span><span class="punctuation">.</span><span class="name">y</span><span class="punctuation">);</span>
   <span class="keyword type">float</span> <span class="name">y</span> <span class="operator">=</span> <span class="name">M_SQRT2</span><span class="operator">/</span><span class="literal number float">2.0</span> <span class="operator">*</span> <span class="punctuation">(</span><span class="name">P</span><span class="punctuation">.</span><span class="name">x</span> <span class="operator">+</span> <span class="name">P</span><span class="punctuation">.</span><span class="name">y</span><span class="punctuation">);</span>

   <span class="comment single">// Square</span>
   <span class="keyword type">float</span> <span class="name">r1</span> <span class="operator">=</span> <span class="name">max</span><span class="punctuation">(</span><span class="name">abs</span><span class="punctuation">(</span><span class="name">x</span><span class="punctuation">),</span><span class="name">abs</span><span class="punctuation">(</span><span class="name">y</span><span class="punctuation">))</span><span class="operator">-</span><span class="name">size</span><span class="operator">/</span><span class="literal number float">3.5</span><span class="punctuation">;</span>

   <span class="comment single">// Disc 1</span>
   <span class="keyword type">float</span> <span class="name">r2</span> <span class="operator">=</span> <span class="name">length</span><span class="punctuation">(</span><span class="name">P</span> <span class="operator">-</span> <span class="name">M_SQRT2</span><span class="operator">/</span><span class="literal number float">2.0</span><span class="operator">*</span><span class="keyword type">vec2</span><span class="punctuation">(</span><span class="operator">+</span><span class="literal number float">1.0</span><span class="punctuation">,</span><span class="operator">-</span><span class="literal number float">1.0</span><span class="punctuation">)</span><span class="operator">*</span><span class="name">size</span><span class="operator">/</span><span class="literal number float">3.5</span><span class="punctuation">)</span> <span class="operator">-</span> <span class="name">size</span><span class="operator">/</span><span class="literal number float">3.5</span><span class="punctuation">;</span>

   <span class="comment single">// Disc 2</span>
   <span class="keyword type">float</span> <span class="name">r3</span> <span class="operator">=</span> <span class="name">length</span><span class="punctuation">(</span><span class="name">P</span> <span class="operator">-</span> <span class="name">M_SQRT2</span><span class="operator">/</span><span class="literal number float">2.0</span><span class="operator">*</span><span class="keyword type">vec2</span><span class="punctuation">(</span><span class="operator">-</span><span class="literal number float">1.0</span><span class="punctuation">,</span><span class="operator">-</span><span class="literal number float">1.0</span><span class="punctuation">)</span><span class="operator">*</span><span class="name">size</span><span class="operator">/</span><span class="literal number float">3.5</span><span class="punctuation">)</span> <span class="operator">-</span> <span class="name">size</span><span class="operator">/</span><span class="literal number float">3.5</span><span class="punctuation">;</span>

   <span class="keyword">return</span> <span class="name">min</span><span class="punctuation">(</span><span class="name">min</span><span class="punctuation">(</span><span class="name">r1</span><span class="punctuation">,</span><span class="name">r2</span><span class="punctuation">),</span><span class="name">r3</span><span class="punctuation">);</span>
<span class="punctuation">}</span>
</pre>
<div class="left figure" id="figure-images/chapter-08/marker-arrow.png" style="width: 20%">
<img alt="images/chapter-08/marker-arrow.png" src="images/chapter-08/marker-arrow.png" />
<p class="caption">Figure</p>
<div class="legend">
Marker &quot;arrow&quot;</div>
</div>
<div class="left figure" id="figure-images/chapter-08/marker-asterisk.png" style="width: 20%">
<img alt="images/chapter-08/marker-asterisk.png" src="images/chapter-08/marker-asterisk.png" />
<p class="caption">Figure</p>
<div class="legend">
Marker &quot;asterisk&quot;</div>
</div>
<div class="left figure" id="figure-images/chapter-08/marker-bar.png" style="width: 20%">
<img alt="images/chapter-08/marker-bar.png" src="images/chapter-08/marker-bar.png" />
<p class="caption">Figure</p>
<div class="legend">
Marker &quot;bar&quot;</div>
</div>
<div class="left figure" id="figure-images/chapter-08/marker-chevron.png" style="width: 20%">
<img alt="images/chapter-08/marker-chevron.png" src="images/chapter-08/marker-chevron.png" />
<p class="caption">Figure</p>
<div class="legend">
Marker &quot;chevron&quot;</div>
</div>
<div class="left figure" id="figure-images/chapter-08/marker-clover.png" style="width: 20%">
<img alt="images/chapter-08/marker-clover.png" src="images/chapter-08/marker-clover.png" />
<p class="caption">Figure</p>
<div class="legend">
Marker &quot;clover&quot;</div>
</div>
<div class="left figure" id="figure-images/chapter-08/marker-club.png" style="width: 20%">
<img alt="images/chapter-08/marker-club.png" src="images/chapter-08/marker-club.png" />
<p class="caption">Figure</p>
<div class="legend">
Marker &quot;club&quot;</div>
</div>
<div class="left figure" id="figure-images/chapter-08/marker-cross.png" style="width: 20%">
<img alt="images/chapter-08/marker-cross.png" src="images/chapter-08/marker-cross.png" />
<p class="caption">Figure</p>
<div class="legend">
Marker &quot;cross&quot;</div>
</div>
<div class="left figure" id="figure-images/chapter-08/marker-diamond.png" style="width: 20%">
<img alt="images/chapter-08/marker-diamond.png" src="images/chapter-08/marker-diamond.png" />
<p class="caption">Figure</p>
<div class="legend">
Marker &quot;diamond&quot;</div>
</div>
<div class="left figure" id="figure-images/chapter-08/marker-disc.png" style="width: 20%">
<img alt="images/chapter-08/marker-disc.png" src="images/chapter-08/marker-disc.png" />
<p class="caption">Figure</p>
<div class="legend">
Marker &quot;disc&quot;</div>
</div>
<div class="left figure" id="figure-images/chapter-08/marker-ellipse.png" style="width: 20%">
<img alt="images/chapter-08/marker-ellipse.png" src="images/chapter-08/marker-ellipse.png" />
<p class="caption">Figure</p>
<div class="legend">
Marker &quot;ellipse&quot;</div>
</div>
<div class="left figure" id="figure-images/chapter-08/marker-heart.png" style="width: 20%">
<img alt="images/chapter-08/marker-heart.png" src="images/chapter-08/marker-heart.png" />
<p class="caption">Figure</p>
<div class="legend">
Marker &quot;heart&quot;</div>
</div>
<div class="left figure" id="figure-images/chapter-08/marker-infinity.png" style="width: 20%">
<img alt="images/chapter-08/marker-infinity.png" src="images/chapter-08/marker-infinity.png" />
<p class="caption">Figure</p>
<div class="legend">
Marker &quot;infinity&quot;</div>
</div>
<div class="left figure" id="figure-images/chapter-08/marker-pin.png" style="width: 20%">
<img alt="images/chapter-08/marker-pin.png" src="images/chapter-08/marker-pin.png" />
<p class="caption">Figure</p>
<div class="legend">
Marker &quot;pin&quot;</div>
</div>
<div class="left figure" id="figure-images/chapter-08/marker-ring.png" style="width: 20%">
<img alt="images/chapter-08/marker-ring.png" src="images/chapter-08/marker-ring.png" />
<p class="caption">Figure</p>
<div class="legend">
Marker &quot;ring&quot;</div>
</div>
<div class="left figure" id="figure-images/chapter-08/marker-spade.png" style="width: 20%">
<img alt="images/chapter-08/marker-spade.png" src="images/chapter-08/marker-spade.png" />
<p class="caption">Figure</p>
<div class="legend">
Marker &quot;spade&quot;</div>
</div>
<div class="left figure" id="figure-images/chapter-08/marker-triangle.png" style="width: 20%">
<img alt="images/chapter-08/marker-triangle.png" src="images/chapter-08/marker-triangle.png" />
<p class="caption">Figure</p>
<div class="legend">
Marker &quot;triangle&quot;</div>
</div>
</div>
<div class="section" id="arrows">
<h2><a class="toc-backref" href="#id29">Arrows</a></h2>
<p>Arrows are a bit different from markers because they are made of a body, which
is a line basically, and a head. Most of the difficulty lies in the head
definition that may vary a lot depending on the type the arrow. For example,
the stealth arrow shader reads:</p>
<pre class="code glsl literal-block">
<span class="keyword type">float</span> <span class="name">line_distance</span><span class="punctuation">(</span><span class="keyword type">vec2</span> <span class="name">p</span><span class="punctuation">,</span> <span class="keyword type">vec2</span> <span class="name">p1</span><span class="punctuation">,</span> <span class="keyword type">vec2</span> <span class="name">p2</span><span class="punctuation">)</span> <span class="punctuation">{</span>
    <span class="keyword type">vec2</span> <span class="name">center</span> <span class="operator">=</span> <span class="punctuation">(</span><span class="name">p1</span> <span class="operator">+</span> <span class="name">p2</span><span class="punctuation">)</span> <span class="operator">*</span> <span class="literal number float">0.5</span><span class="punctuation">;</span>
    <span class="keyword type">float</span> <span class="name">len</span> <span class="operator">=</span> <span class="name">length</span><span class="punctuation">(</span><span class="name">p2</span> <span class="operator">-</span> <span class="name">p1</span><span class="punctuation">);</span>
    <span class="keyword type">vec2</span> <span class="name">dir</span> <span class="operator">=</span> <span class="punctuation">(</span><span class="name">p2</span> <span class="operator">-</span> <span class="name">p1</span><span class="punctuation">)</span> <span class="operator">/</span> <span class="name">len</span><span class="punctuation">;</span>
    <span class="keyword type">vec2</span> <span class="name">rel_p</span> <span class="operator">=</span> <span class="name">p</span> <span class="operator">-</span> <span class="name">center</span><span class="punctuation">;</span>
    <span class="keyword">return</span> <span class="name">dot</span><span class="punctuation">(</span><span class="name">rel_p</span><span class="punctuation">,</span> <span class="keyword type">vec2</span><span class="punctuation">(</span><span class="name">dir</span><span class="punctuation">.</span><span class="name">y</span><span class="punctuation">,</span> <span class="operator">-</span><span class="name">dir</span><span class="punctuation">.</span><span class="name">x</span><span class="punctuation">));</span>
<span class="punctuation">}</span>

<span class="keyword type">float</span> <span class="name">arrow_stealth</span><span class="punctuation">(</span><span class="keyword type">vec2</span> <span class="name">texcoord</span><span class="punctuation">,</span>
                    <span class="keyword type">float</span> <span class="name">body</span><span class="punctuation">,</span> <span class="keyword type">float</span> <span class="name">head</span><span class="punctuation">,</span>
                    <span class="keyword type">float</span> <span class="name">linewidth</span><span class="punctuation">,</span> <span class="keyword type">float</span> <span class="name">antialias</span><span class="punctuation">)</span>
<span class="punctuation">{</span>
    <span class="keyword type">float</span> <span class="name">w</span> <span class="operator">=</span> <span class="name">linewidth</span><span class="operator">/</span><span class="literal number float">2.0</span> <span class="operator">+</span> <span class="name">antialias</span><span class="punctuation">;</span>
    <span class="keyword type">vec2</span> <span class="name">start</span> <span class="operator">=</span> <span class="operator">-</span><span class="keyword type">vec2</span><span class="punctuation">(</span><span class="name">body</span><span class="operator">/</span><span class="literal number float">2.0</span><span class="punctuation">,</span> <span class="literal number float">0.0</span><span class="punctuation">);</span>
    <span class="keyword type">vec2</span> <span class="name">end</span>   <span class="operator">=</span> <span class="operator">+</span><span class="keyword type">vec2</span><span class="punctuation">(</span><span class="name">body</span><span class="operator">/</span><span class="literal number float">2.0</span><span class="punctuation">,</span> <span class="literal number float">0.0</span><span class="punctuation">);</span>
    <span class="keyword type">float</span> <span class="name">height</span> <span class="operator">=</span> <span class="literal number float">0.5</span><span class="punctuation">;</span>

    <span class="comment single">// Head : 4 lines</span>
    <span class="keyword type">float</span> <span class="name">d1</span> <span class="operator">=</span> <span class="name">line_distance</span><span class="punctuation">(</span><span class="name">texcoord</span><span class="punctuation">,</span> <span class="name">end</span><span class="operator">-</span><span class="name">head</span><span class="operator">*</span><span class="keyword type">vec2</span><span class="punctuation">(</span><span class="operator">+</span><span class="literal number float">1.0</span><span class="punctuation">,</span><span class="operator">-</span><span class="name">height</span><span class="punctuation">),</span>
                                       <span class="name">end</span><span class="punctuation">);</span>
    <span class="keyword type">float</span> <span class="name">d2</span> <span class="operator">=</span> <span class="name">line_distance</span><span class="punctuation">(</span><span class="name">texcoord</span><span class="punctuation">,</span> <span class="name">end</span><span class="operator">-</span><span class="name">head</span><span class="operator">*</span><span class="keyword type">vec2</span><span class="punctuation">(</span><span class="operator">+</span><span class="literal number float">1.0</span><span class="punctuation">,</span><span class="operator">-</span><span class="name">height</span><span class="punctuation">),</span>
                                       <span class="name">end</span><span class="operator">-</span><span class="keyword type">vec2</span><span class="punctuation">(</span><span class="literal number float">3.0</span><span class="operator">*</span><span class="name">head</span><span class="operator">/</span><span class="literal number float">4.0</span><span class="punctuation">,</span><span class="literal number float">0.0</span><span class="punctuation">));</span>
    <span class="keyword type">float</span> <span class="name">d3</span> <span class="operator">=</span> <span class="name">line_distance</span><span class="punctuation">(</span><span class="name">texcoord</span><span class="punctuation">,</span> <span class="name">end</span><span class="operator">-</span><span class="name">head</span><span class="operator">*</span><span class="keyword type">vec2</span><span class="punctuation">(</span><span class="operator">+</span><span class="literal number float">1.0</span><span class="punctuation">,</span><span class="operator">+</span><span class="name">height</span><span class="punctuation">),</span> <span class="name">end</span><span class="punctuation">);</span>
    <span class="keyword type">float</span> <span class="name">d4</span> <span class="operator">=</span> <span class="name">line_distance</span><span class="punctuation">(</span><span class="name">texcoord</span><span class="punctuation">,</span> <span class="name">end</span><span class="operator">-</span><span class="name">head</span><span class="operator">*</span><span class="keyword type">vec2</span><span class="punctuation">(</span><span class="operator">+</span><span class="literal number float">1.0</span><span class="punctuation">,</span><span class="operator">+</span><span class="literal number float">0.5</span><span class="punctuation">),</span>
                                       <span class="name">end</span><span class="operator">-</span><span class="keyword type">vec2</span><span class="punctuation">(</span><span class="literal number float">3.0</span><span class="operator">*</span><span class="name">head</span><span class="operator">/</span><span class="literal number float">4.0</span><span class="punctuation">,</span><span class="literal number float">0.0</span><span class="punctuation">));</span>

    <span class="comment single">// Body : 1 segment</span>
    <span class="keyword type">float</span> <span class="name">d5</span> <span class="operator">=</span> <span class="name">segment_distance</span><span class="punctuation">(</span><span class="name">texcoord</span><span class="punctuation">,</span> <span class="name">start</span><span class="punctuation">,</span> <span class="name">end</span> <span class="operator">-</span> <span class="keyword type">vec2</span><span class="punctuation">(</span><span class="name">linewidth</span><span class="punctuation">,</span><span class="literal number float">0.0</span><span class="punctuation">));</span>

    <span class="keyword">return</span> <span class="name">min</span><span class="punctuation">(</span><span class="name">d5</span><span class="punctuation">,</span> <span class="name">max</span><span class="punctuation">(</span> <span class="name">max</span><span class="punctuation">(</span><span class="operator">-</span><span class="name">d1</span><span class="punctuation">,</span> <span class="name">d3</span><span class="punctuation">),</span> <span class="operator">-</span> <span class="name">max</span><span class="punctuation">(</span><span class="operator">-</span><span class="name">d2</span><span class="punctuation">,</span><span class="name">d4</span><span class="punctuation">)));</span>
<span class="punctuation">}</span>
</pre>
<p>Glumpy provides 8 types of arrows that you can see below. You can also have a
look at the <a class="reference external" href="code/chapter-08/arrow.py">arrow.py</a> example where you can
experiment with the different shapes and rendering options. Feel free to design
your own and to open a pull request to have them added to glumpy.</p>
<div class="left figure" id="figure-images/chapter-08/arrow-triangle-90.png" style="width: 20%">
<img alt="images/chapter-08/arrow-triangle-90.png" src="images/chapter-08/arrow-triangle-90.png" />
<p class="caption">Figure</p>
<div class="legend">
Arrow &quot;triangle_90&quot;</div>
</div>
<div class="left figure" id="figure-images/chapter-08/arrow-triangle-60.png" style="width: 20%">
<img alt="images/chapter-08/arrow-triangle-60.png" src="images/chapter-08/arrow-triangle-60.png" />
<p class="caption">Figure</p>
<div class="legend">
Arrow &quot;triangle_60&quot;</div>
</div>
<div class="left figure" id="figure-images/chapter-08/arrow-triangle-30.png" style="width: 20%">
<img alt="images/chapter-08/arrow-triangle-30.png" src="images/chapter-08/arrow-triangle-30.png" />
<p class="caption">Figure</p>
<div class="legend">
Arrow &quot;triangle_30&quot;</div>
</div>
<div class="left figure" id="figure-images/chapter-08/arrow-angle-90.png" style="width: 20%">
<img alt="images/chapter-08/arrow-angle-90.png" src="images/chapter-08/arrow-angle-90.png" />
<p class="caption">Figure</p>
<div class="legend">
Arrow &quot;angle_90&quot;</div>
</div>
<div class="left figure" id="figure-images/chapter-08/arrow-angle-60.png" style="width: 20%">
<img alt="images/chapter-08/arrow-angle-60.png" src="images/chapter-08/arrow-angle-60.png" />
<p class="caption">Figure</p>
<div class="legend">
Arrow &quot;angle_60&quot;</div>
</div>
<div class="left figure" id="figure-images/chapter-08/arrow-angle-30.png" style="width: 20%">
<img alt="images/chapter-08/arrow-angle-30.png" src="images/chapter-08/arrow-angle-30.png" />
<p class="caption">Figure</p>
<div class="legend">
Arrow &quot;angle_30&quot;</div>
</div>
<div class="left figure" id="figure-images/chapter-08/arrow-stealth.png" style="width: 20%">
<img alt="images/chapter-08/arrow-stealth.png" src="images/chapter-08/arrow-stealth.png" />
<p class="caption">Figure</p>
<div class="legend">
Arrow &quot;stealth&quot;</div>
</div>
<div class="left figure" id="figure-images/chapter-08/arrow-curved.png" style="width: 20%">
<img alt="images/chapter-08/arrow-curved.png" src="images/chapter-08/arrow-curved.png" />
<p class="caption">Figure</p>
<div class="legend">
Arrow &quot;curved&quot;</div>
</div>
</div>
<div class="section" id="texture-based">
<h2><a class="toc-backref" href="#id29">Texture based</a></h2>
<div class="right figure" id="figure-images/chapter-08/firefox.png" style="width: 30%">
<img alt="images/chapter-08/firefox.png" src="images/chapter-08/firefox.png" />
<p class="caption">Figure</p>
<div class="legend">
The black and white Firefox logo</div>
</div>
<p>We've seen that constructive solid geometry is a powerful tool for the design
of quite complex shapes. It is also very fast since everything is computed on
the GPU. Of course, the more complex is the shape, the slower it will be to
evaluate and thus to render. However, for really complex shapes, it might not
be possible to express the shape in mathematical terms and we have to find
another way. The idea is to actually precompute the signed distance to an
arbitrary shape on the CPU and to store the result in a texture.</p>
<p>This computation quite be quite intensive and this the reason why it is
preferable to code it in C. Glumpy comes with the binding for the <a class="reference external" href="http://citeseerx.ist.psu.edu/viewdoc/download?doi=10.1.1.170.1024&amp;rep=rep1&amp;type=pdf">&quot;Anti-Aliased
Euclidean Distance Transform&quot;</a>
method proposed by Stefan Gustavson and Robin Strand.</p>
<div class="right figure" id="figure-images/chapter-08/firefox-sdf.png" style="width: 30%">
<img alt="images/chapter-08/firefox-sdf.png" src="images/chapter-08/firefox-sdf.png" />
<p class="caption">Figure</p>
<div class="legend">
Signed distance to the Firefox logo</div>
</div>
<p>If you run the code below, you should obtain the image on the right.</p>
<pre class="code python literal-block">
<span class="keyword namespace">import</span> <span class="name namespace">numpy</span> <span class="keyword namespace">as</span> <span class="name namespace">np</span>
<span class="keyword namespace">from</span> <span class="name namespace">PIL</span> <span class="keyword namespace">import</span> <span class="name">Image</span>
<span class="keyword namespace">from</span> <span class="name namespace">glumpy.ext.sdf</span> <span class="keyword namespace">import</span> <span class="name">compute_sdf</span>

<span class="name">Z</span> <span class="operator">=</span> <span class="name">np</span><span class="operator">.</span><span class="name">array</span><span class="punctuation">(</span><span class="name">Image</span><span class="operator">.</span><span class="name">open</span><span class="punctuation">(</span><span class="literal string double">&quot;firefox.png&quot;</span><span class="punctuation">))</span>
<span class="name">compute_sdf</span><span class="punctuation">(</span><span class="name">Z</span><span class="punctuation">)</span>
<span class="name">image</span> <span class="operator">=</span> <span class="name">Image</span><span class="operator">.</span><span class="name">fromarray</span><span class="punctuation">((</span><span class="name">Z</span><span class="operator">*</span><span class="literal number integer">255</span><span class="punctuation">)</span><span class="operator">.</span><span class="name">astype</span><span class="punctuation">(</span><span class="name">np</span><span class="operator">.</span><span class="name">ubyte</span><span class="punctuation">))</span>
<span class="name">image</span><span class="operator">.</span><span class="name">save</span><span class="punctuation">(</span><span class="literal string double">&quot;firefox-sdf.png&quot;</span><span class="punctuation">)</span>
</pre>
<p>Even though the logo is barely recognisable on the resulting image, it carries
nonetheless the necessary information to compute the distance to the border
from within the shader. When the texture will be read inside the fragment
shader, we'll subtract 0.5 from the texture value (texture value are
normalized, hence the 0.5) to obtain the actual signed distance field. You're
then free to use this distance for accurate rendering of your shape. Needless
to say that the precision of the distance is directly correlated with the size
of your texture...</p>
<div class="right figure" id="figure-movies/chapter-08/texture-marker.mp4" style="width: 30%">
<video controls="True" loop="True">
<source src="movies/chapter-08/texture-marker.mp4"></source>
</video>
<p class="caption">Figure</p>
<div class="legend">
SDF textured marker (see <a class="reference external" href="code/chapter-08/texture-marker.py">texture-marker.py</a>)</div>
</div>
<p>The fragment shader reads (see also <a class="reference external" href="code/chapter-08/texture-marker.py">texture-marker.py</a>):</p>
<pre class="code glsl literal-block">
<span class="keyword">varying</span> <span class="keyword type">float</span> <span class="name">v_size</span><span class="punctuation">;</span>
<span class="keyword">varying</span> <span class="keyword type">vec2</span> <span class="name">v_texcoord</span><span class="punctuation">;</span>
<span class="keyword">uniform</span> <span class="keyword type">float</span> <span class="name">linewidth</span><span class="punctuation">;</span>
<span class="keyword">uniform</span> <span class="keyword type">float</span> <span class="name">antialias</span><span class="punctuation">;</span>
<span class="keyword">uniform</span> <span class="keyword type">sampler2D</span> <span class="name">texture</span><span class="punctuation">;</span>
<span class="keyword type">void</span> <span class="name">main</span><span class="punctuation">()</span> <span class="punctuation">{</span>
    <span class="keyword type">float</span> <span class="name">size</span> <span class="operator">=</span> <span class="name">v_size</span> <span class="operator">+</span> <span class="name">linewidth</span> <span class="operator">+</span> <span class="literal number float">2.0</span><span class="operator">*</span><span class="name">antialias</span><span class="punctuation">;</span>
    <span class="keyword type">float</span> <span class="name">signed_distance</span> <span class="operator">=</span> <span class="name">size</span><span class="operator">*</span><span class="punctuation">(</span><span class="name">texture2D</span><span class="punctuation">(</span><span class="name">texture</span><span class="punctuation">,</span> <span class="name">v_texcoord</span><span class="punctuation">).</span><span class="name">r</span> <span class="operator">-</span> <span class="literal number float">0.5</span><span class="punctuation">);</span>
    <span class="keyword type">float</span> <span class="name">border_distance</span> <span class="operator">=</span> <span class="name">abs</span><span class="punctuation">(</span><span class="name">signed_distance</span><span class="punctuation">)</span> <span class="operator">-</span> <span class="name">linewidth</span><span class="operator">/</span><span class="literal number float">2.0</span> <span class="operator">+</span> <span class="name">antialias</span><span class="punctuation">;</span>
    <span class="keyword type">float</span> <span class="name">alpha</span> <span class="operator">=</span> <span class="name">border_distance</span><span class="operator">/</span><span class="name">antialias</span><span class="punctuation">;</span>
    <span class="name">alpha</span> <span class="operator">=</span> <span class="name">exp</span><span class="punctuation">(</span><span class="operator">-</span><span class="name">alpha</span><span class="operator">*</span><span class="name">alpha</span><span class="punctuation">);</span>
    <span class="keyword">if</span> <span class="punctuation">(</span><span class="name">border_distance</span> <span class="operator">&lt;</span> <span class="literal number oct">0</span><span class="punctuation">)</span>
        <span class="name builtin">gl_FragColor</span> <span class="operator">=</span> <span class="keyword type">vec4</span><span class="punctuation">(</span><span class="literal number float">0.0</span><span class="punctuation">,</span> <span class="literal number float">0.0</span><span class="punctuation">,</span> <span class="literal number float">0.0</span><span class="punctuation">,</span> <span class="literal number float">1.0</span><span class="punctuation">);</span>
    <span class="keyword">else</span> <span class="keyword">if</span> <span class="punctuation">(</span><span class="name">border_distance</span> <span class="operator">&lt;</span> <span class="punctuation">(</span><span class="name">linewidth</span><span class="operator">/</span><span class="literal number float">2.0</span> <span class="operator">+</span> <span class="literal number float">2.0</span><span class="operator">*</span><span class="name">antialias</span><span class="punctuation">))</span>
        <span class="name builtin">gl_FragColor</span> <span class="operator">=</span> <span class="keyword type">vec4</span><span class="punctuation">(</span><span class="literal number float">0.0</span><span class="punctuation">,</span> <span class="literal number float">0.0</span><span class="punctuation">,</span> <span class="literal number float">0.0</span><span class="punctuation">,</span> <span class="name">alpha</span><span class="punctuation">);</span>
    <span class="keyword">else</span>
        <span class="keyword">discard</span><span class="punctuation">;</span>
<span class="punctuation">}</span>
</pre>
</div>
<div class="section" id="id37">
<h2><a class="toc-backref" href="#id29">Exercises</a></h2>
<div class="section" id="quiver-plot">
<h3><a class="toc-backref" href="#id29">Quiver plot</a></h3>
<div class="right figure" id="figure-images/chapter-08/quiver.png" style="width: 50%">
<img alt="images/chapter-08/quiver.png" src="images/chapter-08/quiver.png" />
<p class="caption">Figure</p>
<div class="legend">
An dynamic quiver plot made of two triangles.</div>
</div>
<p>Now that we know how to draw arrows, we can make a quiver plot very easily. The
obvious solution would be to draw n arrows using 2×n triangles (since one arrow
is two triangle). However, if your arrows are evenly spaced as on the figure on
the right, there is a smarter solution using only two triangles.</p>
<p>Solution: <a class="reference external" href="code/chapter-08/quiver.py">quiver.py</a></p>
</div>
<div class="section" id="light-and-shadows">
<h3><a class="toc-backref" href="#id29">Light and shadows</a></h3>
<div class="right figure" id="figure-movies/chapter-08/SDF-light-shadow.mp4" style="width: 50%">
<video controls="True" loop="True">
<source src="movies/chapter-08/SDF-light-shadow.mp4"></source>
</video>
<p class="caption">Figure</p>
<div class="legend">
2D signed distance functions by Marteen.
Live demo at <a class="reference external" href="https://www.shadertoy.com/view/4dfXDn">https://www.shadertoy.com/view/4dfXDn</a></div>
</div>
<p>As explained before, the <a class="reference external" href="https://www.shadertoy.com">shadertoy</a> website is a
great resource and you can learn a lot by reading the sources accompanying each
demo. As an exercise, have a look at this <a class="reference external" href="https://www.shadertoy.com/view/4dfXDn">wonderful demo</a> by Marteen that shows two dimensional
signed distance field functions with light and shadows.</p>
<p>Simply gorgeous...</p>
</div>
</div>
</div>
<hr class="docutils" />
<div class="section" id="rendering-lines">
<h1><a class="toc-backref" href="#contents">Rendering lines</a></h1>
<div class="contents toc chapter-09 local topic" id="id39">
<p class="topic-title first">.</p>
<ul class="simple">
<li><a class="reference internal" href="#raw-lines" id="id199">Raw Lines</a></li>
<li><a class="reference internal" href="#segments" id="id200">Segments</a></li>
<li><a class="reference internal" href="#lines" id="id201">Lines</a><ul>
<li><a class="reference internal" href="#smooth-lines" id="id202">Smooth lines</a></li>
<li><a class="reference internal" href="#broken-lines" id="id203">Broken lines</a></li>
<li><a class="reference internal" href="#bezier-curves" id="id204">Bézier curves</a></li>
</ul>
</li>
<li><a class="reference internal" href="#patterns" id="id205">Patterns</a><ul>
<li><a class="reference internal" href="#simple-dotted-pattern" id="id206">Simple dotted pattern</a></li>
<li><a class="reference internal" href="#arbitrary-dash-patterns" id="id207">Arbitrary dash patterns</a></li>
</ul>
</li>
<li><a class="reference internal" href="#d-lines" id="id208">3D lines</a><ul>
<li><a class="reference internal" href="#fixed-apparent-thickness" id="id209">Fixed apparent thickness</a></li>
<li><a class="reference internal" href="#varying-apparent-thickness" id="id210">Varying apparent thickness</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id44" id="id211">Exercises</a><ul>
<li><a class="reference internal" href="#realtime-signals" id="id212">Realtime signals</a></li>
<li><a class="reference internal" href="#variable-thickness" id="id213">Variable thickness</a></li>
</ul>
</li>
</ul>
</div>
<p>Lines are most certainly among the most important components in scientific
visualization. They can be used to represents axis, frames, plots, error bars,
contours, grids, etc. Lines and segments are among the most simple geometrical
objects. And yet, they can become quite complex if we consider line thickness,
cap, joint and pattern such as dotted, dashed, etc. In the end, rendering lines
with perfect quality is a lot of work as you'll read below. But it's worth the
effort as illustrated in the teaser image above. This comes from an interactive
demo of glumpy (See the <a class="reference external" href="https://github.com/glumpy/glumpy/blob/master/examples/spiral.py">spiral demo</a>).</p>
<div class="section" id="raw-lines">
<h2><a class="toc-backref" href="#id39">Raw Lines</a></h2>
<p>As we've seen in the <a class="reference internal" href="#quickstart">Quickstart</a> chapter, OpenGL come with three different line
primitives, namely <code>gl.GL_LINES</code> (segments), <code>gl.GL_LINE_STRIP</code> (polyline) and
<code>gl.GL_LINE_LOOP</code> (closed polyline) and correspond to the hardware
implementation of the <a class="reference external" href="https://en.wikipedia.org/wiki/Bresenham%27s_line_algorithm">Bresenham algorithm</a> that can be
written as:</p>
<pre class="code python literal-block">
<span class="keyword">def</span> <span class="name function">line</span><span class="punctuation">(</span><span class="name">x0</span><span class="punctuation">,</span> <span class="name">y0</span><span class="punctuation">,</span> <span class="name">x1</span><span class="punctuation">,</span> <span class="name">y1</span><span class="punctuation">,</span> <span class="name">image</span><span class="punctuation">,</span> <span class="name">color</span><span class="punctuation">):</span>
    <span class="name">steep</span> <span class="operator">=</span> <span class="name builtin pseudo">False</span>
    <span class="keyword">if</span> <span class="name builtin">abs</span><span class="punctuation">(</span><span class="name">x0</span><span class="operator">-</span><span class="name">x1</span><span class="punctuation">)</span> <span class="operator">&lt;</span> <span class="name builtin">abs</span><span class="punctuation">(</span><span class="name">y0</span><span class="operator">-</span><span class="name">y1</span><span class="punctuation">):</span>
        <span class="name">x0</span><span class="punctuation">,</span> <span class="name">y0</span> <span class="operator">=</span> <span class="name">y0</span><span class="punctuation">,</span> <span class="name">x0</span>
        <span class="name">x1</span><span class="punctuation">,</span> <span class="name">y1</span> <span class="operator">=</span> <span class="name">y1</span><span class="punctuation">,</span> <span class="name">x1</span>
        <span class="name">steep</span> <span class="operator">=</span> <span class="name builtin pseudo">True</span>
    <span class="keyword">if</span> <span class="name">x0</span> <span class="operator">&gt;</span> <span class="name">x1</span><span class="punctuation">:</span>
        <span class="name">x0</span><span class="punctuation">,</span> <span class="name">x1</span> <span class="operator">=</span> <span class="name">x1</span><span class="punctuation">,</span> <span class="name">x0</span>
        <span class="name">y0</span><span class="punctuation">,</span> <span class="name">y1</span> <span class="operator">=</span> <span class="name">y1</span><span class="punctuation">,</span> <span class="name">y0</span>
    <span class="name">dx</span> <span class="operator">=</span> <span class="name">x1</span><span class="operator">-</span><span class="name">x0</span>
    <span class="name">dy</span> <span class="operator">=</span> <span class="name">y1</span><span class="operator">-</span><span class="name">y0</span>
    <span class="name">error2</span> <span class="operator">=</span> <span class="literal number integer">0</span>
    <span class="name">derror2</span> <span class="operator">=</span> <span class="name builtin">abs</span><span class="punctuation">(</span><span class="name">dy</span><span class="punctuation">)</span><span class="operator">*</span><span class="literal number integer">2</span>
    <span class="name">y</span> <span class="operator">=</span> <span class="name">y0</span>
    <span class="keyword">for</span> <span class="name">x</span> <span class="operator word">in</span> <span class="name builtin">range</span><span class="punctuation">(</span><span class="name">x0</span><span class="punctuation">,</span><span class="name">x1</span><span class="operator">+</span><span class="literal number integer">1</span><span class="punctuation">):</span>
        <span class="keyword">if</span> <span class="name">steep</span><span class="punctuation">:</span>
            <span class="name">set_pixel</span><span class="punctuation">(</span><span class="name">image</span><span class="punctuation">,</span> <span class="name">y</span><span class="punctuation">,</span> <span class="name">x</span><span class="punctuation">,</span> <span class="name">color</span><span class="punctuation">)</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="name">set_pixel</span><span class="punctuation">(</span><span class="name">image</span><span class="punctuation">,</span> <span class="name">x</span><span class="punctuation">,</span> <span class="name">y</span><span class="punctuation">,</span> <span class="name">color</span><span class="punctuation">)</span>
        <span class="name">error2</span> <span class="operator">+=</span> <span class="name">derror2</span><span class="punctuation">;</span>
        <span class="keyword">if</span> <span class="name">error2</span> <span class="operator">&gt;</span> <span class="name">dx</span><span class="punctuation">:</span>
            <span class="name">y</span> <span class="operator">+=</span> <span class="literal number integer">1</span> <span class="keyword">if</span> <span class="name">y1</span> <span class="operator">&gt;</span> <span class="name">y0</span> <span class="keyword">else</span> <span class="operator">-</span><span class="literal number integer">1</span>
            <span class="name">error2</span> <span class="operator">-=</span> <span class="name">dx</span><span class="operator">*</span><span class="literal number integer">2</span>
</pre>
<a class="reference external image-reference" href="images/chapter-09/raw-lines.png"><img alt="images/chapter-09/advisory.jpg" class="right" src="images/chapter-09/advisory.jpg" style="width: 40%;" /></a>
<p>Rendering raw lines using OpenGL is incredibly fast. Really, really fast.  This
means that it can be used for the rendering of real-time signals as we'll see
in the exercises section.</p>
<p>But as you may have guessed by now, the result is also really, really ugly
because these lines are not antialiased and cannot be wider than 1 pixel. Click
on the image on the right if you want to see it. But you've be warned. It makes
my eyes bleed each time I look at it.</p>
</div>
<div class="section" id="segments">
<h2><a class="toc-backref" href="#id39">Segments</a></h2>
<div class="right figure" id="figure-images/chapter-09/segment.png" style="width: 50%">
<img alt="images/chapter-09/segment.png" src="images/chapter-09/segment.png" />
<p class="caption">Figure</p>
<div class="legend">
A thick line between A and B with round caps, thickness w and filter
radius r. Using d = ceil(w + 2.5r), the domain of the (u, v)
parameterization is given by −d ≤ u ≤ ∥AB∥ + d and −d ≤ v ≤ +d.</div>
</div>
<p>If we want to render nice lines, we'll have to draw triangles...</p>
<p>More precisely, we need two triangle for a thick (or thin it doesn't really
matter) line segment. The idea is to compute the signed distance to the segment
envelope like we did in the previous section for markers. However, we have a
supplementary difficulty because we also need to draw segment caps as
illustrated on the figure on the right. This means that when we generate our
triangles, we have to take into account antialias area and the cap size (half
the line thickness for one cap).</p>
<p>Let us consider a segment <code>AB</code> and let us name <code>T</code> the tangent to <code>AB</code> and <code>O</code>
the normal to <code>AB</code>. We want to draw a segment of thickness <code>w</code> using an
antialias area (filter radius) <code>r</code>. From these information, we can compute the
4 necesssary vertices (screen space <code>(x,y)</code>):</p>
<ul class="simple">
<li><code>A₀ =  A - (w/2 + r) * (T+O)</code></li>
<li><code>A₁ =  A - (w/2 + r) * (T-O)</code></li>
<li><code>B₀ =  B + (w/2 + r) * (T+O)</code></li>
<li><code>B₁ =  B + (w/2 + r) * (T-O)</code></li>
</ul>
<p>We can also parameterize these four vertices using a local frame reference
where the origin is <code>A</code> and the direction is horizontal (see figure above):</p>
<ul class="simple">
<li><code>A₀/(u,v) = (     -w/2-r,  +w/2-r)</code></li>
<li><code>A₁/(u,v) = (     -w/2-r,  -w/2-r)</code></li>
<li><code>B₀/(u,v) = (|AB| + w/2-r, +w/2-r)</code></li>
<li><code>B₁/(u,v) = (|AB| + w/2-r, -w/2-r)</code></li>
</ul>
<p>This parameterization is very convenient because the distance to the segment
body is given by the <code>v</code> component while the cap areas can be identified using
<code>u &lt; 0 or x &gt; |AB|</code>.</p>
<p>The next question is where do we compute all these information? We could do it
at the python level of course but it would be slower than computing directly
within the shader. So let's do that instead. For this, we need to distinguish
between each vertex and we need to compute <code>T</code> and <code>O</code>, meaning each vertex
needs an access to <code>A</code>, <code>B</code> and a unique identifier to know wheter we're dealing
with A₀, A₁, B₀ or B₁.</p>
<ul class="simple">
<li><code>A₀: A, B, (u,v) = (0,1)</code></li>
<li><code>A₁: A, B, (u,v) = (0,0)</code></li>
<li><code>B₀: A, B, (u,v) = (1,1)</code></li>
<li><code>B₁: A, B, (u,v) = (1,0)</code></li>
</ul>
<p>From this information, we can now compute each vertex position <code>Pᵢ</code> and
parameterization <code>UVᵢ</code>;</p>
<pre class="code math literal-block">
T = (B-A)/|AB|
O = (-T.y, T.x)
Pᵢ = A + u*T*|AB| + (2*u-1)*T*(w/2 + r) + (2*v-1)*O*(w/2 + r)
T = i
O = j
UVᵢ = u*T*|AB| + (2*u-1)*T*(w/2 + r) + (2*v-1)*O*(w/2 + r)
</pre>
<p>Translated in shader code, that gives us:</p>
<pre class="code glsl literal-block">
<span class="keyword">uniform</span> <span class="keyword type">vec2</span> <span class="name">resolution</span><span class="punctuation">;</span>
<span class="keyword">uniform</span> <span class="keyword type">float</span> <span class="name">antialias</span><span class="punctuation">;</span>
<span class="keyword">attribute</span> <span class="keyword type">float</span> <span class="name">thickness</span><span class="punctuation">;</span>
<span class="keyword">attribute</span> <span class="keyword type">vec2</span> <span class="name">p0</span><span class="punctuation">,</span> <span class="name">p1</span><span class="punctuation">,</span> <span class="name">uv</span><span class="punctuation">;</span>
<span class="keyword type">void</span> <span class="name">main</span><span class="punctuation">()</span> <span class="punctuation">{</span>
    <span class="keyword type">float</span> <span class="name">t</span> <span class="operator">=</span> <span class="name">thickness</span><span class="operator">/</span><span class="literal number float">2.0</span> <span class="operator">+</span> <span class="name">antialias</span><span class="punctuation">;</span>
    <span class="keyword type">float</span> <span class="name">l</span> <span class="operator">=</span> <span class="name">length</span><span class="punctuation">(</span><span class="name">p1</span><span class="operator">-</span><span class="name">p0</span><span class="punctuation">);</span>
    <span class="keyword type">float</span> <span class="name">u</span> <span class="operator">=</span> <span class="literal number float">2.0</span><span class="operator">*</span><span class="name">uv</span><span class="punctuation">.</span><span class="name">x</span> <span class="operator">-</span> <span class="literal number float">1.0</span><span class="punctuation">;</span>
    <span class="keyword type">float</span> <span class="name">v</span> <span class="operator">=</span> <span class="literal number float">2.0</span><span class="operator">*</span><span class="name">uv</span><span class="punctuation">.</span><span class="name">y</span> <span class="operator">-</span> <span class="literal number float">1.0</span><span class="punctuation">;</span>

    <span class="comment single">// Screen space</span>
    <span class="keyword type">vec2</span> <span class="name">T</span> <span class="operator">=</span> <span class="name">normalize</span><span class="punctuation">(</span><span class="name">p1</span><span class="operator">-</span><span class="name">p0</span><span class="punctuation">);</span>
    <span class="keyword type">vec2</span> <span class="name">O</span> <span class="operator">=</span> <span class="keyword type">vec2</span><span class="punctuation">(</span><span class="operator">-</span><span class="name">T</span><span class="punctuation">.</span><span class="name">y</span> <span class="punctuation">,</span> <span class="name">T</span><span class="punctuation">.</span><span class="name">x</span><span class="punctuation">);</span>
    <span class="keyword type">vec2</span> <span class="name">p</span> <span class="operator">=</span> <span class="name">p0</span> <span class="operator">+</span> <span class="name">uv</span><span class="punctuation">.</span><span class="name">x</span><span class="operator">*</span><span class="name">T</span><span class="operator">*</span><span class="name">l</span> <span class="operator">+</span> <span class="name">u</span><span class="operator">*</span><span class="name">T</span><span class="operator">*</span><span class="name">t</span> <span class="operator">+</span> <span class="name">v</span><span class="operator">*</span><span class="name">O</span><span class="operator">*</span><span class="name">t</span><span class="punctuation">;</span>
    <span class="name builtin">gl_Position</span> <span class="operator">=</span> <span class="keyword type">vec4</span><span class="punctuation">(</span><span class="literal number float">2.0</span><span class="operator">*</span><span class="name">p</span><span class="operator">/</span><span class="name">resolution</span><span class="operator">-</span><span class="literal number float">1.0</span><span class="punctuation">,</span> <span class="literal number float">0.0</span><span class="punctuation">,</span> <span class="literal number float">1.0</span><span class="punctuation">);</span>

    <span class="comment single">// Local space</span>
    <span class="name">T</span> <span class="operator">=</span> <span class="keyword type">vec2</span><span class="punctuation">(</span><span class="literal number float">1.0</span><span class="punctuation">,</span> <span class="literal number float">0.0</span><span class="punctuation">);</span>
    <span class="name">O</span> <span class="operator">=</span> <span class="keyword type">vec2</span><span class="punctuation">(</span><span class="literal number float">0.0</span><span class="punctuation">,</span> <span class="literal number float">1.0</span><span class="punctuation">);</span>
    <span class="name">p</span> <span class="operator">=</span> <span class="name">uv</span><span class="punctuation">.</span><span class="name">x</span><span class="operator">*</span><span class="name">T</span><span class="operator">*</span><span class="name">l</span> <span class="operator">+</span> <span class="name">u</span><span class="operator">*</span><span class="name">T</span><span class="operator">*</span><span class="name">t</span> <span class="operator">+</span> <span class="name">v</span><span class="operator">*</span><span class="name">O</span><span class="operator">*</span><span class="name">t</span><span class="punctuation">;</span>
</pre>
<p>In the fragment shader, we can then use the local coordinate to decide on the
color to be rendered by computing the signed distance to the envelope.</p>
<pre class="code glsl literal-block">
<span class="keyword">uniform</span> <span class="keyword type">float</span> <span class="name">antialias</span><span class="punctuation">;</span>
<span class="keyword">varying</span> <span class="keyword type">float</span> <span class="name">v_thickness</span><span class="punctuation">;</span>
<span class="keyword">varying</span> <span class="keyword type">vec2</span> <span class="name">v_p0</span><span class="punctuation">,</span> <span class="name">v_p1</span><span class="punctuation">,</span> <span class="name">v_p</span><span class="punctuation">;</span>
<span class="keyword type">void</span> <span class="name">main</span><span class="punctuation">()</span> <span class="punctuation">{</span>
    <span class="keyword type">float</span> <span class="name">d</span> <span class="operator">=</span> <span class="literal number oct">0</span><span class="punctuation">;</span>
    <span class="keyword">if</span><span class="punctuation">(</span> <span class="name">v_p</span><span class="punctuation">.</span><span class="name">x</span> <span class="operator">&lt;</span> <span class="literal number oct">0</span> <span class="punctuation">)</span>
        <span class="name">d</span> <span class="operator">=</span> <span class="name">length</span><span class="punctuation">(</span><span class="name">v_p</span> <span class="operator">-</span> <span class="name">v_p0</span><span class="punctuation">)</span> <span class="operator">-</span> <span class="name">v_thickness</span><span class="operator">/</span><span class="literal number float">2.0</span> <span class="operator">+</span> <span class="name">antialias</span><span class="operator">/</span><span class="literal number float">2.0</span><span class="punctuation">;</span>
    <span class="keyword">else</span> <span class="keyword">if</span> <span class="punctuation">(</span> <span class="name">v_p</span><span class="punctuation">.</span><span class="name">x</span> <span class="operator">&gt;</span> <span class="name">length</span><span class="punctuation">(</span><span class="name">v_p1</span><span class="operator">-</span><span class="name">v_p0</span><span class="punctuation">)</span> <span class="punctuation">)</span>
        <span class="name">d</span> <span class="operator">=</span> <span class="name">length</span><span class="punctuation">(</span><span class="name">v_p</span> <span class="operator">-</span> <span class="name">v_p1</span><span class="punctuation">)</span> <span class="operator">-</span> <span class="name">v_thickness</span><span class="operator">/</span><span class="literal number float">2.0</span> <span class="operator">+</span> <span class="name">antialias</span><span class="operator">/</span><span class="literal number float">2.0</span><span class="punctuation">;</span>
    <span class="keyword">else</span>
        <span class="name">d</span> <span class="operator">=</span> <span class="name">abs</span><span class="punctuation">(</span><span class="name">v_p</span><span class="punctuation">.</span><span class="name">y</span><span class="punctuation">)</span> <span class="operator">-</span> <span class="name">v_thickness</span><span class="operator">/</span><span class="literal number float">2.0</span> <span class="operator">+</span> <span class="name">antialias</span><span class="operator">/</span><span class="literal number float">2.0</span><span class="punctuation">;</span>
    <span class="keyword">if</span><span class="punctuation">(</span> <span class="name">d</span> <span class="operator">&lt;</span> <span class="literal number oct">0</span><span class="punctuation">)</span>
        <span class="name builtin">gl_FragColor</span> <span class="operator">=</span> <span class="keyword type">vec4</span><span class="punctuation">(</span><span class="literal number float">0.0</span><span class="punctuation">,</span> <span class="literal number float">0.0</span><span class="punctuation">,</span> <span class="literal number float">0.0</span><span class="punctuation">,</span> <span class="literal number float">1.0</span><span class="punctuation">);</span>
    <span class="keyword">else</span> <span class="keyword">if</span> <span class="punctuation">(</span><span class="name">d</span> <span class="operator">&lt;</span> <span class="name">antialias</span><span class="punctuation">)</span> <span class="punctuation">{</span>
        <span class="name">d</span> <span class="operator">=</span> <span class="name">exp</span><span class="punctuation">(</span><span class="operator">-</span><span class="name">d</span><span class="operator">*</span><span class="name">d</span><span class="punctuation">);</span>
        <span class="name builtin">gl_FragColor</span> <span class="operator">=</span> <span class="keyword type">vec4</span><span class="punctuation">(</span><span class="literal number float">0.0</span><span class="punctuation">,</span> <span class="literal number float">0.0</span><span class="punctuation">,</span> <span class="literal number float">0.0</span><span class="punctuation">,</span> <span class="name">d</span><span class="punctuation">);</span>
    <span class="punctuation">}</span>
</pre>
<p>The actual shader is slightly more complicated because we have also to take
care of lines whose thickness is below 1 pixel. In such a case, we consider the
line to be one pixel wide and we use transparency level to suggest that the
line is actually thiner. If you look at the result below (see <a class="reference external" href="code/chapter-09/agg-segments.py">agg-segments.py</a>), the first few lines have a thickness
below 1 pixel.</p>
<div class="right figure" id="figure-images/chapter-09/agg-segments.png" style="width: 100%">
<img alt="images/chapter-09/agg-segments.png" src="images/chapter-09/agg-segments.png" />
<p class="caption">Figure</p>
<div class="legend">
100 antialiased slightly oblique segments whose thickness varies linearly
from 0.1 pixel to 8 pixels. See
<a class="reference external" href="code/chapter-09/agg-segments.py">agg-segments.py</a>.</div>
</div>
<p>Concerning the segment caps, we have used a round cap, but you're free to use
any cap you like. In fact, you could have used any marker we've seen in
the previous chapter or no caps at all (just discard the fragment in such case).</p>
</div>
<div class="section" id="lines">
<h2><a class="toc-backref" href="#id39">Lines</a></h2>
<div class="right figure" id="figure-images/chapter-09/line-joints.png" style="width: 50%">
<img alt="images/chapter-09/line-joints.png" src="images/chapter-09/line-joints.png" />
<p class="caption">Figure</p>
<div class="legend">
The different line joints.</div>
</div>
<p>Polylines (i.e. line made of several segments) is much more difficult to render
than segment because we have to take joints into account as illustrated on the
image on the right. But, even if there appears to exist three different kind of
joints, there are really only two cases to consider: the bevel joint and the
others (round and miter). These cases are different because we can code a
reasonably fast solution for the bevel case while the two others ask for more
work. This is important because for smooth lines, such as Bézier curves (see
below), the fast solution will do the job.</p>
<div class="right figure" id="figure-images/chapter-09/line-tesselation.png" style="width: 100%">
<img alt="images/chapter-09/line-tesselation.png" src="images/chapter-09/line-tesselation.png" />
<p class="caption">Figure</p>
<div class="legend">
Two different line tesselations.</div>
</div>
<p>The reason the fast solution is fast compared to the other one comes from the
number of vertices we need to generate to render a thick line. In the fast
case, we'll need only 2×n vertices while in the other, we'll need 4×n vertices
(and a lot of tests inside the shader).</p>
<div class="section" id="smooth-lines">
<h3><a class="toc-backref" href="#id39">Smooth lines</a></h3>
<div class="right figure" id="figure-images/chapter-09/joint-detail.png" style="width: 35%">
<img alt="images/chapter-09/joint-detail.png" src="images/chapter-09/joint-detail.png" />
<p class="caption">Figure</p>
<div class="legend">
Joint detail</div>
</div>
<p>In order to compute the final position of a vertex inside the vertex shader, we
need to have access to the previous and the next vertex as shown on the figure
on the right. To compute <code>m</code> at <code>P₂</code> we need to have access to <code>P₁</code> and
<code>P₃</code>. Furthermore, each vertex needs to be doubled and we need to take care of
line start and end. To do that, we'll use a single vertex buffer that is baked
such that we each vertex is doubled and two extra vertices are put at start and
end:</p>
<pre class="literal-block">
┌───┬───┬───┬───┬───┬───┬───┬───┬───┬───┐
│ 0 │ 0 │ 1 │ 2 │ 3 │ 4 │ 5 │ 6 │ 7 │ 7 │
└───┴───┴───┴───┴───┴───┴───┴───┴───┴───┘

└──────────── prev ─────────────┘

    └──────────── curr ─────────────┘

        └──────────── next ─────────────┘
</pre>
<p>The goal of these two extra vertices is to use the same buffer for passing the
<code>prev</code>, <code>curr</code> and <code>next</code> attributes to the vertex shader using the same
underlying buffer. Their content will depend on whether the line is closed or
not. It is to be noted that each vertex has four coordinates. The <code>(x,y)</code> gives
the actual vertex coordinates, the <code>z=+1/-1</code> coordinate identifies which vertex
we're dealing with (<code>Vᵢ</code> or <code>Uᵢ</code> on the figure) and the last coordinate is the
curvilinear coordinate along the line. This last one will be useful to know if
we're within the start cap area, the end cap area or inside the
body. Furthermore, it can be used for pattern or texturing (see section
<a class="reference internal" href="#patterns">Patterns</a> below).</p>
<p>Taking all these constraints into account, the line preparation reads:</p>
<pre class="code python literal-block">
<span class="keyword">def</span> <span class="name function">bake</span><span class="punctuation">(</span><span class="name">P</span><span class="punctuation">,</span> <span class="name">closed</span><span class="operator">=</span><span class="name builtin pseudo">False</span><span class="punctuation">):</span>
    <span class="name">epsilon</span> <span class="operator">=</span> <span class="literal number float">1e-10</span>
    <span class="name">n</span> <span class="operator">=</span> <span class="name builtin">len</span><span class="punctuation">(</span><span class="name">P</span><span class="punctuation">)</span>
    <span class="keyword">if</span> <span class="name">closed</span> <span class="operator word">and</span> <span class="punctuation">((</span><span class="name">P</span><span class="punctuation">[</span><span class="literal number integer">0</span><span class="punctuation">]</span><span class="operator">-</span><span class="name">P</span><span class="punctuation">[</span><span class="operator">-</span><span class="literal number integer">1</span><span class="punctuation">])</span><span class="operator">**</span><span class="literal number integer">2</span><span class="punctuation">)</span><span class="operator">.</span><span class="name">sum</span><span class="punctuation">()</span> <span class="operator">&gt;</span> <span class="name">epsilon</span><span class="punctuation">:</span>
        <span class="name">P</span> <span class="operator">=</span> <span class="name">np</span><span class="operator">.</span><span class="name">append</span><span class="punctuation">(</span><span class="name">P</span><span class="punctuation">,</span> <span class="name">P</span><span class="punctuation">[</span><span class="literal number integer">0</span><span class="punctuation">])</span>
        <span class="name">P</span> <span class="operator">=</span> <span class="name">P</span><span class="operator">.</span><span class="name">reshape</span><span class="punctuation">(</span><span class="name">n</span><span class="operator">+</span><span class="literal number integer">1</span><span class="punctuation">,</span><span class="literal number integer">2</span><span class="punctuation">)</span>
        <span class="name">n</span> <span class="operator">=</span> <span class="name">n</span><span class="operator">+</span><span class="literal number integer">1</span>
    <span class="name">V</span> <span class="operator">=</span> <span class="name">np</span><span class="operator">.</span><span class="name">zeros</span><span class="punctuation">(((</span><span class="literal number integer">1</span><span class="operator">+</span><span class="name">n</span><span class="operator">+</span><span class="literal number integer">1</span><span class="punctuation">),</span><span class="literal number integer">2</span><span class="punctuation">,</span><span class="literal number integer">4</span><span class="punctuation">),</span> <span class="name">dtype</span><span class="operator">=</span><span class="name">np</span><span class="operator">.</span><span class="name">float32</span><span class="punctuation">)</span>
    <span class="name">V_prev</span><span class="punctuation">,</span> <span class="name">V_curr</span><span class="punctuation">,</span> <span class="name">V_next</span> <span class="operator">=</span> <span class="name">V</span><span class="punctuation">[:</span><span class="operator">-</span><span class="literal number integer">2</span><span class="punctuation">],</span> <span class="name">V</span><span class="punctuation">[</span><span class="literal number integer">1</span><span class="punctuation">:</span><span class="operator">-</span><span class="literal number integer">1</span><span class="punctuation">],</span> <span class="name">V</span><span class="punctuation">[</span><span class="literal number integer">2</span><span class="punctuation">:]</span>
    <span class="name">V_curr</span><span class="punctuation">[</span><span class="operator">...</span><span class="punctuation">,</span><span class="literal number integer">0</span><span class="punctuation">]</span> <span class="operator">=</span> <span class="name">P</span><span class="punctuation">[:,</span><span class="name">np</span><span class="operator">.</span><span class="name">newaxis</span><span class="punctuation">,</span><span class="literal number integer">0</span><span class="punctuation">]</span>
    <span class="name">V_curr</span><span class="punctuation">[</span><span class="operator">...</span><span class="punctuation">,</span><span class="literal number integer">1</span><span class="punctuation">]</span> <span class="operator">=</span> <span class="name">P</span><span class="punctuation">[:,</span><span class="name">np</span><span class="operator">.</span><span class="name">newaxis</span><span class="punctuation">,</span><span class="literal number integer">1</span><span class="punctuation">]</span>
    <span class="name">V_curr</span><span class="punctuation">[</span><span class="operator">...</span><span class="punctuation">,</span><span class="literal number integer">2</span><span class="punctuation">]</span> <span class="operator">=</span> <span class="literal number integer">1</span><span class="punctuation">,</span><span class="operator">-</span><span class="literal number integer">1</span>
    <span class="name">L</span> <span class="operator">=</span> <span class="name">np</span><span class="operator">.</span><span class="name">cumsum</span><span class="punctuation">(</span><span class="name">np</span><span class="operator">.</span><span class="name">sqrt</span><span class="punctuation">(((</span><span class="name">P</span><span class="punctuation">[</span><span class="literal number integer">1</span><span class="punctuation">:]</span><span class="operator">-</span><span class="name">P</span><span class="punctuation">[:</span><span class="operator">-</span><span class="literal number integer">1</span><span class="punctuation">])</span><span class="operator">**</span><span class="literal number integer">2</span><span class="punctuation">)</span><span class="operator">.</span><span class="name">sum</span><span class="punctuation">(</span><span class="name">axis</span><span class="operator">=-</span><span class="literal number integer">1</span><span class="punctuation">)))</span><span class="operator">.</span><span class="name">reshape</span><span class="punctuation">(</span><span class="name">n</span><span class="operator">-</span><span class="literal number integer">1</span><span class="punctuation">,</span><span class="literal number integer">1</span><span class="punctuation">)</span>
    <span class="name">V_curr</span><span class="punctuation">[</span><span class="literal number integer">1</span><span class="punctuation">:,:,</span><span class="literal number integer">3</span><span class="punctuation">]</span> <span class="operator">=</span> <span class="name">L</span>
    <span class="keyword">if</span> <span class="name">closed</span><span class="punctuation">:</span>
        <span class="name">V</span><span class="punctuation">[</span><span class="literal number integer">0</span><span class="punctuation">],</span> <span class="name">V</span><span class="punctuation">[</span><span class="operator">-</span><span class="literal number integer">1</span><span class="punctuation">]</span> <span class="operator">=</span> <span class="name">V</span><span class="punctuation">[</span><span class="operator">-</span><span class="literal number integer">3</span><span class="punctuation">],</span> <span class="name">V</span><span class="punctuation">[</span><span class="literal number integer">2</span><span class="punctuation">]</span>
    <span class="keyword">else</span><span class="punctuation">:</span>
        <span class="name">V</span><span class="punctuation">[</span><span class="literal number integer">0</span><span class="punctuation">],</span> <span class="name">V</span><span class="punctuation">[</span><span class="operator">-</span><span class="literal number integer">1</span><span class="punctuation">]</span> <span class="operator">=</span> <span class="name">V</span><span class="punctuation">[</span><span class="literal number integer">1</span><span class="punctuation">],</span> <span class="name">V</span><span class="punctuation">[</span><span class="operator">-</span><span class="literal number integer">2</span><span class="punctuation">]</span>
    <span class="keyword">return</span> <span class="name">V_prev</span><span class="punctuation">,</span> <span class="name">V_curr</span><span class="punctuation">,</span> <span class="name">V_next</span><span class="punctuation">,</span> <span class="name">L</span><span class="punctuation">[</span><span class="operator">-</span><span class="literal number integer">1</span><span class="punctuation">]</span>
</pre>
<p>Using this baking, it is now realtively easy to compute vertex position from
within the vertex shader. The only difficulty being to parameterize properly
the vertex such as to have all information to perform the antialiasing inside
the fragment shader:</p>
<pre class="code glsl literal-block">
<span class="keyword">uniform</span> <span class="keyword type">vec2</span> <span class="name">resolution</span><span class="punctuation">;</span>
<span class="keyword">uniform</span> <span class="keyword type">float</span> <span class="name">antialias</span><span class="punctuation">,</span> <span class="name">thickness</span><span class="punctuation">,</span> <span class="name">linelength</span><span class="punctuation">;</span>
<span class="keyword">attribute</span> <span class="keyword type">vec4</span> <span class="name">prev</span><span class="punctuation">,</span> <span class="name">curr</span><span class="punctuation">,</span> <span class="name">next</span><span class="punctuation">;</span>
<span class="keyword">varying</span> <span class="keyword type">vec2</span> <span class="name">v_uv</span><span class="punctuation">;</span>

<span class="keyword type">void</span> <span class="name">main</span><span class="punctuation">()</span> <span class="punctuation">{</span>
    <span class="keyword type">float</span> <span class="name">w</span> <span class="operator">=</span> <span class="name">thickness</span><span class="operator">/</span><span class="literal number float">2.0</span> <span class="operator">+</span> <span class="name">antialias</span><span class="punctuation">;</span>
    <span class="keyword type">vec2</span> <span class="name">p</span><span class="punctuation">;</span>
    <span class="keyword type">vec2</span> <span class="name">t0</span> <span class="operator">=</span> <span class="name">normalize</span><span class="punctuation">(</span><span class="name">curr</span><span class="punctuation">.</span><span class="name">xy</span> <span class="operator">-</span> <span class="name">prev</span><span class="punctuation">.</span><span class="name">xy</span><span class="punctuation">);</span>
    <span class="keyword type">vec2</span> <span class="name">t1</span> <span class="operator">=</span> <span class="name">normalize</span><span class="punctuation">(</span><span class="name">next</span><span class="punctuation">.</span><span class="name">xy</span> <span class="operator">-</span> <span class="name">curr</span><span class="punctuation">.</span><span class="name">xy</span><span class="punctuation">);</span>
    <span class="keyword type">vec2</span> <span class="name">n0</span> <span class="operator">=</span> <span class="keyword type">vec2</span><span class="punctuation">(</span><span class="operator">-</span><span class="name">t0</span><span class="punctuation">.</span><span class="name">y</span><span class="punctuation">,</span> <span class="name">t0</span><span class="punctuation">.</span><span class="name">x</span><span class="punctuation">);</span>
    <span class="keyword type">vec2</span> <span class="name">n1</span> <span class="operator">=</span> <span class="keyword type">vec2</span><span class="punctuation">(</span><span class="operator">-</span><span class="name">t1</span><span class="punctuation">.</span><span class="name">y</span><span class="punctuation">,</span> <span class="name">t1</span><span class="punctuation">.</span><span class="name">x</span><span class="punctuation">);</span>

    <span class="comment single">// Cap at start</span>
    <span class="keyword">if</span> <span class="punctuation">(</span><span class="name">prev</span><span class="punctuation">.</span><span class="name">xy</span> <span class="operator">==</span> <span class="name">curr</span><span class="punctuation">.</span><span class="name">xy</span><span class="punctuation">)</span> <span class="punctuation">{</span>
        <span class="name">v_uv</span> <span class="operator">=</span> <span class="keyword type">vec2</span><span class="punctuation">(</span><span class="operator">-</span><span class="name">w</span><span class="punctuation">,</span> <span class="name">curr</span><span class="punctuation">.</span><span class="name">z</span><span class="operator">*</span><span class="name">w</span><span class="punctuation">);</span>
        <span class="name">p</span> <span class="operator">=</span> <span class="name">curr</span><span class="punctuation">.</span><span class="name">xy</span> <span class="operator">-</span> <span class="name">w</span><span class="operator">*</span><span class="name">t1</span> <span class="operator">+</span> <span class="name">curr</span><span class="punctuation">.</span><span class="name">z</span><span class="operator">*</span><span class="name">w</span><span class="operator">*</span><span class="name">n1</span><span class="punctuation">;</span>
    <span class="comment single">// Cap at end</span>
    <span class="punctuation">}</span> <span class="keyword">else</span> <span class="keyword">if</span> <span class="punctuation">(</span><span class="name">curr</span><span class="punctuation">.</span><span class="name">xy</span> <span class="operator">==</span> <span class="name">next</span><span class="punctuation">.</span><span class="name">xy</span><span class="punctuation">)</span> <span class="punctuation">{</span>
        <span class="name">v_uv</span> <span class="operator">=</span> <span class="keyword type">vec2</span><span class="punctuation">(</span><span class="name">linelength</span><span class="operator">+</span><span class="name">w</span><span class="punctuation">,</span> <span class="name">curr</span><span class="punctuation">.</span><span class="name">z</span><span class="operator">*</span><span class="name">w</span><span class="punctuation">);</span>
        <span class="name">p</span> <span class="operator">=</span> <span class="name">curr</span><span class="punctuation">.</span><span class="name">xy</span> <span class="operator">+</span> <span class="name">w</span><span class="operator">*</span><span class="name">t0</span> <span class="operator">+</span> <span class="name">curr</span><span class="punctuation">.</span><span class="name">z</span><span class="operator">*</span><span class="name">w</span><span class="operator">*</span><span class="name">n0</span><span class="punctuation">;</span>
    <span class="comment single">// Body</span>
    <span class="punctuation">}</span> <span class="keyword">else</span> <span class="punctuation">{</span>
        <span class="keyword type">vec2</span> <span class="name">miter</span> <span class="operator">=</span> <span class="name">normalize</span><span class="punctuation">(</span><span class="name">n0</span> <span class="operator">+</span> <span class="name">n1</span><span class="punctuation">);</span>
        <span class="keyword type">float</span> <span class="name">dy</span> <span class="operator">=</span> <span class="name">w</span> <span class="operator">/</span> <span class="name">dot</span><span class="punctuation">(</span><span class="name">miter</span><span class="punctuation">,</span> <span class="name">n1</span><span class="punctuation">);</span>
        <span class="name">v_uv</span> <span class="operator">=</span> <span class="keyword type">vec2</span><span class="punctuation">(</span><span class="name">curr</span><span class="punctuation">.</span><span class="name">w</span><span class="punctuation">,</span> <span class="name">curr</span><span class="punctuation">.</span><span class="name">z</span><span class="operator">*</span><span class="name">w</span><span class="punctuation">);</span>
        <span class="name">p</span> <span class="operator">=</span> <span class="name">curr</span><span class="punctuation">.</span><span class="name">xy</span> <span class="operator">+</span> <span class="name">dy</span><span class="operator">*</span><span class="name">curr</span><span class="punctuation">.</span><span class="name">z</span><span class="operator">*</span><span class="name">miter</span><span class="punctuation">;</span>
    <span class="punctuation">}</span>
    <span class="name builtin">gl_Position</span> <span class="operator">=</span> <span class="keyword type">vec4</span><span class="punctuation">(</span><span class="literal number float">2.0</span><span class="operator">*</span><span class="name">p</span><span class="operator">/</span><span class="name">resolution</span><span class="operator">-</span><span class="literal number float">1.0</span><span class="punctuation">,</span> <span class="literal number float">0.0</span><span class="punctuation">,</span> <span class="literal number float">1.0</span><span class="punctuation">);</span>
<span class="punctuation">}</span>
</pre>
<p>Adn the fragment shader reads:</p>
<pre class="code glsl literal-block">
<span class="keyword">uniform</span> <span class="keyword type">float</span> <span class="name">antialias</span><span class="punctuation">,</span> <span class="name">thickness</span><span class="punctuation">,</span> <span class="name">linelength</span><span class="punctuation">;</span>
<span class="keyword">varying</span> <span class="keyword type">vec2</span> <span class="name">v_uv</span><span class="punctuation">;</span>

<span class="keyword type">void</span> <span class="name">main</span><span class="punctuation">()</span> <span class="punctuation">{</span>
    <span class="keyword type">float</span> <span class="name">d</span> <span class="operator">=</span> <span class="literal number oct">0</span><span class="punctuation">;</span>
    <span class="keyword type">float</span> <span class="name">w</span> <span class="operator">=</span> <span class="name">thickness</span><span class="operator">/</span><span class="literal number float">2.0</span> <span class="operator">-</span> <span class="name">antialias</span><span class="punctuation">;</span>
    <span class="comment single">// Cap at start</span>
    <span class="keyword">if</span> <span class="punctuation">(</span><span class="name">v_uv</span><span class="punctuation">.</span><span class="name">x</span> <span class="operator">&lt;</span> <span class="literal number oct">0</span><span class="punctuation">)</span>
        <span class="name">d</span> <span class="operator">=</span> <span class="name">length</span><span class="punctuation">(</span><span class="name">v_uv</span><span class="punctuation">)</span> <span class="operator">-</span> <span class="name">w</span><span class="punctuation">;</span>
    <span class="comment single">// Cap at end</span>
    <span class="keyword">else</span> <span class="keyword">if</span> <span class="punctuation">(</span><span class="name">v_uv</span><span class="punctuation">.</span><span class="name">x</span> <span class="operator">&gt;=</span> <span class="name">linelength</span><span class="punctuation">)</span>
        <span class="name">d</span> <span class="operator">=</span> <span class="name">length</span><span class="punctuation">(</span><span class="name">v_uv</span> <span class="operator">-</span> <span class="keyword type">vec2</span><span class="punctuation">(</span><span class="name">linelength</span><span class="punctuation">,</span><span class="literal number oct">0</span><span class="punctuation">))</span> <span class="operator">-</span> <span class="name">w</span><span class="punctuation">;</span>
    <span class="comment single">// Body</span>
    <span class="keyword">else</span>
        <span class="name">d</span> <span class="operator">=</span> <span class="name">abs</span><span class="punctuation">(</span><span class="name">v_uv</span><span class="punctuation">.</span><span class="name">y</span><span class="punctuation">)</span> <span class="operator">-</span> <span class="name">w</span><span class="punctuation">;</span>

    <span class="keyword">if</span><span class="punctuation">(</span> <span class="name">d</span> <span class="operator">&lt;</span> <span class="literal number oct">0</span><span class="punctuation">)</span> <span class="punctuation">{</span>
        <span class="name builtin">gl_FragColor</span> <span class="operator">=</span> <span class="keyword type">vec4</span><span class="punctuation">(</span><span class="literal number float">0.0</span><span class="punctuation">,</span> <span class="literal number float">0.0</span><span class="punctuation">,</span> <span class="literal number float">0.0</span><span class="punctuation">,</span> <span class="literal number float">1.0</span><span class="punctuation">);</span>
    <span class="punctuation">}</span> <span class="keyword">else</span> <span class="punctuation">{</span>
        <span class="name">d</span> <span class="operator">/=</span> <span class="name">antialias</span><span class="punctuation">;</span>
        <span class="name builtin">gl_FragColor</span> <span class="operator">=</span> <span class="keyword type">vec4</span><span class="punctuation">(</span><span class="literal number float">0.0</span><span class="punctuation">,</span> <span class="literal number float">0.0</span><span class="punctuation">,</span> <span class="literal number float">0.0</span><span class="punctuation">,</span> <span class="name">exp</span><span class="punctuation">(</span><span class="operator">-</span><span class="name">d</span><span class="operator">*</span><span class="name">d</span><span class="punctuation">));</span>
    <span class="punctuation">}</span>
<span class="punctuation">}</span>
</pre>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Note that we'll be using the GL_TRIANGLE_STRIP even though it would be
better to use GL_TRIANGLES and to compute the relevant indices. But I feel
lazy right now.</p>
</div>
<p>Putting it all together, we can draw some nice and smooth lines (see
<a class="reference external" href="code/chapter-09/linestrip.py">linestrip.py</a>). Note that for closed lines
such as the star below, first and last vertex needs to be the same (but it is
taken care of in the <code>bake</code> function).</p>
<div class="right figure" id="figure-images/chapter-09/linestrip.png" style="width: 100%">
<img alt="images/chapter-09/linestrip.png" src="images/chapter-09/linestrip.png" />
<p class="caption">Figure</p>
<div class="legend">
Smooth lines with bevel joints (see <a class="reference external" href="code/chapter-09/linestrip.py">linestrip.py</a>)</div>
</div>
</div>
<div class="section" id="broken-lines">
<h3><a class="toc-backref" href="#id39">Broken lines</a></h3>
<div class="right figure" id="figure-images/chapter-09/line-adjency.png" style="width: 40%">
<img alt="images/chapter-09/line-adjency.png" src="images/chapter-09/line-adjency.png" />
<p class="caption">Figure</p>
<div class="legend">
A geometry shader can be used to generate four vertices at each stage and
allows to tesselate and parameterize a line.</div>
</div>
<p>Broken lines are a bit more difficult because we need a different tesselation
just to be able to handle miter and round joints properly in the fragment
shader. To be able to do this, we need to know from within the fragment shader
if a given fragment is inside the joint area or not. This requires a specific
parameterization that relies on having a different tesselation with 4×n
vertices instead of 2×n. I won't explain all the details here but only provide
the final result that you can found in <a class="reference external" href="code/chapter-09/geom_path.py">geom-path.py</a>.</p>
<p>If you look at the sources, you'll see I'm using a geometry shader, which is a
new type of shader that is not officially available in GL ES 2.0 but which is
nonetheless available on a wide number of implementations. This geometry shader
offers the possibility to create new vertex which is quite convenient in our
case because for each couple of vertices we send to the GPU, the geometry
shader will actually create four vertices (see figure above). We thus save the
CPU time of &quot;quadrupling&quot; vertices as we did in the previous section. To be
able to this, we have to use <code>gl.GL_LINES_ADJACENCY_EXT</code> and indicate OpenGL
we'll generate four vertices at each stage, just before the vertex shader:</p>
<pre class="code python literal-block">
<span class="name">geometry</span> <span class="operator">=</span> <span class="name">gloo</span><span class="operator">.</span><span class="name">GeometryShader</span><span class="punctuation">(</span><span class="name">geometry</span><span class="punctuation">,</span> <span class="literal number integer">4</span><span class="punctuation">,</span>
                               <span class="name">gl</span><span class="operator">.</span><span class="name">GL_LINES_ADJACENCY_EXT</span><span class="punctuation">,</span>
                               <span class="name">gl</span><span class="operator">.</span><span class="name">GL_TRIANGLE_STRIP</span><span class="punctuation">)</span>
</pre>
<p>Inside the geometry shader, we now have access to four consecutive vertices (in
the sense of the provided indices) that can be used to compute the actual
position of a given segment of the line. During rendering, we also have to use
the same primitives:</p>
<pre class="code python literal-block">
<span class="name decorator">&#64;window.event</span>
<span class="keyword">def</span> <span class="name function">on_draw</span><span class="punctuation">(</span><span class="name">dt</span><span class="punctuation">):</span>
    <span class="name">window</span><span class="operator">.</span><span class="name">clear</span><span class="punctuation">()</span>
    <span class="name">program</span><span class="operator">.</span><span class="name">draw</span><span class="punctuation">(</span><span class="name">gl</span><span class="operator">.</span><span class="name">GL_LINE_STRIP_ADJACENCY_EXT</span><span class="punctuation">,</span> <span class="name">I</span><span class="punctuation">)</span>
</pre>
<p>I won't further describe the method that is a bit complicated but you can all
the details in the provided demo script. See the caption of the image below.</p>
<div class="right figure" id="figure-images/chapter-09/stars.png" style="width: 100%">
<img alt="images/chapter-09/stars.png" src="images/chapter-09/stars.png" />
<p class="caption">Figure</p>
<div class="legend">
Different line joints using a geometry shader. See
<a class="reference external" href="code/chapter-09/geom_path.py">geom-path.py</a>.</div>
</div>
</div>
<div class="section" id="bezier-curves">
<h3><a class="toc-backref" href="#id39">Bézier curves</a></h3>
<div class="right figure" id="figure-images/chapter-09/bezier_div.png" style="width: 30%">
<img alt="images/chapter-09/bezier_div.png" src="images/chapter-09/bezier_div.png" />
<p class="caption">Figure</p>
<div class="legend">
Bézier demo from the <a class="reference external" href="http://antigrain.com/">antigrain geometry library</a></div>
</div>
<p>There is a huge litterature on Bézier curves and a huge litterature on GPU
Bézier curves as well (+ lot of patents). I won't explain everything here
because it would require a whole book and I'm not sure I understand every
aspect anyway. If you're interested in the topic, you can have a look at <a class="reference external" href="https://pomax.github.io/bezierinfo">A
Primer on Bézier curves</a> by Mike
Kamermans (Pomax) that explain pretty much everything but GPU
implementation. For GPU implementation, you can have a look at shadertoy and do
a search using the &quot;Bézier&quot; or &quot;bezier&quot; keyword (I even commited <a class="reference external" href="https://www.shadertoy.com/view/4dfSDf">one</a> myself).</p>
<p>For the time being, we'll use an approximation of Bézier curves using an
<a class="reference external" href="http://antigrain.com/research/adaptive_bezier/">adaptive subdivision</a> as
designed by Maxim Shemarev (and translated in Python by me, see <a class="reference external" href="code/chapter-09/curves.py">curves.py</a>). You can see on the images below that this
method provides a very good approximation in a reasonable number of segments
(third figure on the right).</p>
<div class="left figure" id="figure-images/chapter-09/bezier01.gif" style="width: 30%">
<img alt="images/chapter-09/bezier01.gif" src="images/chapter-09/bezier01.gif" />
<p class="caption">Figure</p>
<div class="legend">
Approximation of a Bézier curves with too few vertices (n=52).</div>
</div>
<div class="left figure" id="figure-images/chapter-09/bezier02.gif" style="width: 30%">
<img alt="images/chapter-09/bezier02.gif" src="images/chapter-09/bezier02.gif" />
<p class="caption">Figure</p>
<div class="legend">
Approximation of a Bézier curves with too many vertices (n=210).</div>
</div>
<div class="left figure" id="figure-images/chapter-09/bezier04.gif" style="width: 30%">
<img alt="images/chapter-09/bezier04.gif" src="images/chapter-09/bezier04.gif" />
<p class="caption">Figure</p>
<div class="legend">
Adaptive subdivision of a Bézier curves (n=40).</div>
</div>
<p>Consequently, for drawing a Bézier curve, we just need to approximate as line
segments, bake those segments and render them as shown below (using
bevel joint, see <a class="reference external" href="code/chapter-09/bezier.py">bezier.py</a>):</p>
<div class="right figure" id="figure-images/chapter-09/bezier-1.png" style="width: 31%">
<img alt="images/chapter-09/bezier-1.png" src="images/chapter-09/bezier-1.png" />
<p class="caption">Figure</p>
</div>
<div class="right figure" id="figure-images/chapter-09/bezier-2.png" style="width: 31%">
<img alt="images/chapter-09/bezier-2.png" src="images/chapter-09/bezier-2.png" />
<p class="caption">Figure</p>
</div>
<div class="right figure" id="figure-images/chapter-09/bezier-3.png" style="width: 31%">
<img alt="images/chapter-09/bezier-3.png" src="images/chapter-09/bezier-3.png" />
<p class="caption">Figure</p>
</div>
</div>
</div>
<div class="section" id="patterns">
<h2><a class="toc-backref" href="#id39">Patterns</a></h2>
<div class="section" id="simple-dotted-pattern">
<h3><a class="toc-backref" href="#id39">Simple dotted pattern</a></h3>
<div class="right figure" id="figure-movies/chapter-09/linestrip-dotted.mp4" style="width: 35%">
<video controls="True" loop="True">
<source src="movies/chapter-09/linestrip-dotted.mp4"></source>
</video>
<p class="caption">Figure</p>
<div class="legend">
An animated dotted animated computed inside the fragment shader. See
<a class="reference external" href="code/chapter-09/linestrip-dotted.py">linestrip-dotted.py</a>.</div>
</div>
<p>Rendering a simple dotted pattern is surprinsingly simple. If you look at the
fragmen code from the smooth line sections, the computation of the signed
distance reads:</p>
<pre class="code glsl literal-block">
<span class="punctuation">...</span>
<span class="comment single">// Cap at start</span>
<span class="keyword">if</span> <span class="punctuation">(</span><span class="name">v_uv</span><span class="punctuation">.</span><span class="name">x</span> <span class="operator">&lt;</span> <span class="literal number oct">0</span><span class="punctuation">)</span>
    <span class="name">d</span> <span class="operator">=</span> <span class="name">length</span><span class="punctuation">(</span><span class="name">v_uv</span><span class="punctuation">)</span> <span class="operator">-</span> <span class="name">w</span><span class="punctuation">;</span>
<span class="comment single">// Cap at end</span>
<span class="keyword">else</span> <span class="keyword">if</span> <span class="punctuation">(</span><span class="name">v_uv</span><span class="punctuation">.</span><span class="name">x</span> <span class="operator">&gt;=</span> <span class="name">linelength</span><span class="punctuation">)</span>
    <span class="name">d</span> <span class="operator">=</span> <span class="name">length</span><span class="punctuation">(</span><span class="name">v_uv</span> <span class="operator">-</span> <span class="keyword type">vec2</span><span class="punctuation">(</span><span class="name">linelength</span><span class="punctuation">,</span><span class="literal number oct">0</span><span class="punctuation">))</span> <span class="operator">-</span> <span class="name">w</span><span class="punctuation">;</span>
<span class="comment single">// Body</span>
<span class="keyword">else</span>
    <span class="name">d</span> <span class="operator">=</span> <span class="name">abs</span><span class="punctuation">(</span><span class="name">v_uv</span><span class="punctuation">.</span><span class="name">y</span><span class="punctuation">)</span> <span class="operator">-</span> <span class="name">w</span><span class="punctuation">;</span>
<span class="punctuation">...</span>
</pre>
<p>We can slightly change this code in order to compute the signed distance to
discs whose centers area spread over the whole. Do you remember that we took
care of computing the line curvilinear coordinate? Having centers spread along
this line is then just a matter of a modulo.</p>
<pre class="code glsl literal-block">
<span class="keyword">uniform</span> <span class="keyword type">float</span> <span class="name">phase</span><span class="punctuation">;</span>
<span class="punctuation">...</span>
<span class="keyword type">float</span> <span class="name">spacing</span> <span class="operator">=</span> <span class="literal number float">1.5</span><span class="punctuation">;</span>
<span class="keyword type">float</span> <span class="name">center</span> <span class="operator">=</span> <span class="name">v_uv</span><span class="punctuation">.</span><span class="name">x</span> <span class="operator">+</span> <span class="name">spacing</span><span class="operator">/</span><span class="literal number float">2.0</span><span class="operator">*</span><span class="name">thickness</span>
             <span class="operator">-</span> <span class="name">mod</span><span class="punctuation">(</span><span class="name">v_uv</span><span class="punctuation">.</span><span class="name">x</span> <span class="operator">+</span> <span class="name">phase</span> <span class="operator">+</span> <span class="name">spacing</span><span class="operator">/</span><span class="literal number float">2.0</span><span class="operator">*</span><span class="name">thickness</span><span class="punctuation">,</span> <span class="name">spacing</span><span class="operator">*</span><span class="name">thickness</span><span class="punctuation">);</span>
<span class="comment single">// Discard uncomplete dot at the end of the line</span>
<span class="keyword">if</span> <span class="punctuation">(</span><span class="name">linelength</span> <span class="operator">-</span> <span class="name">center</span> <span class="operator">&lt;</span> <span class="name">thickness</span><span class="operator">/</span><span class="literal number float">2.0</span><span class="punctuation">)</span>
    <span class="keyword">discard</span><span class="punctuation">;</span>
<span class="comment single">// Discard uncomplete dot at the start of the line</span>
<span class="keyword">else</span> <span class="keyword">if</span> <span class="punctuation">(</span><span class="name">center</span> <span class="operator">&lt;</span> <span class="name">thickness</span><span class="operator">/</span><span class="literal number float">2.0</span><span class="punctuation">)</span>
    <span class="keyword">discard</span><span class="punctuation">;</span>
<span class="keyword">else</span>
    <span class="name">d</span> <span class="operator">=</span> <span class="name">length</span><span class="punctuation">(</span><span class="name">v_uv</span> <span class="operator">-</span> <span class="keyword type">vec2</span><span class="punctuation">(</span><span class="name">center</span><span class="punctuation">,</span><span class="literal number float">0.0</span><span class="punctuation">))</span> <span class="operator">-</span> <span class="name">w</span><span class="punctuation">;</span>
<span class="punctuation">...</span>
</pre>
<div class="right figure" id="figure-movies/chapter-09/linestrip-spaded.mp4" style="width: 35%">
<video controls="True" loop="True">
<source src="movies/chapter-09/linestrip-spaded.mp4"></source>
</video>
<p class="caption">Figure</p>
<div class="legend">
An animated dotted animated computed inside the fragment shader. See
<a class="reference external" href="code/chapter-09/linestrip-spaded.py">linestrip-spaded.py</a>.</div>
</div>
<p>The animation is obtained by slowly increasing the phase that makes all dot
centers to move along the lines.</p>
<p>By the way, you may have noticed that I've been using the simplest marker I
could think of (disc) for the example above. But we could have used any of the
marker from the previous chapter actually. For example, on the figure on the
right, I use the spade marker and I've added a fading at line start and end to
prevent the sudden apparition/disparition of a marker.</p>
</div>
<div class="section" id="arbitrary-dash-patterns">
<h3><a class="toc-backref" href="#id39">Arbitrary dash patterns</a></h3>
<p>Having arbitrary dashed patterns with possibly very thick lines and arbitrary
joints is quite a difficult problem if we want to have an (almost) pure GPU
implementation. It is actually so hard that I had to write an article
explaining how this can be done. If you want to know more, just read See
&quot;<a class="reference external" href="http://jcgt.org/published/0002/02/08/">Shader-based Antialiased Dashed Stroke Polylines</a>&quot; for a full explanation as well as
<a class="reference external" href="http://jcgt.org/published/0002/02/08/code.zip">Python implementation</a>. The
result is illustrated on the movies below.</p>
<div class="left figure" id="figure-movies/chapter-09/stars.mp4" style="width: 30%">
<video controls="True" loop="True">
<source src="movies/chapter-09/stars.mp4"></source>
</video>
<p class="caption">Figure</p>
</div>
<div class="left figure" id="figure-movies/chapter-09/sphere.mp4" style="width: 30%">
<video controls="True" loop="True">
<source src="movies/chapter-09/sphere.mp4"></source>
</video>
<p class="caption">Figure</p>
</div>
<div class="left figure" id="figure-movies/chapter-09/tiger.mp4" style="width: 30%">
<video controls="True" loop="True">
<source src="movies/chapter-09/tiger.mp4"></source>
</video>
<p class="caption">Figure</p>
</div>
<p>Unfortunately, at the time of writing, these arbitrary dash patterns lines have
not yet been implemented in glumpy. You're thus more than welcome to make a
PR. Contact me if you're interested.</p>
</div>
</div>
<div class="section" id="d-lines">
<h2><a class="toc-backref" href="#id39">3D lines</a></h2>
<div class="right figure" id="figure-movies/chapter-09/linestrip-3d.mp4" style="width: 35%">
<video controls="True" loop="True">
<source src="movies/chapter-09/linestrip-3d.mp4"></source>
</video>
<p class="caption">Figure</p>
<div class="legend">
A loxodrome (spherical spiral) with fixed line thickness. See
<a class="reference external" href="code/chapter-09/linestrip-3d.py">linestrip-3d.py</a></div>
</div>
<p>You certainly have noticed that until now, we've been dealing only with lines
in the two-dimensional screen space, using two-dimensional coordinates <code>(x,y)</code>
to describe positions. The thickness of such lines is rather intuitive because
they live in the screen space.</p>
<p>In three dimensions however, the problem is different. Mathematically, a line
has no thickness per se and the thick lines we've been drawing so far were
actually ribbon. In 3D, we have the choice to consider a thick line to be a
ribbon or a tube. But there is actually a third, and simpler option, which is
to consider than the line is a ribbon that is always facing the camera.</p>
<div class="section" id="fixed-apparent-thickness">
<h3><a class="toc-backref" href="#id39">Fixed apparent thickness</a></h3>
<p>For a fixed apparent thickness, the method is (almost) straighforward:</p>
<ol class="arabic simple">
<li>Apply transformation and get NDC coordinates</li>
<li>Convert NDC coordinates to viewport coordinates</li>
<li>Thicken line in viewport space</li>
<li>Transmit the resulting vertex</li>
</ol>
<p>Let's start with the conversion from NDC (normalized device coordinates) to
screen:</p>
<pre class="code glsl literal-block">
<span class="keyword">uniform</span> <span class="keyword type">vec2</span> <span class="name">viewport</span><span class="punctuation">;</span>
<span class="keyword">uniform</span> <span class="keyword type">mat4</span> <span class="name">model</span><span class="punctuation">,</span> <span class="name">view</span><span class="punctuation">,</span> <span class="name">projection</span><span class="punctuation">;</span>
<span class="keyword">attribute</span> <span class="keyword type">vec3</span> <span class="name">prev</span><span class="punctuation">,</span> <span class="name">curr</span><span class="punctuation">,</span> <span class="name">next</span><span class="punctuation">;</span>

<span class="punctuation">...</span>

<span class="comment single">// Normalized device coordinates</span>
<span class="keyword type">vec4</span> <span class="name">NDC_prev</span> <span class="operator">=</span> <span class="name">projection</span> <span class="operator">*</span> <span class="name">view</span> <span class="operator">*</span> <span class="name">model</span> <span class="operator">*</span> <span class="keyword type">vec4</span><span class="punctuation">(</span><span class="name">prev</span><span class="punctuation">.</span><span class="name">xyz</span><span class="punctuation">,</span> <span class="literal number float">1.0</span><span class="punctuation">);</span>
<span class="keyword type">vec4</span> <span class="name">NDC_curr</span> <span class="operator">=</span> <span class="name">projection</span> <span class="operator">*</span> <span class="name">view</span> <span class="operator">*</span> <span class="name">model</span> <span class="operator">*</span> <span class="keyword type">vec4</span><span class="punctuation">(</span><span class="name">curr</span><span class="punctuation">.</span><span class="name">xyz</span><span class="punctuation">,</span> <span class="literal number float">1.0</span><span class="punctuation">);</span>
<span class="keyword type">vec4</span> <span class="name">NDC_next</span> <span class="operator">=</span> <span class="name">projection</span> <span class="operator">*</span> <span class="name">view</span> <span class="operator">*</span> <span class="name">model</span> <span class="operator">*</span> <span class="keyword type">vec4</span><span class="punctuation">(</span><span class="name">next</span><span class="punctuation">.</span><span class="name">xyz</span><span class="punctuation">,</span> <span class="literal number float">1.0</span><span class="punctuation">);</span>

<span class="comment single">// Viewport (screen) coordinates</span>
<span class="keyword type">vec2</span> <span class="name">screen_prev</span> <span class="operator">=</span> <span class="name">viewport</span> <span class="operator">*</span> <span class="punctuation">((</span><span class="name">NDC_prev</span><span class="punctuation">.</span><span class="name">xy</span><span class="operator">/</span><span class="name">NDC_prev</span><span class="punctuation">.</span><span class="name">w</span><span class="punctuation">)</span> <span class="operator">+</span> <span class="literal number float">1.0</span><span class="punctuation">)</span><span class="operator">/</span><span class="literal number float">2.0</span><span class="punctuation">;</span>
<span class="keyword type">vec2</span> <span class="name">screen_curr</span> <span class="operator">=</span> <span class="name">viewport</span> <span class="operator">*</span> <span class="punctuation">((</span><span class="name">NDC_curr</span><span class="punctuation">.</span><span class="name">xy</span><span class="operator">/</span><span class="name">NDC_curr</span><span class="punctuation">.</span><span class="name">w</span><span class="punctuation">)</span> <span class="operator">+</span> <span class="literal number float">1.0</span><span class="punctuation">)</span><span class="operator">/</span><span class="literal number float">2.0</span><span class="punctuation">;</span>
<span class="keyword type">vec2</span> <span class="name">screen_next</span> <span class="operator">=</span> <span class="name">viewport</span> <span class="operator">*</span> <span class="punctuation">((</span><span class="name">NDC_next</span><span class="punctuation">.</span><span class="name">xy</span><span class="operator">/</span><span class="name">NDC_next</span><span class="punctuation">.</span><span class="name">w</span><span class="punctuation">)</span> <span class="operator">+</span> <span class="literal number float">1.0</span><span class="punctuation">)</span><span class="operator">/</span><span class="literal number float">2.0</span><span class="punctuation">;</span>
</pre>
<p>From these screen coordinates, we can compute the final position as we did
previously with the noticeable difference that we also need to use <code>z</code>
coordinate from the NDC coordinate.</p>
<pre class="code glsl literal-block">
<span class="keyword type">vec2</span> <span class="name">position</span><span class="punctuation">;</span>
<span class="keyword type">float</span> <span class="name">w</span> <span class="operator">=</span> <span class="name">thickness</span><span class="operator">/</span><span class="literal number float">2.0</span> <span class="operator">+</span> <span class="name">antialias</span><span class="punctuation">;</span>
<span class="keyword type">vec2</span> <span class="name">t0</span> <span class="operator">=</span> <span class="name">normalize</span><span class="punctuation">(</span><span class="name">screen_curr</span><span class="punctuation">.</span><span class="name">xy</span> <span class="operator">-</span> <span class="name">screen_prev</span><span class="punctuation">.</span><span class="name">xy</span><span class="punctuation">);</span>
<span class="keyword type">vec2</span> <span class="name">n0</span> <span class="operator">=</span> <span class="keyword type">vec2</span><span class="punctuation">(</span><span class="operator">-</span><span class="name">t0</span><span class="punctuation">.</span><span class="name">y</span><span class="punctuation">,</span> <span class="name">t0</span><span class="punctuation">.</span><span class="name">x</span><span class="punctuation">);</span>
<span class="keyword type">vec2</span> <span class="name">t1</span> <span class="operator">=</span> <span class="name">normalize</span><span class="punctuation">(</span><span class="name">screen_next</span><span class="punctuation">.</span><span class="name">xy</span> <span class="operator">-</span> <span class="name">screen_curr</span><span class="punctuation">.</span><span class="name">xy</span><span class="punctuation">);</span>
<span class="keyword type">vec2</span> <span class="name">n1</span> <span class="operator">=</span> <span class="keyword type">vec2</span><span class="punctuation">(</span><span class="operator">-</span><span class="name">t1</span><span class="punctuation">.</span><span class="name">y</span><span class="punctuation">,</span> <span class="name">t1</span><span class="punctuation">.</span><span class="name">x</span><span class="punctuation">);</span>
<span class="name">v_uv</span> <span class="operator">=</span> <span class="keyword type">vec2</span><span class="punctuation">(</span><span class="name">uv</span><span class="punctuation">.</span><span class="name">x</span><span class="punctuation">,</span> <span class="name">uv</span><span class="punctuation">.</span><span class="name">y</span><span class="operator">*</span><span class="name">w</span><span class="punctuation">);</span>
<span class="keyword">if</span> <span class="punctuation">(</span><span class="name">prev</span><span class="punctuation">.</span><span class="name">xy</span> <span class="operator">==</span> <span class="name">curr</span><span class="punctuation">.</span><span class="name">xy</span><span class="punctuation">)</span> <span class="punctuation">{</span>
    <span class="name">v_uv</span><span class="punctuation">.</span><span class="name">x</span> <span class="operator">=</span> <span class="operator">-</span><span class="name">w</span><span class="punctuation">;</span>
    <span class="name">position</span> <span class="operator">=</span> <span class="name">screen_curr</span><span class="punctuation">.</span><span class="name">xy</span> <span class="operator">-</span> <span class="name">w</span><span class="operator">*</span><span class="name">t1</span> <span class="operator">+</span> <span class="name">uv</span><span class="punctuation">.</span><span class="name">y</span><span class="operator">*</span><span class="name">w</span><span class="operator">*</span><span class="name">n1</span><span class="punctuation">;</span>
<span class="punctuation">}</span> <span class="keyword">else</span> <span class="keyword">if</span> <span class="punctuation">(</span><span class="name">curr</span><span class="punctuation">.</span><span class="name">xy</span> <span class="operator">==</span> <span class="name">next</span><span class="punctuation">.</span><span class="name">xy</span><span class="punctuation">)</span> <span class="punctuation">{</span>
    <span class="name">v_uv</span><span class="punctuation">.</span><span class="name">x</span> <span class="operator">=</span> <span class="name">linelength</span><span class="operator">+</span><span class="name">w</span><span class="punctuation">;</span>
    <span class="name">position</span> <span class="operator">=</span> <span class="name">screen_curr</span><span class="punctuation">.</span><span class="name">xy</span> <span class="operator">+</span> <span class="name">w</span><span class="operator">*</span><span class="name">t0</span> <span class="operator">+</span> <span class="name">uv</span><span class="punctuation">.</span><span class="name">y</span><span class="operator">*</span><span class="name">w</span><span class="operator">*</span><span class="name">n0</span><span class="punctuation">;</span>
<span class="punctuation">}</span> <span class="keyword">else</span> <span class="punctuation">{</span>
    <span class="keyword type">vec2</span> <span class="name">miter</span> <span class="operator">=</span> <span class="name">normalize</span><span class="punctuation">(</span><span class="name">n0</span> <span class="operator">+</span> <span class="name">n1</span><span class="punctuation">);</span>
    <span class="comment single">// The max operator avoid glitches when miter is too large</span>
    <span class="keyword type">float</span> <span class="name">dy</span> <span class="operator">=</span> <span class="name">w</span> <span class="operator">/</span> <span class="name">max</span><span class="punctuation">(</span><span class="name">dot</span><span class="punctuation">(</span><span class="name">miter</span><span class="punctuation">,</span> <span class="name">n1</span><span class="punctuation">),</span> <span class="literal number float">1.0</span><span class="punctuation">);</span>
    <span class="name">position</span> <span class="operator">=</span> <span class="name">screen_curr</span><span class="punctuation">.</span><span class="name">xy</span> <span class="operator">+</span> <span class="name">dy</span><span class="operator">*</span><span class="name">uv</span><span class="punctuation">.</span><span class="name">y</span><span class="operator">*</span><span class="name">miter</span><span class="punctuation">;</span>
<span class="punctuation">}</span>

<span class="comment single">// Back to NDC coordinates</span>
<span class="name builtin">gl_Position</span> <span class="operator">=</span> <span class="keyword type">vec4</span><span class="punctuation">(</span><span class="literal number float">2.0</span><span class="operator">*</span><span class="name">position</span><span class="operator">/</span><span class="name">viewport</span><span class="operator">-</span><span class="literal number float">1.0</span><span class="punctuation">,</span> <span class="name">NDC_curr</span><span class="punctuation">.</span><span class="name">z</span><span class="operator">/</span><span class="name">NDC_curr</span><span class="punctuation">.</span><span class="name">w</span><span class="punctuation">,</span> <span class="literal number float">1.0</span><span class="punctuation">);</span>
</pre>
<p>And we'll use the fragment shader we've using for smooth lines. Have a look at
<a class="reference external" href="code/chapter-09/linestrip-3d.py">linestrip-3d.py</a> for the full
implementation.</p>
</div>
<div class="section" id="varying-apparent-thickness">
<h3><a class="toc-backref" href="#id39">Varying apparent thickness</a></h3>
<div class="right figure" id="figure-movies/chapter-09/linestrip-3d-better.mp4" style="width: 35%">
<video controls="True" loop="True">
<source src="movies/chapter-09/linestrip-3d-better.mp4"></source>
</video>
<p class="caption">Figure</p>
<div class="legend">
A loxodrome (spherical spiral) with subtle varying colors and thickness. See
<a class="reference external" href="code/chapter-09/linestrip-3d-better.py">linestrip-3d-better.py</a></div>
</div>
<p>We can refine the rendering by considering the orientation of the line. This
orientation is given by the normal to the surface, and because our spiral is
drawn over the surface of a sphere, the normal to the surface is easy to
compute because it is the same coordinate as the point. But, instead of
applying the full transformation, we'll restict it to the model transformation
(i.e. no view nor projection) resulting in a normal vector where the <code>z</code>
coordinate indicates if the shape is orienting towards the camera. Then,
depending on this, we can modulate the thickness or the color of the line as
shown on the figure on the right. In this example, we modify the thickness in
the vertex shader and the color in the fragment shader.</p>
<pre class="code glsl literal-block">
<span class="keyword type">vec4</span> <span class="name">normal</span> <span class="operator">=</span> <span class="name">model</span><span class="operator">*</span><span class="keyword type">vec4</span><span class="punctuation">(</span><span class="name">curr</span><span class="punctuation">.</span><span class="name">xyz</span><span class="punctuation">,</span> <span class="literal number float">1.0</span><span class="punctuation">);</span>
<span class="name">v_normal</span> <span class="operator">=</span> <span class="name">normal</span><span class="punctuation">.</span><span class="name">xyz</span><span class="punctuation">;</span>
<span class="keyword">if</span> <span class="punctuation">(</span><span class="name">normal</span><span class="punctuation">.</span><span class="name">z</span> <span class="operator">&lt;</span> <span class="literal number oct">0</span><span class="punctuation">)</span>
    <span class="name">v_thickness</span> <span class="operator">=</span> <span class="name">thickness</span><span class="operator">/</span><span class="literal number float">2.0</span><span class="punctuation">;</span>
<span class="keyword">else</span>
    <span class="name">v_thickness</span> <span class="operator">=</span> <span class="name">thickness</span><span class="operator">*</span><span class="punctuation">(</span><span class="name">pow</span><span class="punctuation">(</span><span class="name">normal</span><span class="punctuation">.</span><span class="name">z</span><span class="punctuation">,</span><span class="literal number float">.5</span><span class="punctuation">)</span><span class="operator">+</span><span class="literal number integer">1</span><span class="punctuation">)</span><span class="operator">/</span><span class="literal number float">2.</span><span class="punctuation">;</span>
</pre>
</div>
</div>
<div class="section" id="id44">
<h2><a class="toc-backref" href="#id39">Exercises</a></h2>
<div class="section" id="realtime-signals">
<h3><a class="toc-backref" href="#id39">Realtime signals</a></h3>
<div class="right figure" id="figure-images/chapter-09/signals.png" style="width: 50%">
<img alt="images/chapter-09/signals.png" src="images/chapter-09/signals.png" />
<p class="caption">Figure</p>
<div class="legend">
20*15 signals of 1000 points each.</div>
</div>
<p>Let us consider a simple example where we have to display 300 (15*20) signals
made of 1,000 points each (300,000 vertices). What could be the fastest way to
display them using raw OpenGL lines?</p>
<p>Solution: <a class="reference external" href="code/chapter-09/signals.py">signals.py</a></p>
</div>
<div class="section" id="variable-thickness">
<h3><a class="toc-backref" href="#id39">Variable thickness</a></h3>
<div class="right figure" id="figure-images/chapter-09/linestrip-varying-thickness.png" style="width: 30%">
<img alt="images/chapter-09/linestrip-varying-thickness.png" src="images/chapter-09/linestrip-varying-thickness.png" />
<p class="caption">Figure</p>
<div class="legend">
Linestrip with varying thickness</div>
</div>
<p>We've seen in the <a class="reference internal" href="#smooth-lines">Smooth lines</a> section how to render smooth lines using
bevel joints. The thickness of the resulting line was (implicitly)
constant. How would you transform the shader to have a varying thickness as
illustrated on the figure on the right?</p>
<p>Solution:
<a class="reference external" href="code/chapter-09/linestrip-varying-thickness.py">linestrip-varying-thickness.py</a></p>
</div>
</div>
</div>
<hr class="docutils" />
<div class="section" id="rendering-polygons">
<h1><a class="toc-backref" href="#contents">Rendering polygons</a></h1>
<div class="contents toc chapter-10 local topic" id="id45">
<p class="topic-title first">.</p>
<ul class="simple">
<li><a class="reference internal" href="#id46" id="id214">Triangulation</a><ul>
<li><a class="reference internal" href="#convex-polygons" id="id215">Convex polygons</a></li>
<li><a class="reference internal" href="#concave-polygons" id="id216">Concave polygons</a></li>
</ul>
</li>
<li><a class="reference internal" href="#fill-rule" id="id217">Fill rule</a><ul>
<li><a class="reference internal" href="#non-zero-fill-rule" id="id218">Non-zero fill rule</a></li>
<li><a class="reference internal" href="#odd-even-fill-rule" id="id219">Odd-even fill rule</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id48" id="id220">Exercises</a><ul>
<li><a class="reference internal" href="#polygon-gradients" id="id221">Polygon gradients</a></li>
<li><a class="reference internal" href="#polygon-patterns" id="id222">Polygon Patterns</a></li>
<li><a class="reference internal" href="#id49" id="id223">Antialiasing</a></li>
</ul>
</li>
</ul>
</div>
<p>Polygons are an important topic for scientific visualization because they can
be used to display bars, histograms, charts, filled plots, etc. Displaying
polygons using OpenGL is really fast, provided we have the proper
triangulation. The teaser image comes from the <a class="reference external" href="https://github.com/glumpy/glumpy/blob/master/examples/tiger.py">tiger demo</a> of glumpy.</p>
<div class="section" id="id46">
<h2><a class="toc-backref" href="#id45">Triangulation</a></h2>
<p>In order to draw a polygon, we need to triangulate it, i.e., we have to
decompose it into a sum of non overlapping triangles. To do that, we have to
consider whether the polygon is convex or concave:</p>
<img alt="images/chapter-10/polygons.png" src="images/chapter-10/polygons.png" style="width: 100%;" />
<p>To know if a given polygon is concave or convex, it is rather easy. Convex
polygons have all their diagonals contained inside, while it is not true for
concave polygons, i.e. you can find two summits such that when you connect
them, the segment is outside the polygon. Another test is to find a straight
line that cross a concave polygon at more than two points as shown on the
figure above with the red lines.</p>
<div class="section" id="convex-polygons">
<h3><a class="toc-backref" href="#id45">Convex polygons</a></h3>
<p>For convex polygons, we have to consider two cases:</p>
<ol class="arabic simple">
<li>points are ordered and describe the contour of the polygon</li>
<li>points are unordered and spread randomly onto the 2d plane</li>
</ol>
<p>For the second case, we can use scipy to compute the convex hull of the points
such as to be in the first case situation:</p>
<pre class="code python literal-block">
<span class="keyword namespace">import</span> <span class="name namespace">numpy</span> <span class="keyword namespace">as</span> <span class="name namespace">np</span>
<span class="keyword namespace">import</span> <span class="name namespace">scipy.spatial</span>

<span class="name">P</span> <span class="operator">=</span> <span class="name">np</span><span class="operator">.</span><span class="name">random</span><span class="operator">.</span><span class="name">uniform</span><span class="punctuation">(</span><span class="operator">-</span><span class="literal number float">1.0</span><span class="punctuation">,</span> <span class="literal number float">1.0</span><span class="punctuation">,</span> <span class="punctuation">(</span><span class="literal number integer">100</span><span class="punctuation">,</span><span class="literal number integer">2</span><span class="punctuation">))</span>
<span class="name">P</span> <span class="operator">=</span> <span class="name">P</span><span class="punctuation">[</span><span class="name">scipy</span><span class="operator">.</span><span class="name">spatial</span><span class="operator">.</span><span class="name">ConvexHull</span><span class="punctuation">(</span><span class="name">P</span><span class="punctuation">)</span><span class="operator">.</span><span class="name">vertices</span><span class="punctuation">]</span>
</pre>
<p>From this ordered set of vertices describing the contour, it is now easy to
render the polygon using the <code>gl.GL_TRIANGLE_FAN</code> primitives:</p>
<pre class="code python literal-block">
<span class="name decorator">&#64;window.event</span>
<span class="keyword">def</span> <span class="name function">on_draw</span><span class="punctuation">(</span><span class="name">dt</span><span class="punctuation">):</span>
    <span class="name">window</span><span class="operator">.</span><span class="name">clear</span><span class="punctuation">()</span>
    <span class="name">polygon</span><span class="operator">.</span><span class="name">draw</span><span class="punctuation">(</span><span class="name">gl</span><span class="operator">.</span><span class="name">GL_TRIANGLE_FAN</span><span class="punctuation">)</span>
</pre>
<p>You can see on the figures below that it is better to use only the convex hull
points to compute the triangulation. You can also check that all other points
are actually inside the polygon area.</p>
<div class="left figure" id="figure-images/chapter-10/convex-polygon-point.png" style="width: 30%">
<img alt="images/chapter-10/convex-polygon-point.png" src="images/chapter-10/convex-polygon-point.png" />
<p class="caption">Figure</p>
<div class="legend">
A cloud of random points. Convex hull points have been highlighted.
See <a class="reference external" href="code/chapter-10/convex-polygon-point.py">convex-polygon-point.py</a></div>
</div>
<div class="left figure" id="figure-images/chapter-10/convex-polygon.png" style="width: 30%">
<img alt="images/chapter-10/convex-polygon.png" src="images/chapter-10/convex-polygon.png" />
<p class="caption">Figure</p>
<div class="legend">
A Delaunay triangulation with a lof of useless triangles.
See <a class="reference external" href="code/chapter-10/convex-polygon.py">convex-polygon.py</a></div>
</div>
<div class="left figure" id="figure-images/chapter-10/convex-polygon-fan.png" style="width: 30%">
<img alt="images/chapter-10/convex-polygon-fan.png" src="images/chapter-10/convex-polygon-fan.png" />
<p class="caption">Figure</p>
<div class="legend">
A triangulation restricted to points belonging to the convex hull.
See <a class="reference external" href="code/chapter-10/convex-polygon-fan.py">convex-polygon-fan.py</a></div>
</div>
</div>
<div class="section" id="concave-polygons">
<h3><a class="toc-backref" href="#id45">Concave polygons</a></h3>
<p>For concave polygons, we could consider the two aforementionned cases where
points are either ordered and describe the contour of the polygon or points are
unordered and spread randomly onto the 2d plane. However, for the latter case,
things become more difficult because the solution is not unique as shown on the
figure below.</p>
<div class="right figure" id="figure-images/chapter-10/concave-hull.png" style="width: 100%">
<img alt="images/chapter-10/concave-hull.png" src="images/chapter-10/concave-hull.png" />
<p class="caption">Figure</p>
<div class="legend">
The concave hull (or <a class="reference external" href="https://en.wikipedia.org/wiki/Alpha_shape">alpha shape</a>) of a set of points is not
unique. Images by <a class="reference external" href="http://www.portailsig.org/content/sur-la-creation-des-enveloppes-concaves-concave-hull-et-les-divers-moyens-d-y-parvenir-forme">Martin Laloux</a>.</div>
</div>
<p>This is the reason why we'll restrict ourselves to the first case, that is, we
have a set or ordered points describing the contour of a concave polygon. But
even in such simple case, triangulation is not obvious and we'll thus need a
dedicated library. We'll use the <a class="reference external" href="http://dzhelil.info/triangle/">triangles</a>
library but there are others:</p>
<div class="right figure" id="figure-images/chapter-10/firefox.png" style="width: 30%">
<img alt="images/chapter-10/firefox.png" src="images/chapter-10/firefox.png" />
<p class="caption">Figure</p>
<div class="legend">
The firefox logo, tesselated (Bézier curves converted to segments) and
triangulated. See <a class="reference external" href="code/chapter-10/firefox.py">firefox.py</a></div>
</div>
<pre class="code python literal-block">
<span class="keyword">def</span> <span class="name function">triangulate</span><span class="punctuation">(</span><span class="name">vertices</span><span class="punctuation">):</span>
    <span class="name">n</span> <span class="operator">=</span> <span class="name builtin">len</span><span class="punctuation">(</span><span class="name">vertices</span><span class="punctuation">)</span>
    <span class="name">segments</span> <span class="operator">=</span> <span class="punctuation">(</span><span class="name">np</span><span class="operator">.</span><span class="name">repeat</span><span class="punctuation">(</span><span class="name">np</span><span class="operator">.</span><span class="name">arange</span><span class="punctuation">(</span><span class="name">n</span><span class="operator">+</span><span class="literal number integer">1</span><span class="punctuation">),</span><span class="literal number integer">2</span><span class="punctuation">)[</span><span class="literal number integer">1</span><span class="punctuation">:</span><span class="operator">-</span><span class="literal number integer">1</span><span class="punctuation">])</span> <span class="operator">%</span> <span class="name">n</span>
    <span class="name">T</span> <span class="operator">=</span> <span class="name">triangle</span><span class="operator">.</span><span class="name">triangulate</span><span class="punctuation">({</span><span class="literal string single">'vertices'</span><span class="punctuation">:</span> <span class="name">vertices</span><span class="punctuation">,</span>
                              <span class="literal string single">'segments'</span><span class="punctuation">:</span> <span class="name">segments</span><span class="punctuation">},</span> <span class="literal string double">&quot;p&quot;</span><span class="punctuation">)</span>
    <span class="keyword">return</span> <span class="name">T</span><span class="punctuation">[</span><span class="literal string double">&quot;vertices&quot;</span><span class="punctuation">],</span> <span class="name">T</span><span class="punctuation">[</span><span class="literal string double">&quot;triangles&quot;</span><span class="punctuation">]</span>
</pre>
<p>On the image on the right, we've parsed (see <a class="reference external" href="code/chapter-10/svg.py">svg.py</a>) the firefox icon SVG path and tesselated the Bézier
curves into line segments. Then we have triangulated the resulting path and
obtained the displayed triangulation using <code>gl.GL_TRIANGLES</code>. See <a class="reference external" href="code/chapter-10/firefox.py">firefox.py</a></p>
</div>
</div>
<div class="section" id="fill-rule">
<h2><a class="toc-backref" href="#id45">Fill rule</a></h2>
<p>The fill-rule property is used to specify how to paint the different parts of a
shape. As explained in the <a class="reference external" href="https://www.w3.org/TR/SVG/painting.html">SVG specification</a>, <em>for a simple,
non-intersecting path, it is intuitively clear what region lies &quot;inside&quot;;
however, for a more complex path, such as a path that intersects itself or
where one subpath encloses another, the interpretation of &quot;inside&quot; is not so
obvious. The fill-rule property provides two options for how the inside of a
shape is determined: non-zero and even-odd.</em></p>
<div class="left figure" id="figure-images/chapter-10/fillrule-nonzero.png" style="width: 45%">
<img alt="images/chapter-10/fillrule-nonzero.png" src="images/chapter-10/fillrule-nonzero.png" />
<p class="caption">Figure</p>
<div class="legend">
From the <a class="reference external" href="https://www.w3.org/TR/SVG/painting.html">SVG Specification</a>: <em>The nonzero fill rule determines the
&quot;insideness&quot; of a point on the canvas by drawing a ray from that point to
infinity in any direction and then examining the places where a segment of
the shape crosses the ray.</em></div>
</div>
<div class="left figure" id="figure-images/chapter-10/fillrule-evenodd.png" style="width: 45%">
<img alt="images/chapter-10/fillrule-evenodd.png" src="images/chapter-10/fillrule-evenodd.png" />
<p class="caption">Figure</p>
<div class="legend">
From the <a class="reference external" href="https://www.w3.org/TR/SVG/painting.html">SVG Specification</a>: <em>The evenodd fill rule determines the
&quot;insideness&quot; of a point on the canvas by drawing a ray from that point to
infinity in any direction and counting the number of path segments from the
given shape that the ray crosses.</em></div>
</div>
<hr class="docutils" />
<p>To enforce the fill-rule property, we'll need to use the <a class="reference external" href="https://www.khronos.org/opengl/wiki/Stencil_Test">stencil buffer</a> that allows to have
per-sample operation and test performed after the fragment shader
stage. Depending on the <a class="reference external" href="https://www.khronos.org/registry/OpenGL-Refpages/gl4/html/glStencilFunc.xhtml">stencil function</a>
and <a class="reference external" href="https://www.khronos.org/registry/OpenGL-Refpages/gl4/html/glStencilOp.xhtml">stencil operation</a>
we'll define, we can control precisely how a shape is rendered. But first, we
need to tell OpenGL we'll be using a stencil buffer. In glumpy, the default is
to have no stencil buffer, that is, the default bit depth of the stencil buffer
is zero. To activate it, we thus simply need to specify some non-zero stencil
bit depth (e.g. 8 for 256 possible values):</p>
<pre class="code python literal-block">
<span class="name">config</span> <span class="operator">=</span> <span class="name">app</span><span class="operator">.</span><span class="name">configuration</span><span class="operator">.</span><span class="name">Configuration</span><span class="punctuation">()</span>
<span class="name">config</span><span class="operator">.</span><span class="name">stencil_size</span> <span class="operator">=</span> <span class="literal number integer">8</span>
<span class="name">window</span> <span class="operator">=</span> <span class="name">app</span><span class="operator">.</span><span class="name">Window</span><span class="punctuation">(</span><span class="name">config</span><span class="operator">=</span><span class="name">config</span><span class="punctuation">,</span> <span class="name">width</span><span class="operator">=</span><span class="literal number integer">512</span><span class="punctuation">,</span> <span class="name">height</span><span class="operator">=</span><span class="literal number integer">512</span><span class="punctuation">)</span>

<span class="name decorator">&#64;window.event</span>
<span class="keyword">def</span> <span class="name function">on_init</span><span class="punctuation">():</span>
    <span class="name">gl</span><span class="operator">.</span><span class="name">glEnable</span><span class="punctuation">(</span><span class="name">gl</span><span class="operator">.</span><span class="name">GL_STENCIL_TEST</span><span class="punctuation">)</span>
</pre>
<p>Note that we also need to activate the stencil test in the <code>on_init</code> window event.</p>
<div class="section" id="non-zero-fill-rule">
<h3><a class="toc-backref" href="#id45">Non-zero fill rule</a></h3>
<p>The non-zero fill rule implementation is easy because it corresponds to the
default triangulation we've just seen above and no extra work is necessary.</p>
</div>
<div class="section" id="odd-even-fill-rule">
<h3><a class="toc-backref" href="#id45">Odd-even fill rule</a></h3>
<p>In order to enforce the odd-even fill rule, we need to use a 2-pass
rendering. The first pass will write to the stencil buffer according to the
operation we define and the second pass will read the stencil buffer in order
to decide if a fragment need to be painted or not. For the first pass, we thus
disable depth and color writing and we instruct OpenGL to increment stencil
value if a shape is drawn clockwise (CW) and to decrement it for counter clock
wise shapes (CCW):</p>
<pre class="code python literal-block">
<span class="comment single"># Disable color and depth writing</span>
<span class="name">gl</span><span class="operator">.</span><span class="name">glColorMask</span><span class="punctuation">(</span><span class="name">gl</span><span class="operator">.</span><span class="name">GL_FALSE</span><span class="punctuation">,</span> <span class="name">gl</span><span class="operator">.</span><span class="name">GL_FALSE</span><span class="punctuation">,</span> <span class="name">gl</span><span class="operator">.</span><span class="name">GL_FALSE</span><span class="punctuation">,</span> <span class="name">gl</span><span class="operator">.</span><span class="name">GL_FALSE</span><span class="punctuation">)</span>
<span class="name">gl</span><span class="operator">.</span><span class="name">glDepthMask</span><span class="punctuation">(</span><span class="name">gl</span><span class="operator">.</span><span class="name">GL_FALSE</span><span class="punctuation">)</span>

<span class="comment single"># Always write to stencil</span>
<span class="name">gl</span><span class="operator">.</span><span class="name">glStencilFunc</span><span class="punctuation">(</span><span class="name">gl</span><span class="operator">.</span><span class="name">GL_ALWAYS</span><span class="punctuation">,</span> <span class="literal number integer">0</span><span class="punctuation">,</span> <span class="literal number integer">0</span><span class="punctuation">)</span>

<span class="comment single"># Increment value for CW shape</span>
<span class="name">gl</span><span class="operator">.</span><span class="name">glStencilOpSeparate</span><span class="punctuation">(</span><span class="name">gl</span><span class="operator">.</span><span class="name">GL_FRONT</span><span class="punctuation">,</span> <span class="name">gl</span><span class="operator">.</span><span class="name">GL_KEEP</span><span class="punctuation">,</span> <span class="name">gl</span><span class="operator">.</span><span class="name">GL_KEEP</span><span class="punctuation">,</span> <span class="name">gl</span><span class="operator">.</span><span class="name">GL_INCR</span><span class="punctuation">)</span>

<span class="comment single"># Decrement value for CCW shape</span>
<span class="name">gl</span><span class="operator">.</span><span class="name">glStencilOpSeparate</span><span class="punctuation">(</span><span class="name">gl</span><span class="operator">.</span><span class="name">GL_BACK</span><span class="punctuation">,</span>  <span class="name">gl</span><span class="operator">.</span><span class="name">GL_KEEP</span><span class="punctuation">,</span> <span class="name">gl</span><span class="operator">.</span><span class="name">GL_KEEP</span><span class="punctuation">,</span> <span class="name">gl</span><span class="operator">.</span><span class="name">GL_DECR</span><span class="punctuation">)</span>
</pre>
<p>Once the stencil buffer has been written, we can use the stored value to decide
for the condition to be tested for writing to the render buffer. Using the
<code>glStencilFunc</code> function, we can express virtually any condition we want:</p>
<blockquote>
<table border="1" class="docutils">
<colgroup>
<col width="24%" />
<col width="76%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head"><code>glStencilFunc</code></th>
<th class="head"><code>(func, ref, mask)</code></th>
</tr>
</thead>
<tbody valign="top">
<tr><td><code>GL_NEVER</code></td>
<td>Always fails</td>
</tr>
<tr><td><code>GL_LESS</code></td>
<td>Passes if ( ref &amp; mask ) &lt;  ( stencil &amp; mask )</td>
</tr>
<tr><td><code>GL_LEQUAL</code></td>
<td>Passes if ( ref &amp; mask ) &lt;= ( stencil &amp; mask )</td>
</tr>
<tr><td><code>GL_GREATER</code></td>
<td>Passes if ( ref &amp; mask ) &gt;  ( stencil &amp; mask )</td>
</tr>
<tr><td><code>GL_GEQUAL</code></td>
<td>Passes if ( ref &amp; mask ) &gt;= ( stencil &amp; mask )</td>
</tr>
<tr><td><code>GL_EQUAL</code></td>
<td>Passes if ( ref &amp; mask ) =  ( stencil &amp; mask )</td>
</tr>
<tr><td><code>GL_NOTEQUAL</code></td>
<td>Passes if ( ref &amp; mask ) != ( stencil &amp; mask )</td>
</tr>
<tr><td><code>GL_ALWAYS</code></td>
<td>Always passes</td>
</tr>
</tbody>
</table>
</blockquote>
<div class="right figure" id="figure-images/chapter-10/winding.png" style="width: 30%">
<img alt="images/chapter-10/winding.png" src="images/chapter-10/winding.png" />
<p class="caption">Figure</p>
<div class="legend">
Odd-even fill rule using the stencil buffer.
See <a class="reference external" href="code/chapter-10/winding.py">winding.py</a></div>
</div>
<p>For the actual odd-even fill rule, we only need to test for the last bit in the
stencil buffer:</p>
<pre class="code python literal-block">
<span class="comment single"># Enable color and depth writing</span>
<span class="name">gl</span><span class="operator">.</span><span class="name">glColorMask</span><span class="punctuation">(</span><span class="name">gl</span><span class="operator">.</span><span class="name">GL_TRUE</span><span class="punctuation">,</span> <span class="name">gl</span><span class="operator">.</span><span class="name">GL_TRUE</span><span class="punctuation">,</span> <span class="name">gl</span><span class="operator">.</span><span class="name">GL_TRUE</span><span class="punctuation">,</span> <span class="name">gl</span><span class="operator">.</span><span class="name">GL_TRUE</span><span class="punctuation">)</span>
<span class="name">gl</span><span class="operator">.</span><span class="name">glDepthMask</span><span class="punctuation">(</span><span class="name">gl</span><span class="operator">.</span><span class="name">GL_TRUE</span><span class="punctuation">)</span>

<span class="comment single"># Actual stencil test</span>
<span class="comment single"># Odd-even</span>
<span class="name">gl</span><span class="operator">.</span><span class="name">glStencilFunc</span><span class="punctuation">(</span><span class="name">gl</span><span class="operator">.</span><span class="name">GL_EQUAL</span><span class="punctuation">,</span> <span class="literal number hex">0x01</span><span class="punctuation">,</span> <span class="literal number hex">0x1</span><span class="punctuation">)</span>

<span class="comment single"># Non zero</span>
<span class="comment single"># gl.glStencilFunc(gl.GL_NOTEQUAL, 0x00, 0xff)</span>

<span class="comment single"># Positive</span>
<span class="comment single"># gl.glStencilFunc(gl.GL_LESS, 0x0, 0xff)</span>

<span class="comment single"># Stencil operation (for both CW and CCW shapes)</span>
<span class="name">gl</span><span class="operator">.</span><span class="name">glStencilOp</span><span class="punctuation">(</span><span class="name">gl</span><span class="operator">.</span><span class="name">GL_KEEP</span><span class="punctuation">,</span> <span class="name">gl</span><span class="operator">.</span><span class="name">GL_KEEP</span><span class="punctuation">,</span> <span class="name">gl</span><span class="operator">.</span><span class="name">GL_KEEP</span><span class="punctuation">)</span>
</pre>
</div>
</div>
<div class="section" id="id48">
<h2><a class="toc-backref" href="#id45">Exercises</a></h2>
<div class="section" id="polygon-gradients">
<h3><a class="toc-backref" href="#id45">Polygon gradients</a></h3>
<div class="right figure" id="figure-images/chapter-10/radial-gradient.png" style="width: 25%">
<img alt="images/chapter-10/radial-gradient.png" src="images/chapter-10/radial-gradient.png" />
<p class="caption">Figure</p>
<div class="legend">
Radial gradient.</div>
</div>
<p>The SVG specification considers two kind of color gradients (i.e. smooth
transition from one color to another), radial and linear. Using the vertices
coordinates inside the shader, it is thus very easy to create those gradients.
In order to do that, you need to compute (for every fragment) a scalar that
indicate tells the amount of color 1 and color 2 respectively and try to render
the image on the right.</p>
<p>Solution: <a class="reference external" href="code/chapter-10/radial-gradient.py">radial-gradient.py</a></p>
</div>
<div class="section" id="polygon-patterns">
<h3><a class="toc-backref" href="#id45">Polygon Patterns</a></h3>
<div class="right figure" id="figure-images/chapter-10/pattern.png" style="width: 25%">
<img alt="images/chapter-10/pattern.png" src="images/chapter-10/pattern.png" />
<p class="caption">Figure</p>
<div class="legend">
Patterns.</div>
</div>
<p>We can also use any texture to pain the polygon. It's only a matter of
assigning the right texture to polygon vertices. Try to render the image on the
right using this <a class="reference external" href="images/chapter-10/wave.png">texture</a></p>
<p>Solution: <a class="reference external" href="code/chapter-10/pattern.py">pattern.py</a></p>
</div>
<div class="section" id="id49">
<h3><a class="toc-backref" href="#id45">Antialiasing</a></h3>
<p>As you have noticed, the polygon we've renderered so far are not antialised
(because we've been using only raw triangles). While it might be possible to
write a specific shader to take car of antiliasing on the border, it is far
more easier to draw an antialiased polygon in two steps. First, we draw the
interio of the polygon and then, we render a half-line on the contour. We need
a half-line because we do not want the line to cover the already rendered
polygon. There is no real difficulty and this is a good exercise. I will use
the best proposed solution to be included here.</p>
</div>
</div>
</div>
<div class="section" id="rendering-a-mesh">
<h1><a class="toc-backref" href="#contents">Rendering a mesh</a></h1>
<p>Work in Progress.</p>
<!-- .. contents:: .
   :local:
   :depth: 2
   :class: toc chapter-11


Ok, it is now time to go 3D! I'm pretty sure you're reading this book only for
this. I won't explain everything since you'll find a lot of online resources
dedicated to 3D rendering using OpenGL. Instead, I'll concentrate on common
techniques found in scientific visualization. The teaser image is a Klein
bottle rendered using glumpy. Sources are available from the
`geometric-parametric.py
<https://github.com/glumpy/glumpy/blob/master/examples/geometry-parametric.py>`_
example.


Parametric surfaces
- - - - - - - - - - - - - - - - - - -

From Wikipedia:

    *A parametric surface is a surface in the Euclidean space ℝ³ which is
    defined by a parametric equation with two parameters f(u,v) : ℝ² →
    ℝ³. Parametric representation is a very general way to specify a surface,
    as well as implicit representation.*

Surfaces such as `Boy's surface
<https://en.wikipedia.org/wiki/Boy%27s_surface>`_, `Klein bottle
<https://en.wikipedia.org/wiki/Klein_bottle>`_, `Möbius strip
<https://en.wikipedia.org/wiki/Klein_bottle>`_ are all parametric surfaces that
can be described using more or less simple equations. Let's consider the Boy's
surface. Considering two parameters (u,v) in [0,π], the (x,y,z) surface writes (thanks `Mayavi <http://docs.enthought.com/mayavi/mayavi/auto/example_boy.html>`_):

.. code:: python

   x = 2 / 3. * (cos(u) * cos(2 * v)
       + sqrt(2) * sin(u) * cos(v)) * cos(u) / (sqrt(2) - sin(2 * u) * sin(3 * v))
   y = 2 / 3. * (cos(u) * sin(2 * v) -
        sqrt(2) * sin(u) * sin(v)) * cos(u) / (sqrt(2) - sin(2 * u) * sin(3 * v))
   z = -sqrt(2) * cos(u) * cos(u) / (sqrt(2) - sin(2 * u) * sin(3 * v))


What is nice with such (u,v) parameterization is that we can easily triangulate
the surface. We only have to iterate over u and v and compute the corresponding
vertices:

.. code:: python

    vtype = [('position', np.float32, 3)]
    vcount += 1
    ucount += 1
    n = vcount*ucount
    Un = np.repeat(np.linspace(0, 1, ucount, endpoint=True), vcount)
    U = umin+Un*(umax-umin) # normalization
    Vn = np.tile  (np.linspace(0, 1, vcount, endpoint=True), ucount)
    V = vmin+Vn*(vmax-vmin) # normalization
    vertices = np.zeros(n, dtype=vtype)
    for i,(u,v) in enumerate(zip(U,V)):
        x,y,z = func(u,v)
        vertices["position"][i] = x,y,z


Then (and because this a regular surface), we can easily build the
corresponding indices:

.. code:: python

   for i in range(ucount-1):
       for j in range(vcount-1):
           indices.append(i*(vcount) + j        )
           indices.append(i*(vcount) + j+1      )
           indices.append(i*(vcount) + j+vcount+1)
           indices.append(i*(vcount) + j+vcount  )
           indices.append(i*(vcount) + j+vcount+1)
           indices.append(i*(vcount) + j        )
   indices = np.array(indices, dtype=itype)


.. figure:: images/chapter-11/boy-tesselation.png
   :figwidth: 100%

   Figure

   Tesselated Boy's surface using 16, 32, 64 and 128 steps.
   See `boy-tesselation.py <code/chapter-11/boy-tesselation.py>`_


.. figure:: movies/chapter-11/boy.mp4
   :figclass: right
   :loop:
   :controls:
   :figwidth: 35%

   Figure

   Colored Boy's surface using an approximated Viridis colormap by `Jérôme
   Liard <https://www.shadertoy.com/user/blackjero>`_.
   See `boy.py <code/chapter-11/boy.py>`_


We can make the rendering a bit nicer using colors according to (u,v)
coordinates. For this, we just need to provide the fragment shader with the
(uv) coordinate and decide how to paint the surface acccording to u, v or both.
Furthermore, instead of drawing the surface twices to display the grid lines,
we can directly render them in the same shader.

.. code:: glsl

   varying vec2 v_uv;
   void main()
   {
       float x = 1 - sin(v_uv.x);
       vec4 color = vec4(vec3(x), 1.0);
       vec4 black = vec4(vec3(0.0), 1.0);
       vec2 d = fract((v_uv/M_PI)*64.0);
       vec2 f = fwidth(d);
       vec2 a = smoothstep(0.99-f, 0.99+f, d);
       gl_FragColor =  mix(color, black, max(a.x,a.y));
   }



Height fields
- - - - - - - - - - - - -

Height fields are also a very common object in scientific visualization. It
allows to visualize a function of the type z = f(x,y) over a specific domain.


Mesh models
- - - - - - - - - - - -->
</div>
<div class="section" id="rendering-text">
<h1><a class="toc-backref" href="#contents">Rendering text</a></h1>
<p>Work in Progress.</p>
<!-- .. contents:: .
   :local:
   :depth: 2
   :class: toc chapter-12


Failsafe text
- - - - - - - - - - - - -

2D text
- - - - - - -

3D text
- - - - - - - -->
</div>
<div class="section" id="framebuffer">
<h1><a class="toc-backref" href="#contents">Framebuffer</a></h1>
<p>Work in Progress.</p>
<!-- .. contents:: .
   :local:
   :depth: 2
   :class: toc chapter-13

Post-processing
- - - - - - - - - - - - - - -

General computation
- - - - - - - - - - - - - - - - - - -

Color picking
- - - - - - - - - - - - - -->
</div>
<div class="section" id="special-techniques">
<h1><a class="toc-backref" href="#contents">Special techniques</a></h1>
<p>Work in Progress.</p>
<!-- .. contents:: .
   :local:
   :depth: 2
   :class: toc chapter-14


Colormaps
- - - - - - - - -

Contours
- - - - - - - -

Transparency
- - - - - - - - - - - -

Generic transformation
- - - - - - - - - - - - - - - - - - - - - -

Grids
- - - - -

Cartesian grid
++++++++++++++

.. figure:: data/quad-grid.mp4
   :loop:
   :controls:
   :figwidth: 35%
   :figclass: left

   Figure

   An animated antialiased shader grid with constant rendering time,
   i.e. independent of the number of lines displayed.


If you're familiar with the old fixed pipeline (or any other graphic library
for that matter), you should know that the most obvious way to display a grid
is to draw lines one by one. Of course, the more lines you have and the slower
your program will be. Using modern GL, we can have a constant rendering time,
that is, indepent of the number of displayed line. How? you might wonder. The
trick is to draw lines within the shader. If we reconsider the `quad simple.py
<code/chapter-03/quad-simple.py>`_ example, you might discover that the
fragment shader may have access to its exact coordinate, provided we pass this
information from the vertex shader. Let's imagine the window size is 512x512
and we multiply the normalized vertex coordinate by 256, we then have the exact
position for any fragment within the fragment shader. We can then compute a
distance to the nearest major or minor line by using the `mod` (modulo)
operator. Using this distance, we can decide what will be the color of the
fragment. It it is close enough from a major or minor line, it'll be black,
else it'll be white. For a flawless rendering, you'll actually need to modulate
the color depending on the distance using the GLSL `mix` function. (`solution 4
<code/chapter-03/quad-grid.py>`_)

Hexagonal grid
++++++++++++++


Polar grid
++++++++++ -->
</div>
<div class="section" id="conclusion">
<h1><a class="toc-backref" href="#contents">Conclusion</a></h1>
<p>Work in Progress.</p>
</div>
<div class="section" id="glsl-references">
<h1><a class="toc-backref" href="#contents">GLSL References</a></h1>
<div class="contents toc chapter-16 local topic" id="id50">
<p class="topic-title first">.</p>
<ul class="simple">
<li><a class="reference internal" href="#types" id="id224">Types</a><ul>
<li><a class="reference internal" href="#scalar" id="id225">Scalar</a></li>
<li><a class="reference internal" href="#vector" id="id226">Vector</a></li>
<li><a class="reference internal" href="#matrix" id="id227">Matrix</a></li>
<li><a class="reference internal" href="#id52" id="id228">Texture</a></li>
</ul>
</li>
<li><a class="reference internal" href="#qualifiers" id="id229">Qualifiers</a><ul>
<li><a class="reference internal" href="#storage" id="id230">Storage</a></li>
<li><a class="reference internal" href="#parameters" id="id231">Parameters</a></li>
<li><a class="reference internal" href="#precision" id="id232">Precision</a></li>
</ul>
</li>
<li><a class="reference internal" href="#built-in-variables" id="id233">Built-in variables</a><ul>
<li><a class="reference internal" href="#vertex-shader" id="id234">Vertex shader</a></li>
<li><a class="reference internal" href="#fragment-shader" id="id235">Fragment shader</a></li>
</ul>
</li>
<li><a class="reference internal" href="#built-in-constants" id="id236">Built-in constants</a></li>
<li><a class="reference internal" href="#built-in-functions" id="id237">Built-in functions</a><ul>
<li><a class="reference internal" href="#angle-and-trigonometry-functions" id="id238">Angle and trigonometry functions</a></li>
<li><a class="reference internal" href="#exponential-functions" id="id239">Exponential functions</a></li>
<li><a class="reference internal" href="#common-functions" id="id240">Common functions</a></li>
<li><a class="reference internal" href="#geometric-functions" id="id241">Geometric functions</a></li>
<li><a class="reference internal" href="#matrix-functions" id="id242">Matrix functions</a></li>
<li><a class="reference internal" href="#vector-relational-functions" id="id243">Vector Relational Functions</a></li>
<li><a class="reference internal" href="#texture-lookup-functions" id="id244">Texture lookup functions</a></li>
</ul>
</li>
</ul>
</div>
<p>The information below has been directly extracted and reformated from the <a class="reference external" href="https://www.khronos.org/files/opengles_shading_language.pdf">GLES
Shading language 1.0</a>. Copyright (c)
2006-2009 The Khronos Group Inc. All Rights Reserved. The teaser image above
has been coded by Shadertoy Grand Master <a class="reference external" href="http://iquilezles.org/www/index.htm">Íñigo Quílez</a> and is available from the <a class="reference external" href="https://www.shadertoy.com/view/ld3Gz2">shadertoy
website</a> which is a great resource for
learning OpenGL and WebGL (and that is more or less compatible with GLES 2.0).</p>
<div class="section" id="types">
<h2><a class="toc-backref" href="#id50">Types</a></h2>
<div class="section" id="scalar">
<h3><a class="toc-backref" href="#id50">Scalar</a></h3>
<p><span class="proto">void</span></p>
<blockquote>
for functions that do not return a value</blockquote>
<p><span class="proto">bool</span></p>
<blockquote>
a conditional type, taking on values of true or false</blockquote>
<p><span class="proto">int</span></p>
<blockquote>
a signed integer</blockquote>
<p><span class="proto">float</span></p>
<blockquote>
a single floating-point scalar</blockquote>
</div>
<div class="section" id="vector">
<h3><a class="toc-backref" href="#id50">Vector</a></h3>
<p><span class="proto">bvec2</span> <span class="proto">bvec3</span> <span class="proto">bvec4</span></p>
<blockquote>
a two, three or four components Boolean vector</blockquote>
<p><span class="proto">ivec2</span> <span class="proto">ivec3</span> <span class="proto">ivec4</span></p>
<blockquote>
a two, three or four components interge vector</blockquote>
<p><span class="proto">vec2</span> <span class="proto">vec3</span> <span class="proto">vec4</span></p>
<blockquote>
a two, three or four components floating-point vector</blockquote>
</div>
<div class="section" id="matrix">
<h3><a class="toc-backref" href="#id50">Matrix</a></h3>
<p><span class="proto">mat2</span> <span class="proto">mat3</span> <span class="proto">mat4</span></p>
<blockquote>
a 2×2, 3×3 or 4×4 floating-point matrix</blockquote>
</div>
<div class="section" id="id52">
<h3><a class="toc-backref" href="#id50">Texture</a></h3>
<p><span class="proto">sampler2D</span></p>
<blockquote>
a handle for accessing a 2D texture</blockquote>
<p><span class="proto">samplerCube</span></p>
<blockquote>
a handle for accessing a cube mapped texture</blockquote>
</div>
</div>
<div class="section" id="qualifiers">
<h2><a class="toc-backref" href="#id50">Qualifiers</a></h2>
<div class="section" id="storage">
<h3><a class="toc-backref" href="#id50">Storage</a></h3>
<p><span class="proto">&lt;none: default&gt;</span></p>
<blockquote>
local read/write memory, or an input parameter to a function</blockquote>
<p><span class="proto">const</span></p>
<blockquote>
a compile-time constant, or a function parameter that is read-only</blockquote>
<p><span class="proto">attribute</span></p>
<blockquote>
linkage between a vertex shader and OpenGL ES for  per-vertex data</blockquote>
<p><span class="proto">uniform</span></p>
<blockquote>
value does not change across the primitive being processed, uniforms form
the linkage between a shader, OpenGL ES, and the application</blockquote>
<p><span class="proto">varying</span></p>
<blockquote>
linkage between a vertex shader and a fragment shader for interpolated data</blockquote>
</div>
<div class="section" id="parameters">
<h3><a class="toc-backref" href="#id50">Parameters</a></h3>
<p><span class="proto">&lt;none: default&gt;</span></p>
<blockquote>
same as <code>in</code></blockquote>
<p><span class="proto">in</span></p>
<blockquote>
for function parameters passed into a function</blockquote>
<p><span class="proto">out</span></p>
<blockquote>
for function parameters passed back out of a function, but not initialized
for use when passed in</blockquote>
<p><span class="proto">inout</span></p>
<blockquote>
for function parameters passed both into and out of a function</blockquote>
</div>
<div class="section" id="precision">
<h3><a class="toc-backref" href="#id50">Precision</a></h3>
<p><span class="proto">highp</span></p>
<blockquote>
Satisfies the minimum requirements for the vertex language.
Optional in the fragment language.</blockquote>
<p><span class="proto">mediump</span></p>
<blockquote>
Satisfies the minimum requirements for the fragment language. Its range and
precision has to be greater than or the same as provided by <code>lowp</code> and less
than or the same as provided by <code>highp</code>.</blockquote>
<p><span class="proto">lowp</span></p>
<blockquote>
Range and precision that can be less than <code>mediump</code>, but still intended to
represent all color values for any color channel.</blockquote>
</div>
</div>
<div class="section" id="built-in-variables">
<h2><a class="toc-backref" href="#id50">Built-in variables</a></h2>
<div class="section" id="vertex-shader">
<h3><a class="toc-backref" href="#id50">Vertex shader</a></h3>
<p>These built-in vertex shader variables for communicating with fixed
functionality are intrinsically declared with the following types:</p>
<pre class="code glsl literal-block">
<span class="keyword">highp</span>   <span class="keyword type">vec4</span>  <span class="name builtin">gl_Position</span><span class="punctuation">;</span>    <span class="comment single">// should be written to</span>
<span class="keyword">mediump</span> <span class="keyword type">float</span> <span class="name builtin">gl_PointSize</span><span class="punctuation">;</span>   <span class="comment single">// may be written to</span>
</pre>
<p><span class="proto">gl_Position</span></p>
<blockquote>
The variable <code>gl_Position</code> is intended for writing the homogeneous vertex
position.</blockquote>
<p><span class="proto">gl_PointSize</span></p>
<blockquote>
The variable <code>gl_PointSize</code> is intended for a vertex shader to write the size
of the point to be rasterized. It is measured in pixels.</blockquote>
</div>
<div class="section" id="fragment-shader">
<h3><a class="toc-backref" href="#id50">Fragment shader</a></h3>
<p>The built-in variables that are accessible from a fragment shader are
intrinsically given types as follows:</p>
<pre class="code glsl literal-block">
<span class="keyword">mediump</span> <span class="keyword type">vec4</span>  <span class="name builtin">gl_FragCoord</span><span class="punctuation">;</span>
        <span class="keyword type">bool</span>  <span class="name builtin">gl_FrontFacing</span><span class="punctuation">;</span>
<span class="keyword">mediump</span> <span class="keyword type">vec4</span>  <span class="name builtin">gl_FragColor</span><span class="punctuation">;</span>
<span class="keyword">mediump</span> <span class="keyword type">vec4</span>  <span class="name builtin">gl_FragData</span><span class="punctuation">[</span><span class="name builtin">gl_MaxDrawBuffers</span><span class="punctuation">];</span>
<span class="keyword">mediump</span> <span class="keyword type">vec2</span>  <span class="name builtin">gl_PointCoord</span><span class="punctuation">;</span>
</pre>
<p><span class="proto">gl_FragColor</span></p>
<blockquote>
Writing to <code>gl_FragColor</code> specifies the fragment color that will be used by
the subsequent fixed functionality pipeline.</blockquote>
<p><span class="proto">gl_FragData</span></p>
<blockquote>
<code>gl_FragData</code> is an array. Writing to <code>gl_FragData[n]</code> specifies the
fragment data that will be used by the subsequent fixed functionality
pipeline for data n.</blockquote>
<p><span class="proto">gl_FragCoord</span></p>
<blockquote>
The variable <code>gl_FragCoord</code> is available as a read-only variable from within
fragment shaders and it holds the window relative coordinates x, y, z, and
1/w values for the fragment.</blockquote>
<p><span class="proto">gl_FrontFacing</span></p>
<blockquote>
<code>gl_FrontFacing</code> value is true if the fragment belongs to a front-facing
primitive.</blockquote>
<p><span class="proto">gl_PointCoord</span></p>
<blockquote>
The values in <code>gl_PointCoord</code> are two-dimensional coordinates indicating
where within a point primitive the current fragment is located. They range
from 0.0 to 1.0 across the point.</blockquote>
</div>
</div>
<div class="section" id="built-in-constants">
<h2><a class="toc-backref" href="#id50">Built-in constants</a></h2>
<p>The following built-in constants are provided to the vertex and fragment shaders.
The example values below are the minimum values allowed for these maximums.</p>
<pre class="code glsl literal-block">
<span class="keyword">const</span> <span class="keyword">mediump</span> <span class="keyword type">int</span> <span class="name builtin">gl_MaxVertexAttribs</span> <span class="operator">=</span> <span class="literal number integer">8</span><span class="punctuation">;</span>
<span class="keyword">const</span> <span class="keyword">mediump</span> <span class="keyword type">int</span> <span class="name builtin">gl_MaxVertexUniformVectors</span> <span class="operator">=</span> <span class="literal number integer">128</span><span class="punctuation">;</span>
<span class="keyword">const</span> <span class="keyword">mediump</span> <span class="keyword type">int</span> <span class="name builtin">gl_MaxVaryingVectors</span> <span class="operator">=</span> <span class="literal number integer">8</span><span class="punctuation">;</span>
<span class="keyword">const</span> <span class="keyword">mediump</span> <span class="keyword type">int</span> <span class="name builtin">gl_MaxVertexTextureImageUnits</span> <span class="operator">=</span> <span class="literal number oct">0</span><span class="punctuation">;</span>
<span class="keyword">const</span> <span class="keyword">mediump</span> <span class="keyword type">int</span> <span class="name builtin">gl_MaxCombinedTextureImageUnits</span> <span class="operator">=</span> <span class="literal number integer">8</span><span class="punctuation">;</span>
<span class="keyword">const</span> <span class="keyword">mediump</span> <span class="keyword type">int</span> <span class="name builtin">gl_MaxTextureImageUnits</span> <span class="operator">=</span> <span class="literal number integer">8</span><span class="punctuation">;</span>
<span class="keyword">const</span> <span class="keyword">mediump</span> <span class="keyword type">int</span> <span class="name builtin">gl_MaxFragmentUniformVectors</span> <span class="operator">=</span> <span class="literal number integer">16</span><span class="punctuation">;</span>
<span class="keyword">const</span> <span class="keyword">mediump</span> <span class="keyword type">int</span> <span class="name builtin">gl_MaxDrawBuffers</span> <span class="operator">=</span> <span class="literal number integer">1</span><span class="punctuation">;</span>
</pre>
</div>
<div class="section" id="built-in-functions">
<h2><a class="toc-backref" href="#id50">Built-in functions</a></h2>
<div class="section" id="angle-and-trigonometry-functions">
<h3><a class="toc-backref" href="#id50">Angle and trigonometry functions</a></h3>
<p>For all the functions below, T can be a <code>float</code> or a <code>float</code> vector (<code>vec2</code>,
<code>vec3</code>, <code>vec4</code>). In case of a <code>float</code> vector, the function is computed for each
component separately.</p>
<p><span class="proto">T radians (T degrees)</span></p>
<blockquote>
<p>The <code>radians</code> function converts degrees to radians.</p>
<pre class="code glsl literal-block">
<span class="keyword type">float</span> <span class="name">x</span> <span class="operator">=</span> <span class="name">radians</span><span class="punctuation">(</span><span class="literal number float">90.0</span><span class="punctuation">);</span>              <span class="comment single">// x = π/2</span>
<span class="keyword type">vec2</span>  <span class="name">x</span> <span class="operator">=</span> <span class="name">radians</span><span class="punctuation">(</span><span class="keyword type">vec2</span><span class="punctuation">(</span><span class="literal number float">45.0</span><span class="punctuation">,</span> <span class="literal number float">90.0</span><span class="punctuation">));</span>  <span class="comment single">// x = vec2(π/4, π/2)</span>
</pre>
</blockquote>
<p><span class="proto">T degrees (T radians)</span></p>
<blockquote>
<p>The <code>degree</code> function converts radians to degrees.</p>
<pre class="code glsl literal-block">
<span class="keyword">const</span> <span class="name">pi</span> <span class="operator">=</span> <span class="literal number float">3.141592653589793</span><span class="punctuation">;</span>
<span class="keyword type">float</span> <span class="name">x</span> <span class="operator">=</span> <span class="name">degrees</span><span class="punctuation">(</span><span class="name">pi</span><span class="punctuation">);</span>                    <span class="comment single">// x = 180</span>
<span class="keyword type">vec2</span>  <span class="name">x</span> <span class="operator">=</span> <span class="name">degrees</span><span class="punctuation">(</span><span class="keyword type">vec2</span><span class="punctuation">(</span><span class="name">pi</span><span class="operator">/</span><span class="literal number float">4.0</span><span class="punctuation">,</span> <span class="name">pi</span><span class="operator">/</span><span class="literal number float">2.0</span><span class="punctuation">));</span>  <span class="comment single">// x = vec2(45.0, 90.0)</span>
</pre>
</blockquote>
<p><span class="proto">T sin (T angle)</span></p>
<blockquote>
<p>The <code>sin</code> function returns the sine of an angle in radians.</p>
<pre class="code glsl literal-block">
<span class="keyword">const</span> <span class="name">pi</span> <span class="operator">=</span> <span class="literal number float">3.141592653589793</span><span class="punctuation">;</span>
<span class="keyword type">float</span> <span class="name">x</span> <span class="operator">=</span> <span class="name">sin</span><span class="punctuation">(</span><span class="literal number float">0.0</span><span class="punctuation">);</span>                <span class="comment single">// x = 0</span>
<span class="keyword type">vec2</span>  <span class="name">x</span> <span class="operator">=</span> <span class="name">sin</span><span class="punctuation">(</span><span class="keyword type">vec2</span><span class="punctuation">(</span><span class="literal number float">0.0</span><span class="punctuation">,</span> <span class="name">pi</span><span class="operator">/</span><span class="literal number float">2.0</span><span class="punctuation">));</span>  <span class="comment single">// x = vec2(0.0, 1.0)</span>
</pre>
</blockquote>
<p><span class="proto">T cos (T angle)</span></p>
<blockquote>
<p>The <code>cos</code> function returns the cosine of an angle in radians.</p>
<pre class="code glsl literal-block">
<span class="keyword">const</span> <span class="name">pi</span> <span class="operator">=</span> <span class="literal number float">3.141592653589793</span><span class="punctuation">;</span>
<span class="keyword type">float</span> <span class="name">x</span> <span class="operator">=</span> <span class="name">cos</span><span class="punctuation">(</span><span class="literal number float">0.0</span><span class="punctuation">);</span>                <span class="comment single">// x = 0</span>
<span class="keyword type">vec2</span>  <span class="name">x</span> <span class="operator">=</span> <span class="name">cos</span><span class="punctuation">(</span><span class="keyword type">vec2</span><span class="punctuation">(</span><span class="literal number float">0.0</span><span class="punctuation">,</span> <span class="name">pi</span><span class="operator">/</span><span class="literal number float">2.0</span><span class="punctuation">));</span>  <span class="comment single">// x = vec2(1.0, 0.0)</span>
</pre>
</blockquote>
<p><span class="proto">T tan (T angle)</span></p>
<blockquote>
<p>The <code>tan</code> function returns the tangent of an angle in radians.</p>
<pre class="code glsl literal-block">
<span class="keyword">const</span> <span class="name">pi</span> <span class="operator">=</span> <span class="literal number float">3.141592653589793</span><span class="punctuation">;</span>
<span class="keyword type">float</span> <span class="name">x</span> <span class="operator">=</span> <span class="name">tan</span><span class="punctuation">(</span><span class="literal number float">0.0</span><span class="punctuation">);</span>                <span class="comment single">// x = 0</span>
<span class="keyword type">vec2</span>  <span class="name">x</span> <span class="operator">=</span> <span class="name">tan</span><span class="punctuation">(</span><span class="keyword type">vec2</span><span class="punctuation">(</span><span class="literal number float">0.0</span><span class="punctuation">,</span> <span class="name">pi</span><span class="operator">/</span><span class="literal number float">4.0</span><span class="punctuation">));</span>  <span class="comment single">// x = vec2(0.0, 1.0)</span>
</pre>
</blockquote>
<p><span class="proto">T asin (T x)</span></p>
<blockquote>
<p>The <code>asin</code> returns an angle in radians whose sine is x. The range of values
returned by this function is [−π/2,π/2] Results are undefined if ∣x∣ &gt; 1.</p>
<pre class="code glsl literal-block">
<span class="keyword type">float</span> <span class="name">x</span> <span class="operator">=</span> <span class="name">asin</span><span class="punctuation">(</span><span class="literal number float">0.0</span><span class="punctuation">);</span>             <span class="comment single">// x = 0.0</span>
<span class="keyword type">vec2</span>  <span class="name">x</span> <span class="operator">=</span> <span class="name">asin</span><span class="punctuation">(</span><span class="keyword type">vec2</span><span class="punctuation">(</span><span class="literal number float">0.0</span><span class="punctuation">,</span> <span class="literal number float">1.0</span><span class="punctuation">));</span>  <span class="comment single">// x = vec2(0.0, π/2)</span>
</pre>
</blockquote>
<p><span class="proto">T acos (T x)</span></p>
<blockquote>
<p>The <code>acos</code> returns an angle in radians whose cosine is x. The range of values
returned by this function is [0,π] Results are undefined if ∣x∣ &gt; 1.</p>
<pre class="code glsl literal-block">
<span class="keyword type">float</span> <span class="name">x</span> <span class="operator">=</span> <span class="name">acos</span><span class="punctuation">(</span><span class="literal number float">0.0</span><span class="punctuation">);</span>             <span class="comment single">// x = π/2</span>
<span class="keyword type">vec2</span>  <span class="name">x</span> <span class="operator">=</span> <span class="name">acos</span><span class="punctuation">(</span><span class="keyword type">vec2</span><span class="punctuation">(</span><span class="literal number float">0.0</span><span class="punctuation">,</span> <span class="literal number float">1.0</span><span class="punctuation">));</span>  <span class="comment single">// x = vec2(π/2, 0.0)</span>
</pre>
</blockquote>
<p><span class="proto">T atan (T y_over_x)</span></p>
<blockquote>
<p>The <code>atan</code> function returns an angle whose tangent is y/x.  The signs of x and
y are used to determine what quadrant the angle is in. The range of values
returned by this function is [−π,π].  Results are undefined if x and y are
both 0.</p>
<pre class="code glsl literal-block">
<span class="keyword type">float</span> <span class="name">x</span> <span class="operator">=</span> <span class="name">atan</span><span class="punctuation">(</span><span class="literal number float">0.0</span><span class="punctuation">);</span>             <span class="comment single">// x = 0.0</span>
<span class="keyword type">vec2</span>  <span class="name">x</span> <span class="operator">=</span> <span class="name">atan</span><span class="punctuation">(</span><span class="keyword type">vec2</span><span class="punctuation">(</span><span class="literal number float">0.0</span><span class="punctuation">,</span> <span class="literal number float">1.0</span><span class="punctuation">));</span>  <span class="comment single">// x = vec2(0.0, π/4)</span>
</pre>
</blockquote>
</div>
<div class="section" id="exponential-functions">
<h3><a class="toc-backref" href="#id50">Exponential functions</a></h3>
<p>For all the functions below, T can be a <code>float</code> or a <code>float</code> vector (<code>vec2</code>,
<code>vec3</code>, <code>vec4</code>). In case of a <code>float</code> vector, the function is computed for each
component separately.</p>
<p><span class="proto">T pow (T x, T y)</span></p>
<blockquote>
<p>The <code>power</code> function returns x raised to the power of y, i.e., xʸ.
Results are undefined if x &lt; 0 or if x = 0 and y ≤ 0.</p>
<pre class="code glsl literal-block">
<span class="keyword type">float</span> <span class="name">x</span> <span class="operator">=</span> <span class="name">pow</span><span class="punctuation">(</span><span class="literal number float">2.0</span><span class="punctuation">,</span> <span class="literal number float">2.0</span><span class="punctuation">);</span>            <span class="comment single">// x = 4.0</span>
<span class="keyword type">vec2</span>  <span class="name">x</span> <span class="operator">=</span> <span class="name">pow</span><span class="punctuation">(</span><span class="keyword type">vec2</span><span class="punctuation">(</span><span class="literal number float">2.0</span><span class="punctuation">,</span> <span class="literal number float">3.0</span><span class="punctuation">),</span> <span class="literal number float">2.0</span><span class="punctuation">);</span> <span class="comment single">// x = vec2(4.0, 9.0)</span>
</pre>
</blockquote>
<p><span class="proto">T exp (T x)</span></p>
<blockquote>
<p>The <code>exp</code> function returns the natural exponentiation of x, i.e eˣ.</p>
<pre class="code glsl literal-block">
<span class="keyword type">float</span> <span class="name">x</span> <span class="operator">=</span> <span class="name">exp</span><span class="punctuation">(</span><span class="literal number float">2.0</span><span class="punctuation">);</span>            <span class="comment single">// x = e²</span>
<span class="keyword type">vec2</span>  <span class="name">x</span> <span class="operator">=</span> <span class="name">exp</span><span class="punctuation">(</span><span class="keyword type">vec2</span><span class="punctuation">(</span><span class="literal number float">2.0</span><span class="punctuation">,</span> <span class="literal number float">3.0</span><span class="punctuation">));</span> <span class="comment single">// x = vec2(e², e³)</span>
</pre>
</blockquote>
<p><span class="proto">T log (T x)</span></p>
<blockquote>
<p>The <code>log</code> function returns the natural logarithm of x, i.e., returns the
value y which satisfies the equation x = eʸ.
Results are undefined if x ≤ 0.</p>
<pre class="code glsl literal-block">
<span class="keyword">const</span> <span class="keyword type">float</span> <span class="name">e</span> <span class="operator">=</span> <span class="literal number float">2.718281828459045</span><span class="punctuation">;</span>
<span class="keyword type">float</span> <span class="name">x</span> <span class="operator">=</span> <span class="name">log</span><span class="punctuation">(</span><span class="literal number float">1.0</span><span class="punctuation">);</span>          <span class="comment single">// x = 0.0</span>
<span class="keyword type">vec2</span>  <span class="name">x</span> <span class="operator">=</span> <span class="name">log</span><span class="punctuation">(</span><span class="keyword type">vec2</span><span class="punctuation">(</span><span class="literal number float">1.0</span><span class="punctuation">,</span> <span class="name">e</span><span class="punctuation">));</span> <span class="comment single">// x = vec2(0.0, 1.0)</span>
</pre>
</blockquote>
<p><span class="proto">T exp2 (T x)</span></p>
<blockquote>
<p>The <code>exp2</code> function returns 2 raised to the x power, i.e., 2ˣ</p>
<pre class="code glsl literal-block">
<span class="keyword type">float</span> <span class="name">x</span> <span class="operator">=</span> <span class="name">exp2</span><span class="punctuation">(</span><span class="literal number float">2.0</span><span class="punctuation">);</span>            <span class="comment single">// x = 4.0</span>
<span class="keyword type">vec2</span>  <span class="name">x</span> <span class="operator">=</span> <span class="name">exp2</span><span class="punctuation">(</span><span class="keyword type">vec2</span><span class="punctuation">(</span><span class="literal number float">2.0</span><span class="punctuation">,</span> <span class="literal number float">3.0</span><span class="punctuation">));</span> <span class="comment single">// x = vec2(4.0, 8.0)</span>
</pre>
</blockquote>
<p><span class="proto">T log2 (T x)</span></p>
<blockquote>
<p>The <code>log2</code> function returns the base 2 logarithm of x, i.e., returns the
value y which satisfies the equation x = 2ʸ.
Results are undefined if x ≤ 0.</p>
<pre class="code glsl literal-block">
<span class="keyword type">float</span> <span class="name">x</span> <span class="operator">=</span> <span class="name">log2</span><span class="punctuation">(</span><span class="literal number float">4.0</span><span class="punctuation">);</span>            <span class="comment single">// x = 2.0</span>
<span class="keyword type">vec2</span>  <span class="name">x</span> <span class="operator">=</span> <span class="name">log2</span><span class="punctuation">(</span><span class="keyword type">vec2</span><span class="punctuation">(</span><span class="literal number float">4.0</span><span class="punctuation">,</span> <span class="literal number float">8.0</span><span class="punctuation">));</span> <span class="comment single">// x = vec2(2.0, 3.0)</span>
</pre>
</blockquote>
<p><span class="proto">T sqrt (T x)</span></p>
<blockquote>
<p>The <code>sqrt</code> function returns the square root of x.
Results are undefined if x &lt; 0.</p>
<pre class="code glsl literal-block">
<span class="keyword type">float</span> <span class="name">x</span> <span class="operator">=</span> <span class="name">sqrt</span><span class="punctuation">(</span><span class="literal number float">4.0</span><span class="punctuation">);</span>            <span class="comment single">// x = 2.0</span>
<span class="keyword type">vec2</span>  <span class="name">x</span> <span class="operator">=</span> <span class="name">sqrt</span><span class="punctuation">(</span><span class="keyword type">vec2</span><span class="punctuation">(</span><span class="literal number float">4.0</span><span class="punctuation">,</span> <span class="literal number float">9.0</span><span class="punctuation">));</span> <span class="comment single">// x = vec2(2.0, 3.0)</span>
</pre>
</blockquote>
<p><span class="proto">T inversesqrt (T x)</span></p>
<blockquote>
<p>The <code>inversesqrt</code> returns the inverse square root of x, i.e. the
reciprocal of the square root.
Results are undefined if x ≤ 0.</p>
<pre class="code glsl literal-block">
<span class="keyword type">float</span> <span class="name">x</span> <span class="operator">=</span> <span class="name">inversesqrt</span><span class="punctuation">(</span><span class="literal number float">1.0</span><span class="operator">/</span><span class="literal number float">4.0</span><span class="punctuation">);</span>         <span class="comment single">// x = 2.0</span>
<span class="keyword type">vec2</span>  <span class="name">x</span> <span class="operator">=</span> <span class="name">sqrt</span><span class="punctuation">(</span><span class="keyword type">vec2</span><span class="punctuation">(</span><span class="literal number float">1.0</span><span class="operator">/</span><span class="literal number float">4.0</span><span class="punctuation">,</span> <span class="literal number float">1.0</span><span class="operator">/</span><span class="literal number float">9.0</span><span class="punctuation">));</span> <span class="comment single">// x = vec2(2.0, 3.0)</span>
</pre>
</blockquote>
</div>
<div class="section" id="common-functions">
<h3><a class="toc-backref" href="#id50">Common functions</a></h3>
<p>For all the functions below, T can be a <code>float</code> or a <code>float</code> vector (<code>vec2</code>,
<code>vec3</code>, <code>vec4</code>). In case of a <code>float</code> vector, the function is computed for each
component separately.</p>
<p><span class="proto">T abs (T x)</span></p>
<blockquote>
<p>The <code>abs</code> function returns x if x ≥ 0, otherwise it returns –x.</p>
<pre class="code glsl literal-block">
<span class="keyword type">float</span> <span class="name">x</span> <span class="operator">=</span> <span class="name">abs</span><span class="punctuation">(</span><span class="operator">-</span><span class="literal number float">1.0</span><span class="punctuation">);</span>            <span class="comment single">// x = 1.0</span>
<span class="keyword type">vec2</span>  <span class="name">x</span> <span class="operator">=</span> <span class="name">abs</span><span class="punctuation">(</span><span class="keyword type">vec2</span><span class="punctuation">(</span><span class="literal number float">1.0</span><span class="punctuation">,</span> <span class="operator">-</span><span class="literal number float">2.0</span><span class="punctuation">));</span> <span class="comment single">// x = vec2(1.0, 2.0)</span>
</pre>
</blockquote>
<p><span class="proto">T sign (T x)</span></p>
<blockquote>
<p>The <code>sign</code> function returns 1.0 if x &gt; 0, 0.0 if x = 0, and –1.0 if x &lt; 0.</p>
<pre class="code glsl literal-block">
<span class="keyword type">float</span> <span class="name">x</span> <span class="operator">=</span> <span class="name">sign</span><span class="punctuation">(</span><span class="operator">-</span><span class="literal number float">2.0</span><span class="punctuation">);</span>          <span class="comment single">// x = -1.0</span>
<span class="keyword type">vec2</span>  <span class="name">x</span> <span class="operator">=</span> <span class="name">abs</span><span class="punctuation">(</span><span class="keyword type">vec2</span><span class="punctuation">(</span><span class="literal number float">0.0</span><span class="punctuation">,</span> <span class="literal number float">2.0</span><span class="punctuation">));</span> <span class="comment single">// x = vec2(0.0, 1.0)</span>
</pre>
</blockquote>
<p><span class="proto">T floor (T x)</span></p>
<blockquote>
<p>The <code>floor</code> function returns a value equal to the nearest integer that is
less than or equal to x.</p>
<pre class="code glsl literal-block">
<span class="keyword type">float</span> <span class="name">x</span> <span class="operator">=</span> <span class="name">sign</span><span class="punctuation">(</span><span class="literal number float">1.9</span><span class="punctuation">);</span>             <span class="comment single">// x = 1.0</span>
<span class="keyword type">vec2</span>  <span class="name">x</span> <span class="operator">=</span> <span class="name">sign</span><span class="punctuation">(</span><span class="keyword type">vec2</span><span class="punctuation">(</span><span class="operator">-</span><span class="literal number float">0.1</span><span class="punctuation">,</span> <span class="literal number float">1.1</span><span class="punctuation">));</span> <span class="comment single">// x = vec2(-1.0, 1.0)</span>
</pre>
</blockquote>
<p><span class="proto">T ceil (T x)</span></p>
<blockquote>
<p>The <code>ceil</code> function returns a value equal to the nearest integer that is
greater than or equal to x.</p>
<pre class="code glsl literal-block">
<span class="keyword type">float</span> <span class="name">x</span> <span class="operator">=</span> <span class="name">sign</span><span class="punctuation">(</span><span class="literal number float">1.9</span><span class="punctuation">);</span>             <span class="comment single">// x = 2.0</span>
<span class="keyword type">vec2</span>  <span class="name">x</span> <span class="operator">=</span> <span class="name">sign</span><span class="punctuation">(</span><span class="keyword type">vec2</span><span class="punctuation">(</span><span class="operator">-</span><span class="literal number float">0.1</span><span class="punctuation">,</span> <span class="literal number float">1.1</span><span class="punctuation">));</span> <span class="comment single">// x = vec2(0.0, 2.0)</span>
</pre>
</blockquote>
<p><span class="proto">T fract (T x)</span></p>
<blockquote>
<p>The <code>frac</code> function returns the fractional part of x, i.e. x – floor (x).</p>
<pre class="code glsl literal-block">
<span class="keyword type">float</span> <span class="name">x</span> <span class="operator">=</span> <span class="name">frac</span><span class="punctuation">(</span><span class="literal number float">1.9</span><span class="punctuation">);</span>             <span class="comment single">// x = 0.9</span>
<span class="keyword type">vec2</span>  <span class="name">x</span> <span class="operator">=</span> <span class="name">sign</span><span class="punctuation">(</span><span class="keyword type">vec2</span><span class="punctuation">(</span><span class="operator">-</span><span class="literal number float">0.1</span><span class="punctuation">,</span> <span class="literal number float">1.1</span><span class="punctuation">));</span> <span class="comment single">// x = vec2(0.9, 0.1)</span>
</pre>
</blockquote>
<p><span class="proto">T mod (T x, float y)</span></p>
<blockquote>
<p>The <code>mod</code> function returns the modulus (modulo) of x, i.e. x – y * floor
(x/y)</p>
<pre class="code glsl literal-block">
<span class="keyword type">float</span> <span class="name">x</span> <span class="operator">=</span> <span class="name">mod</span><span class="punctuation">(</span><span class="literal number float">1.1</span><span class="punctuation">,</span> <span class="literal number float">1.0</span><span class="punctuation">);</span>            <span class="comment single">// x = 0.1</span>
<span class="keyword type">vec2</span>  <span class="name">x</span> <span class="operator">=</span> <span class="name">mod</span><span class="punctuation">(</span><span class="keyword type">vec2</span><span class="punctuation">(</span><span class="literal number float">1.1</span><span class="punctuation">,</span> <span class="literal number float">2.2</span><span class="punctuation">),</span> <span class="literal number float">1.0</span><span class="punctuation">);</span> <span class="comment single">// x = vec2(0.1, 0.2)</span>
</pre>
</blockquote>
<p><span class="proto">T mod (T x, T y)</span></p>
<blockquote>
<p>The <code>mod</code> function returns the modulus (modulo) of x, i.e. x – y * floor
(x/y).</p>
<pre class="code glsl literal-block">
<span class="keyword type">float</span> <span class="name">x</span> <span class="operator">=</span> <span class="name">mod</span><span class="punctuation">(</span><span class="literal number float">1.1</span><span class="punctuation">,</span> <span class="literal number float">1.0</span><span class="punctuation">);</span>        <span class="comment single">// x = 0.1</span>
<span class="keyword type">vec2</span>  <span class="name">x</span> <span class="operator">=</span> <span class="name">mod</span><span class="punctuation">(</span><span class="keyword type">vec2</span><span class="punctuation">(</span><span class="literal number float">1.1</span><span class="punctuation">,</span> <span class="literal number float">2.2</span><span class="punctuation">),</span>
              <span class="keyword type">vec2</span><span class="punctuation">(</span><span class="literal number float">1.0</span><span class="punctuation">,</span> <span class="literal number float">1.5</span><span class="punctuation">));</span>  <span class="comment single">// x = vec2(0.1, 0.7)</span>
</pre>
</blockquote>
<div class="line-block">
<div class="line"><span class="proto">T min (T x, T y)</span></div>
<div class="line"><span class="proto">T min (T x, float y)</span></div>
</div>
<blockquote>
<p>The <code>min</code> function returns y if y &lt; x, otherwise it returns x</p>
<pre class="code glsl literal-block">
<span class="keyword type">vec2</span> <span class="name">x</span> <span class="operator">=</span> <span class="name">min</span><span class="punctuation">(</span><span class="keyword type">vec2</span><span class="punctuation">(</span><span class="literal number float">1.0</span><span class="punctuation">,</span> <span class="literal number float">2.0</span><span class="punctuation">),</span>
             <span class="keyword type">vec2</span><span class="punctuation">(</span><span class="literal number float">0.0</span><span class="punctuation">,</span> <span class="literal number float">3.0</span><span class="punctuation">));</span>      <span class="comment single">// x = vec2(0.0, 2.0)</span>
<span class="keyword type">vec2</span> <span class="name">x</span> <span class="operator">=</span> <span class="name">min</span><span class="punctuation">(</span><span class="keyword type">vec2</span><span class="punctuation">(</span><span class="literal number float">1.0</span><span class="punctuation">,</span> <span class="literal number float">2.0</span><span class="punctuation">),</span> <span class="literal number float">1.0</span><span class="punctuation">);</span> <span class="comment single">// x = vec2(1.0, 1.0)</span>
</pre>
</blockquote>
<div class="line-block">
<div class="line"><span class="proto">T max (T x, T y)</span></div>
<div class="line"><span class="proto">T max (T x, float y)</span></div>
</div>
<blockquote>
<p>The <code>max</code> function returns y if x &lt; y, otherwise it returns x</p>
<pre class="code glsl literal-block">
<span class="keyword type">vec2</span> <span class="name">x</span> <span class="operator">=</span> <span class="name">max</span><span class="punctuation">(</span><span class="keyword type">vec2</span><span class="punctuation">(</span><span class="literal number float">1.0</span><span class="punctuation">,</span> <span class="literal number float">2.0</span><span class="punctuation">),</span>
             <span class="keyword type">vec2</span><span class="punctuation">(</span><span class="literal number float">0.0</span><span class="punctuation">,</span> <span class="literal number float">3.0</span><span class="punctuation">));</span>      <span class="comment single">// x = vec2(1.0, 3.0)</span>
<span class="keyword type">vec2</span> <span class="name">x</span> <span class="operator">=</span> <span class="name">max</span><span class="punctuation">(</span><span class="keyword type">vec2</span><span class="punctuation">(</span><span class="literal number float">1.0</span><span class="punctuation">,</span> <span class="literal number float">2.0</span><span class="punctuation">),</span> <span class="literal number float">1.0</span><span class="punctuation">);</span> <span class="comment single">// x = vec2(1.0, 2.0)</span>
</pre>
</blockquote>
<div class="line-block">
<div class="line"><span class="proto">T clamp (T x, T a, T b)</span></div>
<div class="line"><span class="proto">T clamp (T x, float a, float b)</span></div>
</div>
<blockquote>
<p>The <code>clamp</code> function returns <code>min(max(x,a),b)</code>.
Results are undefined if a &gt; b.</p>
<pre class="code glsl literal-block">
<span class="keyword type">float</span> <span class="name">x</span> <span class="operator">=</span> <span class="name">clamp</span><span class="punctuation">(</span><span class="literal number float">1.1</span><span class="punctuation">,</span> <span class="literal number float">0.0</span><span class="punctuation">,</span> <span class="literal number float">1.0</span><span class="punctuation">);</span>            <span class="comment single">// x = 1.0;</span>
<span class="keyword type">vec2</span>  <span class="name">x</span> <span class="operator">=</span> <span class="name">clamp</span><span class="punctuation">(</span><span class="keyword type">vec2</span><span class="punctuation">(</span><span class="literal number float">1.0</span><span class="punctuation">,</span> <span class="literal number float">2.0</span><span class="punctuation">),</span> <span class="literal number float">0.0</span><span class="punctuation">,</span> <span class="literal number float">1.0</span><span class="punctuation">);</span> <span class="comment single">// x = vec2(1.0, 1.0)</span>
</pre>
</blockquote>
<div class="line-block">
<div class="line"><span class="proto">T mix (T x, T y, T a)</span></div>
<div class="line"><span class="proto">T mix (T x, T y, float a)</span></div>
</div>
<blockquote>
<p>The <code>mix</code> function returns the linear blend of x and y, i.e. x(1-a)+ya.</p>
<pre class="code glsl literal-block">
<span class="keyword type">float</span> <span class="name">x</span> <span class="operator">=</span> <span class="name">mix</span><span class="punctuation">(</span><span class="literal number float">0.0</span><span class="punctuation">,</span> <span class="literal number float">4.0</span><span class="punctuation">,</span> <span class="literal number float">0.25</span><span class="punctuation">);</span>  <span class="comment single">// x = 1.0;</span>
<span class="keyword type">float</span> <span class="name">x</span> <span class="operator">=</span> <span class="name">mix</span><span class="punctuation">(</span><span class="literal number float">0.0</span><span class="punctuation">,</span> <span class="literal number float">4.0</span><span class="punctuation">,</span> <span class="literal number float">0.75</span><span class="punctuation">);</span>  <span class="comment single">// x = 3.0;</span>
</pre>
</blockquote>
<div class="line-block">
<div class="line"><span class="proto">T step (T edge, T x)</span></div>
<div class="line"><span class="proto">T step (float edge, T x)</span></div>
</div>
<blockquote>
<p>The <code>step</code> returns 0.0 if x &lt; edge, otherwise it returns 1.0</p>
<pre class="code glsl literal-block">
<span class="keyword type">float</span> <span class="name">x</span> <span class="operator">=</span> <span class="name">step</span><span class="punctuation">(</span><span class="literal number float">0.0</span><span class="punctuation">,</span> <span class="operator">-</span><span class="literal number float">1.0</span><span class="punctuation">);</span> <span class="comment single">// x = -1.0;</span>
<span class="keyword type">float</span> <span class="name">x</span> <span class="operator">=</span> <span class="name">step</span><span class="punctuation">(</span><span class="literal number float">0.0</span><span class="punctuation">,</span> <span class="literal number float">0.5</span><span class="punctuation">);</span>  <span class="comment single">// x = 1.0</span>
</pre>
</blockquote>
<div class="line-block">
<div class="line"><span class="proto">T smoothstep (T edge0, T edge1, T x)</span></div>
<div class="line"><span class="proto">T smoothstep (float edge0, float edge1, T x)</span></div>
</div>
<blockquote>
<p>The <code>smoothstep</code> function returns 0.0 if x &lt;= edge0 and 1.0 if x ≥ edge1 and
performs smooth Hermite interpolation between 0 and 1 when edge0 &lt; x &lt;
edge1. This is useful in cases where you would want a threshold function with
a smooth transition. This is equivalent to:</p>
<pre class="code glsl literal-block">
<span class="name">T</span> <span class="name">t</span> <span class="operator">=</span> <span class="name">clamp</span> <span class="punctuation">((</span><span class="name">x</span> <span class="error">–</span> <span class="name">edge0</span><span class="punctuation">)</span> <span class="operator">/</span> <span class="punctuation">(</span><span class="name">edge1</span> <span class="error">–</span> <span class="name">edge0</span><span class="punctuation">),</span> <span class="literal number oct">0</span><span class="punctuation">,</span> <span class="literal number integer">1</span><span class="punctuation">);</span>
<span class="keyword">return</span> <span class="name">t</span> <span class="operator">*</span> <span class="name">t</span> <span class="operator">*</span> <span class="punctuation">(</span><span class="literal number integer">3</span> <span class="error">–</span> <span class="literal number integer">2</span> <span class="operator">*</span> <span class="name">t</span><span class="punctuation">);</span>
</pre>
<p>Results are undefined if edge0 &gt;= edge1.</p>
</blockquote>
</div>
<div class="section" id="geometric-functions">
<h3><a class="toc-backref" href="#id50">Geometric functions</a></h3>
<p><span class="proto">float length (T x)</span></p>
<blockquote>
<p>The <code>length</code> function returns the length of vector x, i.e. the square root of
the sum of the squares components.</p>
<pre class="code glsl literal-block">
<span class="keyword type">float</span> <span class="name">x</span> <span class="operator">=</span> <span class="name">length</span><span class="punctuation">(</span><span class="literal number float">1.0</span><span class="punctuation">);</span>             <span class="comment single">// x = 1.0</span>
<span class="keyword type">float</span> <span class="name">x</span> <span class="operator">=</span> <span class="name">length</span><span class="punctuation">(</span><span class="keyword type">vec2</span><span class="punctuation">(</span><span class="literal number float">3.0</span><span class="punctuation">,</span><span class="literal number float">4.0</span><span class="punctuation">));</span>   <span class="comment single">// x = 5.0</span>
</pre>
</blockquote>
<p><span class="proto">float distance (T p0, T p1)</span></p>
<blockquote>
<p>Returns the distance between p0 and p1, i.e. <code>length(p1-p0)</code>.</p>
<pre class="code glsl literal-block">
<span class="keyword type">vec3</span> <span class="name">p0</span> <span class="operator">=</span> <span class="keyword type">vec3</span><span class="punctuation">(</span><span class="literal number float">1.0</span><span class="punctuation">,</span> <span class="literal number float">5.0</span><span class="punctuation">,</span> <span class="literal number float">7.0</span><span class="punctuation">);</span>
<span class="keyword type">vec3</span> <span class="name">p1</span> <span class="operator">=</span> <span class="keyword type">vec3</span><span class="punctuation">(</span><span class="literal number float">1.0</span><span class="punctuation">,</span> <span class="literal number float">2.0</span><span class="punctuation">,</span> <span class="literal number float">3.0</span><span class="punctuation">);</span>
<span class="keyword type">float</span> <span class="name">x</span> <span class="operator">=</span> <span class="name">length</span><span class="punctuation">(</span><span class="name">p0</span><span class="punctuation">,</span><span class="name">p1</span><span class="punctuation">);</span> <span class="comment single">// x = 5.0</span>
</pre>
</blockquote>
<p><span class="proto">float dot (T x, T y)</span></p>
<blockquote>
Returns the dot product of x and y</blockquote>
<p><span class="proto">vec3 cross (vec3 x, vec3 y)</span></p>
<blockquote>
The <code>cross</code> functionn returns the cross product of x and y.</blockquote>
<p><span class="proto">T normalize (T x)</span></p>
<blockquote>
<p>The <code>normalize</code> function returns a vector in the same direction as x but
with a length of 1.</p>
<pre class="code glsl literal-block">
<span class="keyword type">vec2</span> <span class="name">p</span> <span class="operator">=</span> <span class="name">normalize</span><span class="punctuation">(</span><span class="keyword type">vec2</span><span class="punctuation">(</span><span class="literal number float">3.0</span><span class="punctuation">,</span> <span class="literal number float">4.0</span><span class="punctuation">));</span> <span class="comment single">// x = vec2(3.0,4.0)/5.0</span>
</pre>
</blockquote>
<p><span class="proto">T faceforward(T N, T I,T Nref)</span></p>
<blockquote>
The <code>faceforward</code> function return N if <code>dot(Nref, I) &lt; 0</code>, otherwise it
returns –N.</blockquote>
<p><span class="proto">T reflect (T I, T N)</span></p>
<blockquote>
For the incident vector I and surface orientation N, the <code>reflect</code> function
returns the reflection direction: I – 2 ∗ dot(N, I) ∗ N N must already be
normalized in order to achieve the desired result.</blockquote>
<p><span class="proto">T refract (T I, T N, float eta)</span></p>
<blockquote>
<p>For the incident vector I and surface normal N, and the ratio of indices of
refraction eta, the <code>reftact</code> function returns the refraction vector. The
result is computed by:</p>
<pre class="code glsl literal-block">
<span class="name">k</span> <span class="operator">=</span> <span class="literal number float">1.0</span><span class="operator">-</span><span class="name">eta</span><span class="operator">*</span><span class="name">eta</span><span class="operator">*</span><span class="punctuation">(</span><span class="literal number float">1.0</span><span class="operator">-</span><span class="name">dot</span><span class="punctuation">(</span><span class="name">N</span><span class="punctuation">,</span><span class="name">I</span><span class="punctuation">)</span><span class="operator">*</span><span class="name">dot</span><span class="punctuation">(</span><span class="name">N</span><span class="punctuation">,</span><span class="name">I</span><span class="punctuation">))</span>
<span class="keyword">if</span> <span class="punctuation">(</span><span class="name">k</span> <span class="operator">&lt;</span> <span class="literal number float">0.0</span><span class="punctuation">)</span>
    <span class="keyword">return</span> <span class="name">T</span><span class="punctuation">(</span><span class="literal number oct">0</span><span class="punctuation">)</span>
<span class="keyword">return</span> <span class="name">eta</span><span class="operator">*</span><span class="name">I</span><span class="operator">-</span><span class="punctuation">(</span><span class="name">eta</span><span class="operator">*</span><span class="name">dot</span><span class="punctuation">(</span><span class="name">N</span><span class="punctuation">,</span><span class="name">I</span><span class="punctuation">)</span><span class="operator">+</span><span class="name">sqrt</span><span class="punctuation">(</span><span class="name">k</span><span class="punctuation">))</span><span class="operator">*</span><span class="name">N</span>
</pre>
<p>The input parameters for the incident vector I and the surface normal N must
already be normalized to get the desired results.</p>
</blockquote>
</div>
<div class="section" id="matrix-functions">
<h3><a class="toc-backref" href="#id50">Matrix functions</a></h3>
<p><span class="proto">mat matrixCompMult (mat x, mat y)</span></p>
<blockquote>
<p>The <code>matrixCompMult</code> multiply matrix x by matrix y component-wise, i.e.,
<code>result[i][j]</code> is the scalar product of <code>x[i][j]</code> and <code>y[i][j]</code>.</p>
<p><strong>Note</strong>: to get linear algebraic matrix multiplication, use the multiply
operator (*).</p>
<pre class="code glsl literal-block">
<span class="keyword type">mat4</span> <span class="name">x</span> <span class="operator">=</span> <span class="keyword type">mat4</span><span class="punctuation">(</span><span class="literal number float">1.0</span><span class="punctuation">);</span>
<span class="keyword type">mat4</span> <span class="name">y</span> <span class="operator">=</span> <span class="keyword type">mat4</span><span class="punctuation">(</span><span class="literal number float">2.0</span><span class="punctuation">);</span>
<span class="keyword type">mat4</span> <span class="name">z</span> <span class="operator">=</span> <span class="name">matrix</span> <span class="name">CompMult</span><span class="punctuation">(</span><span class="name">x</span><span class="punctuation">,</span><span class="name">y</span><span class="punctuation">);</span> <span class="comment single">// z = mat4(2.0);</span>
</pre>
</blockquote>
</div>
<div class="section" id="vector-relational-functions">
<h3><a class="toc-backref" href="#id50">Vector Relational Functions</a></h3>
<p>Relational and equality operators (&lt;, &lt;=, &gt;, &gt;=, ==, !=) are defined to produce
scalar Boolean results. For vector results, use the following built-in
functions. Below, <code>bvecN</code> is a placeholder for one of <code>bvec2</code>, <code>bvec3</code>, or
<code>bvec4</code>, <code>ivecN</code> is a placeholder for one of <code>ivec2</code>, <code>ivec3</code>, or <code>ivec4</code>, and
<code>vecN</code> is a placeholder for <code>vec2</code>, <code>vec3</code>, or <code>vec4</code>. In all cases, the sizes
of the input and return vectors for any particular call must match.</p>
<div class="line-block">
<div class="line"><span class="proto">bvecN lessThan (ivecN x, ivecN y)</span></div>
<div class="line"><span class="proto">bvecN lessThan (vecN x, vecN y)</span></div>
</div>
<blockquote>
<p>The <code>lessThan</code> function returns the component-wise compare of x &lt; y.</p>
<pre class="code glsl literal-block">
<span class="keyword type">bvec2</span> <span class="name">c</span> <span class="operator">=</span> <span class="name">lessThan</span><span class="punctuation">(</span><span class="keyword type">vec2</span><span class="punctuation">(</span><span class="literal number float">1.0</span><span class="punctuation">,</span><span class="literal number float">1.0</span><span class="punctuation">),</span>
                   <span class="keyword type">vec2</span><span class="punctuation">(</span><span class="literal number float">1.0</span><span class="punctuation">,</span><span class="literal number float">2.0</span><span class="punctuation">));</span> <span class="comment single">// x = vec2(false, true);</span>
</pre>
</blockquote>
<div class="line-block">
<div class="line"><span class="proto">bvecN lessThanEqual (ivecN x, ivecN y)</span></div>
<div class="line"><span class="proto">bvecN lessThanEqual (vecN x, vecN y)</span></div>
</div>
<blockquote>
<p>The <code>lessThan</code> function returns the component-wise compare of x ≤ y.</p>
<pre class="code glsl literal-block">
<span class="keyword type">bvec2</span> <span class="name">c</span> <span class="operator">=</span> <span class="name">lessThan</span><span class="punctuation">(</span><span class="keyword type">vec2</span><span class="punctuation">(</span><span class="literal number float">1.0</span><span class="punctuation">,</span><span class="literal number float">1.0</span><span class="punctuation">),</span>
                   <span class="keyword type">vec2</span><span class="punctuation">(</span><span class="literal number float">1.0</span><span class="punctuation">,</span><span class="literal number float">2.0</span><span class="punctuation">));</span> <span class="comment single">// x = vec2(true, true);</span>
</pre>
</blockquote>
<div class="line-block">
<div class="line"><span class="proto">bvecN greaterThan (ivecN x, ivecN y)</span></div>
<div class="line"><span class="proto">bvecN greaterThan (vecN x, vecN y)</span></div>
</div>
<blockquote>
<p>The <code>greaterThan</code> function returns the component-wise compare of x &gt; y.</p>
<pre class="code glsl literal-block">
<span class="keyword type">bvec2</span> <span class="name">c</span> <span class="operator">=</span> <span class="name">greaterThan</span><span class="punctuation">(</span><span class="keyword type">vec2</span><span class="punctuation">(</span><span class="literal number float">1.0</span><span class="punctuation">,</span><span class="literal number float">1.0</span><span class="punctuation">),</span>
                      <span class="keyword type">vec2</span><span class="punctuation">(</span><span class="literal number float">1.0</span><span class="punctuation">,</span><span class="literal number float">2.0</span><span class="punctuation">));</span> <span class="comment single">// x = vec2(false, false);</span>
</pre>
</blockquote>
<div class="line-block">
<div class="line"><span class="proto">bvecN greaterThanEqual (ivecN x, ivecN y)</span></div>
<div class="line"><span class="proto">bvecN greaterThanEqual (vecN x, vecN y)</span></div>
</div>
<blockquote>
<p>The <code>greaterThan</code> function returns the component-wise compare of x ≥ y.</p>
<pre class="code glsl literal-block">
<span class="keyword type">bvec2</span> <span class="name">c</span> <span class="operator">=</span> <span class="name">greaterThan</span><span class="punctuation">(</span><span class="keyword type">vec2</span><span class="punctuation">(</span><span class="literal number float">1.0</span><span class="punctuation">,</span><span class="literal number float">1.0</span><span class="punctuation">),</span>
                      <span class="keyword type">vec2</span><span class="punctuation">(</span><span class="literal number float">1.0</span><span class="punctuation">,</span><span class="literal number float">2.0</span><span class="punctuation">));</span> <span class="comment single">// x = vec2(true, false);</span>
</pre>
</blockquote>
<div class="line-block">
<div class="line"><span class="proto">bvecN equal (bvecN x, bvecN y)</span></div>
<div class="line"><span class="proto">bvecN equal (ivecN x, ivecN y)</span></div>
<div class="line"><span class="proto">bvecN equal (vecN x, vecN y)</span></div>
</div>
<blockquote>
<p>The <code>equal</code> function returns the component-wise compare of x == y.</p>
<pre class="code glsl literal-block">
<span class="keyword type">ivec2</span> <span class="name">c</span> <span class="operator">=</span> <span class="name">equald</span><span class="punctuation">(</span><span class="keyword type">ivec2</span><span class="punctuation">(</span><span class="literal number integer">1</span><span class="punctuation">,</span><span class="literal number integer">1</span><span class="punctuation">),</span>
                 <span class="keyword type">ivec2</span><span class="punctuation">(</span><span class="literal number integer">1</span><span class="punctuation">,</span><span class="literal number integer">2</span><span class="punctuation">));</span> <span class="comment single">// x = vec2(true, false);</span>
</pre>
</blockquote>
<div class="line-block">
<div class="line"><span class="proto">bvecN notEqual (bvecN x, bvecN y)</span></div>
<div class="line"><span class="proto">bvecN notEqual (ivecN x, ivecN y)</span></div>
<div class="line"><span class="proto">bvecN notEqual (vecN x, vecN y)</span></div>
</div>
<blockquote>
<p>The <code>notEqual</code> function returns the component-wise compare of x == y.</p>
<pre class="code glsl literal-block">
<span class="keyword type">ivec2</span> <span class="name">c</span> <span class="operator">=</span> <span class="name">notEqual</span><span class="punctuation">(</span><span class="keyword type">ivec2</span><span class="punctuation">(</span><span class="literal number integer">1</span><span class="punctuation">,</span><span class="literal number integer">1</span><span class="punctuation">),</span>
                   <span class="name">ovec2</span><span class="punctuation">(</span><span class="literal number integer">1</span><span class="punctuation">,</span><span class="literal number integer">2</span><span class="punctuation">));</span> <span class="comment single">// x = vec2(false, true);</span>
</pre>
</blockquote>
<p><span class="proto">bool any (bvecN x)</span></p>
<blockquote>
<p>The <code>any</code> function returns true if any component  of x is true.</p>
<pre class="code glsl literal-block">
<span class="keyword type">bool</span> <span class="name">x</span> <span class="operator">=</span> <span class="name">any</span><span class="punctuation">(</span><span class="keyword type">bvec3</span><span class="punctuation">(</span><span class="keyword constant">true</span><span class="punctuation">,</span> <span class="keyword constant">false</span><span class="punctuation">,</span> <span class="keyword constant">false</span><span class="punctuation">));</span>  <span class="comment single">// x = true</span>
<span class="keyword type">bool</span> <span class="name">x</span> <span class="operator">=</span> <span class="name">any</span><span class="punctuation">(</span><span class="keyword type">bvec3</span><span class="punctuation">(</span><span class="keyword constant">false</span><span class="punctuation">,</span> <span class="keyword constant">false</span><span class="punctuation">,</span> <span class="keyword constant">false</span><span class="punctuation">));</span> <span class="comment single">// x = false</span>
</pre>
</blockquote>
<p><span class="proto">bool all (bvecN x)</span></p>
<blockquote>
<p>The <code>all</code> function returns true only if all components of x are true.</p>
<pre class="code glsl literal-block">
<span class="keyword type">bool</span> <span class="name">x</span> <span class="operator">=</span> <span class="name">all</span><span class="punctuation">(</span><span class="keyword type">bvec3</span><span class="punctuation">(</span><span class="keyword constant">true</span><span class="punctuation">,</span> <span class="keyword constant">true</span><span class="punctuation">,</span> <span class="keyword constant">true</span><span class="punctuation">));</span>  <span class="comment single">// x = true</span>
<span class="keyword type">bool</span> <span class="name">x</span> <span class="operator">=</span> <span class="name">all</span><span class="punctuation">(</span><span class="keyword type">bvec3</span><span class="punctuation">(</span><span class="keyword constant">true</span><span class="punctuation">,</span> <span class="keyword constant">true</span><span class="punctuation">,</span> <span class="keyword constant">false</span><span class="punctuation">));</span> <span class="comment single">// x = false</span>
</pre>
</blockquote>
<p><span class="proto">bvecN not (bvecN x)</span></p>
<blockquote>
<p>Returns the component-wise logical complement of x.</p>
<pre class="code glsl literal-block">
<span class="keyword type">bvec2</span> <span class="name">x</span> <span class="operator">=</span> <span class="name">not</span><span class="punctuation">(</span><span class="keyword type">bvec2</span><span class="punctuation">(</span><span class="keyword constant">true</span><span class="punctuation">,</span> <span class="keyword constant">false</span><span class="punctuation">));</span> <span class="comment single">// x = bvec2(false, true)</span>
</pre>
</blockquote>
</div>
<div class="section" id="texture-lookup-functions">
<h3><a class="toc-backref" href="#id50">Texture lookup functions</a></h3>
<p><span class="proto">vec4 texture2D (sampler2D sampler, vec2 coord)</span></p>
<blockquote>
Use the texture coordinate coord to do a texture lookup in the 2D texture
currently bound to sampler.</blockquote>
<p><span class="proto">vec4 textureCube (samplerCube sampler, vec3 coord )</span></p>
<blockquote>
Use the texture coordinate coord to do a texture lookup in the cube map
texture currently bound to sampler. The direction of coord is used to select
which face to do a 2- dimensional texture lookup in, as described in section
3.8.6 in version 2.0 of the OpenGL specification.</blockquote>
</div>
</div>
</div>
<div class="section" id="bibliography">
<h1><a class="toc-backref" href="#contents">Bibliography</a></h1>
<div class="contents toc chapter-17 local topic" id="id53">
<p class="topic-title first">.</p>
<ul class="simple">
<li><a class="reference internal" href="#people" id="id245">People</a></li>
<li><a class="reference internal" href="#tutorials" id="id246">Tutorials</a></li>
<li><a class="reference internal" href="#articles" id="id247">Articles</a></li>
<li><a class="reference internal" href="#books" id="id248">Books</a></li>
</ul>
</div>
<p>This is a curated list of some computer graphics resources (people, articles,
books &amp; tutorials) addressing different aspects. Some are very specific to
OpenGL while some others offer a broader view on computer graphics and
geometry.</p>
<div class="section" id="people">
<h2><a class="toc-backref" href="#id53">People</a></h2>
<ul class="simple">
<li><a class="reference external" href="http://iquilezles.org/www/index.htm">Íñigo Quílez</a> wrote short articles on
the techniques he developed for computer graphics experiments, demos,
shadertoys and movies. All content is beginner and medium level, and mostly
pragmatic rather than theoretical. He is also a master in raymarched distance
fields and wrote some of the most amazing scripts on <a class="reference external" href="https://www.shadertoy.com">shadertoys</a> (see for example his beautiful <a class="reference external" href="http://iquilezles.org/www/articles/raymarchingdf/raymarchingdf.htm">snail script</a>.</li>
<li><a class="reference external" href="http://paulbourke.net">Paul Bourke</a> offers on his website a very large set
of resources concerning Geometry, Surfaces, Curves &amp; Polyhedra (among other
things). He generally get straight to the point with demonstration and
code. I cannot count the number of times I landed on his page when asking a
simple geometry questions (distance between two lines in 3D, circles passing
through three points, intersecion of two circles, etc).</li>
<li><a class="reference external" href="http://github.prideout.net">Philip Rideout</a> maintains the Little
Grasshoper website where he explains some specific techniques such as
volumetric smoke, tesselation, clipping). Everything comes with code, demos
and explanations and I translated some of his <a class="reference external" href="http://prideout.net/blog/">techniques</a> in this book.</li>
</ul>
</div>
<div class="section" id="tutorials">
<h2><a class="toc-backref" href="#id53">Tutorials</a></h2>
<ul class="simple">
<li><a class="reference external" href="http://www.opengl-tutorial.org">OpenGL tutorial (C)</a>, Sam Hocevar, 2017.</li>
<li><a class="reference external" href="https://learnopengl.com/">Learn OpenGL (C)</a>, Joey de Vries, 2017.</li>
<li><a class="reference external" href="http://duriansoftware.com/joe/An-intro-to-modern-OpenGL.-Table-of-Contents.html">An intro to modern OpenGL (C)</a>, Joe Groff, 2010.</li>
<li><a class="reference external" href="https://www.khronos.org/opengl/wiki/Main_Page">OpenGL Wiki</a>, Community Edited, 2017.</li>
<li><a class="reference external" href="http://www.songho.ca/opengl/index.html">Fundamental OpenGL tutorial</a>, Song Ho Ahn (안성호), 2017.</li>
<li><a class="reference external" href="https://github.com/ssloy/tinyrenderer/wiki">Tiny renderer</a>, Dmitry V. Sokolov, 2016.</li>
</ul>
</div>
<div class="section" id="articles">
<h2><a class="toc-backref" href="#id53">Articles</a></h2>
<ul>
<li><div class="first line-block">
<div class="line"><a class="reference external" href="http://jcgt.org/published/0002/01/04/">Higher Quality 2D Text Rendering</a></div>
<div class="line">N. P. Rougier,
Journal of Computer Graphics Techniques (JCGT), vol. 2, no. 1, pp. 50–64, 2013.</div>
</div>
<div class="abstract docutils container">
<p>Even though text is pervasive in most 3D applications, there is
surprisingly no native support for text rendering in OpenGL. To cope with
this absence, Mark Kilgard introduced the use of texture fonts [Kilgard
1997]. This technique is well known and widely used and ensures both good
performances and a decent quality in most situations. However, the quality
may degrade strongly in orthographic mode (screen space) due to pixelation
effects at large sizes and to legibility problems at small sizes due to
incorrect hinting and positioning of glyphs. In this paper, we consider
font-texture rendering to develop methods to ensure the highest quality in
orthographic mode. The method used allows for both the accurate render-
ing and positioning of any glyph on the screen. While the method is
compatible with complex shaping and/or layout (e.g., the Arabic alphabet),
these specific cases are not studied in this article.</p>
</div>
</li>
<li><div class="first line-block">
<div class="line"><a class="reference external" href="http://jcgt.org/published/0002/02/08/">Shader-based Antialiased Dashed Stroke Polylines</a></div>
<div class="line">N. P. Rougier
Journal of Computer Graphics Techniques (JCGT), vol. 2, no. 2, pp. 105–121, 2013.</div>
</div>
<div class="abstract docutils container">
<p>Dashed stroked paths are a widely-used feature found in the vast majority
of vector-drawing software and libraries. They enable, for example, the
highlighting of a given path, such as the current selection, in drawing
software or distinguishing curves, in the case of a scientific plotting
package. This paper introduces a shader-based method for rendering
arbitrary dash patterns along any continuous polyline (smooth or
broken). The proposed method does not tessellate individual dash patterns
and allows for fast and nearly accurate rendering of any user-defined dash
pattern and caps. Benchmarks indicate a slowdown ratio between 1.1 and 2.1
with an increased memory consumption between 3 and 6. Furthermore, the
method can be used for solid thick polylines with correct caps and joins
with only a slowdown factor of 1.1.</p>
</div>
</li>
<li><div class="first line-block">
<div class="line"><a class="reference external" href="http://jcgt.org/published/0003/04/01/">Antialiased 2D Grid, Marker, and Arrow Shaders</a></div>
<div class="line">N. P. Rougier
Journal of Computer Graphics Techniques (JCGT), vol. 3, no. 4, pp. 1–52, 2014.</div>
</div>
<div class="abstract docutils container">
<p>Grids, markers, and arrows are important components in scientific
visualisation. Grids are widely used in scientific plots and help visually
locate data. Markers visualize individual points and aggregated
data. Quiver plots show vector fields, such as a velocity buffer, through
regularly-placed arrows. Being able to draw these components quickly is
critical if one wants to offer interactive visualisation. This article
provides algorithms with GLSL implementations for drawing grids, markers,
and arrows using implicit surfaces that make it possible quickly render
pixel-perfect antialiased shapes.</p>
</div>
</li>
</ul>
</div>
<div class="section" id="books">
<h2><a class="toc-backref" href="#id53">Books</a></h2>
<ul>
<li><div class="first line-block">
<div class="line"><a class="reference external" href="http://graphicscodex.com">The Graphics Codex</a></div>
<div class="line">Morgan McGuire, 2017.</div>
</div>
<div class="abstract docutils container">
<p>The Graphics Codex is designed to support a course either as the sole,
standalone text or as lecture notes and an encyclopedic reference
alongside a traditional textbook. It contains 400 cross-referenced
equation and diagram entries, 14 chapters on physically-based shading and
rendering Multi-platform programming projects, Links to external DirectX,
OpenGL, Unity, Mitsuba, G3D, and other API documentation, PDF links and
full citations for primary sources and textbooks, Free updates with new
content every month</p>
</div>
</li>
<li><div class="first line-block">
<div class="line"><a class="reference external" href="http://www.realtimerendering.com/">Real-time Rendering, 3ʳᵈ edition</a></div>
<div class="line">Tomas Akenine-Moller, Eric Haines, Naty Hoffman</div>
</div>
<div class="abstract docutils container">
<p>Thoroughly revised, this third edition focuses on modern techniques used
to generate synthetic three-dimensional images in a fraction of a
second. With the advent of programmable shaders, a wide variety of new
algorithms have arisen and evolved over the past few years. This edition
discusses current, practical rendering methods used in games and other
applications. It also presents a solid theoretical framework and relevant
mathematics for the field of interactive computer graphics, all in an
approachable style.</p>
</div>
</li>
<li><div class="first line-block">
<div class="line"><a class="reference external" href="http://dept.cs.williams.edu/~morgan/cgpp/about.xml">Computer Graphics: Principles and Practice, 3ʳᵈ edition</a></div>
<div class="line">John F. Hughes, Andries van Dam, Morgan McGuire, David F. Sklar,
James D. Foley, Steven K. Feiner, Kurt Akeley</div>
</div>
<div class="abstract docutils container">
<p>In this book, we explain the principles, as well as the mathematics,
underlying computer graphics--knowledge that is essential for successful
work both now and in the future. Early chapters show how to create 2D and
3D pictures right away, supporting experimentation. Later chapters,
covering a broad range of topics, demonstrate more sophisticated
approaches. Sections on current computer graphics practice show how to
apply given principles in common situations, such as how to approximate an
ideal solution on available hardware, or how to represent a data structure
more efficiently. Topics are reinforced by exercises, programming
problems, and hands-on projects.</p>
</div>
</li>
<li><div class="first line-block">
<div class="line"><a class="reference external" href="https://www.crcpress.com/Fundamentals-of-Computer-Graphics/Shirley-Ashikhmin-Marschner/p/book/9781568814698">Fundamentals of Computer Graphics, 4ᵗʰ edition</a></div>
<div class="line">Peter Shirley, Michael Ashikhmin, Steve Marschner</div>
</div>
<div class="abstract docutils container">
<p>The third edition of this widely adopted text gives students a
comprehensive, fundamental introduction to computer graphics. The authors
present the mathematical foundations of computer graphics with a focus on
geometric intuition, allowing the programmer to understand and apply those
foundations to the development of efficient code.</p>
</div>
</li>
<li><div class="first line-block">
<div class="line"><a class="reference external" href="http://www.labri.fr/perso/nrougier/from-python-to-numpy/">From Python to Numpy</a></div>
<div class="line">Nicolas P. Rougier</div>
</div>
<div class="abstract docutils container">
<p>There are already a fair number of books about Numpy and a legitimate
question is to wonder if another book is really necessary. As you may have
guessed by reading these lines, my personal answer is yes, mostly because
I think there is room for a different approach concentrating on the
migration from Python to Numpy through vectorization. There are a lot of
techniques that you don't find in books and such techniques are mostly
learned through experience. The goal of this book is to explain some of
these techniques and to provide an opportunity for making this experience
in the process.</p>
</div>
</li>
</ul>
</div>
</div>
</div>
</body>
</html>
